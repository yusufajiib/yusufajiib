<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Informasi Pembayaran SPP - Panduan Harga Per Kelas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen relative">
    <!-- Watermark Background -->
    <div class="fixed inset-0 pointer-events-none z-0 opacity-5">
        <div class="absolute inset-0 flex items-center justify-center">
            <div class="text-center transform rotate-12">
                <img 
                    src="https://lh3.googleusercontent.com/d/1yTmDUC2K2-cSm_EWq1hQt_rtJ1xa4Odc" 
                    alt="Watermark Logo" 
                    class="w-96 h-96 object-contain mx-auto mb-4 opacity-30"
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                >
                <!-- Fallback watermark if logo fails -->
                <div class="w-96 h-96 mx-auto mb-4 flex items-center justify-center text-gray-400" style="display: none;">
                    <svg class="w-64 h-64" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M12 14l9-5-9-5-9 5 9 5z"/>
                        <path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/>
                    </svg>
                </div>
                <h1 class="text-6xl font-bold text-gray-300 mb-2">MA NU HASYIM ASY'ARI 1</h1>
                <p class="text-4xl text-gray-300">KUDUS</p>
                <p class="text-2xl text-gray-300 mt-4">SISTEM INFORMASI PEMBAYARAN SPP</p>
            </div>
        </div>
    </div><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97bea1b091ab5f54',t:'MTc1NzMzNjQ1Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-blue-600 relative z-10">
        <div class="container mx-auto px-4 sm:px-6 py-4">
            <div class="flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0">
                <div class="flex items-center space-x-3 text-center sm:text-left">
                    <!-- School Logo -->
                    <div class="flex-shrink-0">
                        <img 
                            src="https://lh3.googleusercontent.com/d/1yTmDUC2K2-cSm_EWq1hQt_rtJ1xa4Odc" 
                            alt="Logo MA NU Hasyim Asy'ari 1 Kudus" 
                            class="w-12 h-12 sm:w-16 sm:h-16 object-contain rounded-lg shadow-md"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                        >
                        <!-- Fallback icon if logo fails to load -->
                        <div class="bg-green-600 text-white p-3 rounded-lg w-12 h-12 sm:w-16 sm:h-16 flex items-center justify-center" style="display: none;">
                            <svg class="w-6 h-6 sm:w-8 sm:h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M12 14l9-5-9-5-9 5 9 5z"/>
                                <path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/>
                            </svg>
                        </div>
                    </div>
                    <div>
                        <h1 class="text-lg sm:text-2xl font-bold text-gray-800 leading-tight">MA NU Hasyim Asy'ari 1 Kudus</h1>
                        <p class="text-xs sm:text-sm text-gray-600 mt-1">Jl. Mayor H. Basuno No. 17 Sunggingan Kota Kudus 59317</p>
                    </div>
                </div>
                <div class="text-center sm:text-right">
                    <p class="text-xs sm:text-sm text-gray-600">Tahun Ajaran</p>
                    <p class="font-semibold text-sm sm:text-base text-gray-800" id="academicYear">2025/2026</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8 relative z-10">
        <!-- Pricing Guide Section - Hidden -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-8 hidden">
            <!-- Panduan pengaturan harga disembunyikan untuk fokus pada pencarian -->
        </div>

        <!-- Search Section -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Administrasi Madrasah</h2>
                <p class="text-gray-600">Masukkan NISN untuk melihat informasi</p>
            </div>
            
            <div class="max-w-md mx-auto">
                <div class="relative">
                    <input 
                        type="text" 
                        id="nisnInput" 
                        placeholder="Masukkan NISN (10 digit)"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-center text-lg font-mono"
                        maxlength="10"
                    >
                    <button 
                        onclick="searchStudent()" 
                        class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center space-x-2"
                    >
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                        </svg>
                        <span>Cari Data Siswa</span>
                    </button>
                    <button 
                        onclick="refreshData()" 
                        class="w-full mt-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200 flex items-center justify-center space-x-2 text-sm"
                    >
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                        </svg>
                        <span>Refresh Data</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Transaction Input Section -->
        <div id="transactionInput" class="hidden bg-white rounded-xl shadow-lg p-8 mb-8 border-2 border-green-200">
            <div class="text-center mb-6">
                <h3 class="text-2xl font-bold text-green-800 mb-2">Input Transaksi Pembayaran</h3>
                <p class="text-green-600">Masukkan pembayaran untuk <span id="transactionStudentName" class="font-semibold"></span></p>
            </div>
            
            <div class="max-w-2xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Payment Type Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Pembayaran</label>
                        <select id="paymentType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-green-500 focus:outline-none" onchange="updatePaymentOptions()">
                            <option value="">Pilih Jenis Pembayaran</option>
                            <option value="spp">SPP Bulanan</option>
                            <option value="tabungan">Tabungan Siswa</option>
                            <option value="lks">Buku LKS</option>
                            <option value="ulangan">UHB (Ulangan Harian)</option>
                            <option value="ujian">PAS (Ujian Semester)</option>
                            <option value="ujian_akhir">Ujian Akhir</option>
                            <option value="infaq">Infaq Kenaikan Kelas</option>
                            <option value="siswa_baru_putra">Siswa Baru (Putra)</option>
                            <option value="siswa_baru_putri">Siswa Baru (Putri)</option>
                            <option value="perpisahan">Perpisahan</option>
                            <option value="study_tour">Studi Tour</option>
                            <option value="buku_kenangan">Buku Kenangan</option>
                        </select>
                    </div>
                    
                    <!-- Period Selection -->
                    <div id="periodSelection" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Periode</label>
                        <select id="paymentPeriod" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-green-500 focus:outline-none">
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    
                    <!-- Class Selection -->
                    <div id="classSelection" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                        <select id="paymentClass" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-green-500 focus:outline-none">
                            <option value="class10">Kelas 10</option>
                            <option value="class11">Kelas 11</option>
                            <option value="class12">Kelas 12</option>
                        </select>
                    </div>
                    
                    <!-- Amount Input -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Pembayaran</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2 text-gray-500">Rp</span>
                            <input 
                                type="text" 
                                id="paymentAmount" 
                                placeholder="0"
                                class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:border-green-500 focus:outline-none"
                                oninput="formatCurrency(this)"
                            >
                        </div>
                        <div id="targetAmountInfo" class="text-sm text-gray-500 mt-1"></div>
                    </div>
                </div>
                
                <!-- Transaction Date -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Transaksi</label>
                    <input 
                        type="date" 
                        id="transactionDate" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-green-500 focus:outline-none"
                    >
                </div>
                
                <!-- Notes -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Catatan (Opsional)</label>
                    <textarea 
                        id="transactionNotes" 
                        placeholder="Catatan tambahan..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-green-500 focus:outline-none"
                        rows="2"
                    ></textarea>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex space-x-4 mt-6">
                    <button 
                        onclick="processTransaction()" 
                        class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center space-x-2"
                    >
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        <span>Proses Pembayaran</span>
                    </button>
                    <button 
                        onclick="cancelTransaction()" 
                        class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200"
                    >
                        Batal
                    </button>
                </div>
            </div>
        </div>

        <!-- Student Info Section -->
        <div id="studentInfo" class="hidden bg-white rounded-xl shadow-lg p-8 mb-8">
            <div class="flex items-center justify-between mb-6 pb-6 border-b">
                <div class="flex items-center space-x-4">
                    <div class="bg-blue-100 p-4 rounded-full">
                        <svg class="w-8 h-8 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div>
                        <h3 id="studentName" class="text-2xl font-bold text-gray-800"></h3>
                        <p id="studentClass" class="text-gray-600"></p>
                        <p id="studentNISN" class="text-sm text-gray-500"></p>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button 
                        onclick="showTransactionInput()" 
                        class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 flex items-center space-x-2"
                    >
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"/>
                        </svg>
                        <span>Input Transaksi</span>
                    </button>
                    <button 
                        onclick="showTransactionHistory()" 
                        class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 flex items-center space-x-2"
                    >
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                        </svg>
                        <span>History Transaksi</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Payment Status Section -->
        <div id="paymentStatus" class="hidden space-y-6">
            <!-- Current Month Status -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h4 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <span class="bg-yellow-100 text-yellow-800 p-2 rounded-lg mr-3">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                        </svg>
                    </span>
                    Status Bulan Berjalan
                </h4>
                <div id="currentMonthStatus" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Current month payment status will be inserted here -->
                </div>
            </div>

            <!-- Complete Payment History -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h4 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <span class="bg-blue-100 text-blue-800 p-2 rounded-lg mr-3">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                        </svg>
                    </span>
                    Riwayat Pembayaran Lengkap
                </h4>
                <div id="completePaymentHistory">
                    <!-- Complete payment history will be inserted here -->
                </div>
            </div>

            <!-- Pricing Changes Notification -->
            <div id="pricingChanges" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6">
                <h4 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <span class="bg-orange-100 text-orange-800 p-2 rounded-lg mr-3">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                    </span>
                    Perubahan Tarif Terbaru
                </h4>
                <div id="pricingChangesList" class="space-y-3">
                    <!-- Pricing changes will be inserted here -->
                </div>
            </div>

            <!-- Summary -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h4 class="text-xl font-bold text-gray-800 mb-4">Ringkasan Pembayaran</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <div class="text-3xl font-bold text-green-600" id="totalPaid">0</div>
                        <div class="text-sm text-gray-600">Bulan Terbayar</div>
                    </div>
                    <div class="text-center p-4 bg-red-50 rounded-lg">
                        <div class="text-3xl font-bold text-red-600" id="totalUnpaid">0</div>
                        <div class="text-sm text-gray-600">Bulan Belum Bayar</div>
                    </div>
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <div class="text-3xl font-bold text-blue-600" id="totalAmount">Rp 0</div>
                        <div class="text-sm text-gray-600">Total Tunggakan</div>
                    </div>
                </div>
                
                <!-- Current Pricing Display - Hidden -->
                <div class="mt-6 pt-6 border-t hidden">
                    <h5 class="text-lg font-semibold text-gray-700 mb-3">Tarif Saat Ini (Per Kelas)</h5>
                    <div id="currentPricing" class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                        <!-- Current pricing will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction History Section -->
        <div id="transactionHistory" class="hidden bg-white rounded-xl shadow-lg p-8 mb-8 border-2 border-purple-200">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-2xl font-bold text-purple-800 mb-2">History Transaksi</h3>
                    <p class="text-purple-600">Riwayat pembayaran untuk <span id="historyStudentName" class="font-semibold"></span></p>
                </div>
                <button 
                    onclick="hideTransactionHistory()" 
                    class="text-gray-500 hover:text-gray-700 p-2"
                >
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            
            <div class="max-w-4xl mx-auto">
                <!-- Filter Options -->
                <div class="flex flex-wrap gap-4 mb-6 p-4 bg-purple-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-purple-700 mb-1">Filter Periode</label>
                        <select id="historyFilter" class="px-3 py-2 border border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none text-sm" onchange="filterTransactionHistory()">
                            <option value="all">Semua Transaksi</option>
                            <option value="today">Hari Ini</option>
                            <option value="week">7 Hari Terakhir</option>
                            <option value="month">30 Hari Terakhir</option>
                            <option value="year">Tahun Ini</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-purple-700 mb-1">Jenis Pembayaran</label>
                        <select id="historyTypeFilter" class="px-3 py-2 border border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none text-sm" onchange="filterTransactionHistory()">
                            <option value="all">Semua Jenis</option>
                            <option value="spp">SPP</option>
                            <option value="tabungan">Tabungan</option>
                            <option value="lks">LKS</option>
                            <option value="ulangan">UHB</option>
                            <option value="ujian">PAS</option>
                            <option value="onetime">Pembayaran Sekali</option>
                        </select>
                    </div>
                </div>
                
                <!-- Transaction List -->
                <div id="transactionList" class="space-y-4">
                    <!-- Transaction items will be populated here -->
                </div>
                
                <!-- Empty State -->
                <div id="emptyTransactionHistory" class="hidden text-center py-8">
                    <div class="text-gray-400 mb-4">
                        <svg class="w-16 h-16 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-600 mb-2">Belum Ada Transaksi</h4>
                    <p class="text-gray-500">Belum ada riwayat transaksi untuk filter yang dipilih</p>
                </div>
            </div>
        </div>

        <!-- No Data Message -->
        <div id="noDataMessage" class="hidden bg-white rounded-xl shadow-lg p-8 text-center">
            <div class="text-gray-400 mb-4">
                <svg class="w-16 h-16 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
            </div>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">Data Tidak Ditemukan</h3>
            <p class="text-gray-500">NISN yang Anda masukkan tidak terdaftar dalam sistem</p>
        </div>
    </main>

    <script>
        // Payment components configuration (Enhanced with new components from pricing format)
        const paymentComponents = {
            // Monthly payments
            spp: { name: 'SPP', defaultAmount: 175000, type: 'monthly', description: 'Sumbangan Pembinaan Pendidikan' },
            tabungan: { name: 'Tabungan', defaultAmount: 50000, type: 'monthly_class10', description: 'Tabungan Siswa (Khusus Kelas 10)' },
            
            // Semester payments
            lks: { name: 'Buku LKS', defaultAmount: 120000, type: 'semester', description: 'Lembar Kerja Siswa' },
            ulangan: { name: 'UHB (Ulangan Harian)', defaultAmount: 100000, type: 'semester', description: 'Ulangan Harian Bersama' },
            ujian: { name: 'PAS (Ujian Semester)', defaultAmount: 100000, type: 'semester', description: 'Penilaian Akhir Semester' },
            ujian_akhir: { name: 'Ujian Akhir', defaultAmount: 125000, type: 'onetime', description: 'Ujian Akhir Sekolah' },
            
            // Yearly payments
            infaq: { name: 'Infaq Kenaikan Kelas', defaultAmount: 150000, type: 'yearly', description: 'Infaq Kenaikan Kelas' },
            
            // One-time payments - New students
            siswa_baru_putra: { name: 'Siswa Baru (Putra)', defaultAmount: 1200000, type: 'onetime', description: 'Biaya Pendaftaran Siswa Baru Putra' },
            siswa_baru_putri: { name: 'Siswa Baru (Putri)', defaultAmount: 1350000, type: 'onetime', description: 'Biaya Pendaftaran Siswa Baru Putri' },
            siswa_pindahan_putra: { name: 'Siswa Pindahan (Putra)', defaultAmount: 1200000, type: 'onetime', description: 'Biaya Siswa Pindahan Putra' },
            siswa_pindahan_putri: { name: 'Siswa Pindahan (Putri)', defaultAmount: 1350000, type: 'onetime', description: 'Biaya Siswa Pindahan Putri' },
            
            // Other one-time payments
            perpisahan: { name: 'Perpisahan', defaultAmount: 1000000, type: 'onetime', description: 'Biaya Perpisahan Kelas XII' },
            study_tour: { name: 'Studi Tour', defaultAmount: 300000, type: 'onetime', description: 'Biaya Studi Tour' },
            buku_kenangan: { name: 'Buku Kenangan', defaultAmount: 50000, type: 'onetime', description: 'Buku Kenangan Sekolah' },
            
            // Legacy component for backward compatibility
            siswa_baru: { name: 'Siswa Baru', defaultAmount: 1250000, type: 'onetime', description: 'Biaya Pendaftaran Siswa Baru (Umum)' }
        };

        // Dynamic payment amounts from Google Sheets (Enhanced for class-specific pricing)
        let paymentAmounts = {};
        
        // Pricing history for tracking changes
        let pricingHistory = {};

        // Google Sheets Configuration
        const GOOGLE_SHEETS_CONFIG = {
            SHEET_ID: '17MDc804lNUm_XwUM6hPj6Ui8T-JVtpxJCLq4XovVs0A',
            SHEET_NAME: 'Sheet7',
            API_KEY: 'AIzaSyCAJWvsjw92iebZM54KZivepTpl_Q2gk70'
        };

        // Cache for storing fetched data
        let studentsData = {};
        let isDataLoaded = false;
        
        // Transaction history storage
        let transactionHistory = {};
        let currentStudentNISN = null;

        // Function to fetch data from Google Sheets
        async function fetchStudentData() {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.SHEET_ID}/values/${GOOGLE_SHEETS_CONFIG.SHEET_NAME}?key=${GOOGLE_SHEETS_CONFIG.API_KEY}`;
                
                showLoadingMessage('Mengambil data dari database...');
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    parseSheetData(data.values);
                    isDataLoaded = true;
                    hideLoadingMessage();
                } else {
                    throw new Error('Data tidak ditemukan dalam spreadsheet');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                showErrorMessage('Gagal mengambil data dari database. Menggunakan data contoh.');
                loadSampleData();
                isDataLoaded = true;
            }
        }

        // Function to parse Google Sheets data
        function parseSheetData(rows) {
            const headers = rows[0];
            studentsData = {};
            
            // First, parse payment amounts from the spreadsheet
            parsePaymentAmounts(rows);
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (row.length < 3) continue;
                
                const nisn = row[0]?.toString().trim();
                const name = row[1]?.toString().trim();
                const currentClass = row[2]?.toString().trim();
                
                if (!nisn || !name || !currentClass) continue;
                
                studentsData[nisn] = {
                    name: name,
                    currentClass: currentClass,
                    nisn: nisn,
                    payments: initializePaymentStructure()
                };
                
                parsePaymentData(studentsData[nisn], row, headers);
            }
        }

        // Function to initialize payment structure (Updated with new components)
        function initializePaymentStructure() {
            return {
                // Monthly payments - store {paid: boolean, amount: number}
                spp: {
                    class10: new Array(12).fill().map(() => ({paid: false, amount: 0})),
                    class11: new Array(12).fill().map(() => ({paid: false, amount: 0})),
                    class12: new Array(12).fill().map(() => ({paid: false, amount: 0}))
                },
                tabungan: {
                    class10: new Array(12).fill().map(() => ({paid: false, amount: 0})),
                    class11: new Array(12).fill().map(() => ({paid: false, amount: 0})),
                    class12: new Array(12).fill().map(() => ({paid: false, amount: 0}))
                },
                // Semester payments
                lks: { 
                    class10: [{paid: false, amount: 0}, {paid: false, amount: 0}], 
                    class11: [{paid: false, amount: 0}, {paid: false, amount: 0}], 
                    class12: [{paid: false, amount: 0}, {paid: false, amount: 0}] 
                },
                ulangan: { 
                    class10: [{paid: false, amount: 0}, {paid: false, amount: 0}], 
                    class11: [{paid: false, amount: 0}, {paid: false, amount: 0}], 
                    class12: [{paid: false, amount: 0}, {paid: false, amount: 0}] 
                },
                ujian: { 
                    class10: [{paid: false, amount: 0}, {paid: false, amount: 0}], 
                    class11: [{paid: false, amount: 0}, {paid: false, amount: 0}], 
                    class12: [{paid: false, amount: 0}, {paid: false, amount: 0}] 
                },
                ujian_akhir: [{paid: false, amount: 0}],
                // Yearly payments
                infaq: { 
                    class10: [{paid: false, amount: 0}], 
                    class11: [{paid: false, amount: 0}], 
                    class12: [{paid: false, amount: 0}] 
                },
                // One-time payments - New students
                siswa_baru_putra: [{paid: false, amount: 0}],
                siswa_baru_putri: [{paid: false, amount: 0}],
                siswa_pindahan_putra: [{paid: false, amount: 0}],
                siswa_pindahan_putri: [{paid: false, amount: 0}],
                
                // Other one-time payments
                perpisahan: [{paid: false, amount: 0}],
                study_tour: [{paid: false, amount: 0}],
                buku_kenangan: [{paid: false, amount: 0}],
                
                // Legacy component for backward compatibility
                siswa_baru: [{paid: false, amount: 0}]
            };
        }

        // Function to parse payment amounts from Google Sheets (Enhanced for dedicated pricing blocks)
        function parsePaymentAmounts(rows) {
            const headers = rows[0];
            
            // Look for dedicated pricing blocks with "TARIF KELAS" format
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row[0]) continue;
                
                const firstCell = row[0].toString().trim();
                
                // Check if this is a pricing block header
                if (firstCell.toLowerCase().includes('tarif') && firstCell.toLowerCase().includes('kelas')) {
                    // Look for class specification in the next rows or same row
                    let classType = null;
                    let pricingData = '';
                    
                    // Check current row for class info
                    for (let j = 1; j < row.length; j++) {
                        if (row[j]) {
                            const cellContent = row[j].toString().trim();
                            if (cellContent.toLowerCase().includes('kelas')) {
                                // Extract class number
                                const classMatch = cellContent.match(/kelas\s*(\d+)/i);
                                if (classMatch) {
                                    classType = `class${classMatch[1]}`;
                                }
                                pricingData = cellContent;
                                break;
                            }
                        }
                    }
                    
                    // If no class found in current row, check next row
                    if (!classType && i + 1 < rows.length) {
                        const nextRow = rows[i + 1];
                        for (let j = 0; j < nextRow.length; j++) {
                            if (nextRow[j]) {
                                const cellContent = nextRow[j].toString().trim();
                                if (cellContent.toLowerCase().includes('kelas')) {
                                    const classMatch = cellContent.match(/kelas\s*(\d+)/i);
                                    if (classMatch) {
                                        classType = `class${classMatch[1]}`;
                                    }
                                    pricingData = cellContent;
                                    break;
                                }
                            }
                        }
                    }
                    
                    // Parse the pricing data if we found a class
                    if (classType && pricingData) {
                        parsePricingBlock(pricingData, classType);
                    }
                }
            }
            
            // Fallback: Look for traditional header-based pricing
            if (Object.keys(paymentAmounts).length === 0) {
                headers.forEach((header, index) => {
                    if (!header) return;
                    
                    const headerLower = header.toString().toLowerCase().trim();
                    
                    // Check for amount/nominal/biaya keywords
                    if (headerLower.includes('amount') || headerLower.includes('nominal') || 
                        headerLower.includes('biaya') || headerLower.includes('tarif') || 
                        headerLower.includes('harga')) {
                        
                        const componentInfo = detectComponentFromHeaderWithClass(header);
                        
                        if (componentInfo && rows.length > 1) {
                            // Get amount from first data row that has a valid amount
                            for (let rowIndex = 1; rowIndex < rows.length; rowIndex++) {
                                const amountValue = rows[rowIndex][index];
                                if (amountValue) {
                                    const cleanValue = amountValue.toString().replace(/[^\d]/g, '');
                                    const amount = parseFloat(cleanValue);
                                    if (!isNaN(amount) && amount > 0) {
                                        const priceKey = componentInfo.classType ? 
                                            `${componentInfo.component}_${componentInfo.classType}` : 
                                            componentInfo.component;
                                        paymentAmounts[priceKey] = amount;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Function to parse individual pricing blocks
        function parsePricingBlock(pricingData, classType) {
            // Component mapping for Indonesian terms
            const componentMappings = {
                'siswa baru putra': 'siswa_baru_putra',
                'siswa baru putri': 'siswa_baru_putri',
                'spp': 'spp',
                'tabungan': 'tabungan',
                'lks': 'lks',
                'uhb': 'ulangan',
                'ulangan harian': 'ulangan',
                'pas': 'ujian',
                'ujian semester': 'ujian',
                'infaq kenaikan kelas': 'infaq',
                'infaq': 'infaq',
                'perpisahan': 'perpisahan',
                'studi tour': 'study_tour',
                'study tour': 'study_tour',
                'buku kenangan': 'buku_kenangan',
                'ujian akhir': 'ujian_akhir'
            };
            
            // Split the pricing data into lines
            const lines = pricingData.split(/[\n\r]+/);
            
            for (const line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine) continue;
                
                // Look for pattern: "Component Name: Rp Amount"
                const match = trimmedLine.match(/^(.+?):\s*Rp\s*([\d.,]+)/i);
                if (match) {
                    const componentName = match[1].trim().toLowerCase();
                    const amountStr = match[2].replace(/[.,]/g, '');
                    const amount = parseFloat(amountStr);
                    
                    if (!isNaN(amount) && amount > 0) {
                        // Find matching component
                        let mappedComponent = null;
                        for (const [key, value] of Object.entries(componentMappings)) {
                            if (componentName.includes(key)) {
                                mappedComponent = value;
                                break;
                            }
                        }
                        
                        if (mappedComponent) {
                            const priceKey = `${mappedComponent}_${classType}`;
                            const oldAmount = paymentAmounts[priceKey];
                            paymentAmounts[priceKey] = amount;
                            
                            // Track pricing history
                            if (!pricingHistory[priceKey]) {
                                pricingHistory[priceKey] = [];
                            }
                            
                            if (oldAmount && oldAmount !== amount) {
                                pricingHistory[priceKey].push({
                                    oldAmount: oldAmount,
                                    newAmount: amount,
                                    changeDate: new Date().toLocaleDateString('id-ID'),
                                    changeType: amount > oldAmount ? 'naik' : 'turun'
                                });
                            }
                        }
                    }
                }
            }
        }

        // Function to detect component from header (Enhanced with class detection)
        function detectComponentFromHeader(header) {
            const componentInfo = detectComponentFromHeaderWithClass(header);
            return componentInfo ? componentInfo.component : null;
        }

        // Function to detect component and class from header
        function detectComponentFromHeaderWithClass(header) {
            const headerLower = header.toString().toLowerCase().trim();
            const normalizedHeader = headerLower.replace(/[^a-z0-9]/g, '');
            
            // Component detection with various naming patterns
            const componentPatterns = {
                'spp': ['spp'],
                'tabungan': ['tabungan', 'saving'],
                'lks': ['lks', 'lembarkerja', 'lembar_kerja'],
                'ulangan': ['ulangan', 'ulhar', 'quiz'],
                'ujian': ['ujian', 'exam', 'test'],
                'ujian_akhir': ['ujianakhir', 'ujian_akhir', 'finalexam', 'akhir'],
                'infaq': ['infaq', 'donasi'],
                'siswa_baru': ['siswabaru', 'newstudent', 'pendaftaran', 'siswa_baru'],
                'perpisahan': ['perpisahan', 'farewell'],
                'study_tour': ['studytour', 'tour', 'wisata', 'study_tour'],
                'buku_kenangan': ['bukukenangan', 'yearbook', 'kenangan', 'buku_kenangan']
            };
            
            // Class detection patterns
            const classPatterns = {
                'class10': ['10', 'x', 'sepuluh'],
                'class11': ['11', 'xi', 'sebelas'],
                'class12': ['12', 'xii', 'duabelas']
            };
            
            let foundComponent = null;
            let foundClass = null;
            
            // Find matching component
            for (const [key, patterns] of Object.entries(componentPatterns)) {
                for (const pattern of patterns) {
                    if (normalizedHeader.includes(pattern)) {
                        foundComponent = key;
                        break;
                    }
                }
                if (foundComponent) break;
            }
            
            // Find matching class
            for (const [key, patterns] of Object.entries(classPatterns)) {
                for (const pattern of patterns) {
                    if (normalizedHeader.includes(pattern)) {
                        foundClass = key;
                        break;
                    }
                }
                if (foundClass) break;
            }
            
            return foundComponent ? {
                component: foundComponent,
                classType: foundClass
            } : null;
        }

        // Function to get payment amount with dynamic pricing support (Enhanced for class-specific pricing)
        function getPaymentAmount(componentKey, classType = null, period = null) {
            // Priority order for finding the right price:
            // 1. Class + Period specific (e.g., spp_class10_juli)
            // 2. Class specific (e.g., spp_class10)
            // 3. Component general (e.g., spp)
            // 4. Default from component config
            
            const keys = [];
            
            if (classType && period) {
                keys.push(`${componentKey}_${classType}_${period}`);
            }
            if (classType) {
                keys.push(`${componentKey}_${classType}`);
            }
            keys.push(componentKey);
            
            // Try each key in priority order
            for (const key of keys) {
                if (paymentAmounts[key] && paymentAmounts[key] > 0) {
                    return paymentAmounts[key];
                }
            }
            
            // Fallback to default
            return paymentComponents[componentKey]?.defaultAmount || 0;
        }

        // Function to get pricing change information
        function getPricingChanges(componentKey) {
            return pricingHistory[componentKey] || [];
        }

        // Function to parse payment data from spreadsheet row
        function parsePaymentData(student, row, headers) {
            // Create a mapping of header names to column indices for flexible positioning
            const headerMap = {};
            headers.forEach((header, index) => {
                if (header) {
                    headerMap[header.toString().toLowerCase().trim()] = index;
                }
            });
            
            // Process all columns regardless of position
            headers.forEach((header, colIndex) => {
                if (colIndex < row.length && header) {
                    const headerLower = header.toString().toLowerCase().trim();
                    const value = row[colIndex]?.toString().trim();
                    
                    // Debug logging for ujian_akhir headers
                    if (headerLower.includes('ujian') || headerLower.includes('akhir')) {
                        console.log(`Processing header for ${student.name}: "${header}" (${headerLower}) = "${value}"`);
                    }
                    
                    // Parse payment amount - handle cicilan (partial payments)
                    let paidAmount = 0;
                    let isPaid = false;
                    
                    if (value) {
                        const valueLower = value.toLowerCase();
                        
                        // Check for text indicators (full payment)
                        if (valueLower === 'lunas' || valueLower === 'paid' || valueLower === 'sudah' || valueLower === 'bayar') {
                            isPaid = true;
                            paidAmount = null; // Full payment, amount will be determined by component
                        }
                        // Check for dates (full payment)
                        else if (value.match(/\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/) || value.match(/\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}/)) {
                            isPaid = true;
                            paidAmount = null; // Full payment
                        }
                        // Check for numeric values (could be partial or full payment)
                        else {
                            const numericValue = parseFloat(value.replace(/[^\d.]/g, ''));
                            if (!isNaN(numericValue) && numericValue > 0) {
                                paidAmount = numericValue;
                                isPaid = true; // Any payment > 0 is considered "paid" but we track the amount
                            }
                        }
                    }
                    
                    mapHeaderToPayment(student, headerLower, isPaid, paidAmount);
                }
            });
        }

        // Function to map spreadsheet headers to payment structure (Updated for amounts)
        function mapHeaderToPayment(student, header, isPaid, paidAmount) {
            // Normalize header for flexible matching
            const normalizedHeader = header.replace(/[^a-z0-9]/g, '').toLowerCase();
            
            // Month name mappings for flexible header formats
            const monthMappings = {
                'jul': 0, 'juli': 0, 'july': 0,
                'agu': 1, 'agustus': 1, 'august': 1,
                'sep': 2, 'september': 2,
                'okt': 3, 'oktober': 3, 'october': 3,
                'nov': 4, 'november': 4,
                'des': 5, 'desember': 5, 'december': 5,
                'jan': 6, 'januari': 6, 'january': 6,
                'feb': 7, 'februari': 7, 'february': 7,
                'mar': 8, 'maret': 8, 'march': 8,
                'apr': 9, 'april': 9,
                'mei': 10, 'may': 10,
                'jun': 11, 'juni': 11, 'june': 11
            };
            
            // Semester mappings
            const semesterMappings = {
                'sem1': 0, 'semester1': 0, 'ganjil': 0, '1': 0,
                'sem2': 1, 'semester2': 1, 'genap': 1, '2': 1
            };
            
            // Enhanced ujian_akhir matching with more flexible patterns
            if ((normalizedHeader.includes('ujian') && normalizedHeader.includes('akhir')) ||
                normalizedHeader.includes('ujianakhir') ||
                normalizedHeader.includes('finalexam') ||
                normalizedHeader.includes('akhir') ||
                header.toLowerCase().includes('ujian akhir')) {
                const finalAmount = paidAmount === null ? getPaymentAmount('ujian_akhir') : paidAmount;
                student.payments.ujian_akhir[0] = {
                    paid: isPaid,
                    amount: isPaid ? finalAmount : 0
                };
                return; // Exit early to avoid double processing
            }
            
            // Direct UHB (Ulangan Harian Bersama) matching
            if (normalizedHeader.includes('uhb') || 
                (normalizedHeader.includes('ulangan') && (normalizedHeader.includes('harian') || normalizedHeader.includes('bersama')))) {
                // Try to extract class and semester info
                let classNum = '';
                let semesterNum = '';
                
                // Extract class number
                const classMatch = header.match(/(?:kelas|class)\s*(\d+)|(\d+)/i);
                if (classMatch) {
                    classNum = classMatch[1] || classMatch[2];
                }
                
                // Extract semester
                const semMatch = header.match(/(?:sem|semester)\s*(\d+)|ganjil|genap/i);
                if (semMatch) {
                    if (semMatch[1]) {
                        semesterNum = semMatch[1];
                    } else if (header.toLowerCase().includes('ganjil')) {
                        semesterNum = '1';
                    } else if (header.toLowerCase().includes('genap')) {
                        semesterNum = '2';
                    }
                }
                
                if (classNum && semesterNum) {
                    const classKey = `class${classNum}`;
                    const semIndex = parseInt(semesterNum) - 1;
                    
                    if (student.payments.ulangan[classKey] && semIndex >= 0 && semIndex < 2) {
                        const finalAmount = paidAmount === null ? getPaymentAmount('ulangan', classKey) : paidAmount;
                        student.payments.ulangan[classKey][semIndex] = {
                            paid: isPaid,
                            amount: isPaid ? finalAmount : 0
                        };
                        return;
                    }
                }
            }
            
            // Direct PAS (Penilaian Akhir Semester) matching
            if (normalizedHeader.includes('pas') || 
                (normalizedHeader.includes('penilaian') && normalizedHeader.includes('akhir')) ||
                (normalizedHeader.includes('ujian') && normalizedHeader.includes('semester'))) {
                // Try to extract class and semester info
                let classNum = '';
                let semesterNum = '';
                
                // Extract class number
                const classMatch = header.match(/(?:kelas|class)\s*(\d+)|(\d+)/i);
                if (classMatch) {
                    classNum = classMatch[1] || classMatch[2];
                }
                
                // Extract semester
                const semMatch = header.match(/(?:sem|semester)\s*(\d+)|ganjil|genap/i);
                if (semMatch) {
                    if (semMatch[1]) {
                        semesterNum = semMatch[1];
                    } else if (header.toLowerCase().includes('ganjil')) {
                        semesterNum = '1';
                    } else if (header.toLowerCase().includes('genap')) {
                        semesterNum = '2';
                    }
                }
                
                if (classNum && semesterNum) {
                    const classKey = `class${classNum}`;
                    const semIndex = parseInt(semesterNum) - 1;
                    
                    if (student.payments.ujian[classKey] && semIndex >= 0 && semIndex < 2) {
                        const finalAmount = paidAmount === null ? getPaymentAmount('ujian', classKey) : paidAmount;
                        student.payments.ujian[classKey][semIndex] = {
                            paid: isPaid,
                            amount: isPaid ? finalAmount : 0
                        };
                        return;
                    }
                }
            }
            
            // Check for gender-specific siswa baru first (priority matching)
            if (normalizedHeader.includes('siswa') && normalizedHeader.includes('baru')) {
                if (normalizedHeader.includes('putra') || normalizedHeader.includes('laki')) {
                    const finalAmount = paidAmount === null ? getPaymentAmount('siswa_baru_putra') : paidAmount;
                    student.payments.siswa_baru_putra[0] = {
                        paid: isPaid,
                        amount: isPaid ? finalAmount : 0
                    };
                    return; // Exit early to avoid double processing
                } else if (normalizedHeader.includes('putri') || normalizedHeader.includes('perempuan')) {
                    const finalAmount = paidAmount === null ? getPaymentAmount('siswa_baru_putri') : paidAmount;
                    student.payments.siswa_baru_putri[0] = {
                        paid: isPaid,
                        amount: isPaid ? finalAmount : 0
                    };
                    return; // Exit early to avoid double processing
                }
            }
            
            // Try to parse the header intelligently
            const parts = header.split(/[_\s-]+/);
            let component = '';
            let classNum = '';
            let period = '';
            
            // Identify component, class, and period from any position in header
            parts.forEach(part => {
                const partLower = part.toLowerCase();
                
                // Check for component names with more flexible matching
                if (partLower.includes('spp')) component = 'spp';
                else if (partLower.includes('tabungan')) component = 'tabungan';
                else if (partLower.includes('lks')) component = 'lks';
                else if (partLower.includes('uhb') || partLower.includes('ulangan')) component = 'ulangan';
                else if (partLower.includes('pas') || (partLower.includes('ujian') && !partLower.includes('akhir'))) component = 'ujian';
                else if (partLower.includes('ujian') && partLower.includes('akhir')) component = 'ujian_akhir';
                else if (partLower.includes('infaq')) component = 'infaq';
                else if (partLower.includes('siswa') || partLower.includes('baru') || partLower.includes('pendaftaran')) component = 'siswa_baru';
                else if (partLower.includes('perpisahan') || partLower.includes('farewell')) component = 'perpisahan';
                else if (partLower.includes('study') || partLower.includes('tour') || partLower.includes('wisata')) component = 'study_tour';
                else if (partLower.includes('buku') || partLower.includes('kenangan') || partLower.includes('yearbook')) component = 'buku_kenangan';
                
                // Check for class numbers
                if (partLower.match(/^(10|11|12)$/)) {
                    classNum = partLower;
                }
                
                // Check for months
                Object.keys(monthMappings).forEach(monthKey => {
                    if (partLower.includes(monthKey)) {
                        period = monthMappings[monthKey].toString();
                    }
                });
                
                // Check for semesters
                Object.keys(semesterMappings).forEach(semKey => {
                    if (partLower.includes(semKey)) {
                        period = semesterMappings[semKey].toString();
                    }
                });
            });
            
            // Apply the mapping if we found valid components
            if (component && student.payments[component]) {
                if (classNum) {
                    const classKey = `class${classNum}`;
                    if (student.payments[component][classKey]) {
                        if (period !== '') {
                            const index = parseInt(period);
                            if (index >= 0 && index < student.payments[component][classKey].length) {
                                // Set payment data with amount (use class-specific pricing)
                                const finalAmount = paidAmount === null ? getPaymentAmount(component, classKey) : paidAmount;
                                student.payments[component][classKey][index] = {
                                    paid: isPaid,
                                    amount: isPaid ? finalAmount : 0
                                };
                            }
                        } else if (student.payments[component][classKey].length === 1) {
                            // For yearly payments
                            const finalAmount = paidAmount === null ? getPaymentAmount(component, classKey) : paidAmount;
                            student.payments[component][classKey][0] = {
                                paid: isPaid,
                                amount: isPaid ? finalAmount : 0
                            };
                        }
                    }
                } else if (Array.isArray(student.payments[component])) {
                    // For one-time payments without class specification
                    const finalAmount = paidAmount === null ? getPaymentAmount(component) : paidAmount;
                    student.payments[component][0] = {
                        paid: isPaid,
                        amount: isPaid ? finalAmount : 0
                    };
                }
            }
            
            // Enhanced fallback: more flexible header matching for one-time payments
            const flexibleMappings = {
                'ujian_akhir': ['ujianakhir', 'ujian_akhir', 'finalexam', 'akhir', 'ujianfinal', 'ujian', 'final', 'test', 'exam'],
                'ulangan': ['uhb', 'ulangan', 'ulanganharianbesama', 'ulanganharian', 'quiz'],
                'ujian': ['pas', 'penilaianakhirsemester', 'ujiansemseter', 'ujian', 'semester'],
                'siswa_baru_putra': ['siswabaru', 'siswabaruputra', 'siswabarulaki', 'pendaftaranputra', 'daftarputra'],
                'siswa_baru_putri': ['siswabaruputri', 'siswabaruputri', 'siswabaruperempuan', 'pendaftaranputri', 'daftarputri'],
                'siswa_baru': ['siswa', 'baru', 'pendaftaran', 'daftar', 'masuk'],
                'perpisahan': ['perpisahan', 'farewell', 'pisah'],
                'study_tour': ['study', 'tour', 'wisata', 'karyawisata'],
                'buku_kenangan': ['buku', 'kenangan', 'yearbook']
            };
            
            Object.keys(flexibleMappings).forEach(componentKey => {
                flexibleMappings[componentKey].forEach(keyword => {
                    if (normalizedHeader.includes(keyword)) {
                        if (student.payments[componentKey]) {
                            const finalAmount = paidAmount === null ? getPaymentAmount(componentKey) : paidAmount;
                            student.payments[componentKey][0] = {
                                paid: isPaid,
                                amount: isPaid ? finalAmount : 0
                            };
                            
                            // Debug logging for ujian_akhir
                            if (componentKey === 'ujian_akhir') {
                                console.log(`Ujian Akhir mapped for ${student.name}: header="${header}", keyword="${keyword}", paid=${isPaid}, amount=${finalAmount}`);
                            }
                        }
                    }
                });
            });
        }

        // Function to load sample data as fallback (Updated with new pricing format)
        function loadSampleData() {
            // Set sample class-specific pricing with new format rates
            paymentAmounts = {
                // Class 10 pricing
                'spp_class10': 125000,
                'tabungan_class10': 50000,
                'lks_class10': 120000,
                'ulangan_class10': 100000,
                'ujian_class10': 100000,
                'ujian_akhir_class10': 125000,
                'infaq_class10': 150000,
                'siswa_baru_putra_class10': 1200000,
                'siswa_baru_putri_class10': 1350000,
                'perpisahan_class10': 1000000,
                'study_tour_class10': 300000,
                'buku_kenangan_class10': 50000,
                
                // Class 11 pricing
                'spp_class11': 175000,
                'lks_class11': 120000,
                'ulangan_class11': 100000,
                'ujian_class11': 100000,
                'ujian_akhir_class11': 125000,
                'infaq_class11': 150000,

                'perpisahan_class11': 1000000,
                'study_tour_class11': 300000,
                'buku_kenangan_class11': 50000,
                
                // Class 12 pricing
                'spp_class12': 175000,
                'lks_class12': 120000,
                'ulangan_class12': 100000,
                'ujian_class12': 100000,
                'ujian_akhir_class12': 125000,
                'infaq_class12': 150000,

                'perpisahan_class12': 1000000,
                'study_tour_class12': 300000,
                'buku_kenangan_class12': 50000
            };
            
            studentsData = {
                '0086045210': {
                    name: 'Abdul Malik',
                    currentClass: 'X IPA 1',
                    nisn: '0086045210',
                    payments: {
                        spp: {
                            class10: [
                                {paid: true, amount: 75000}, {paid: true, amount: 50000}, {paid: false, amount: 0}, 
                                {paid: false, amount: 0}, {paid: false, amount: 0}, {paid: false, amount: 0},
                                {paid: false, amount: 0}, {paid: false, amount: 0}, {paid: false, amount: 0},
                                {paid: false, amount: 0}, {paid: false, amount: 0}, {paid: false, amount: 0}
                            ],
                            class11: new Array(12).fill().map(() => ({paid: false, amount: 0})),
                            class12: new Array(12).fill().map(() => ({paid: false, amount: 0}))
                        },
                        tabungan: {
                            class10: [
                                {paid: true, amount: 25000}, {paid: true, amount: 30000}, {paid: false, amount: 0}, 
                                {paid: false, amount: 0}, {paid: false, amount: 0}, {paid: false, amount: 0},
                                {paid: false, amount: 0}, {paid: false, amount: 0}, {paid: false, amount: 0},
                                {paid: false, amount: 0}, {paid: false, amount: 0}, {paid: false, amount: 0}
                            ],
                            class11: new Array(12).fill().map(() => ({paid: false, amount: 0})),
                            class12: new Array(12).fill().map(() => ({paid: false, amount: 0}))
                        },
                        lks: { 
                            class10: [{paid: true, amount: 30000}, {paid: false, amount: 0}], 
                            class11: [{paid: false, amount: 0}, {paid: false, amount: 0}], 
                            class12: [{paid: false, amount: 0}, {paid: false, amount: 0}] 
                        },
                        ulangan: { 
                            class10: [{paid: true, amount: 100000}, {paid: false, amount: 0}], 
                            class11: [{paid: false, amount: 0}, {paid: false, amount: 0}], 
                            class12: [{paid: false, amount: 0}, {paid: false, amount: 0}] 
                        },
                        ujian: { 
                            class10: [{paid: false, amount: 0}, {paid: false, amount: 0}], 
                            class11: [{paid: false, amount: 0}, {paid: false, amount: 0}], 
                            class12: [{paid: false, amount: 0}, {paid: false, amount: 0}] 
                        },
                        ujian_akhir: [{paid: false, amount: 0}],
                        infaq: { 
                            class10: [{paid: true, amount: 100000}], 
                            class11: [{paid: false, amount: 0}], 
                            class12: [{paid: false, amount: 0}] 
                        },
                        // New student payments (gender-specific)
                        siswa_baru_putra: [{paid: true, amount: 750000}],  // Male new student - partial payment
                        siswa_baru_putri: [{paid: false, amount: 0}],
                        siswa_pindahan_putra: [{paid: false, amount: 0}],
                        siswa_pindahan_putri: [{paid: false, amount: 0}],
                        
                        // Other payments
                        perpisahan: [{paid: false, amount: 0}],
                        study_tour: [{paid: false, amount: 0}],
                        buku_kenangan: [{paid: false, amount: 0}],
                        
                        // Legacy for backward compatibility
                        siswa_baru: [{paid: true, amount: 750000}]
                    }
                }
            };
        }

        // Loading and error message functions
        function showLoadingMessage(message) {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingMessage';
            loadingDiv.className = 'fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingDiv.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg text-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p class="text-gray-700">${message}</p>
                </div>
            `;
            document.body.appendChild(loadingDiv);
        }

        function hideLoadingMessage() {
            const loadingDiv = document.getElementById('loadingMessage');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        function showErrorMessage(message) {
            hideLoadingMessage();
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded z-50';
            errorDiv.innerHTML = `
                <span class="block sm:inline">${message}</span>
                <button onclick="this.parentElement.remove()" class="float-right ml-4 text-red-500 hover:text-red-700">×</button>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        const months = ['Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni'];
        const semesters = ['Semester 1', 'Semester 2'];

        // Function to get current academic month (0-based index)
        function getCurrentAcademicMonth() {
            const now = new Date();
            const currentMonth = now.getMonth(); // 0-based (0=January, 11=December)
            const currentYear = now.getFullYear();
            
            // Academic year starts in July
            // July 2024 - June 2025 = Academic Year 2024/2025
            // July 2025 - June 2026 = Academic Year 2025/2026
            
            if (currentMonth >= 6) { // July (6) to December (11)
                return currentMonth - 6; // July=0, August=1, ..., December=5
            } else { // January (0) to June (5)
                return currentMonth + 6; // January=6, February=7, ..., June=11
            }
        }

        // Function to get current academic year string
        function getCurrentAcademicYear() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            if (currentMonth >= 6) { // July to December
                return `${currentYear}/${currentYear + 1}`;
            } else { // January to June
                return `${currentYear - 1}/${currentYear}`;
            }
        }

        // Function to get display year for a specific academic month
        function getCurrentDisplayYear(academicMonth) {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            // Academic months 0-5 (July-December) use current calendar year
            // Academic months 6-11 (January-June) use next calendar year
            if (academicMonth <= 5) { // July to December
                if (currentMonth >= 6) { // We're in July-December period
                    return currentYear;
                } else { // We're in January-June period, so last year's July-December
                    return currentYear - 1;
                }
            } else { // January to June
                if (currentMonth >= 6) { // We're in July-December period, so next year's January-June
                    return currentYear + 1;
                } else { // We're in January-June period
                    return currentYear;
                }
            }
        }

        async function searchStudent() {
            const nisn = document.getElementById('nisnInput').value.trim();
            
            if (nisn.length !== 10) {
                alert('NISN harus 10 digit');
                return;
            }

            if (!isDataLoaded) {
                await fetchStudentData();
            }

            const student = studentsData[nisn];
            
            if (student) {
                displayStudentInfo(student);
                displayPaymentStatus(student);
                document.getElementById('noDataMessage').classList.add('hidden');
            } else {
                hideStudentInfo();
                document.getElementById('noDataMessage').classList.remove('hidden');
            }
        }

        function displayStudentInfo(student) {
            document.getElementById('studentName').textContent = student.name;
            document.getElementById('studentClass').textContent = student.currentClass;
            document.getElementById('studentNISN').textContent = `NISN: ${student.nisn}`;
            document.getElementById('studentInfo').classList.remove('hidden');
            
            // Store current student for transaction processing
            currentStudentNISN = student.nisn;
            
            // Initialize transaction history if not exists
            if (!transactionHistory[student.nisn]) {
                transactionHistory[student.nisn] = [];
            }
        }

        function displayPaymentStatus(student) {
            const currentMonth = getCurrentAcademicMonth(); // Get actual current month
            displayCurrentMonthStatus(student, currentMonth);
            displayCompletePaymentHistory(student);
            displayPricingChanges();
            displayCurrentPricing();
            displaySummary(student.payments);
            document.getElementById('paymentStatus').classList.remove('hidden');
        }

        function displayCurrentMonthStatus(student, currentMonth) {
            const container = document.getElementById('currentMonthStatus');
            const currentClass = student.currentClass.includes('XII') ? 'class12' : 
                               student.currentClass.includes('XI') ? 'class11' : 'class10';
            
            const sppPayment = student.payments.spp[currentClass][currentMonth];
            const tabunganPayment = currentClass === 'class10' ? student.payments.tabungan[currentClass][currentMonth] : null;
            const monthName = months[currentMonth];
            
            // SPP Card with class-specific pricing
            const sppTargetAmount = getPaymentAmount('spp', currentClass);
            const currentYear = getCurrentDisplayYear(currentMonth);
            const sppIsPartialPayment = sppPayment.paid && sppPayment.amount < sppTargetAmount;
            const sppRemainingAmount = sppTargetAmount - sppPayment.amount;
            
            let currentMonthCards = `
                <div class="p-4 rounded-lg ${sppPayment.paid ? (sppIsPartialPayment ? 'bg-yellow-50 border-2 border-yellow-300' : 'bg-green-50 border-2 border-green-200') : 'bg-red-50 border-2 border-red-200'}">
                    <div class="flex items-center justify-between">
                        <div>
                            <h5 class="font-semibold ${sppPayment.paid ? (sppIsPartialPayment ? 'text-yellow-800' : 'text-green-800') : 'text-red-800'}">${monthName} ${currentYear}</h5>
                            <p class="text-sm ${sppPayment.paid ? (sppIsPartialPayment ? 'text-yellow-600' : 'text-green-600') : 'text-red-600'}">SPP Bulanan (${currentClass.replace('class', 'Kelas ')})</p>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold ${sppPayment.paid ? (sppIsPartialPayment ? 'text-yellow-600' : 'text-green-600') : 'text-red-600'}">
                                ${sppPayment.paid ? (sppIsPartialPayment ? '⚠️ CICILAN' : '✓ LUNAS') : '✗ BELUM BAYAR'}
                            </div>
                            <div class="text-sm text-gray-600">
                                ${sppPayment.paid ? 
                                    (sppIsPartialPayment ? 
                                        `Dibayar: Rp ${sppPayment.amount.toLocaleString('id-ID')} | Sisa: Rp ${sppRemainingAmount.toLocaleString('id-ID')}` :
                                        `Dibayar: Rp ${sppPayment.amount.toLocaleString('id-ID')}`
                                    ) : 
                                    `Target: Rp ${sppTargetAmount.toLocaleString('id-ID')}`
                                }
                            </div>
                        </div>
                    </div>
                </div>`;
            
            // Tabungan Card (only for class 10)
            if (currentClass === 'class10' && tabunganPayment !== null) {
                const tabunganTargetAmount = getPaymentAmount('tabungan', currentClass);
                const tabunganIsPartialPayment = tabunganPayment.paid && tabunganPayment.amount < tabunganTargetAmount;
                const tabunganRemainingAmount = tabunganTargetAmount - tabunganPayment.amount;
                
                currentMonthCards += `
                <div class="p-4 rounded-lg ${tabunganPayment.paid ? (tabunganIsPartialPayment ? 'bg-yellow-50 border-2 border-yellow-300' : 'bg-green-50 border-2 border-green-200') : 'bg-red-50 border-2 border-red-200'}">
                    <div class="flex items-center justify-between">
                        <div>
                            <h5 class="font-semibold ${tabunganPayment.paid ? (tabunganIsPartialPayment ? 'text-yellow-800' : 'text-green-800') : 'text-red-800'}">${monthName} ${currentYear}</h5>
                            <p class="text-sm ${tabunganPayment.paid ? (tabunganIsPartialPayment ? 'text-yellow-600' : 'text-green-600') : 'text-red-600'}">Tabungan Siswa (Khusus Kelas 10)</p>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold ${tabunganPayment.paid ? (tabunganIsPartialPayment ? 'text-yellow-600' : 'text-green-600') : 'text-red-600'}">
                                ${tabunganPayment.paid ? (tabunganIsPartialPayment ? '⚠️ CICILAN' : '✓ LUNAS') : '✗ BELUM BAYAR'}
                            </div>
                            <div class="text-sm text-gray-600">
                                ${tabunganPayment.paid ? 
                                    (tabunganIsPartialPayment ? 
                                        `Dibayar: Rp ${tabunganPayment.amount.toLocaleString('id-ID')} | Sisa: Rp ${tabunganRemainingAmount.toLocaleString('id-ID')}` :
                                        `Dibayar: Rp ${tabunganPayment.amount.toLocaleString('id-ID')}`
                                    ) : 
                                    `Target: Rp ${tabunganTargetAmount.toLocaleString('id-ID')}`
                                }
                            </div>
                        </div>
                    </div>
                </div>`;
            } else {
                currentMonthCards += `
                <div class="p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                    <div class="text-center">
                        <h5 class="font-semibold text-blue-800 mb-2">Informasi Pembayaran</h5>
                        <p class="text-sm text-blue-600">Pembayaran dapat dilakukan melalui:</p>
                        <p class="text-xs text-blue-500 mt-1">Bank BNI • ATM • Mobile Banking • Teller</p>
                        <div class="mt-2 text-xs text-blue-400">
                            Tarif Tahun Ajaran 2025/2026: Kelas 10 SPP (Rp ${getPaymentAmount('spp', 'class10').toLocaleString('id-ID')}), 
                            Kelas 11 SPP (Rp ${getPaymentAmount('spp', 'class11').toLocaleString('id-ID')}), 
                            Kelas 12 SPP (Rp ${getPaymentAmount('spp', 'class12').toLocaleString('id-ID')})
                            <br>Tabungan hanya untuk Kelas 10: Rp ${getPaymentAmount('tabungan', 'class10').toLocaleString('id-ID')}
                        </div>
                    </div>
                </div>`;
            }
            
            container.innerHTML = currentMonthCards;
        }

        // Function to display complete payment history
        function displayCompletePaymentHistory(student) {
            const container = document.getElementById('completePaymentHistory');
            const currentClass = student.currentClass.includes('XII') ? 'class12' : 
                               student.currentClass.includes('XI') ? 'class11' : 'class10';
            
            let historyHTML = '';
            
            // Create tabs for different payment categories
            historyHTML += `
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button onclick="showPaymentCategory('monthly')" class="payment-tab-btn bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                            Pembayaran Bulanan
                        </button>
                        <button onclick="showPaymentCategory('semester')" class="payment-tab-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">
                            Pembayaran Semester
                        </button>
                        <button onclick="showPaymentCategory('yearly')" class="payment-tab-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">
                            Pembayaran Tahunan
                        </button>
                        <button onclick="showPaymentCategory('onetime')" class="payment-tab-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">
                            Pembayaran Sekali
                        </button>
                    </div>
                </div>
            `;
            
            // Monthly Payments Section
            historyHTML += `
                <div id="monthly-payments" class="payment-category">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            `;
            
            // SPP for all classes
            ['class10', 'class11', 'class12'].forEach((classType, classIndex) => {
                const className = ['Kelas 10', 'Kelas 11', 'Kelas 12'][classIndex];
                const classColor = ['green', 'yellow', 'red'][classIndex];
                
                historyHTML += `
                    <div class="bg-${classColor}-50 border border-${classColor}-200 rounded-lg p-4">
                        <h5 class="font-bold text-${classColor}-800 mb-3 flex items-center">
                            <span class="w-3 h-3 bg-${classColor}-500 rounded-full mr-2"></span>
                            SPP ${className}
                        </h5>
                        <div class="space-y-2">
                `;
                
                if (student.payments.spp && student.payments.spp[classType]) {
                    student.payments.spp[classType].forEach((payment, monthIndex) => {
                        const monthName = months[monthIndex];
                        const targetAmount = getPaymentAmount('spp', classType);
                        const isCurrentClass = classType === currentClass;
                        const isPartialPayment = payment.paid && payment.amount < targetAmount;
                        const remainingAmount = targetAmount - payment.amount;
                        
                        historyHTML += `
                            <div class="flex justify-between items-center p-2 ${payment.paid ? (isPartialPayment ? 'bg-yellow-100 border-2 border-yellow-300' : 'bg-green-100') : 'bg-red-100'} rounded text-sm ${!isCurrentClass ? 'opacity-60' : ''}">
                                <span class="font-medium">${monthName}</span>
                                <div class="text-right">
                                    <div class="${payment.paid ? (isPartialPayment ? 'text-yellow-700' : 'text-green-700') : 'text-red-700'} font-semibold">
                                        ${payment.paid ? (isPartialPayment ? '⚠️ CICILAN' : '✓ LUNAS') : '✗ BELUM'}
                                    </div>
                                    <div class="text-xs text-gray-600">
                                        ${payment.paid ? 
                                            (isPartialPayment ? 
                                                `Rp ${payment.amount.toLocaleString('id-ID')} | Sisa: Rp ${remainingAmount.toLocaleString('id-ID')}` :
                                                `Rp ${payment.amount.toLocaleString('id-ID')}`
                                            ) : 
                                            `Rp ${targetAmount.toLocaleString('id-ID')}`
                                        }
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    historyHTML += `<div class="text-gray-500 text-sm italic">Belum ada data pembayaran</div>`;
                }
                
                historyHTML += `
                        </div>
                    </div>
                `;
            });
            
            historyHTML += `
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h5 class="font-bold text-blue-800 mb-3 flex items-center">
                            <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                            Tabungan Siswa (Khusus Kelas 10)
                        </h5>
                        <div class="space-y-2">
            `;
            
            if (student.payments.tabungan && student.payments.tabungan.class10) {
                student.payments.tabungan.class10.forEach((payment, monthIndex) => {
                    const monthName = months[monthIndex];
                    const targetAmount = getPaymentAmount('tabungan', 'class10');
                    const isCurrentClass = currentClass === 'class10';
                    const isPartialPayment = payment.paid && payment.amount < targetAmount;
                    const remainingAmount = targetAmount - payment.amount;
                    
                    historyHTML += `
                        <div class="flex justify-between items-center p-2 ${payment.paid ? (isPartialPayment ? 'bg-yellow-100 border-2 border-yellow-300' : 'bg-green-100') : 'bg-red-100'} rounded text-sm ${!isCurrentClass ? 'opacity-60' : ''}">
                            <span class="font-medium">${monthName}</span>
                            <div class="text-right">
                                <div class="${payment.paid ? (isPartialPayment ? 'text-yellow-700' : 'text-green-700') : 'text-red-700'} font-semibold">
                                    ${payment.paid ? (isPartialPayment ? '⚠️ CICILAN' : '✓ LUNAS') : '✗ BELUM'}
                                </div>
                                <div class="text-xs text-gray-600">
                                    ${payment.paid ? 
                                        (isPartialPayment ? 
                                            `Rp ${payment.amount.toLocaleString('id-ID')} | Sisa: Rp ${remainingAmount.toLocaleString('id-ID')}` :
                                            `Rp ${payment.amount.toLocaleString('id-ID')}`
                                        ) : 
                                        `Rp ${targetAmount.toLocaleString('id-ID')}`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                historyHTML += `<div class="text-gray-500 text-sm italic">Belum ada data pembayaran</div>`;
            }
            
            if (currentClass !== 'class10') {
                historyHTML += `
                    <div class="mt-3 p-2 bg-gray-100 rounded text-center">
                        <p class="text-xs text-gray-600 italic">Tabungan hanya berlaku untuk siswa Kelas 10</p>
                    </div>
                `;
            }
            
            historyHTML += `
                        </div>
                    </div>
                </div>
            `;
            
            // Semester Payments Section
            historyHTML += `
                <div id="semester-payments" class="payment-category hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            `;
            
            const semesterComponents = ['lks', 'ulangan', 'ujian'];
            const semesterNames = ['Buku LKS', 'UHB (Ulangan)', 'PAS (Ujian)'];
            
            semesterComponents.forEach((componentKey, compIndex) => {
                historyHTML += `
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                        <h5 class="font-bold text-purple-800 mb-3">${semesterNames[compIndex]}</h5>
                        <div class="space-y-3">
                `;
                
                ['class10', 'class11', 'class12'].forEach((classType, classIndex) => {
                    const className = ['Kelas 10', 'Kelas 11', 'Kelas 12'][classIndex];
                    const isCurrentClass = classType === currentClass;
                    
                    historyHTML += `
                        <div class="border-l-4 border-purple-300 pl-3 ${!isCurrentClass ? 'opacity-60' : ''}">
                            <div class="font-medium text-purple-700 text-sm mb-2">${className}</div>
                    `;
                    
                    if (student.payments[componentKey] && student.payments[componentKey][classType]) {
                        student.payments[componentKey][classType].forEach((payment, semIndex) => {
                            const semesterName = semesters[semIndex];
                            const targetAmount = getPaymentAmount(componentKey, classType);
                            const isPartialPayment = payment.paid && payment.amount < targetAmount;
                            const remainingAmount = targetAmount - payment.amount;
                            
                            historyHTML += `
                                <div class="flex justify-between items-center p-2 ${payment.paid ? (isPartialPayment ? 'bg-yellow-100 border-2 border-yellow-300' : 'bg-green-100') : 'bg-red-100'} rounded text-xs mb-1">
                                    <span>${semesterName}</span>
                                    <div class="text-right">
                                        <div class="${payment.paid ? (isPartialPayment ? 'text-yellow-700' : 'text-green-700') : 'text-red-700'} font-semibold">
                                            ${payment.paid ? (isPartialPayment ? '⚠️' : '✓') : '✗'}
                                        </div>
                                        <div class="text-xs text-gray-600">
                                            ${payment.paid ? 
                                                (isPartialPayment ? 
                                                    `Rp ${payment.amount.toLocaleString('id-ID')} | Sisa: Rp ${remainingAmount.toLocaleString('id-ID')}` :
                                                    `Rp ${payment.amount.toLocaleString('id-ID')}`
                                                ) : 
                                                `Rp ${targetAmount.toLocaleString('id-ID')}`
                                            }
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        historyHTML += `<div class="text-gray-500 text-xs italic">Belum ada data</div>`;
                    }
                    
                    historyHTML += `</div>`;
                });
                
                historyHTML += `
                        </div>
                    </div>
                `;
            });
            
            historyHTML += `
                    </div>
                </div>
            `;
            
            // Yearly Payments Section
            historyHTML += `
                <div id="yearly-payments" class="payment-category hidden">
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                        <h5 class="font-bold text-orange-800 mb-3">Infaq Kenaikan Kelas</h5>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            `;
            
            ['class10', 'class11'].forEach((classType, classIndex) => {
                const className = ['Kelas 10', 'Kelas 11'][classIndex];
                const isCurrentClass = classType === currentClass;
                
                historyHTML += `
                    <div class="border border-orange-300 rounded p-3 ${!isCurrentClass ? 'opacity-60' : ''}">
                        <div class="font-medium text-orange-700 mb-2">${className}</div>
                `;
                
                if (student.payments.infaq && student.payments.infaq[classType]) {
                    const payment = student.payments.infaq[classType][0];
                    const targetAmount = getPaymentAmount('infaq', classType);
                    const isPartialPayment = payment.paid && payment.amount < targetAmount;
                    const remainingAmount = targetAmount - payment.amount;
                    
                    historyHTML += `
                        <div class="flex justify-between items-center p-2 ${payment.paid ? (isPartialPayment ? 'bg-yellow-100 border-2 border-yellow-300' : 'bg-green-100') : 'bg-red-100'} rounded text-sm">
                            <span>Tahun Ajaran</span>
                            <div class="text-right">
                                <div class="${payment.paid ? (isPartialPayment ? 'text-yellow-700' : 'text-green-700') : 'text-red-700'} font-semibold">
                                    ${payment.paid ? (isPartialPayment ? '⚠️ CICILAN' : '✓ LUNAS') : '✗ BELUM'}
                                </div>
                                <div class="text-xs text-gray-600">
                                    ${payment.paid ? 
                                        (isPartialPayment ? 
                                            `Dibayar: Rp ${payment.amount.toLocaleString('id-ID')} | Sisa: Rp ${remainingAmount.toLocaleString('id-ID')}` :
                                            `Rp ${payment.amount.toLocaleString('id-ID')}`
                                        ) : 
                                        `Rp ${targetAmount.toLocaleString('id-ID')}`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    historyHTML += `<div class="text-gray-500 text-sm italic">Belum ada data</div>`;
                }
                
                historyHTML += `</div>`;
            });
            
            // Add note for Class 12
            if (currentClass === 'class12') {
                historyHTML += `
                    <div class="border border-gray-300 rounded p-3 bg-gray-50">
                        <div class="font-medium text-gray-500 mb-2">Kelas 12</div>
                        <div class="text-gray-500 text-sm italic text-center">
                            Tidak ada Infaq Kenaikan Kelas untuk Kelas 12
                        </div>
                    </div>
                `;
            }
            
            historyHTML += `
                        </div>
                    </div>
                </div>
            `;
            
            // One-time Payments Section
            historyHTML += `
                <div id="onetime-payments" class="payment-category hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            `;
            
            const onetimeComponents = [
                'siswa_baru_putra', 'siswa_baru_putri', 'ujian_akhir', 'perpisahan', 'study_tour', 'buku_kenangan'
            ];
            
            // Filter components based on student gender (inferred from name or data)
            const studentName = student.name.toLowerCase();
            
            // Strong female indicators
            const femaleIndicators = ['siti', 'aisyah', 'fatimah', 'khadijah', 'dewi', 'putri', 'sarah', 'maya', 'nur', 'umi', 'sri', 'indira', 'ratna', 'wulan', 'sari', 'fitri', 'lestari', 'kartika', 'anggraini', 'permata'];
            
            // Strong male indicators  
            const maleIndicators = ['abdul', 'muhammad', 'ahmad', 'malik', 'umar', 'ali', 'hasan', 'husain', 'yusuf', 'ibrahim', 'ismail', 'musa', 'isa', 'daud', 'sulaiman', 'yahya', 'zakariya', 'ilyas', 'ayyub', 'yunus', 'harun', 'lut', 'nuh', 'adam', 'idris', 'hud', 'salih', 'syu\'aib', 'dzulkifli', 'dzulqarnain'];
            
            // Check for strong female indicators first
            const hasFemaleIndicator = femaleIndicators.some(indicator => studentName.includes(indicator));
            
            // Check for strong male indicators
            const hasMaleIndicator = maleIndicators.some(indicator => studentName.includes(indicator));
            
            // Default to male if no clear indicators, but prioritize explicit indicators
            let isMale = true; // Default assumption
            
            if (hasFemaleIndicator && !hasMaleIndicator) {
                isMale = false;
            } else if (hasMaleIndicator && !hasFemaleIndicator) {
                isMale = true;
            } else if (hasFemaleIndicator && hasMaleIndicator) {
                // If both indicators present, check which comes first or is more prominent
                const firstFemaleIndex = Math.min(...femaleIndicators.filter(ind => studentName.includes(ind)).map(ind => studentName.indexOf(ind)));
                const firstMaleIndex = Math.min(...maleIndicators.filter(ind => studentName.includes(ind)).map(ind => studentName.indexOf(ind)));
                isMale = firstMaleIndex < firstFemaleIndex;
            }
            // If no indicators found, keep default (male)
            
            const relevantComponents = onetimeComponents.filter(componentKey => {
                // Show gender-specific components based on student gender
                if (componentKey.includes('putra') && !isMale) return false;
                if (componentKey.includes('putri') && isMale) return false;
                
                // Show components that have actual payment data
                if (student.payments[componentKey] && student.payments[componentKey][0].paid) return true;
                
                // For unpaid gender-specific components, only show the relevant gender
                if (componentKey.includes('putra') || componentKey.includes('putri')) {
                    return (componentKey.includes('putra') && isMale) || (componentKey.includes('putri') && !isMale);
                }
                
                return true; // Show all other components
            });
            
            relevantComponents.forEach(componentKey => {
                const component = paymentComponents[componentKey];
                if (!component) return;
                
                historyHTML += `
                    <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                        <h5 class="font-bold text-indigo-800 mb-2">${component.name}</h5>
                        <p class="text-xs text-indigo-600 mb-3">${component.description}</p>
                `;
                
                if (student.payments[componentKey]) {
                    const payment = student.payments[componentKey][0];
                    const targetAmount = getPaymentAmount(componentKey);
                    
                    const isPartialPayment = payment.paid && payment.amount < targetAmount;
                    const remainingAmount = targetAmount - payment.amount;
                    
                    historyHTML += `
                        <div class="flex justify-between items-center p-3 ${payment.paid ? (isPartialPayment ? 'bg-yellow-100 border-2 border-yellow-300' : 'bg-green-100') : 'bg-red-100'} rounded">
                            <span class="font-medium">Status</span>
                            <div class="text-right">
                                <div class="${payment.paid ? (isPartialPayment ? 'text-yellow-700' : 'text-green-700') : 'text-red-700'} font-semibold">
                                    ${payment.paid ? (isPartialPayment ? '⚠️ CICILAN' : '✓ LUNAS') : '✗ BELUM BAYAR'}
                                </div>
                                <div class="text-sm text-gray-600">
                                    ${payment.paid ? 
                                        (isPartialPayment ? 
                                            `Dibayar: Rp ${payment.amount.toLocaleString('id-ID')} | Sisa: Rp ${remainingAmount.toLocaleString('id-ID')}` :
                                            `Rp ${payment.amount.toLocaleString('id-ID')}`
                                        ) : 
                                        `Rp ${targetAmount.toLocaleString('id-ID')}`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    historyHTML += `<div class="text-gray-500 text-sm italic">Belum ada data pembayaran</div>`;
                }
                
                historyHTML += `</div>`;
            });
            
            historyHTML += `
                    </div>
                </div>
            `;
            
            container.innerHTML = historyHTML;
        }

        // Function to show payment category
        function showPaymentCategory(category) {
            // Hide all categories
            document.querySelectorAll('.payment-category').forEach(el => {
                el.classList.add('hidden');
            });
            
            // Show selected category
            document.getElementById(`${category}-payments`).classList.remove('hidden');
            
            // Update tab buttons
            document.querySelectorAll('.payment-tab-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            event.target.classList.remove('bg-gray-200', 'text-gray-700');
            event.target.classList.add('bg-blue-600', 'text-white');
        }

        // Function to display pricing changes notification
        function displayPricingChanges() {
            const container = document.getElementById('pricingChangesList');
            const pricingChangesDiv = document.getElementById('pricingChanges');
            
            let hasChanges = false;
            let changesHTML = '';
            
            Object.keys(pricingHistory).forEach(componentKey => {
                const changes = pricingHistory[componentKey];
                if (changes.length > 0) {
                    hasChanges = true;
                    const latestChange = changes[changes.length - 1];
                    
                    // Parse component key for display
                    const keyParts = componentKey.split('_');
                    const baseComponent = keyParts[0];
                    const classType = keyParts[1] || '';
                    const component = paymentComponents[baseComponent];
                    
                    const displayName = classType ? 
                        `${component.name} (${classType.replace('class', 'Kelas ')})` : 
                        component.name;
                    
                    changesHTML += `
                        <div class="flex items-center justify-between p-3 ${latestChange.changeType === 'naik' ? 'bg-red-50 border border-red-200' : 'bg-green-50 border border-green-200'} rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="text-2xl">
                                    ${latestChange.changeType === 'naik' ? '📈' : '📉'}
                                </div>
                                <div>
                                    <h6 class="font-semibold ${latestChange.changeType === 'naik' ? 'text-red-800' : 'text-green-800'}">${displayName}</h6>
                                    <p class="text-sm text-gray-600">${component.description}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm ${latestChange.changeType === 'naik' ? 'text-red-600' : 'text-green-600'} font-semibold">
                                    ${latestChange.changeType === 'naik' ? 'NAIK' : 'TURUN'}
                                </div>
                                <div class="text-xs text-gray-500">
                                    Rp ${latestChange.oldAmount.toLocaleString('id-ID')} → Rp ${latestChange.newAmount.toLocaleString('id-ID')}
                                </div>
                                <div class="text-xs text-gray-400">${latestChange.changeDate}</div>
                            </div>
                        </div>
                    `;
                }
            });
            
            if (hasChanges) {
                container.innerHTML = changesHTML;
                pricingChangesDiv.classList.remove('hidden');
            } else {
                pricingChangesDiv.classList.add('hidden');
            }
        }

        // Function to display current pricing (Enhanced for class-specific pricing)
        function displayCurrentPricing() {
            const container = document.getElementById('currentPricing');
            let pricingHTML = '';
            
            // Display class-specific pricing
            const classes = ['class10', 'class11', 'class12'];
            const classNames = ['Kelas 10', 'Kelas 11', 'Kelas 12'];
            const classColors = ['green', 'yellow', 'red'];
            
            Object.keys(paymentComponents).forEach(componentKey => {
                const component = paymentComponents[componentKey];
                
                if (component.type === 'monthly' || component.type === 'semester' || component.type === 'yearly') {
                    // For infaq, only show class10 and class11
                    const applicableClasses = componentKey === 'infaq' ? 
                        [0, 1] : // Only class10 and class11 indices
                        [0, 1, 2]; // All classes
                    
                    applicableClasses.forEach((classIndex) => {
                        const classType = classes[classIndex];
                        const currentAmount = getPaymentAmount(componentKey, classType);
                        const defaultAmount = component.defaultAmount;
                        const hasChanged = currentAmount !== defaultAmount;
                        
                        pricingHTML += `
                            <div class="p-2 ${hasChanged ? 'bg-yellow-50 border border-yellow-200' : 'bg-gray-50 border border-gray-200'} rounded">
                                <div class="font-medium text-gray-700 text-xs">${component.name}</div>
                                <div class="text-xs text-${classColors[classIndex]}-600 font-medium">${classNames[classIndex]}</div>
                                <div class="text-sm font-semibold ${hasChanged ? 'text-yellow-700' : 'text-gray-600'}">
                                    Rp ${currentAmount.toLocaleString('id-ID')}
                                </div>
                                ${hasChanged ? `
                                    <div class="text-xs text-yellow-600">
                                        ${currentAmount > defaultAmount ? '↗️' : '↘️'} 
                                        ${currentAmount > defaultAmount ? 'Naik' : 'Turun'}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                } else {
                    // One-time payments
                    const currentAmount = getPaymentAmount(componentKey);
                    const defaultAmount = component.defaultAmount;
                    const hasChanged = currentAmount !== defaultAmount;
                    
                    pricingHTML += `
                        <div class="p-2 ${hasChanged ? 'bg-yellow-50 border border-yellow-200' : 'bg-gray-50 border border-gray-200'} rounded">
                            <div class="font-medium text-gray-700 text-xs">${component.name}</div>
                            <div class="text-sm font-semibold ${hasChanged ? 'text-yellow-700' : 'text-gray-600'}">
                                Rp ${currentAmount.toLocaleString('id-ID')}
                            </div>
                            ${hasChanged ? `
                                <div class="text-xs text-yellow-600">
                                    ${currentAmount > defaultAmount ? '↗️' : '↘️'} 
                                    ${currentAmount > defaultAmount ? 'Naik' : 'Turun'}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            });
            
            container.innerHTML = pricingHTML;
        }

        function displaySummary(payments) {
            let totalPaid = 0;
            let totalUnpaid = 0;
            let totalOutstanding = 0; // Total amount still owed (including partial payments)
            
            Object.keys(paymentComponents).forEach(componentKey => {
                const component = paymentComponents[componentKey];
                
                if (component.type === 'monthly' || component.type === 'monthly_class10') {
                    ['class10', 'class11', 'class12'].forEach(classType => {
                        if (payments[componentKey] && payments[componentKey][classType]) {
                            payments[componentKey][classType].forEach(payment => {
                                if (component.type === 'monthly_class10' && classType !== 'class10') return;
                                
                                const targetAmount = getPaymentAmount(componentKey, classType);
                                if (payment.paid) {
                                    totalPaid++;
                                    // Add remaining amount if it's a partial payment
                                    if (payment.amount < targetAmount) {
                                        totalOutstanding += (targetAmount - payment.amount);
                                    }
                                } else {
                                    totalUnpaid++;
                                    totalOutstanding += targetAmount;
                                }
                            });
                        }
                    });
                } else if (component.type === 'semester') {
                    ['class10', 'class11', 'class12'].forEach(classType => {
                        if (payments[componentKey] && payments[componentKey][classType]) {
                            payments[componentKey][classType].forEach(payment => {
                                const targetAmount = getPaymentAmount(componentKey, classType);
                                if (payment.paid) {
                                    totalPaid++;
                                    if (payment.amount < targetAmount) {
                                        totalOutstanding += (targetAmount - payment.amount);
                                    }
                                } else {
                                    totalUnpaid++;
                                    totalOutstanding += targetAmount;
                                }
                            });
                        }
                    });
                } else if (component.type === 'yearly') {
                    // Only process infaq for class10 and class11 (no infaq for class12)
                    const applicableClasses = componentKey === 'infaq' ? ['class10', 'class11'] : ['class10', 'class11', 'class12'];
                    applicableClasses.forEach(classType => {
                        if (payments[componentKey] && payments[componentKey][classType]) {
                            const payment = payments[componentKey][classType][0];
                            const targetAmount = getPaymentAmount(componentKey, classType);
                            if (payment.paid) {
                                totalPaid++;
                                if (payment.amount < targetAmount) {
                                    totalOutstanding += (targetAmount - payment.amount);
                                }
                            } else {
                                totalUnpaid++;
                                totalOutstanding += targetAmount;
                            }
                        }
                    });
                } else if (component.type === 'onetime') {
                    if (payments[componentKey]) {
                        const payment = payments[componentKey][0];
                        const targetAmount = getPaymentAmount(componentKey);
                        if (payment.paid) {
                            totalPaid++;
                            if (payment.amount < targetAmount) {
                                totalOutstanding += (targetAmount - payment.amount);
                            }
                        } else {
                            totalUnpaid++;
                            totalOutstanding += targetAmount;
                        }
                    }
                }
            });
            
            document.getElementById('totalPaid').textContent = totalPaid;
            document.getElementById('totalUnpaid').textContent = totalUnpaid;
            document.getElementById('totalAmount').textContent = `Rp ${totalOutstanding.toLocaleString('id-ID')}`;
        }

        function hideStudentInfo() {
            document.getElementById('studentInfo').classList.add('hidden');
            document.getElementById('paymentStatus').classList.add('hidden');
        }

        async function refreshData() {
            isDataLoaded = false;
            studentsData = {};
            paymentAmounts = {};
            pricingHistory = {};
            await fetchStudentData();
            
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
            successDiv.innerHTML = `
                <span class="block sm:inline">Data berhasil diperbarui dari Google Sheets!</span>
                <button onclick="this.parentElement.remove()" class="float-right ml-4 text-green-500 hover:text-green-700">×</button>
            `;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                if (successDiv.parentElement) {
                    successDiv.remove();
                }
            }, 3000);
        }

        // Transaction Management Functions
        function showTransactionInput() {
            if (!currentStudentNISN) return;
            
            const student = studentsData[currentStudentNISN];
            document.getElementById('transactionStudentName').textContent = student.name;
            document.getElementById('transactionInput').classList.remove('hidden');
            
            // Set default date to today
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            
            // Reset form
            resetTransactionForm();
            
            // Scroll to transaction input
            document.getElementById('transactionInput').scrollIntoView({ behavior: 'smooth' });
        }

        function resetTransactionForm() {
            document.getElementById('paymentType').value = '';
            document.getElementById('paymentAmount').value = '';
            document.getElementById('transactionNotes').value = '';
            document.getElementById('periodSelection').classList.add('hidden');
            document.getElementById('classSelection').classList.add('hidden');
            document.getElementById('targetAmountInfo').textContent = '';
        }

        function cancelTransaction() {
            document.getElementById('transactionInput').classList.add('hidden');
            resetTransactionForm();
        }

        function updatePaymentOptions() {
            const paymentType = document.getElementById('paymentType').value;
            const periodSelection = document.getElementById('periodSelection');
            const classSelection = document.getElementById('classSelection');
            const paymentPeriod = document.getElementById('paymentPeriod');
            const paymentClass = document.getElementById('paymentClass');
            const targetAmountInfo = document.getElementById('targetAmountInfo');
            
            // Reset visibility
            periodSelection.classList.add('hidden');
            classSelection.classList.add('hidden');
            
            if (!paymentType) {
                targetAmountInfo.textContent = '';
                return;
            }
            
            const component = paymentComponents[paymentType];
            if (!component) return;
            
            // Show class selection for class-specific payments
            if (component.type === 'monthly' || component.type === 'semester' || component.type === 'yearly') {
                classSelection.classList.remove('hidden');
                
                // Set default class based on current student
                const student = studentsData[currentStudentNISN];
                const currentClass = student.currentClass.includes('XII') ? 'class12' : 
                                   student.currentClass.includes('XI') ? 'class11' : 'class10';
                paymentClass.value = currentClass;
            }
            
            // Show period selection for monthly and semester payments
            if (component.type === 'monthly' || component.type === 'monthly_class10') {
                periodSelection.classList.remove('hidden');
                paymentPeriod.innerHTML = '';
                
                months.forEach((month, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = month;
                    paymentPeriod.appendChild(option);
                });
                
                // Set current month as default
                paymentPeriod.value = getCurrentAcademicMonth();
                
            } else if (component.type === 'semester') {
                periodSelection.classList.remove('hidden');
                paymentPeriod.innerHTML = '';
                
                semesters.forEach((semester, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = semester;
                    paymentPeriod.appendChild(option);
                });
            }
            
            updateTargetAmount();
        }

        function updateTargetAmount() {
            const paymentType = document.getElementById('paymentType').value;
            const paymentClass = document.getElementById('paymentClass').value;
            const targetAmountInfo = document.getElementById('targetAmountInfo');
            
            if (!paymentType) return;
            
            const targetAmount = getPaymentAmount(paymentType, paymentClass);
            targetAmountInfo.textContent = `Target pembayaran: Rp ${targetAmount.toLocaleString('id-ID')}`;
        }

        function formatCurrency(input) {
            // Remove non-numeric characters except dots
            let value = input.value.replace(/[^\d]/g, '');
            
            // Format with thousand separators
            if (value) {
                value = parseInt(value).toLocaleString('id-ID');
            }
            
            input.value = value;
        }

        function processTransaction() {
            const paymentType = document.getElementById('paymentType').value;
            const paymentPeriod = document.getElementById('paymentPeriod').value;
            const paymentClass = document.getElementById('paymentClass').value;
            const paymentAmount = document.getElementById('paymentAmount').value.replace(/[^\d]/g, '');
            const transactionDate = document.getElementById('transactionDate').value;
            const transactionNotes = document.getElementById('transactionNotes').value;
            
            // Validation
            if (!paymentType) {
                alert('Pilih jenis pembayaran');
                return;
            }
            
            if (!paymentAmount || parseInt(paymentAmount) <= 0) {
                alert('Masukkan jumlah pembayaran yang valid');
                return;
            }
            
            if (!transactionDate) {
                alert('Pilih tanggal transaksi');
                return;
            }
            
            const component = paymentComponents[paymentType];
            const amount = parseInt(paymentAmount);
            
            // Process the payment
            const student = studentsData[currentStudentNISN];
            let success = false;
            let paymentDetails = {};
            
            try {
                if (component.type === 'monthly' || component.type === 'monthly_class10') {
                    if (paymentPeriod === '') {
                        alert('Pilih periode pembayaran');
                        return;
                    }
                    
                    const periodIndex = parseInt(paymentPeriod);
                    const classType = paymentClass || 'class10';
                    
                    if (student.payments[paymentType] && student.payments[paymentType][classType]) {
                        const currentPayment = student.payments[paymentType][classType][periodIndex];
                        const targetAmount = getPaymentAmount(paymentType, classType);
                        
                        // Update payment
                        student.payments[paymentType][classType][periodIndex] = {
                            paid: true,
                            amount: currentPayment.amount + amount
                        };
                        
                        paymentDetails = {
                            type: paymentType,
                            period: months[periodIndex],
                            class: classType,
                            amount: amount,
                            targetAmount: targetAmount,
                            totalPaid: student.payments[paymentType][classType][periodIndex].amount
                        };
                        
                        success = true;
                    }
                    
                } else if (component.type === 'semester') {
                    if (paymentPeriod === '') {
                        alert('Pilih semester');
                        return;
                    }
                    
                    const periodIndex = parseInt(paymentPeriod);
                    const classType = paymentClass || 'class10';
                    
                    if (student.payments[paymentType] && student.payments[paymentType][classType]) {
                        const currentPayment = student.payments[paymentType][classType][periodIndex];
                        const targetAmount = getPaymentAmount(paymentType, classType);
                        
                        student.payments[paymentType][classType][periodIndex] = {
                            paid: true,
                            amount: currentPayment.amount + amount
                        };
                        
                        paymentDetails = {
                            type: paymentType,
                            period: semesters[periodIndex],
                            class: classType,
                            amount: amount,
                            targetAmount: targetAmount,
                            totalPaid: student.payments[paymentType][classType][periodIndex].amount
                        };
                        
                        success = true;
                    }
                    
                } else if (component.type === 'yearly') {
                    const classType = paymentClass || 'class10';
                    
                    if (student.payments[paymentType] && student.payments[paymentType][classType]) {
                        const currentPayment = student.payments[paymentType][classType][0];
                        const targetAmount = getPaymentAmount(paymentType, classType);
                        
                        student.payments[paymentType][classType][0] = {
                            paid: true,
                            amount: currentPayment.amount + amount
                        };
                        
                        paymentDetails = {
                            type: paymentType,
                            period: 'Tahunan',
                            class: classType,
                            amount: amount,
                            targetAmount: targetAmount,
                            totalPaid: student.payments[paymentType][classType][0].amount
                        };
                        
                        success = true;
                    }
                    
                } else if (component.type === 'onetime') {
                    if (student.payments[paymentType]) {
                        const currentPayment = student.payments[paymentType][0];
                        const targetAmount = getPaymentAmount(paymentType);
                        
                        student.payments[paymentType][0] = {
                            paid: true,
                            amount: currentPayment.amount + amount
                        };
                        
                        paymentDetails = {
                            type: paymentType,
                            period: 'Sekali',
                            class: null,
                            amount: amount,
                            targetAmount: targetAmount,
                            totalPaid: student.payments[paymentType][0].amount
                        };
                        
                        success = true;
                    }
                }
                
                if (success) {
                    // Add to transaction history
                    const transaction = {
                        id: Date.now(),
                        date: transactionDate,
                        timestamp: new Date().toISOString(),
                        type: paymentType,
                        typeName: component.name,
                        period: paymentDetails.period,
                        class: paymentDetails.class,
                        amount: amount,
                        targetAmount: paymentDetails.targetAmount,
                        totalPaid: paymentDetails.totalPaid,
                        notes: transactionNotes,
                        status: paymentDetails.totalPaid >= paymentDetails.targetAmount ? 'LUNAS' : 'CICILAN'
                    };
                    
                    transactionHistory[currentStudentNISN].unshift(transaction);
                    
                    // Show success message
                    showSuccessMessage(`Pembayaran ${component.name} berhasil diproses!`);
                    
                    // Reset form and hide input
                    cancelTransaction();
                    
                    // Refresh display
                    displayPaymentStatus(student);
                    
                } else {
                    throw new Error('Gagal memproses pembayaran');
                }
                
            } catch (error) {
                console.error('Transaction error:', error);
                alert('Terjadi kesalahan saat memproses pembayaran: ' + error.message);
            }
        }

        function showTransactionHistory() {
            if (!currentStudentNISN) return;
            
            const student = studentsData[currentStudentNISN];
            document.getElementById('historyStudentName').textContent = student.name;
            document.getElementById('transactionHistory').classList.remove('hidden');
            
            // Reset filters
            document.getElementById('historyFilter').value = 'all';
            document.getElementById('historyTypeFilter').value = 'all';
            
            // Load transaction history
            loadTransactionHistory();
            
            // Scroll to history section
            document.getElementById('transactionHistory').scrollIntoView({ behavior: 'smooth' });
        }

        function hideTransactionHistory() {
            document.getElementById('transactionHistory').classList.add('hidden');
        }

        function loadTransactionHistory() {
            const transactions = transactionHistory[currentStudentNISN] || [];
            displayTransactionList(transactions);
        }

        function filterTransactionHistory() {
            const periodFilter = document.getElementById('historyFilter').value;
            const typeFilter = document.getElementById('historyTypeFilter').value;
            const transactions = transactionHistory[currentStudentNISN] || [];
            
            let filteredTransactions = [...transactions];
            
            // Filter by period
            if (periodFilter !== 'all') {
                const now = new Date();
                const filterDate = new Date();
                
                switch (periodFilter) {
                    case 'today':
                        filterDate.setHours(0, 0, 0, 0);
                        break;
                    case 'week':
                        filterDate.setDate(now.getDate() - 7);
                        break;
                    case 'month':
                        filterDate.setDate(now.getDate() - 30);
                        break;
                    case 'year':
                        filterDate.setFullYear(now.getFullYear(), 0, 1);
                        break;
                }
                
                filteredTransactions = filteredTransactions.filter(transaction => {
                    const transactionDate = new Date(transaction.date);
                    return transactionDate >= filterDate;
                });
            }
            
            // Filter by type
            if (typeFilter !== 'all') {
                if (typeFilter === 'onetime') {
                    const onetimeTypes = ['siswa_baru_putra', 'siswa_baru_putri', 'ujian_akhir', 'perpisahan', 'study_tour', 'buku_kenangan'];
                    filteredTransactions = filteredTransactions.filter(transaction => 
                        onetimeTypes.includes(transaction.type)
                    );
                } else {
                    filteredTransactions = filteredTransactions.filter(transaction => 
                        transaction.type === typeFilter
                    );
                }
            }
            
            displayTransactionList(filteredTransactions);
        }

        function displayTransactionList(transactions) {
            const container = document.getElementById('transactionList');
            const emptyState = document.getElementById('emptyTransactionHistory');
            
            if (transactions.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            let transactionHTML = '';
            
            transactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date);
                const formattedDate = transactionDate.toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const timestamp = new Date(transaction.timestamp);
                const formattedTime = timestamp.toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const statusColor = transaction.status === 'LUNAS' ? 'green' : 'yellow';
                const progressPercentage = Math.min((transaction.totalPaid / transaction.targetAmount) * 100, 100);
                
                transactionHTML += `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="bg-${statusColor}-100 p-2 rounded-full">
                                    <svg class="w-5 h-5 text-${statusColor}-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800">${transaction.typeName}</h4>
                                    <p class="text-sm text-gray-600">
                                        ${transaction.period}${transaction.class ? ` - ${transaction.class.replace('class', 'Kelas ')}` : ''}
                                    </p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold text-${statusColor}-600">
                                    Rp ${transaction.amount.toLocaleString('id-ID')}
                                </div>
                                <div class="text-xs text-gray-500">${formattedTime}</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                <span>Progress Pembayaran</span>
                                <span>${transaction.status} (${progressPercentage.toFixed(0)}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-${statusColor}-500 h-2 rounded-full transition-all duration-300" style="width: ${progressPercentage}%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>Rp ${transaction.totalPaid.toLocaleString('id-ID')}</span>
                                <span>Rp ${transaction.targetAmount.toLocaleString('id-ID')}</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between text-sm">
                            <div class="text-gray-600">
                                <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                                </svg>
                                ${formattedDate}
                            </div>
                            ${transaction.notes ? `
                                <div class="text-gray-500 italic text-xs max-w-xs truncate" title="${transaction.notes}">
                                    "${transaction.notes}"
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = transactionHTML;
        }

        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50 max-w-sm';
            successDiv.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                    <span class="block sm:inline">${message}</span>
                </div>
                <button onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-green-500 hover:text-green-700">×</button>
            `;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                if (successDiv.parentElement) {
                    successDiv.remove();
                }
            }, 5000);
        }

        window.addEventListener('load', function() {
            // Set current academic year in header
            document.getElementById('academicYear').textContent = getCurrentAcademicYear();
            fetchStudentData();
            
            // Add event listeners for dynamic updates
            document.getElementById('paymentClass').addEventListener('change', updateTargetAmount);
        });

        document.getElementById('nisnInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStudent();
            }
        });

        document.getElementById('nisnInput').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });
    </script>
</body>
</html>
