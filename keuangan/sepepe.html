<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrasi Madrasah - MA NU Hasyim Asy'ari 1 Kudus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
        }
        .gradient-bg { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            position: relative;
            overflow: hidden;
        }
        .gradient-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
        }
        .card-shadow { 
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }
        .search-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .student-info-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.98), rgba(248,250,252,0.95));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .info-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.95), rgba(241,245,249,0.9));
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .summary-card-1 {
            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
            position: relative;
            overflow: hidden;
        }
        .summary-card-1::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        .summary-card-2 {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%);
            position: relative;
            overflow: hidden;
        }
        .summary-card-2::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        .summary-card-3 {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%);
            position: relative;
            overflow: hidden;
        }
        .summary-card-3::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        .payment-section {
            background: linear-gradient(145deg, rgba(249,250,251,0.9), rgba(243,244,246,0.8));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .monthly-section {
            background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(147,197,253,0.1));
            border: 1px solid rgba(59,130,246,0.2);
        }
        .semester-section {
            background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(110,231,183,0.1));
            border: 1px solid rgba(16,185,129,0.2);
        }
        .yearly-section {
            background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(196,181,253,0.1));
            border: 1px solid rgba(139,92,246,0.2);
        }
        .onetime-section {
            background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(251,191,36,0.1));
            border: 1px solid rgba(245,158,11,0.2);
        }
        .payment-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.95), rgba(248,250,252,0.9));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.4);
            transition: all 0.3s ease;
        }
        .payment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .status-paid { background: linear-gradient(135deg, #10b981, #059669); }
        .status-unpaid { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .status-partial { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .status-overpaid { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .tab-active {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
            box-shadow: 0 4px 15px rgba(59,130,246,0.3);
        }
        .tab-inactive {
            background: linear-gradient(145deg, rgba(255,255,255,0.8), rgba(243,244,246,0.6));
            backdrop-filter: blur(10px);
        }
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        .search-button {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%);
            box-shadow: 0 8px 25px rgba(59,130,246,0.3);
            transition: all 0.3s ease;
        }
        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(59,130,246,0.4);
        }
        .connection-status {
            background: linear-gradient(145deg, rgba(255,255,255,0.9), rgba(248,250,252,0.8));
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 8px 16px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .floating { animation: float 3s ease-in-out infinite; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-4 md:py-6 shadow-lg">
        <div class="container mx-auto px-4">
            <!-- Mobile Layout -->
            <div class="md:hidden">
                <div class="text-center mb-1">
                    <h1 class="text-2xl font-bold leading-tight">MA NU HASYIM ASY'ARI 1 KUDUS</h1>
                </div>
                <div class="text-center">
                    <p class="text-xs text-blue-100 mb-1">Jl. Mayor H. Basuno No. 17 Sunggingan Kota Kudus 59317</p>
                    <p class="text-xs text-blue-100 mb-1" id="currentAcademicYearMobile">Tahun Ajaran 2024/2025</p>
                    <p class="text-xs text-blue-200">Periode 3 Tahun (Kelas 10-12)</p>
                </div>
            </div>
            
            <!-- Desktop Layout -->
            <div class="hidden md:flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold mb-1">MA NU HASYIM ASY'ARI 1 KUDUS</h1>
                    <p class="text-blue-100">Jl. Mayor H. Basuno No. 17 Sunggingan Kota Kudus 59317</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-blue-100" id="currentAcademicYear">Tahun Ajaran 2024/2025</p>
                    <p class="text-xs text-blue-200">Periode 3 Tahun (Kelas 10-12)</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Watermark Logo -->
    <div class="fixed inset-0 flex items-center justify-center pointer-events-none z-0">
        <div class="opacity-5 transform rotate-12">
            <img src="https://lh3.googleusercontent.com/d/1yTmDUC2K2-cSm_EWq1hQt_rtJ1xa4Odc" 
                 alt="Watermark Logo" 
                 class="w-96 h-96 object-contain"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div class="w-96 h-96 flex items-center justify-center text-gray-300 text-9xl font-bold hidden">üè´</div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 relative z-10">
        <!-- Search Section -->
        <div class="search-card rounded-xl card-shadow p-8 mb-8 floating">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Administrasi Madrasah</h2>
                <p class="text-gray-600">Masukkan NISN untuk melihat informasi</p>
            </div>
            
            <div class="max-w-md mx-auto">
                <div class="relative">
                    <input 
                        type="text" 
                        id="nisnInput" 
                        placeholder="Masukkan NISN (10 digit)"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-center text-lg font-medium"
                        maxlength="10"
                    >
                    <button 
                        onclick="searchStudent()" 
                        id="searchButton"
                        class="w-full mt-4 search-button text-white py-3 px-6 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 flex items-center justify-center"
                    >
                        <span id="searchText">üîç Cari Data Siswa</span>
                        <div id="loadingSpinner" class="loading-spinner ml-2 hidden"></div>
                    </button>
                </div>
            </div>

            <!-- Connection Status -->
            <div id="connectionStatus" class="mt-4 text-center text-sm">
                <span class="connection-status text-blue-600">üîÑ Memuat sistem...</span>
            </div>
        </div>

        <!-- Student Info Section -->
        <div id="studentInfo" class="hidden student-info-card rounded-xl card-shadow p-4 md:p-8 mb-8">
            <!-- Mobile Layout -->
            <div class="md:hidden mb-6 pb-6 border-b">
                <div class="flex items-center space-x-4 mb-4">
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-xl font-bold flex-shrink-0">
                        <span id="studentInitialMobile">A</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="text-lg font-bold text-gray-800 break-words leading-tight" id="studentNameMobile">Nama Siswa</h3>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-2 text-sm text-gray-600">
                    <div class="flex justify-between">
                        <span class="font-medium">NISN:</span> 
                        <span id="displayNisnMobile" class="font-mono">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-medium">Kelas:</span> 
                        <span id="studentClassMobile">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-medium">Jurusan:</span> 
                        <span id="studentMajorMobile">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-medium">Jenis Kelamin:</span> 
                        <span id="studentGenderMobile">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-medium">Tahun Masuk:</span> 
                        <span id="entryYearMobile">-</span>
                    </div>
                </div>
            </div>
            
            <!-- Desktop Layout -->
            <div class="hidden md:flex items-center space-x-6 mb-6 pb-6 border-b">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                    <span id="studentInitial">A</span>
                </div>
                <div class="flex-1 text-right">
                    <h3 class="text-2xl font-bold text-gray-800 break-words" id="studentName">Nama Siswa</h3>
                    <div class="grid grid-cols-2 gap-4 mt-2 text-sm text-gray-600 text-right">
                        <p><span class="font-medium">NISN:</span> <span id="displayNisn" class="font-mono">-</span></p>
                        <p><span class="font-medium">Kelas:</span> <span id="studentClass">-</span></p>
                        <p><span class="font-medium">Jurusan:</span> <span id="studentMajor">-</span></p>
                        <p><span class="font-medium">Jenis Kelamin:</span> <span id="studentGender">-</span></p>
                        <p><span class="font-medium">Tahun Masuk:</span> <span id="entryYear">-</span></p>
                    </div>
                </div>
            </div>
            
            <!-- Current Month Status -->
            <div class="mb-6 pb-6 border-b hidden" id="currentMonthSection">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200">
                    <div class="text-center">
                        <div class="text-sm text-gray-600 mb-3 font-medium">üìÖ Status Pembayaran Bulan Ini</div>
                        <div id="currentMonthStatus" class="inline-block px-6 py-3 rounded-full text-white font-semibold text-sm shadow-lg">
                            Belum Dicek
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Summary -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-8 hidden" id="paymentSummarySection">
                <div class="summary-card-1 text-white p-4 md:p-6 rounded-xl relative z-10">
                    <div class="flex items-center justify-between relative z-10">
                        <div class="flex-1 min-w-0">
                            <p class="text-green-100 text-xs md:text-sm mb-1">Total Terbayar</p>
                            <p class="text-lg md:text-2xl font-bold truncate" id="totalPaid">Rp 0</p>
                        </div>
                        <div class="text-2xl md:text-3xl ml-2 flex-shrink-0">‚úÖ</div>
                    </div>
                </div>
                <div class="summary-card-2 text-white p-4 md:p-6 rounded-xl relative z-10">
                    <div class="flex items-center justify-between relative z-10">
                        <div class="flex-1 min-w-0">
                            <p class="text-red-100 text-xs md:text-sm mb-1">Total Tunggakan</p>
                            <p class="text-lg md:text-2xl font-bold truncate" id="totalUnpaid">Rp 0</p>
                        </div>
                        <div class="text-2xl md:text-3xl ml-2 flex-shrink-0">‚è∞</div>
                    </div>
                </div>
                <div class="summary-card-3 text-white p-4 md:p-6 rounded-xl relative z-10">
                    <div class="flex items-center justify-between relative z-10">
                        <div class="flex-1 min-w-0">
                            <p class="text-blue-100 text-xs md:text-sm mb-1">Total Keseluruhan</p>
                            <p class="text-lg md:text-2xl font-bold truncate" id="totalOverall">Rp 0</p>
                        </div>
                        <div class="text-2xl md:text-3xl ml-2 flex-shrink-0">üí∞</div>
                    </div>
                </div>
            </div>

            <!-- Component Breakdown -->
            <div class="mb-8 hidden" id="componentBreakdownSection">
                <!-- Mobile Layout (2x2 grid) -->
                <div class="grid grid-cols-2 gap-3 md:hidden">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-3 border border-blue-200">
                        <div class="text-center">
                            <div class="text-xl mb-1">üìö</div>
                            <div class="text-xs text-blue-600 mb-1 leading-tight">Total Biaya Bulanan (3 tahun)</div>
                            <div class="text-sm font-bold text-blue-800 break-words" id="totalSppMobile">Rp 0</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-3 border border-green-200">
                        <div class="text-center">
                            <div class="text-xl mb-1">üìñ</div>
                            <div class="text-xs text-green-600 mb-1 leading-tight">Total Biaya Semester (3 tahun)</div>
                            <div class="text-sm font-bold text-green-800 break-words" id="totalSemesterMobile">Rp 0</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-3 border border-purple-200">
                        <div class="text-center">
                            <div class="text-xl mb-1">üéì</div>
                            <div class="text-xs text-purple-600 mb-1 leading-tight">Total Sekali Bayar (3 tahun)</div>
                            <div class="text-sm font-bold text-purple-800 break-words" id="totalOneTimeMobile">Rp 0</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-3 border border-orange-200">
                        <div class="text-center">
                            <div class="text-xl mb-1">üóìÔ∏è</div>
                            <div class="text-xs text-orange-600 mb-1 leading-tight">Total Biaya Tahunan (3 tahun)</div>
                            <div class="text-sm font-bold text-orange-800 break-words" id="totalOthersMobile">Rp 0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Desktop Layout (1x4 grid) -->
                <div class="hidden md:grid grid-cols-4 gap-4">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                        <div class="text-center">
                            <div class="text-2xl mb-2">üìö</div>
                            <div class="text-xs text-blue-600 mb-1">Total Biaya Bulanan (3 tahun)</div>
                            <div class="text-lg font-bold text-blue-800" id="totalSpp">Rp 0</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                        <div class="text-center">
                            <div class="text-2xl mb-2">üìñ</div>
                            <div class="text-xs text-green-600 mb-1">Total Biaya Semester (3 tahun)</div>
                            <div class="text-lg font-bold text-green-800" id="totalSemester">Rp 0</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border border-purple-200">
                        <div class="text-center">
                            <div class="text-2xl mb-2">üéì</div>
                            <div class="text-xs text-purple-600 mb-1">Total Sekali Bayar (3 tahun)</div>
                            <div class="text-lg font-bold text-purple-800" id="totalOneTime">Rp 0</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4 border border-orange-200">
                        <div class="text-center">
                            <div class="text-2xl mb-2">üóìÔ∏è</div>
                            <div class="text-xs text-orange-600 mb-1">Total Biaya Tahunan (3 tahun)</div>
                            <div class="text-lg font-bold text-orange-800" id="totalOthers">Rp 0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Year Tabs -->
            <div class="flex flex-col sm:flex-row space-y-1 sm:space-y-0 sm:space-x-1 mb-6 payment-section p-1 rounded-lg hidden" id="yearTabs">
                <button onclick="showYear(10)" id="tab10" class="flex-1 py-3 px-4 rounded-md font-semibold transition-all duration-300 tab-active text-white text-sm sm:text-base">
                    Kelas 10 (2024/2025)
                </button>
                <button onclick="showYear(11)" id="tab11" class="flex-1 py-3 px-4 rounded-md font-semibold transition-all duration-300 tab-inactive text-gray-600 hover:bg-gray-200 text-sm sm:text-base">
                    Kelas 11 (2025/2026)
                </button>
                <button onclick="showYear(12)" id="tab12" class="flex-1 py-3 px-4 rounded-md font-semibold transition-all duration-300 tab-inactive text-gray-600 hover:bg-gray-200 text-sm sm:text-base">
                    Kelas 12 (2026/2027)
                </button>
            </div>

            <!-- Payment Details -->
            <div id="paymentDetails">
                <!-- Payment details will be populated by JavaScript -->
            </div>
        </div>

        <!-- Info Section -->
        <div id="infoSection" class="info-card rounded-xl card-shadow p-8 hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚ÑπÔ∏è Informasi Pembayaran</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-semibold text-gray-700 mb-3">Struktur Biaya per Kelas:</h4>
                    
                    <div class="space-y-3 mb-4">
                        <div class="bg-blue-50 rounded-lg p-3">
                            <h5 class="font-semibold text-blue-800 mb-2">üí∞ Biaya Bulanan</h5>
                            <div class="text-sm text-blue-700 space-y-1">
                                <p>‚Ä¢ SPP Kelas 10: Rp 125.000/bulan</p>
                                <p>‚Ä¢ SPP Kelas 11-12: Rp 175.000/bulan</p>
                                <p>‚Ä¢ Tabungan: Rp 50.000/bulan (Kelas 10)</p>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 rounded-lg p-3">
                            <h5 class="font-semibold text-green-800 mb-2">üìö Biaya Semester</h5>
                            <div class="text-sm text-green-700 space-y-1">
                                <p>‚Ä¢ Buku LKS: Rp 150.000</p>
                                <p>‚Ä¢ Ulangan Harian: Rp 100.000</p>
                                <p>‚Ä¢ Ulangan Semester: Rp 120.000</p>
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 rounded-lg p-3">
                            <h5 class="font-semibold text-purple-800 mb-2">üéì Biaya Sekali Bayar</h5>
                            <div class="text-sm text-purple-700 space-y-1">
                                <p>‚Ä¢ Siswa Baru Putra: Rp 1.200.000</p>
                                <p>‚Ä¢ Siswi Baru Putri: Rp 1.350.000</p>
                                <p>‚Ä¢ Study Tour: Rp 500.000</p>
                                <p>‚Ä¢ Perpisahan: Rp 1.000.000</p>
                                <p>‚Ä¢ Ujian Akhir: Rp 500.000</p>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 rounded-lg p-3">
                            <h5 class="font-semibold text-yellow-800 mb-2">ü§≤ Biaya Tahunan</h5>
                            <div class="text-sm text-yellow-700 space-y-1">
                                <p>‚Ä¢ Infaq Kenaikan Kelas: Rp 150.000</p>
                                <p class="text-xs text-yellow-600">* Hanya untuk Kelas 10 & 11 (tidak ada di Kelas 12)</p>
                            </div>
                        </div>
                    </div>
                    
                    <h4 class="font-semibold text-gray-700 mb-2">Cara Pembayaran:</h4>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>‚Ä¢ Bank BNI: 1234567890 (MA NU HASYIM ASY'ARI 1)</li>
                        <li>‚Ä¢ Bank Mandiri: 0987654321 (MA NU HASYIM ASY'ARI 1)</li>
                        <li>‚Ä¢ Kantin Madrasah (Tunai)</li>
                        <li>‚Ä¢ Transfer Digital (QRIS)</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-700 mb-2">Jenis Pembayaran:</h4>
                    <div class="grid grid-cols-2 gap-2 text-xs text-gray-600 mb-4">
                        <div>‚Ä¢ üìö SPP</div>
                        <div>‚Ä¢ üè¶ Tabungan</div>
                        <div>‚Ä¢ üìñ LKS</div>
                        <div>‚Ä¢ üìù UHB</div>
                        <div>‚Ä¢ üìù PAS</div>
                        <div>‚Ä¢ ü§≤ Infaq Kenaikan</div>
                        <div>‚Ä¢ üéì Perpisahan</div>
                        <div>‚Ä¢ üöå Studi Tour</div>
                        <div>‚Ä¢ üìî Buku Kenangan</div>
                        <div>‚Ä¢ üìã Ujian Akhir</div>
                    </div>
                    
                    <h4 class="font-semibold text-gray-700 mb-2">Jadwal Pembayaran:</h4>
                    <ul class="text-sm text-gray-600 space-y-1 mb-4">
                        <li>‚Ä¢ Tanggal 1-10: Pembayaran Normal</li>
                        <li>‚Ä¢ Tanggal 11-20: Denda Rp 25.000</li>
                        <li>‚Ä¢ Tanggal 21-31: Denda Rp 50.000</li>
                    </ul>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <p class="text-xs text-yellow-800">
                            <strong>Catatan:</strong> Siswa yang menunggak lebih dari 2 bulan tidak diperkenankan mengikuti ujian semester.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google Sheets Configuration
        const GOOGLE_SHEETS_CONFIG = {
            SHEET_ID: '17MDc804lNUm_XwUM6hPj6Ui8T-JVtpxJCLq4XovVs0A',
            SHEET_NAME: 'Sheet7',
            API_KEY: 'AIzaSyCAJWvsjw92iebZM54KZivepTpl_Q2gk70'
        };

        let sheetsData = [];
        let currentStudent = null;
        let currentYear = 10;

        // Get current academic year
        function getCurrentAcademicYear() {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1; // JavaScript months are 0-indexed
            
            // Academic year starts in July (month 7)
            // If current month is January-June, we're still in the previous academic year
            if (currentMonth >= 7) {
                // July-December: current year / next year
                return `${currentYear}/${currentYear + 1}`;
            } else {
                // January-June: previous year / current year
                return `${currentYear - 1}/${currentYear}`;
            }
        }

        // Initialize the application
        async function initializeApp() {
            try {
                // Update academic year display
                const academicYear = getCurrentAcademicYear();
                document.getElementById('currentAcademicYear').textContent = `Tahun Ajaran ${academicYear}`;
                document.getElementById('currentAcademicYearMobile').textContent = `Tahun Ajaran ${academicYear}`;
                
                // Try to load from Google Sheets
                updateConnectionStatus('üîÑ Menghubungkan ke database...', 'text-blue-600');
                await loadSheetsData();
                updateConnectionStatus('‚úÖ Terhubung ke Google Sheets', 'text-green-600');
                
                // Show ready status after 2 seconds
                setTimeout(() => {
                    updateConnectionStatus('üí° Sistem siap digunakan', 'text-blue-600');
                }, 2000);
                
            } catch (error) {
                console.error('Error loading Google Sheets data:', error);
                updateConnectionStatus('‚ö†Ô∏è Menggunakan data contoh untuk demo', 'text-yellow-600');
                
                // Load sample data for testing
                loadSampleData();
                
                // Show ready status after 2 seconds
                setTimeout(() => {
                    updateConnectionStatus('üí° Sistem siap digunakan', 'text-blue-600');
                }, 2000);
            }
        }

        // Load sample data for testing - FIXED with grade-specific columns
        function loadSampleData() {
            sheetsData = [
                // Header row - GRADE-SPECIFIC columns
                ['NISN', 'Nama', 'Kelas', 'Jurusan', 'Tahun_Masuk', 'Jenis_Kelamin', 
                 'SPP_10_Juli', 'SPP_10_Agustus', 'Tabungan_10_Juli', 'LKS_10_Sem1', 'UHB_10_Sem1', 'PAS_10_Sem1', 'Infaq_Naik_Kelas_10', 
                 'SPP_11_Juli', 'SPP_11_Agustus', 'LKS_11_Sem1', 'UHB_11_Sem1', 'PAS_11_Sem1', 'Infaq_Naik_Kelas_11',
                 'SPP_12_Juli', 'SPP_12_Agustus', 'LKS_12_Sem1', 'UHB_12_Sem1', 'PAS_12_Sem1',
                 'Siswa_Baru_Putra', 'Siswi_Baru_Putri', 'Study_Tour', 'Perpisahan', 'Buku_Kenangan', 'Ujian_Akhir'],
                // Sample student data - payments isolated by grade
                ['1234567890', 'Ahmad Fauzi', '10', 'IPA', '2024', 'laki-laki', 
                 '150000', '125000', '50000', '150000', '100000', '120000', '150000', // Grade 10 payments (SPP Juli overpaid)
                 '0', '0', '0', '0', '0', '0', // Grade 11 payments (not paid yet)
                 '0', '0', '0', '0', '0', // Grade 12 payments (not paid yet)
                 '1200000', '0', '0', '0', '0', '0'], // One-time payments
                ['1234567891', 'Siti Aminah', '10', 'IPS', '2024', 'perempuan', 
                 '125000', '0', '50000', '150000', '0', '0', '0', // Grade 10 payments
                 '0', '0', '0', '0', '0', '0', // Grade 11 payments (not paid yet)
                 '0', '0', '0', '0', '0', // Grade 12 payments (not paid yet)
                 '0', '1350000', '0', '0', '0', '0'], // One-time payments
                ['1234567892', 'Budi Santoso', '11', 'IPA', '2023', 'laki-laki', 
                 '125000', '125000', '50000', '150000', '100000', '120000', '150000', // Grade 10 payments (completed)
                 '175000', '175000', '150000', '100000', '120000', '150000', // Grade 11 payments (current)
                 '0', '0', '0', '0', '0', // Grade 12 payments (not paid yet)
                 '1200000', '0', '0', '0', '0', '0'] // One-time payments
            ];
        }

        // Load data from Google Sheets
        async function loadSheetsData() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.SHEET_ID}/values/${GOOGLE_SHEETS_CONFIG.SHEET_NAME}?key=${GOOGLE_SHEETS_CONFIG.API_KEY}`;
            
            try {
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.values || data.values.length === 0) {
                    throw new Error('No data found in Google Sheets');
                }
                
                sheetsData = data.values;
                console.log('Successfully loaded from Google Sheets:', sheetsData.length, 'rows');
                
            } catch (error) {
                console.error('Error loading Google Sheets data:', error);
                throw error;
            }
        }

        // Update connection status
        function updateConnectionStatus(message, className) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.innerHTML = `<span class="connection-status ${className}">${message}</span>`;
        }

        // Search for student by NISN
        async function searchStudent() {
            const nisn = document.getElementById('nisnInput').value.trim();
            
            if (nisn.length !== 10) {
                alert('NISN harus 10 digit!');
                return;
            }

            // Show loading state
            setLoadingState(true);

            try {
                // Reload data to get latest information
                await loadSheetsData();
                
                // Find student in sheets data
                const student = findStudentByNISN(nisn);
                
                if (!student) {
                    alert('NISN tidak ditemukan dalam database!');
                    setLoadingState(false);
                    return;
                }

                currentStudent = student;
                displayStudentInfo(nisn, student);
                
            } catch (error) {
                console.error('Error searching student:', error);
                alert('Terjadi kesalahan saat mencari data siswa. Silakan coba lagi.');
            } finally {
                setLoadingState(false);
            }
        }

        // Find student by NISN in sheets data
        function findStudentByNISN(nisn) {
            if (sheetsData.length === 0) return null;
            
            // Assuming first row contains headers
            const headers = sheetsData[0];
            const nisnColumnIndex = headers.findIndex(header => 
                header.toLowerCase().includes('nisn')
            );
            
            if (nisnColumnIndex === -1) {
                console.error('NISN column not found in sheets data');
                return null;
            }

            // Find the row with matching NISN
            const studentRow = sheetsData.find((row, index) => {
                if (index === 0) return false; // Skip header row
                return row[nisnColumnIndex] === nisn;
            });

            if (!studentRow) return null;

            // Parse student data from the row
            return parseStudentData(headers, studentRow);
        }

        // Fee structure based on detailed breakdown
        const FEE_STRUCTURE = {
            // One-time payments (paid once in 3 years)
            oneTime: {
                'Siswa Baru Putra': 1200000,
                'Siswi Baru Putri': 1350000,
                'Perpisahan': 1000000,
                'Study Tour': 500000,
                'Buku Kenangan': 50000,
                'Ujian Akhir': 500000
            },
            // Monthly payments
            monthly: {
                'SPP': {
                    10: 125000,
                    11: 175000,
                    12: 175000
                },
                'Tabungan': 50000 // Only for grade 10
            },
            // Semester payments (2 times per year)
            semester: {
                'Buku LKS': 150000,
                'Ulangan Harian': 100000,
                'Ulangan Semester': 120000
            },
            // Yearly payments (only for grades 10 and 11, not grade 12)
            yearly: {
                'Infaq Kenaikan Kelas': 150000
            }
        };

        // Parse student data from sheets row - FIXED with grade isolation
        function parseStudentData(headers, row) {
            const student = {
                name: '',
                class: '',
                major: '',
                entryYear: '',
                gender: '',
                payments: {
                    10: {},
                    11: {},
                    12: {}
                }
            };

            // Map basic student info
            headers.forEach((header, index) => {
                const value = row[index] || '';
                const headerLower = header.toLowerCase();
                
                if (headerLower.includes('nama')) {
                    student.name = value;
                } else if (headerLower.includes('kelas')) {
                    student.class = value;
                } else if (headerLower.includes('jurusan')) {
                    student.major = value;
                } else if (headerLower.includes('tahun')) {
                    student.entryYear = value;
                } else if (headerLower.includes('jenis_kelamin') || headerLower.includes('gender') || headerLower.includes('kelamin')) {
                    // Normalize gender values
                    const genderValue = value.toLowerCase().trim();
                    if (genderValue.includes('laki') || genderValue === 'l' || genderValue === 'male' || genderValue === 'putra') {
                        student.gender = 'laki-laki';
                    } else if (genderValue.includes('perempuan') || genderValue === 'p' || genderValue === 'female' || genderValue === 'putri') {
                        student.gender = 'perempuan';
                    } else {
                        student.gender = genderValue;
                    }
                }
            });

            // Parse payment data for each grade and payment type - GRADE ISOLATION FIXED
            [10, 11, 12].forEach(grade => {
                const gradePayments = {};
                
                // One-time payments distributed by grade
                Object.keys(FEE_STRUCTURE.oneTime).forEach(feeType => {
                    let shouldInclude = false;
                    
                    // Grade 10: Only new student fees
                    if (grade === 10) {
                        if (feeType === 'Siswa Baru Putra' && student.gender === 'laki-laki') shouldInclude = true;
                        if (feeType === 'Siswi Baru Putri' && student.gender === 'perempuan') shouldInclude = true;
                    }
                    
                    // Grade 11: Study Tour
                    if (grade === 11) {
                        if (feeType === 'Study Tour') shouldInclude = true;
                    }
                    
                    // Grade 12: Graduation-related fees
                    if (grade === 12) {
                        if (feeType === 'Perpisahan' || feeType === 'Buku Kenangan' || feeType === 'Ujian Akhir') {
                            shouldInclude = true;
                        }
                    }
                    
                    if (shouldInclude) {
                        const expectedAmount = FEE_STRUCTURE.oneTime[feeType];
                        const paymentStatus = checkPaymentStatus(headers, row, feeType, grade, expectedAmount);
                        gradePayments[feeType] = {
                            paid: paymentStatus.paid,
                            amount: expectedAmount,
                            paidAmount: paymentStatus.amount,
                            remaining: paymentStatus.remaining,
                            status: paymentStatus.status,
                            installments: paymentStatus.installments,
                            date: paymentStatus.paid ? new Date().toISOString().split('T')[0] : null,
                            type: 'oneTime',
                            frequency: 'Sekali dalam 3 tahun'
                        };
                    }
                });
                
                // Monthly payments - MUST be grade-specific
                Object.keys(FEE_STRUCTURE.monthly).forEach(feeType => {
                    // Tabungan only for grade 10
                    if (feeType === 'Tabungan' && grade !== 10) return;
                    
                    // For monthly payments, create entries for each month
                    const months = [
                        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember',
                        'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni'
                    ];
                    
                    months.forEach((month, monthIndex) => {
                        const monthKey = `${feeType} ${month}`;
                        
                        // Get the correct amount based on fee type and grade
                        let expectedAmount;
                        if (feeType === 'SPP') {
                            expectedAmount = FEE_STRUCTURE.monthly[feeType][grade];
                        } else {
                            expectedAmount = FEE_STRUCTURE.monthly[feeType];
                        }
                        
                        // CRITICAL: Pass the specific grade to ensure payment isolation
                        const paymentStatus = checkPaymentStatus(headers, row, `${feeType}_${grade}_${month}`, grade, expectedAmount);
                        
                        gradePayments[monthKey] = {
                            paid: paymentStatus.paid,
                            amount: expectedAmount,
                            paidAmount: paymentStatus.amount,
                            remaining: paymentStatus.remaining,
                            status: paymentStatus.status,
                            installments: paymentStatus.installments,
                            date: paymentStatus.paid ? new Date().toISOString().split('T')[0] : null,
                            type: 'monthly',
                            frequency: 'Per bulan'
                        };
                    });
                });
                
                // Semester payments (2 times per year) - MUST be grade-specific
                Object.keys(FEE_STRUCTURE.semester).forEach(feeType => {
                    ['Semester 1', 'Semester 2'].forEach(semester => {
                        const semesterKey = `${feeType} ${semester}`;
                        const expectedAmount = FEE_STRUCTURE.semester[feeType];
                        
                        // CRITICAL: Pass the specific grade to ensure payment isolation
                        const paymentStatus = checkPaymentStatus(headers, row, `${feeType}_${grade}_${semester}`, grade, expectedAmount);
                        
                        gradePayments[semesterKey] = {
                            paid: paymentStatus.paid,
                            amount: expectedAmount,
                            paidAmount: paymentStatus.amount,
                            remaining: paymentStatus.remaining,
                            status: paymentStatus.status,
                            installments: paymentStatus.installments,
                            date: paymentStatus.paid ? new Date().toISOString().split('T')[0] : null,
                            type: 'semester',
                            frequency: 'Per semester'
                        };
                    });
                });
                
                // Yearly payments (only for grades 10 and 11, not grade 12) - MUST be grade-specific
                if (grade === 10 || grade === 11) {
                    Object.keys(FEE_STRUCTURE.yearly).forEach(feeType => {
                        const expectedAmount = FEE_STRUCTURE.yearly[feeType];
                        
                        // CRITICAL: Pass the specific grade to ensure payment isolation
                        const paymentStatus = checkPaymentStatus(headers, row, `${feeType}_${grade}`, grade, expectedAmount);
                        
                        gradePayments[feeType] = {
                            paid: paymentStatus.paid,
                            amount: expectedAmount,
                            paidAmount: paymentStatus.amount,
                            remaining: paymentStatus.remaining,
                            status: paymentStatus.status,
                            installments: paymentStatus.installments,
                            date: paymentStatus.paid ? new Date().toISOString().split('T')[0] : null,
                            type: 'yearly',
                            frequency: 'Per tahun'
                        };
                    });
                }
                
                student.payments[grade] = gradePayments;
            });
            
            return student;
        }
        
        // Helper function to check payment status with installment support - FIXED for grade isolation
        function checkPaymentStatus(headers, row, feeType, grade, expectedAmount) {
            // Create comprehensive list of possible column name patterns - GRADE-SPECIFIC FIRST
            const feeTypeClean = feeType.replace(/\s+/g, '').toLowerCase();
            const feeTypeUnderscore = feeType.replace(/\s+/g, '_').toLowerCase();
            
            // Create all possible column name patterns
            const possibleColumnNames = [];
            
            // Handle semester payments with exact patterns from your Google Sheets
            if (feeType.includes('Semester')) {
                const semesterMatch = feeType.match(/(Semester\s*[12])/);
                if (semesterMatch) {
                    const semesterNum = semesterMatch[1].replace(/\D/g, ''); // Extract just the number
                    const baseType = feeType.replace(semesterMatch[1], '').trim().replace(/\s+/g, '').toLowerCase();
                    
                    // Exact patterns matching your Google Sheets headers - GRADE-SPECIFIC
                    if (baseType.includes('ulangan') && baseType.includes('harian')) {
                        // UHB patterns: uhb_10_sem1, uhb_10_sem2, etc.
                        possibleColumnNames.push(`uhb_${grade}_sem${semesterNum}`);
                        possibleColumnNames.push(`UHB_${grade}_sem${semesterNum}`);
                        possibleColumnNames.push(`uhb_${grade}_semester${semesterNum}`);
                        possibleColumnNames.push(`UHB_${grade}_semester${semesterNum}`);
                    } else if (baseType.includes('ulangan') && baseType.includes('semester')) {
                        // PAS patterns: pas_10_sem1, pas_10_sem2, etc.
                        possibleColumnNames.push(`pas_${grade}_sem${semesterNum}`);
                        possibleColumnNames.push(`PAS_${grade}_sem${semesterNum}`);
                        possibleColumnNames.push(`pas_${grade}_semester${semesterNum}`);
                        possibleColumnNames.push(`PAS_${grade}_semester${semesterNum}`);
                    } else if (baseType.includes('lks') || baseType.includes('buku')) {
                        // LKS patterns: lks_10_sem1, lks_10_sem2, etc.
                        possibleColumnNames.push(`lks_${grade}_sem${semesterNum}`);
                        possibleColumnNames.push(`LKS_${grade}_sem${semesterNum}`);
                        possibleColumnNames.push(`lks_${grade}_semester${semesterNum}`);
                        possibleColumnNames.push(`LKS_${grade}_semester${semesterNum}`);
                    }
                    
                    // Additional fallback patterns
                    possibleColumnNames.push(`${baseType}_${grade}_sem${semesterNum}`);
                    possibleColumnNames.push(`${baseType}_${grade}_semester${semesterNum}`);
                    possibleColumnNames.push(`${baseType}_sem${semesterNum}_${grade}`);
                    possibleColumnNames.push(`${baseType}_semester${semesterNum}_${grade}`);
                }
            }
            
            // Map common fee type abbreviations for other payments
            const feeTypeMap = {
                'spp': ['spp'],
                'tabungan': ['tabungan', 'tab'],
                'buku_lks': ['lks', 'buku_lks', 'bukulks', 'bukuLKS'],
                'ulangan_harian': ['uhb', 'ulangan_harian', 'ulanganharian', 'uh', 'UHB', 'Ulangan_Harian'],
                'ulangan_semester': ['pas', 'ulangan_semester', 'ulangansemester', 'us', 'uas', 'PAS', 'Ulangan_Semester'],
                'infaq_kenaikan_kelas': ['infaq_naik_kelas', 'infaq_kenaikan', 'infaqkenaikan', 'kenaikan'],
                'perpisahan': ['perpisahan'],
                'study_tour': ['studytour', 'study_tour', 'tour'],
                'buku_kenangan': ['buku_kenangan', 'bukukenangan'],
                'ujian_akhir': ['ujian_akhir', 'ujianakhir', 'ua'],
                'siswa_baru_putra': ['siswa_baru', 'siswabaru', 'putra'],
                'siswi_baru_putri': ['siswa_baru_putri', 'siswi_baru_putri', 'siswi_baru', 'siswibaruputri', 'putri']
            };
            
            // Get possible fee type variations
            let feeVariations = [feeTypeClean, feeTypeUnderscore];
            
            // Add mapped variations
            Object.entries(feeTypeMap).forEach(([key, variations]) => {
                if (feeTypeClean.includes(key) || key.includes(feeTypeClean)) {
                    feeVariations = feeVariations.concat(variations);
                }
            });
            
            // Remove duplicates
            feeVariations = [...new Set(feeVariations)];
            
            // Add general patterns for non-semester payments - GRADE-SPECIFIC FIRST
            if (!feeType.includes('Semester')) {
                feeVariations.forEach(feeVar => {
                    // GRADE-SPECIFIC patterns first (highest priority)
                    possibleColumnNames.push(`${feeVar}_${grade}`);
                    possibleColumnNames.push(`${feeVar}_kelas_${grade}`);
                    possibleColumnNames.push(`kelas_${grade}_${feeVar}`);
                    possibleColumnNames.push(`${feeVar}${grade}`);
                    possibleColumnNames.push(`${grade}_${feeVar}`);
                    
                    // Special patterns for Infaq Kenaikan Kelas
                    if (feeType.includes('Infaq Kenaikan')) {
                        possibleColumnNames.push(`infaq_naik_kelas_${grade}`);
                        possibleColumnNames.push(`infaq_kenaikan_kelas_${grade}`);
                        possibleColumnNames.push(`INFAQ_NAIK_KELAS_${grade}`);
                        possibleColumnNames.push(`INFAQ_KENAIKAN_KELAS_${grade}`);
                        possibleColumnNames.push(`infaq_naik_${grade}`);
                        possibleColumnNames.push(`infaq_kenaikan_${grade}`);
                    }
                    
                    // With month patterns for monthly payments - GRADE MUST BE INCLUDED
                    if (feeType.includes('Juli') || feeType.includes('Agustus') || feeType.includes('September') || 
                        feeType.includes('Oktober') || feeType.includes('November') || feeType.includes('Desember') ||
                        feeType.includes('Januari') || feeType.includes('Februari') || feeType.includes('Maret') ||
                        feeType.includes('April') || feeType.includes('Mei') || feeType.includes('Juni')) {
                        
                        const monthMatch = feeType.match(/(Juli|Agustus|September|Oktober|November|Desember|Januari|Februari|Maret|April|Mei|Juni)/);
                        if (monthMatch) {
                            const month = monthMatch[1].toLowerCase();
                            const baseType = feeType.replace(monthMatch[1], '').trim().replace(/\s+/g, '').toLowerCase();
                            
                            // Month abbreviations for Google Sheets
                            const monthAbbr = {
                                'juli': 'jul',
                                'agustus': 'agu',
                                'september': 'sep',
                                'oktober': 'okt',
                                'november': 'nov',
                                'desember': 'des',
                                'januari': 'jan',
                                'februari': 'feb',
                                'maret': 'mar',
                                'april': 'apr',
                                'mei': 'mei',
                                'juni': 'jun'
                            };
                            
                            const shortMonth = monthAbbr[month] || month;
                            
                            // GRADE-SPECIFIC monthly patterns (highest priority)
                            possibleColumnNames.push(`${baseType}_${grade}_${shortMonth}`);
                            possibleColumnNames.push(`${baseType}_${shortMonth}_${grade}`);
                            possibleColumnNames.push(`${baseType}_${month}_${grade}`);
                            possibleColumnNames.push(`${baseType}_${grade}_${month}`);
                            possibleColumnNames.push(`${month}_${baseType}_${grade}`);
                            possibleColumnNames.push(`${grade}_${baseType}_${month}`);
                            possibleColumnNames.push(`${baseType}${month}${grade}`);
                            possibleColumnNames.push(`${grade}${baseType}${shortMonth}`);
                            possibleColumnNames.push(`${shortMonth}${baseType}${grade}`);
                            
                            // Only add non-grade-specific patterns as fallback (lower priority)
                            possibleColumnNames.push(`${baseType}_${month}`);
                            possibleColumnNames.push(`${month}_${baseType}`);
                        }
                    }
                    
                    // Direct patterns (lowest priority for monthly/semester payments)
                    if (!feeType.includes('Juli') && !feeType.includes('Agustus') && !feeType.includes('September') && 
                        !feeType.includes('Oktober') && !feeType.includes('November') && !feeType.includes('Desember') &&
                        !feeType.includes('Januari') && !feeType.includes('Februari') && !feeType.includes('Maret') &&
                        !feeType.includes('April') && !feeType.includes('Mei') && !feeType.includes('Juni')) {
                        possibleColumnNames.push(feeVar);
                    }
                });
            }
            
            let paymentColumnIndex = -1;
            let matchedColumnName = '';
            let bestMatchScore = 0;
            
            // Find the best matching column
            headers.forEach((header, index) => {
                const headerLower = header.toLowerCase();
                
                possibleColumnNames.forEach(columnName => {
                    const columnLower = columnName.toLowerCase();
                    
                    let score = 0;
                    
                    // Exact match gets highest score
                    if (headerLower === columnLower) {
                        score = 100;
                    }
                    // Exact match without case sensitivity
                    else if (header === columnName) {
                        score = 95;
                    }
                    // Contains match
                    else if (headerLower.includes(columnLower)) {
                        score = 80;
                    }
                    // Reverse contains match
                    else if (columnLower.includes(headerLower)) {
                        score = 70;
                    }
                    // Partial match with grade
                    else if (headerLower.includes(grade.toString()) && 
                             (headerLower.includes(feeTypeClean) || 
                              feeVariations.some(v => headerLower.includes(v)))) {
                        score = 60;
                    }
                    
                    if (score > bestMatchScore) {
                        bestMatchScore = score;
                        paymentColumnIndex = index;
                        matchedColumnName = header;
                    }
                });
            });
            
            if (paymentColumnIndex === -1 || !row[paymentColumnIndex]) {
                // Enhanced debug logging
                console.log(`Debug - Payment column not found:`, {
                    feeType: feeType,
                    grade: grade,
                    searchPatterns: possibleColumnNames.slice(0, 15), // Show first 15 patterns
                    availableHeaders: headers,
                    bestMatchScore: bestMatchScore,
                    matchedColumnName: matchedColumnName
                });
                
                return {
                    paid: false,
                    amount: 0,
                    remaining: expectedAmount,
                    status: 'unpaid',
                    installments: [],
                    date: null
                };
            }
            
            const cellValue = row[paymentColumnIndex].toString().trim();
            
            // Find corresponding date column
            const paymentDate = findPaymentDate(headers, row, feeType, grade, matchedColumnName);
            
            // Check for full payment indicators
            if (cellValue.toLowerCase() === 'lunas' || 
                cellValue.toLowerCase() === 'paid' || 
                cellValue === '1') {
                return {
                    paid: true,
                    amount: expectedAmount,
                    remaining: 0,
                    status: 'paid',
                    installments: [{
                        amount: expectedAmount,
                        date: paymentDate,
                        note: 'Lunas'
                    }],
                    date: paymentDate
                };
            }
            
            // Check for numeric values (installments)
            const numericValue = parseFloat(cellValue.replace(/[^\d.-]/g, ''));
            if (!isNaN(numericValue) && numericValue > 0) {
                const remaining = Math.max(0, expectedAmount - numericValue);
                const isPaid = numericValue >= expectedAmount;
                const isOverpaid = numericValue > expectedAmount;
                
                let status, note;
                if (isOverpaid) {
                    status = 'overpaid';
                    note = `Lebih Bayar (${formatCurrency(numericValue - expectedAmount)})`;
                } else if (isPaid) {
                    status = 'paid';
                    note = 'Lunas';
                } else {
                    status = 'installment';
                    note = 'Cicilan';
                }
                
                return {
                    paid: isPaid,
                    amount: numericValue,
                    remaining: remaining,
                    overpaid: isOverpaid ? numericValue - expectedAmount : 0,
                    status: status,
                    installments: [{
                        amount: numericValue,
                        date: paymentDate,
                        note: note
                    }],
                    date: paymentDate
                };
            }
            
            // Check for multiple installments (comma or semicolon separated)
            if (cellValue.includes(',') || cellValue.includes(';')) {
                const separator = cellValue.includes(',') ? ',' : ';';
                const installmentStrings = cellValue.split(separator);
                const installments = [];
                let totalPaid = 0;
                
                installmentStrings.forEach((installmentStr, index) => {
                    const cleanStr = installmentStr.trim();
                    const amount = parseFloat(cleanStr.replace(/[^\d.-]/g, ''));
                    
                    if (!isNaN(amount) && amount > 0) {
                        totalPaid += amount;
                        installments.push({
                            amount: amount,
                            date: paymentDate,
                            note: `Cicilan ${index + 1}`
                        });
                    }
                });
                
                if (installments.length > 0) {
                    const remaining = Math.max(0, expectedAmount - totalPaid);
                    const isPaid = totalPaid >= expectedAmount;
                    const isOverpaid = totalPaid > expectedAmount;
                    
                    let status;
                    if (isOverpaid) {
                        status = 'overpaid';
                        // Add overpayment note to last installment
                        installments[installments.length - 1].note += ` - Lebih Bayar (${formatCurrency(totalPaid - expectedAmount)})`;
                    } else if (isPaid) {
                        status = 'paid';
                    } else {
                        status = 'installment';
                    }
                    
                    return {
                        paid: isPaid,
                        amount: totalPaid,
                        remaining: remaining,
                        overpaid: isOverpaid ? totalPaid - expectedAmount : 0,
                        status: status,
                        installments: installments,
                        date: paymentDate
                    };
                }
            }
            
            // Default: unpaid
            return {
                paid: false,
                amount: 0,
                remaining: expectedAmount,
                overpaid: 0,
                status: 'unpaid',
                installments: [],
                date: null
            };
        }

        // Helper function to find payment date from Google Sheets
        function findPaymentDate(headers, row, feeType, grade, paymentColumnName) {
            // Create date column patterns based on your Google Sheets structure
            const dateColumnPatterns = [];
            
            // Handle semester payments
            if (feeType.includes('Semester')) {
                const semesterMatch = feeType.match(/(Semester\s*[12])/);
                if (semesterMatch) {
                    const semesterNum = semesterMatch[1].replace(/\D/g, '');
                    const baseType = feeType.replace(semesterMatch[1], '').trim().replace(/\s+/g, '').toLowerCase();
                    
                    if (baseType.includes('ulangan') && baseType.includes('harian')) {
                        dateColumnPatterns.push(`tgl_uhb_${grade}_sem${semesterNum}`);
                    } else if (baseType.includes('ulangan') && baseType.includes('semester')) {
                        dateColumnPatterns.push(`tgl_pas_${grade}_sem${semesterNum}`);
                    } else if (baseType.includes('lks') || baseType.includes('buku')) {
                        dateColumnPatterns.push(`tgl_lks_${grade}_sem${semesterNum}`);
                    }
                }
            }
            // Handle monthly payments
            else if (feeType.includes('Juli') || feeType.includes('Agustus') || feeType.includes('September') || 
                     feeType.includes('Oktober') || feeType.includes('November') || feeType.includes('Desember') ||
                     feeType.includes('Januari') || feeType.includes('Februari') || feeType.includes('Maret') ||
                     feeType.includes('April') || feeType.includes('Mei') || feeType.includes('Juni')) {
                
                const monthMatch = feeType.match(/(Juli|Agustus|September|Oktober|November|Desember|Januari|Februari|Maret|April|Mei|Juni)/);
                if (monthMatch) {
                    const month = monthMatch[1].toLowerCase();
                    const baseType = feeType.replace(monthMatch[1], '').trim().replace(/\s+/g, '').toLowerCase();
                    
                    // Month abbreviations for Google Sheets
                    const monthAbbr = {
                        'juli': 'jul',
                        'agustus': 'agu',
                        'september': 'sep',
                        'oktober': 'okt',
                        'november': 'nov',
                        'desember': 'des',
                        'januari': 'jan',
                        'februari': 'feb',
                        'maret': 'mar',
                        'april': 'apr',
                        'mei': 'mei',
                        'juni': 'jun'
                    };
                    
                    const shortMonth = monthAbbr[month] || month;
                    
                    if (baseType === 'spp') {
                        dateColumnPatterns.push(`tgl_spp_${grade}_${shortMonth}`);
                    } else if (baseType === 'tabungan') {
                        dateColumnPatterns.push(`tgl_tabungan_${grade}_${shortMonth}`);
                    }
                }
            }
            // Handle one-time and yearly payments
            else {
                const feeTypeClean = feeType.replace(/\s+/g, '_').toLowerCase();
                
                if (feeType.includes('Siswa Baru Putra')) {
                    dateColumnPatterns.push('tgl_siswa_baru_putra');
                } else if (feeType.includes('Siswi Baru Putri')) {
                    dateColumnPatterns.push('tgl_siswi_baru_putri');
                } else if (feeType.includes('Ujian Akhir')) {
                    dateColumnPatterns.push('tgl_ujian_akhir');
                } else if (feeType.includes('Perpisahan')) {
                    dateColumnPatterns.push('tgl_perpisahan');
                } else if (feeType.includes('Buku Kenangan')) {
                    dateColumnPatterns.push('tgl_buku_kenangan');
                } else if (feeType.includes('Study Tour')) {
                    dateColumnPatterns.push('tgl_study_tour');
                } else if (feeType.includes('Infaq Kenaikan')) {
                    dateColumnPatterns.push(`tgl_infaq_naik_kelas_${grade}`);
                }
            }
            
            // Find the best matching date column
            let dateColumnIndex = -1;
            let bestMatchScore = 0;
            
            headers.forEach((header, index) => {
                const headerLower = header.toLowerCase();
                
                dateColumnPatterns.forEach(pattern => {
                    const patternLower = pattern.toLowerCase();
                    
                    let score = 0;
                    
                    // Exact match gets highest score
                    if (headerLower === patternLower) {
                        score = 100;
                    }
                    // Contains match
                    else if (headerLower.includes(patternLower)) {
                        score = 80;
                    }
                    // Reverse contains match
                    else if (patternLower.includes(headerLower)) {
                        score = 70;
                    }
                    
                    if (score > bestMatchScore) {
                        bestMatchScore = score;
                        dateColumnIndex = index;
                    }
                });
            });
            
            // Return the date if found and valid
            if (dateColumnIndex !== -1 && row[dateColumnIndex]) {
                const dateValue = row[dateColumnIndex].toString().trim();
                if (dateValue && dateValue !== '' && dateValue !== '-') {
                    // Try to parse the date
                    const parsedDate = parseDate(dateValue);
                    return parsedDate;
                }
            }
            
            return null;
        }

        // Helper function to parse various date formats
        function parseDate(dateString) {
            if (!dateString || dateString === '' || dateString === '-') {
                return null;
            }
            
            // Try different date formats
            const formats = [
                // ISO format
                /^\d{4}-\d{2}-\d{2}$/,
                // Indonesian format
                /^\d{1,2}\/\d{1,2}\/\d{4}$/,
                // European format
                /^\d{1,2}-\d{1,2}-\d{4}$/,
                // US format
                /^\d{1,2}\/\d{1,2}\/\d{2,4}$/
            ];
            
            const cleanDateString = dateString.trim();
            
            // Try to parse as Date object first
            const parsedDate = new Date(cleanDateString);
            if (!isNaN(parsedDate.getTime())) {
                return parsedDate.toISOString().split('T')[0];
            }
            
            // Try manual parsing for Indonesian format (dd/mm/yyyy or d/m/yyyy)
            if (cleanDateString.includes('/')) {
                const parts = cleanDateString.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]);
                    const year = parseInt(parts[2]);
                    
                    // Validate ranges
                    if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 1900) {
                        const date = new Date(year, month - 1, day);
                        if (!isNaN(date.getTime())) {
                            return date.toISOString().split('T')[0];
                        }
                    }
                }
            }
            
            // Try manual parsing for dash format (dd-mm-yyyy or d-m-yyyy)
            if (cleanDateString.includes('-') && !cleanDateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const parts = cleanDateString.split('-');
                if (parts.length === 3) {
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]);
                    const year = parseInt(parts[2]);
                    
                    // Validate ranges
                    if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 1900) {
                        const date = new Date(year, month - 1, day);
                        if (!isNaN(date.getTime())) {
                            return date.toISOString().split('T')[0];
                        }
                    }
                }
            }
            
            return null;
        }

        // Set loading state for search button
        function setLoadingState(loading) {
            const button = document.getElementById('searchButton');
            const text = document.getElementById('searchText');
            const spinner = document.getElementById('loadingSpinner');
            
            if (loading) {
                text.textContent = 'Mencari...';
                spinner.classList.remove('hidden');
                button.disabled = true;
                button.classList.add('opacity-75');
            } else {
                text.textContent = 'üîç Cari Data Siswa';
                spinner.classList.add('hidden');
                button.disabled = false;
                button.classList.remove('opacity-75');
            }
        }

        // Display student information
        function displayStudentInfo(nisn, student) {
            // Show student info section
            document.getElementById('studentInfo').classList.remove('hidden');
            
            // Show all payment information sections
            document.getElementById('currentMonthSection').classList.remove('hidden');
            document.getElementById('paymentSummarySection').classList.remove('hidden');
            document.getElementById('componentBreakdownSection').classList.remove('hidden');
            document.getElementById('yearTabs').classList.remove('hidden');
            document.getElementById('infoSection').classList.remove('hidden');
            
            // Calculate current class based on entry year
            const currentClass = calculateCurrentClass(student.entryYear);
            
            // Fill student details for both desktop and mobile
            const studentName = student.name || 'Nama tidak tersedia';
            const studentGender = student.gender === 'laki-laki' ? 'Laki-laki' : student.gender === 'perempuan' ? 'Perempuan' : (student.gender || '-');
            const studentInitial = (student.name || 'A').charAt(0);
            
            // Desktop elements
            document.getElementById('studentName').textContent = studentName;
            document.getElementById('displayNisn').textContent = nisn;
            document.getElementById('studentClass').textContent = currentClass;
            document.getElementById('studentMajor').textContent = student.major || '-';
            document.getElementById('studentGender').textContent = studentGender;
            document.getElementById('entryYear').textContent = student.entryYear || '-';
            document.getElementById('studentInitial').textContent = studentInitial;
            
            // Mobile elements
            document.getElementById('studentNameMobile').textContent = studentName;
            document.getElementById('displayNisnMobile').textContent = nisn;
            document.getElementById('studentClassMobile').textContent = currentClass;
            document.getElementById('studentMajorMobile').textContent = student.major || '-';
            document.getElementById('studentGenderMobile').textContent = studentGender;
            document.getElementById('entryYearMobile').textContent = student.entryYear || '-';
            document.getElementById('studentInitialMobile').textContent = studentInitial;

            // Update tab years based on entry year
            updateTabYears(student.entryYear);

            // Calculate totals
            calculateTotals(student);
            
            // Show current year payments
            showYear(currentYear);
            
            // Update current month status
            updateCurrentMonthStatus(student);
        }

        // Calculate payment totals
        function calculateTotals(student) {
            let totalPaid = 0;
            let totalUnpaid = 0;
            let totalOverpaid = 0;
            
            // Component totals
            let totalSpp = 0;
            let totalSemester = 0;
            let totalOneTime = 0;
            let totalOthers = 0;

            Object.entries(student.payments).forEach(([grade, yearPayments]) => {
                Object.entries(yearPayments).forEach(([feeType, payment]) => {
                    // Add the actual paid amount
                    totalPaid += payment.paidAmount || 0;
                    // Add the remaining amount to unpaid
                    totalUnpaid += payment.remaining || 0;
                    // Track overpayments
                    totalOverpaid += payment.overpaid || 0;
                    
                    // Calculate component totals (expected amounts) based on fee type
                    const expectedAmount = payment.amount || 0;
                    
                    if (feeType.includes('SPP')) {
                        totalSpp += expectedAmount;
                    } else if (feeType.includes('LKS') || feeType.includes('Ulangan')) {
                        totalSemester += expectedAmount;
                    } else if (feeType.includes('Siswa Baru') || feeType.includes('Siswi Baru') || 
                              feeType.includes('Perpisahan') || feeType.includes('Study Tour') || 
                              feeType.includes('Buku Kenangan') || feeType.includes('Ujian Akhir')) {
                        // Only count one-time payments that match the student's gender
                        if ((feeType.includes('Siswa Baru Putra') && student.gender === 'laki-laki') ||
                            (feeType.includes('Siswi Baru Putri') && student.gender === 'perempuan') ||
                            (!feeType.includes('Siswa Baru') && !feeType.includes('Siswi Baru'))) {
                            totalOneTime += expectedAmount;
                        }
                    } else if (feeType.includes('Infaq')) {
                        // Yearly fees (Infaq Kenaikan Kelas only)
                        totalOthers += expectedAmount;
                    } else if (feeType.includes('Tabungan')) {
                        // Tabungan is monthly, add to SPP category
                        totalSpp += expectedAmount;
                    }
                });
            });

            // Calculate standard total fees based on gender
            const standardTotal = totalSpp + totalSemester + totalOneTime + totalOthers;
            const actualOverpayment = Math.max(0, totalPaid - standardTotal);
            
            const totalOverall = totalPaid + totalUnpaid;

            // Display totals with overpayment information
            let paidText = totalPaid > 0 ? formatCurrency(totalPaid) : 'Rp 0';
            if (actualOverpayment > 0) {
                paidText += `\n(Kelebihan: +${formatCurrency(actualOverpayment)})`;
            }
            document.getElementById('totalPaid').innerHTML = paidText.replace('\n', '<br><small class="text-green-200 text-xs md:text-sm">') + (actualOverpayment > 0 ? '</small>' : '');
            
            document.getElementById('totalUnpaid').textContent = totalUnpaid > 0 ? formatCurrency(totalUnpaid) : 'Rp 0';
            
            // Show overpayment info in the overall total if there's overpayment
            let overallText = totalOverall > 0 ? formatCurrency(totalOverall) : 'Rp 0';
            if (actualOverpayment > 0) {
                overallText += `\n(Kelebihan Bayar: +${formatCurrency(actualOverpayment)})`;
            }
            document.getElementById('totalOverall').innerHTML = overallText.replace('\n', '<br><small class="text-blue-200 text-xs md:text-sm">') + (actualOverpayment > 0 ? '</small>' : '');
            
            // Component breakdown - show only if has value (Desktop)
            document.getElementById('totalSpp').textContent = totalSpp > 0 ? formatCurrency(totalSpp) : 'Rp 0';
            document.getElementById('totalSemester').textContent = totalSemester > 0 ? formatCurrency(totalSemester) : 'Rp 0';
            document.getElementById('totalOneTime').textContent = totalOneTime > 0 ? formatCurrency(totalOneTime) : 'Rp 0';
            document.getElementById('totalOthers').textContent = totalOthers > 0 ? formatCurrency(totalOthers) : 'Rp 0';
            
            // Component breakdown - Mobile elements
            document.getElementById('totalSppMobile').textContent = totalSpp > 0 ? formatCurrency(totalSpp) : 'Rp 0';
            document.getElementById('totalSemesterMobile').textContent = totalSemester > 0 ? formatCurrency(totalSemester) : 'Rp 0';
            document.getElementById('totalOneTimeMobile').textContent = totalOneTime > 0 ? formatCurrency(totalOneTime) : 'Rp 0';
            document.getElementById('totalOthersMobile').textContent = totalOthers > 0 ? formatCurrency(totalOthers) : 'Rp 0';
        }

        // Update current month status
        function updateCurrentMonthStatus(student) {
            // Get current month name
            const currentDate = new Date();
            const monthNames = [
                'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
            ];
            const currentMonthName = monthNames[currentDate.getMonth()];
            
            // Check SPP payment status for current grade
            const currentGrade = getCurrentGrade(student);
            let sppPaid = false;
            let tabunganPaid = false;
            
            // Check SPP payment for current month
            const sppKey = `SPP ${currentMonthName}`;
            if (student.payments[currentGrade] && student.payments[currentGrade][sppKey]) {
                sppPaid = student.payments[currentGrade][sppKey].paid;
            }
            
            // Check Tabungan payment for current month (only for grade 10)
            const tabunganKey = `Tabungan ${currentMonthName}`;
            if (currentGrade === 10 && student.payments[currentGrade] && student.payments[currentGrade][tabunganKey]) {
                tabunganPaid = student.payments[currentGrade][tabunganKey].paid;
            }

            const statusElement = document.getElementById('currentMonthStatus');
            
            // Create status text based on grade and payment status
            let statusText = '';
            let statusClass = '';
            
            if (currentGrade === 10) {
                // For grade 10, show both SPP and Tabungan
                if (sppPaid && tabunganPaid) {
                    statusText = `SPP & Tabungan ${currentMonthName} Lunas`;
                    statusClass = 'px-4 py-2 rounded-full text-white font-semibold text-sm status-paid';
                } else if (sppPaid && !tabunganPaid) {
                    statusText = `SPP ${currentMonthName} Lunas, Tabungan Belum Bayar`;
                    statusClass = 'px-4 py-2 rounded-full text-white font-semibold text-sm status-partial';
                } else if (!sppPaid && tabunganPaid) {
                    statusText = `Tabungan ${currentMonthName} Lunas, SPP Belum Bayar`;
                    statusClass = 'px-4 py-2 rounded-full text-white font-semibold text-sm status-partial';
                } else {
                    statusText = `SPP & Tabungan ${currentMonthName} Belum Bayar`;
                    statusClass = 'px-4 py-2 rounded-full text-white font-semibold text-sm status-unpaid';
                }
            } else {
                // For grade 11 and 12, show only SPP
                if (sppPaid) {
                    statusText = `SPP ${currentMonthName} Lunas`;
                    statusClass = 'px-4 py-2 rounded-full text-white font-semibold text-sm status-paid';
                } else {
                    statusText = `SPP ${currentMonthName} Belum Bayar`;
                    statusClass = 'px-4 py-2 rounded-full text-white font-semibold text-sm status-unpaid';
                }
            }
            
            statusElement.textContent = statusText;
            statusElement.className = statusClass;
        }

        // Calculate current class based on entry year
        function calculateCurrentClass(entryYear) {
            if (!entryYear) return '-';
            
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1; // JavaScript months are 0-indexed
            const entryYearInt = parseInt(entryYear);
            
            // School year starts in July (month 7)
            // If current month is January-June, we're still in the previous academic year
            let academicYear = currentYear;
            if (currentMonth < 7) {
                academicYear = currentYear - 1;
            }
            
            const yearsSinceEntry = academicYear - entryYearInt;
            
            if (yearsSinceEntry < 0) return 'Belum Masuk';
            else if (yearsSinceEntry === 0) return '10';
            else if (yearsSinceEntry === 1) return '11';
            else if (yearsSinceEntry === 2) return '12';
            else return 'Lulus';
        }

        // Get current grade based on entry year
        function getCurrentGrade(student) {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;
            const entryYear = parseInt(student.entryYear);
            
            // School year starts in July
            let academicYear = currentYear;
            if (currentMonth < 7) {
                academicYear = currentYear - 1;
            }
            
            const yearsSinceEntry = academicYear - entryYear;
            
            if (yearsSinceEntry <= 0) return 10;
            else if (yearsSinceEntry === 1) return 11;
            else return 12;
        }

        // Update tab years based on student's entry year
        function updateTabYears(entryYear) {
            if (!entryYear) return;
            
            const entryYearInt = parseInt(entryYear);
            
            // Calculate academic years for each grade
            const grade10Year = `${entryYearInt}/${entryYearInt + 1}`;
            const grade11Year = `${entryYearInt + 1}/${entryYearInt + 2}`;
            const grade12Year = `${entryYearInt + 2}/${entryYearInt + 3}`;
            
            // Update tab text content
            document.getElementById('tab10').innerHTML = `Kelas 10 (${grade10Year})`;
            document.getElementById('tab11').innerHTML = `Kelas 11 (${grade11Year})`;
            document.getElementById('tab12').innerHTML = `Kelas 12 (${grade12Year})`;
        }

        // Show payments for specific year
        function showYear(year) {
            currentYear = year;
            
            // Update tab styles
            document.querySelectorAll('[id^="tab"]').forEach(tab => {
                tab.className = 'flex-1 py-3 px-4 rounded-md font-semibold transition-all duration-300 tab-inactive text-gray-600 hover:bg-gray-200';
            });
            document.getElementById(`tab${year}`).className = 'flex-1 py-3 px-4 rounded-md font-semibold transition-all duration-300 tab-active text-white';

            // Display payment details for the year
            displayPaymentDetails(year);
        }

        // Display payment details for a specific year
        function displayPaymentDetails(year) {
            if (!currentStudent) return;

            const payments = currentStudent.payments[year];
            const detailsContainer = document.getElementById('paymentDetails');
            
            // Group payments by frequency
            const paymentsByFrequency = {
                monthly: [],
                semester: [],
                yearly: [],
                oneTime: []
            };

            Object.entries(payments).forEach(([feeType, payment]) => {
                const paymentData = { feeType, ...payment };
                
                if (payment.type === 'monthly') {
                    paymentsByFrequency.monthly.push(paymentData);
                } else if (payment.type === 'semester') {
                    paymentsByFrequency.semester.push(paymentData);
                } else if (payment.type === 'yearly') {
                    paymentsByFrequency.yearly.push(paymentData);
                } else if (payment.type === 'oneTime') {
                    paymentsByFrequency.oneTime.push(paymentData);
                }
            });

            let html = `
                <div class="payment-section rounded-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h4 class="text-lg font-semibold text-gray-800">Detail Pembayaran Kelas ${year}</h4>
                        <button onclick="downloadExcel(${year})" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2">
                            <span>üìä</span>
                            <span>Download Excel</span>
                        </button>
                    </div>
                    
                    <!-- Detailed Payment Table -->
                    <div class="mb-8 bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-6 py-3 border-b border-gray-200">
                            <h5 class="text-md font-semibold text-gray-800">üìã Tabel Detail Pembayaran Kelas ${year}</h5>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm" id="paymentTable${year}">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700 border-b">No</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700 border-b">Jenis Pembayaran</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700 border-b">Kategori</th>
                                        <th class="px-4 py-3 text-right font-semibold text-gray-700 border-b">Nominal</th>
                                        <th class="px-4 py-3 text-right font-semibold text-gray-700 border-b">Terbayar</th>
                                        <th class="px-4 py-3 text-right font-semibold text-gray-700 border-b">Sisa</th>
                                        <th class="px-4 py-3 text-center font-semibold text-gray-700 border-b">Status</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700 border-b">Tanggal Bayar</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700 border-b">Keterangan</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${generateTableRows(paymentsByFrequency, year)}
                                </tbody>
                                <tfoot class="bg-gray-50 border-t-2 border-gray-300">
                                    ${generateTableFooter(paymentsByFrequency)}
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            detailsContainer.innerHTML = html;
        }

        // Generate table rows for payment details
        function generateTableRows(paymentsByFrequency, year) {
            let rows = '';
            let rowNumber = 1;

            // Monthly payments
            if (paymentsByFrequency.monthly.length > 0) {
                rows += `
                    <tr class="bg-blue-50">
                        <td colspan="9" class="px-4 py-2 font-semibold text-blue-800 border-b">üìÖ Pembayaran Bulanan</td>
                    </tr>
                `;
                
                paymentsByFrequency.monthly.forEach(payment => {
                    rows += generateTableRow(payment, rowNumber++);
                });
            }

            // Semester payments
            if (paymentsByFrequency.semester.length > 0) {
                rows += `
                    <tr class="bg-green-50">
                        <td colspan="9" class="px-4 py-2 font-semibold text-green-800 border-b">üìö Pembayaran Semester</td>
                    </tr>
                `;
                
                paymentsByFrequency.semester.forEach(payment => {
                    rows += generateTableRow(payment, rowNumber++);
                });
            }

            // Yearly payments (only for grades 10 and 11, not grade 12)
            if ((year === 10 || year === 11) && paymentsByFrequency.yearly.length > 0) {
                rows += `
                    <tr class="bg-purple-50">
                        <td colspan="9" class="px-4 py-2 font-semibold text-purple-800 border-b">üóìÔ∏è Pembayaran Tahunan</td>
                    </tr>
                `;
                
                paymentsByFrequency.yearly.forEach(payment => {
                    rows += generateTableRow(payment, rowNumber++);
                });
            }

            // One-time payments
            if (paymentsByFrequency.oneTime.length > 0) {
                rows += `
                    <tr class="bg-orange-50">
                        <td colspan="9" class="px-4 py-2 font-semibold text-orange-800 border-b">üéØ Pembayaran Sekali Bayar</td>
                    </tr>
                `;
                
                paymentsByFrequency.oneTime.forEach(payment => {
                    rows += generateTableRow(payment, rowNumber++);
                });
            }

            return rows;
        }

        // Generate individual table row
        function generateTableRow(payment, rowNumber) {
            let statusBadge, statusText;
            
            if (payment.status === 'overpaid') {
                statusBadge = 'bg-purple-100 text-purple-800';
                statusText = 'üí∞ Lebih Bayar';
            } else if (payment.status === 'paid') {
                statusBadge = 'bg-green-100 text-green-800';
                statusText = '‚úÖ Lunas';
            } else if (payment.status === 'installment') {
                statusBadge = 'bg-yellow-100 text-yellow-800';
                statusText = '‚è≥ Cicilan';
            } else {
                statusBadge = 'bg-red-100 text-red-800';
                statusText = '‚ùå Belum Bayar';
            }

            const categoryMap = {
                'monthly': 'üìÖ Bulanan',
                'semester': 'üìö Semester',
                'yearly': 'üóìÔ∏è Tahunan',
                'oneTime': 'üéØ Sekali Bayar'
            };

            return `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="px-4 py-3 text-gray-700">${rowNumber}</td>
                    <td class="px-4 py-3 text-gray-800 font-medium">${payment.feeType}</td>
                    <td class="px-4 py-3 text-gray-600">${categoryMap[payment.type] || payment.type}</td>
                    <td class="px-4 py-3 text-right text-gray-800 font-medium">${formatCurrency(payment.amount)}</td>
                    <td class="px-4 py-3 text-right text-green-600 font-medium">${formatCurrency(payment.paidAmount || 0)}</td>
                    <td class="px-4 py-3 text-right text-red-600 font-medium">${formatCurrency(payment.remaining || 0)}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusBadge}">${statusText}</span>
                    </td>
                    <td class="px-4 py-3 text-gray-600">${payment.date || '-'}</td>
                    <td class="px-4 py-3 text-gray-600">${payment.installments && payment.installments.length > 0 ? payment.installments[0].note : '-'}</td>
                </tr>
            `;
        }

        // Generate table footer with totals
        function generateTableFooter(paymentsByFrequency) {
            let totalExpected = 0;
            let totalPaid = 0;
            let totalRemaining = 0;

            Object.values(paymentsByFrequency).forEach(payments => {
                payments.forEach(payment => {
                    totalExpected += payment.amount || 0;
                    totalPaid += payment.paidAmount || 0;
                    totalRemaining += payment.remaining || 0;
                });
            });

            return `
                <tr class="font-bold text-gray-800">
                    <td colspan="3" class="px-4 py-3 text-right">TOTAL:</td>
                    <td class="px-4 py-3 text-right">${formatCurrency(totalExpected)}</td>
                    <td class="px-4 py-3 text-right text-green-600">${formatCurrency(totalPaid)}</td>
                    <td class="px-4 py-3 text-right text-red-600">${formatCurrency(totalRemaining)}</td>
                    <td colspan="3" class="px-4 py-3"></td>
                </tr>
            `;
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount || 0);
        }

        // Download Excel functionality
        function downloadExcel(year) {
            if (!currentStudent) {
                alert('Data siswa tidak ditemukan!');
                return;
            }

            try {
                // Create CSV content with BOM for proper UTF-8 encoding
                let csvContent = "\uFEFF"; // BOM for UTF-8
                
                // Add header with student info
                csvContent += `LAPORAN PEMBAYARAN SISWA\n`;
                csvContent += `Nama: ${currentStudent.name}\n`;
                csvContent += `NISN: ${document.getElementById('displayNisn').textContent}\n`;
                csvContent += `Kelas: ${year}\n`;
                csvContent += `Tanggal Export: ${new Date().toLocaleDateString('id-ID')}\n\n`;
                
                // Add table headers
                csvContent += "No,Jenis Pembayaran,Kategori,Nominal,Terbayar,Sisa,Status,Tanggal Bayar,Keterangan\n";

                const payments = currentStudent.payments[year];
                if (!payments || Object.keys(payments).length === 0) {
                    alert('Tidak ada data pembayaran untuk kelas ini!');
                    return;
                }

                let rowNumber = 1;

                // Group payments by frequency for better organization
                const paymentsByFrequency = {
                    monthly: [],
                    semester: [],
                    yearly: [],
                    oneTime: []
                };

                Object.entries(payments).forEach(([feeType, payment]) => {
                    const paymentData = { feeType, ...payment };
                    
                    if (payment.type === 'monthly') {
                        paymentsByFrequency.monthly.push(paymentData);
                    } else if (payment.type === 'semester') {
                        paymentsByFrequency.semester.push(paymentData);
                    } else if (payment.type === 'yearly') {
                        paymentsByFrequency.yearly.push(paymentData);
                    } else if (payment.type === 'oneTime') {
                        paymentsByFrequency.oneTime.push(paymentData);
                    }
                });

                const categoryMap = {
                    'monthly': 'Bulanan',
                    'semester': 'Semester', 
                    'yearly': 'Tahunan',
                    'oneTime': 'Sekali Bayar'
                };

                const statusMap = {
                    'overpaid': 'Lebih Bayar',
                    'paid': 'Lunas',
                    'installment': 'Cicilan',
                    'unpaid': 'Belum Bayar'
                };

                // Add payments by category
                ['monthly', 'semester', 'yearly', 'oneTime'].forEach(category => {
                    const categoryPayments = paymentsByFrequency[category];
                    if (categoryPayments.length > 0) {
                        // Add category header
                        csvContent += `\n"=== ${categoryMap[category].toUpperCase()} ===",,,,,,,\n`;
                        
                        categoryPayments.forEach(payment => {
                            const nominal = payment.amount || 0;
                            const terbayar = payment.paidAmount || 0;
                            const sisa = payment.remaining || 0;
                            const status = statusMap[payment.status] || payment.status;
                            const tanggal = payment.date || '-';
                            const keterangan = payment.installments && payment.installments.length > 0 ? payment.installments[0].note : '-';
                            
                            // Escape commas in text fields
                            const feeTypeEscaped = `"${payment.feeType.replace(/"/g, '""')}"`;
                            const kategoriEscaped = `"${categoryMap[payment.type] || payment.type}"`;
                            const statusEscaped = `"${status}"`;
                            const tanggalEscaped = `"${tanggal}"`;
                            const keteranganEscaped = `"${keterangan.replace(/"/g, '""')}"`;
                            
                            csvContent += `${rowNumber},${feeTypeEscaped},${kategoriEscaped},${nominal},${terbayar},${sisa},${statusEscaped},${tanggalEscaped},${keteranganEscaped}\n`;
                            rowNumber++;
                        });
                    }
                });

                // Add totals
                let totalExpected = 0;
                let totalPaid = 0;
                let totalRemaining = 0;

                Object.values(payments).forEach(payment => {
                    totalExpected += payment.amount || 0;
                    totalPaid += payment.paidAmount || 0;
                    totalRemaining += payment.remaining || 0;
                });

                csvContent += `\n"TOTAL:",,"",${totalExpected},${totalPaid},${totalRemaining},"","",""\n`;

                // Create blob and download
                const blob = new Blob([csvContent], { 
                    type: 'text/csv;charset=utf-8;' 
                });
                
                // Create download link
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                
                // Generate filename
                const studentName = currentStudent.name.replace(/[^a-zA-Z0-9]/g, '_');
                const currentDate = new Date().toISOString().split('T')[0];
                const filename = `Pembayaran_Kelas_${year}_${studentName}_${currentDate}.csv`;
                
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                
                // Add to DOM, click, and remove
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up the URL object
                URL.revokeObjectURL(url);
                
                // Show success message
                setTimeout(() => {
                    alert(`File berhasil didownload: ${filename}`);
                }, 100);
                
            } catch (error) {
                console.error('Error downloading Excel:', error);
                alert('Terjadi kesalahan saat mendownload file. Silakan coba lagi.');
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the app
            initializeApp();

            // Add enter key support for NISN input
            document.getElementById('nisnInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchStudent();
                }
            });

            // Add input validation for NISN
            document.getElementById('nisnInput').addEventListener('input', function(e) {
                // Only allow numbers
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
                
                // Limit to 10 digits
                if (e.target.value.length > 10) {
                    e.target.value = e.target.value.slice(0, 10);
                }
            });
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97d1fbb5d7cd3104',t:'MTc1NzUzOTM3My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
