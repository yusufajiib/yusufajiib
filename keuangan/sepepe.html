<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Informasi SPP - SMA Negeri 1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
        }
        .gradient-bg { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            position: relative;
            overflow: hidden;
        }
        .gradient-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
        }
        .card-shadow { 
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }
        .search-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .student-info-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.98), rgba(248,250,252,0.95));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .info-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.95), rgba(241,245,249,0.9));
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .summary-card-1 {
            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
            position: relative;
            overflow: hidden;
        }
        .summary-card-1::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        .summary-card-2 {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%);
            position: relative;
            overflow: hidden;
        }
        .summary-card-2::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        .summary-card-3 {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%);
            position: relative;
            overflow: hidden;
        }
        .summary-card-3::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        .payment-section {
            background: linear-gradient(145deg, rgba(249,250,251,0.9), rgba(243,244,246,0.8));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .monthly-section {
            background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(147,197,253,0.1));
            border: 1px solid rgba(59,130,246,0.2);
        }
        .semester-section {
            background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(110,231,183,0.1));
            border: 1px solid rgba(16,185,129,0.2);
        }
        .yearly-section {
            background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(196,181,253,0.1));
            border: 1px solid rgba(139,92,246,0.2);
        }
        .onetime-section {
            background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(251,191,36,0.1));
            border: 1px solid rgba(245,158,11,0.2);
        }
        .payment-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.95), rgba(248,250,252,0.9));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.4);
            transition: all 0.3s ease;
        }
        .payment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .status-paid { background: linear-gradient(135deg, #10b981, #059669); }
        .status-unpaid { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .status-partial { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .tab-active {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
            box-shadow: 0 4px 15px rgba(59,130,246,0.3);
        }
        .tab-inactive {
            background: linear-gradient(145deg, rgba(255,255,255,0.8), rgba(243,244,246,0.6));
            backdrop-filter: blur(10px);
        }
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        .search-button {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%);
            box-shadow: 0 8px 25px rgba(59,130,246,0.3);
            transition: all 0.3s ease;
        }
        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(59,130,246,0.4);
        }
        .connection-status {
            background: linear-gradient(145deg, rgba(255,255,255,0.9), rgba(248,250,252,0.8));
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 8px 16px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .floating { animation: float 3s ease-in-out infinite; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-6 shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center">
                        <span class="text-2xl font-bold text-blue-600">üè´</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Sistem Informasi SPP</h1>
                        <p class="text-blue-100">SMA Negeri 1 Jakarta</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-blue-100">Tahun Ajaran 2024/2025</p>
                    <p class="text-xs text-blue-200">Periode 3 Tahun (Kelas 10-12)</p>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <!-- Search Section -->
        <div class="search-card rounded-xl card-shadow p-8 mb-8 floating">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Cek Status Pembayaran SPP</h2>
                <p class="text-gray-600">Masukkan NISN untuk melihat informasi pembayaran Anda</p>
            </div>
            
            <div class="max-w-md mx-auto">
                <div class="relative">
                    <input 
                        type="text" 
                        id="nisnInput" 
                        placeholder="Masukkan NISN (10 digit)"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-center text-lg font-medium"
                        maxlength="10"
                    >
                    <button 
                        onclick="searchStudent()" 
                        id="searchButton"
                        class="w-full mt-4 search-button text-white py-3 px-6 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 flex items-center justify-center"
                    >
                        <span id="searchText">üîç Cari Data Siswa</span>
                        <div id="loadingSpinner" class="loading-spinner ml-2 hidden"></div>
                    </button>
                </div>
            </div>

            <!-- Connection Status -->
            <div id="connectionStatus" class="mt-4 text-center text-sm">
                <span class="connection-status text-gray-600">üì° Menghubungkan ke database...</span>
            </div>
        </div>

        <!-- Student Info Section -->
        <div id="studentInfo" class="hidden student-info-card rounded-xl card-shadow p-8 mb-8">
            <div class="flex items-center space-x-6 mb-6 pb-6 border-b">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                    <span id="studentInitial">A</span>
                </div>
                <div class="flex-1">
                    <h3 class="text-2xl font-bold text-gray-800" id="studentName">Nama Siswa</h3>
                    <div class="grid grid-cols-2 gap-4 mt-2 text-sm text-gray-600">
                        <p><span class="font-medium">NISN:</span> <span id="displayNisn">-</span></p>
                        <p><span class="font-medium">Kelas:</span> <span id="studentClass">-</span></p>
                        <p><span class="font-medium">Jurusan:</span> <span id="studentMajor">-</span></p>
                        <p><span class="font-medium">Jenis Kelamin:</span> <span id="studentGender">-</span></p>
                        <p><span class="font-medium">Tahun Masuk:</span> <span id="entryYear">-</span></p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-500 mb-1">Status Pembayaran Bulan Ini</div>
                    <div id="currentMonthStatus" class="px-4 py-2 rounded-full text-white font-semibold text-sm">
                        Belum Dicek
                    </div>
                </div>
            </div>

            <!-- Payment Summary -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="summary-card-1 text-white p-6 rounded-xl relative z-10">
                    <div class="flex items-center justify-between relative z-10">
                        <div>
                            <p class="text-green-100 text-sm">Total Terbayar</p>
                            <p class="text-2xl font-bold" id="totalPaid">Rp 0</p>
                        </div>
                        <div class="text-3xl">‚úÖ</div>
                    </div>
                </div>
                <div class="summary-card-2 text-white p-6 rounded-xl relative z-10">
                    <div class="flex items-center justify-between relative z-10">
                        <div>
                            <p class="text-red-100 text-sm">Total Tunggakan</p>
                            <p class="text-2xl font-bold" id="totalUnpaid">Rp 0</p>
                        </div>
                        <div class="text-3xl">‚è∞</div>
                    </div>
                </div>
                <div class="summary-card-3 text-white p-6 rounded-xl relative z-10">
                    <div class="flex items-center justify-between relative z-10">
                        <div>
                            <p class="text-blue-100 text-sm">Total SPP 3 Tahun</p>
                            <p class="text-2xl font-bold" id="totalSpp">Rp 5.700.000</p>
                        </div>
                        <div class="text-3xl">üí∞</div>
                    </div>
                </div>
            </div>

            <!-- Year Tabs -->
            <div class="flex space-x-1 mb-6 payment-section p-1 rounded-lg" id="yearTabs">
                <button onclick="showYear(10)" id="tab10" class="flex-1 py-3 px-4 rounded-md font-semibold transition-all duration-300 tab-active text-white">
                    Kelas 10 (2024/2025)
                </button>
                <button onclick="showYear(11)" id="tab11" class="flex-1 py-3 px-4 rounded-md font-semibold transition-all duration-300 tab-inactive text-gray-600 hover:bg-gray-200">
                    Kelas 11 (2025/2026)
                </button>
                <button onclick="showYear(12)" id="tab12" class="flex-1 py-3 px-4 rounded-md font-semibold transition-all duration-300 tab-inactive text-gray-600 hover:bg-gray-200">
                    Kelas 12 (2026/2027)
                </button>
            </div>

            <!-- Payment Details -->
            <div id="paymentDetails">
                <!-- Payment details will be populated by JavaScript -->
            </div>
        </div>

        <!-- Info Section -->
        <div class="info-card rounded-xl card-shadow p-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚ÑπÔ∏è Informasi Pembayaran</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-semibold text-gray-700 mb-3">Struktur Biaya per Kelas:</h4>
                    
                    <div class="space-y-3 mb-4">
                        <div class="bg-blue-50 rounded-lg p-3">
                            <h5 class="font-semibold text-blue-800 mb-2">üí∞ Biaya Bulanan</h5>
                            <div class="text-sm text-blue-700 space-y-1">
                                <p>‚Ä¢ SPP Kelas 10: Rp 125.000/bulan</p>
                                <p>‚Ä¢ SPP Kelas 11-12: Rp 175.000/bulan</p>
                                <p>‚Ä¢ Tabungan: Rp 50.000/bulan (Kelas 10)</p>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 rounded-lg p-3">
                            <h5 class="font-semibold text-green-800 mb-2">üìö Biaya Semester</h5>
                            <div class="text-sm text-green-700 space-y-1">
                                <p>‚Ä¢ Buku LKS: Rp 150.000</p>
                                <p>‚Ä¢ Ulangan Harian: Rp 100.000</p>
                                <p>‚Ä¢ Ulangan Semester: Rp 120.000</p>
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 rounded-lg p-3">
                            <h5 class="font-semibold text-purple-800 mb-2">üéì Biaya Sekali Bayar</h5>
                            <div class="text-sm text-purple-700 space-y-1">
                                <p>‚Ä¢ Siswa Baru Putra: Rp 1.200.000</p>
                                <p>‚Ä¢ Siswi Baru Putri: Rp 1.350.000</p>
                                <p>‚Ä¢ Study Tour: Rp 500.000</p>
                                <p>‚Ä¢ Perpisahan: Rp 1.000.000</p>
                            </div>
                        </div>
                    </div>
                    
                    <h4 class="font-semibold text-gray-700 mb-2">Cara Pembayaran:</h4>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>‚Ä¢ Bank BNI: 1234567890 (SMA Negeri 1)</li>
                        <li>‚Ä¢ Bank Mandiri: 0987654321 (SMA Negeri 1)</li>
                        <li>‚Ä¢ Kantin Sekolah (Tunai)</li>
                        <li>‚Ä¢ Transfer Digital (QRIS)</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-700 mb-2">Jenis Pembayaran:</h4>
                    <div class="grid grid-cols-2 gap-2 text-xs text-gray-600 mb-4">
                        <div>‚Ä¢ üìö SPP</div>
                        <div>‚Ä¢ üè¶ Tabungan</div>
                        <div>‚Ä¢ üìñ LKS</div>
                        <div>‚Ä¢ üìù UHB</div>
                        <div>‚Ä¢ üìù PAS</div>
                        <div>‚Ä¢ ü§≤ Infaq Kenaikan</div>
                        <div>‚Ä¢ üéì Perpisahan</div>
                        <div>‚Ä¢ üöå Studi Tour</div>
                        <div>‚Ä¢ üìî Buku Kenangan</div>
                        <div>‚Ä¢ üìã Ujian Akhir</div>
                    </div>
                    
                    <h4 class="font-semibold text-gray-700 mb-2">Jadwal Pembayaran:</h4>
                    <ul class="text-sm text-gray-600 space-y-1 mb-4">
                        <li>‚Ä¢ Tanggal 1-10: Pembayaran Normal</li>
                        <li>‚Ä¢ Tanggal 11-20: Denda Rp 25.000</li>
                        <li>‚Ä¢ Tanggal 21-31: Denda Rp 50.000</li>
                    </ul>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <p class="text-xs text-yellow-800">
                            <strong>Catatan:</strong> Siswa yang menunggak lebih dari 2 bulan tidak diperkenankan mengikuti ujian semester.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google Sheets Configuration
        const GOOGLE_SHEETS_CONFIG = {
            SHEET_ID: '17MDc804lNUm_XwUM6hPj6Ui8T-JVtpxJCLq4XovVs0A',
            SHEET_NAME: 'Sheet7',
            API_KEY: 'AIzaSyCAJWvsjw92iebZM54KZivepTpl_Q2gk70'
        };

        let sheetsData = [];
        let currentStudent = null;
        let currentYear = 10;

        // Initialize the application
        async function initializeApp() {
            try {
                await loadSheetsData();
                updateConnectionStatus('‚úÖ Terhubung ke database', 'text-green-600');
            } catch (error) {
                console.error('Failed to load sheets data:', error);
                updateConnectionStatus('‚ùå Gagal terhubung ke database', 'text-red-600');
            }
        }

        // Load data from Google Sheets
        async function loadSheetsData() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.SHEET_ID}/values/${GOOGLE_SHEETS_CONFIG.SHEET_NAME}?key=${GOOGLE_SHEETS_CONFIG.API_KEY}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                sheetsData = data.values || [];
                console.log('Data loaded from Google Sheets:', sheetsData.length, 'rows');
                return sheetsData;
            } catch (error) {
                console.error('Error loading Google Sheets data:', error);
                throw error;
            }
        }

        // Update connection status
        function updateConnectionStatus(message, className) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.innerHTML = `<span class="${className}">${message}</span>`;
        }

        // Search for student by NISN
        async function searchStudent() {
            const nisn = document.getElementById('nisnInput').value.trim();
            
            if (nisn.length !== 10) {
                alert('NISN harus 10 digit!');
                return;
            }

            // Show loading state
            setLoadingState(true);

            try {
                // Reload data to get latest information
                await loadSheetsData();
                
                // Find student in sheets data
                const student = findStudentByNISN(nisn);
                
                if (!student) {
                    alert('NISN tidak ditemukan dalam database!');
                    setLoadingState(false);
                    return;
                }

                currentStudent = student;
                displayStudentInfo(nisn, student);
                
            } catch (error) {
                console.error('Error searching student:', error);
                alert('Terjadi kesalahan saat mencari data siswa. Silakan coba lagi.');
            } finally {
                setLoadingState(false);
            }
        }

        // Find student by NISN in sheets data
        function findStudentByNISN(nisn) {
            if (sheetsData.length === 0) return null;
            
            // Assuming first row contains headers
            const headers = sheetsData[0];
            const nisnColumnIndex = headers.findIndex(header => 
                header.toLowerCase().includes('nisn')
            );
            
            if (nisnColumnIndex === -1) {
                console.error('NISN column not found in sheets data');
                return null;
            }

            // Find the row with matching NISN
            const studentRow = sheetsData.find((row, index) => {
                if (index === 0) return false; // Skip header row
                return row[nisnColumnIndex] === nisn;
            });

            if (!studentRow) return null;

            // Parse student data from the row
            return parseStudentData(headers, studentRow);
        }

        // Fee structure based on detailed breakdown
        const FEE_STRUCTURE = {
            // One-time payments (paid once in 3 years)
            oneTime: {
                'Siswa Baru Putra': 1200000,
                'Siswi Baru Putri': 1350000,
                'Perpisahan': 1000000,
                'Study Tour': 500000,
                'Buku Kenangan': 50000,
                'Ujian Akhir': 50000
            },
            // Monthly payments
            monthly: {
                'SPP': {
                    10: 125000,
                    11: 175000,
                    12: 175000
                },
                'Tabungan': 50000 // Only for grade 10
            },
            // Semester payments (2 times per year)
            semester: {
                'Buku LKS': 150000,
                'Ulangan Harian': 100000,
                'Ulangan Semester': 120000
            },
            // Yearly payments
            yearly: {
                'Infaq Kenaikan Kelas': 150000
            }
        };

        // Parse student data from sheets row
        function parseStudentData(headers, row) {
            const student = {
                name: '',
                class: '',
                major: '',
                entryYear: '',
                gender: '',
                payments: {
                    10: {},
                    11: {},
                    12: {}
                }
            };

            // Map basic student info
            headers.forEach((header, index) => {
                const value = row[index] || '';
                const headerLower = header.toLowerCase();
                
                if (headerLower.includes('nama')) {
                    student.name = value;
                } else if (headerLower.includes('kelas')) {
                    student.class = value;
                } else if (headerLower.includes('jurusan')) {
                    student.major = value;
                } else if (headerLower.includes('tahun')) {
                    student.entryYear = value;
                } else if (headerLower.includes('jenis_kelamin') || headerLower.includes('gender') || headerLower.includes('kelamin')) {
                    // Normalize gender values
                    const genderValue = value.toLowerCase().trim();
                    if (genderValue.includes('laki') || genderValue === 'l' || genderValue === 'male' || genderValue === 'putra') {
                        student.gender = 'laki-laki';
                    } else if (genderValue.includes('perempuan') || genderValue === 'p' || genderValue === 'female' || genderValue === 'putri') {
                        student.gender = 'perempuan';
                    } else {
                        student.gender = genderValue;
                    }
                }
            });

            // Parse payment data for each grade and payment type
            [10, 11, 12].forEach(grade => {
                const gradePayments = {};
                
                // One-time payments distributed by grade
                Object.keys(FEE_STRUCTURE.oneTime).forEach(feeType => {
                    let shouldInclude = false;
                    
                    // Grade 10: Only new student fees
                    if (grade === 10) {
                        if (feeType === 'Siswa Baru Putra' && student.gender === 'laki-laki') shouldInclude = true;
                        if (feeType === 'Siswi Baru Putri' && student.gender === 'perempuan') shouldInclude = true;
                    }
                    
                    // Grade 11: Study Tour
                    if (grade === 11) {
                        if (feeType === 'Study Tour') shouldInclude = true;
                    }
                    
                    // Grade 12: Graduation-related fees
                    if (grade === 12) {
                        if (feeType === 'Perpisahan' || feeType === 'Buku Kenangan' || feeType === 'Ujian Akhir') {
                            shouldInclude = true;
                        }
                    }
                    
                    if (shouldInclude) {
                        const expectedAmount = FEE_STRUCTURE.oneTime[feeType];
                        const paymentStatus = checkPaymentStatus(headers, row, feeType, grade, expectedAmount);
                        gradePayments[feeType] = {
                            paid: paymentStatus.paid,
                            amount: expectedAmount,
                            paidAmount: paymentStatus.amount,
                            remaining: paymentStatus.remaining,
                            status: paymentStatus.status,
                            installments: paymentStatus.installments,
                            date: paymentStatus.paid ? new Date().toISOString().split('T')[0] : null,
                            type: 'oneTime',
                            frequency: 'Sekali dalam 3 tahun'
                        };
                    }
                });
                
                // Monthly payments
                Object.keys(FEE_STRUCTURE.monthly).forEach(feeType => {
                    // Tabungan only for grade 10
                    if (feeType === 'Tabungan' && grade !== 10) return;
                    
                    // For monthly payments, create entries for each month
                    const months = [
                        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember',
                        'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni'
                    ];
                    
                    months.forEach((month, monthIndex) => {
                        const monthKey = `${feeType} ${month}`;
                        
                        // Get the correct amount based on fee type and grade
                        let expectedAmount;
                        if (feeType === 'SPP') {
                            expectedAmount = FEE_STRUCTURE.monthly[feeType][grade];
                        } else {
                            expectedAmount = FEE_STRUCTURE.monthly[feeType];
                        }
                        
                        const paymentStatus = checkPaymentStatus(headers, row, `${feeType}_${month}`, grade, expectedAmount);
                        
                        gradePayments[monthKey] = {
                            paid: paymentStatus.paid,
                            amount: expectedAmount,
                            paidAmount: paymentStatus.amount,
                            remaining: paymentStatus.remaining,
                            status: paymentStatus.status,
                            installments: paymentStatus.installments,
                            date: paymentStatus.paid ? new Date().toISOString().split('T')[0] : null,
                            type: 'monthly',
                            frequency: 'Per bulan'
                        };
                    });
                });
                
                // Semester payments (2 times per year)
                Object.keys(FEE_STRUCTURE.semester).forEach(feeType => {
                    ['Semester 1', 'Semester 2'].forEach(semester => {
                        const semesterKey = `${feeType} ${semester}`;
                        const expectedAmount = FEE_STRUCTURE.semester[feeType];
                        const paymentStatus = checkPaymentStatus(headers, row, `${feeType}_${semester}`, grade, expectedAmount);
                        
                        gradePayments[semesterKey] = {
                            paid: paymentStatus.paid,
                            amount: expectedAmount,
                            paidAmount: paymentStatus.amount,
                            remaining: paymentStatus.remaining,
                            status: paymentStatus.status,
                            installments: paymentStatus.installments,
                            date: paymentStatus.paid ? new Date().toISOString().split('T')[0] : null,
                            type: 'semester',
                            frequency: 'Per semester'
                        };
                    });
                });
                
                // Yearly payments
                Object.keys(FEE_STRUCTURE.yearly).forEach(feeType => {
                    const expectedAmount = FEE_STRUCTURE.yearly[feeType];
                    const paymentStatus = checkPaymentStatus(headers, row, feeType, grade, expectedAmount);
                    
                    gradePayments[feeType] = {
                        paid: paymentStatus.paid,
                        amount: expectedAmount,
                        paidAmount: paymentStatus.amount,
                        remaining: paymentStatus.remaining,
                        status: paymentStatus.status,
                        installments: paymentStatus.installments,
                        date: paymentStatus.paid ? new Date().toISOString().split('T')[0] : null,
                        type: 'yearly',
                        frequency: 'Per tahun'
                    };
                });
                
                student.payments[grade] = gradePayments;
            });
            
            return student;
        }
        
        // Helper function to check payment status with installment support
        function checkPaymentStatus(headers, row, feeType, grade, expectedAmount) {
            // Create comprehensive list of possible column name patterns
            const feeTypeClean = feeType.replace(/\s+/g, '').toLowerCase();
            const feeTypeUnderscore = feeType.replace(/\s+/g, '_').toLowerCase();
            
            // Map common fee type abbreviations
            const feeTypeMap = {
                'spp': ['spp'],
                'tabungan': ['tabungan', 'tab'],
                'buku_lks': ['lks', 'buku_lks', 'bukulks'],
                'ulangan_harian': ['uhb', 'ulangan_harian', 'ulanganharian', 'uh'],
                'ulangan_semester': ['pas', 'ulangan_semester', 'ulangansemester', 'us', 'uas'],
                'infaq_kenaikan_kelas': ['infaq', 'infaq_kenaikan', 'infaqkenaikan'],
                'perpisahan': ['perpisahan'],
                'study_tour': ['studytour', 'study_tour', 'tour'],
                'buku_kenangan': ['buku_kenangan', 'bukukenangan'],
                'ujian_akhir': ['ujian_akhir', 'ujianakhir', 'ua'],
                'siswa_baru_putra': ['siswa_baru', 'siswabaru', 'putra'],
                'siswi_baru_putri': ['siswi_baru', 'siswibaruputri', 'putri']
            };
            
            // Get possible fee type variations
            let feeVariations = [feeTypeClean, feeTypeUnderscore];
            
            // Add mapped variations
            Object.entries(feeTypeMap).forEach(([key, variations]) => {
                if (feeTypeClean.includes(key) || key.includes(feeTypeClean)) {
                    feeVariations = feeVariations.concat(variations);
                }
            });
            
            // Remove duplicates
            feeVariations = [...new Set(feeVariations)];
            
            // Create all possible column name patterns
            const possibleColumnNames = [];
            
            feeVariations.forEach(feeVar => {
                // Direct patterns
                possibleColumnNames.push(feeVar);
                possibleColumnNames.push(`${feeVar}_${grade}`);
                possibleColumnNames.push(`${feeVar}_kelas_${grade}`);
                possibleColumnNames.push(`kelas_${grade}_${feeVar}`);
                possibleColumnNames.push(`${feeVar}${grade}`);
                possibleColumnNames.push(`${grade}_${feeVar}`);
                
                // With month patterns for monthly payments
                if (feeType.includes('Juli') || feeType.includes('Agustus') || feeType.includes('September') || 
                    feeType.includes('Oktober') || feeType.includes('November') || feeType.includes('Desember') ||
                    feeType.includes('Januari') || feeType.includes('Februari') || feeType.includes('Maret') ||
                    feeType.includes('April') || feeType.includes('Mei') || feeType.includes('Juni')) {
                    
                    const monthMatch = feeType.match(/(Juli|Agustus|September|Oktober|November|Desember|Januari|Februari|Maret|April|Mei|Juni)/);
                    if (monthMatch) {
                        const month = monthMatch[1].toLowerCase();
                        const baseType = feeType.replace(monthMatch[1], '').trim().replace(/\s+/g, '').toLowerCase();
                        
                        possibleColumnNames.push(`${baseType}_${month}_${grade}`);
                        possibleColumnNames.push(`${baseType}_${grade}_${month}`);
                        possibleColumnNames.push(`${month}_${baseType}_${grade}`);
                        possibleColumnNames.push(`${grade}_${baseType}_${month}`);
                        possibleColumnNames.push(`${baseType}${month}${grade}`);
                        possibleColumnNames.push(`${baseType}_${month}`);
                        possibleColumnNames.push(`${month}_${baseType}`);
                    }
                }
                
                // With semester patterns
                if (feeType.includes('Semester')) {
                    const semesterMatch = feeType.match(/(Semester\s*[12])/);
                    if (semesterMatch) {
                        const semester = semesterMatch[1].replace(/\s+/g, '').toLowerCase();
                        const baseType = feeType.replace(semesterMatch[1], '').trim().replace(/\s+/g, '').toLowerCase();
                        
                        possibleColumnNames.push(`${baseType}_${semester}_${grade}`);
                        possibleColumnNames.push(`${baseType}_${grade}_${semester}`);
                        possibleColumnNames.push(`${semester}_${baseType}_${grade}`);
                        possibleColumnNames.push(`${grade}_${baseType}_${semester}`);
                    }
                }
            });
            
            let paymentColumnIndex = -1;
            let matchedColumnName = '';
            let bestMatchScore = 0;
            
            // Try to find the best matching column with scoring
            headers.forEach((header, index) => {
                const headerNormalized = header.toLowerCase().replace(/[\s_-]/g, '');
                
                possibleColumnNames.forEach(columnName => {
                    const columnNormalized = columnName.toLowerCase().replace(/[\s_-]/g, '');
                    
                    let score = 0;
                    
                    // Exact match gets highest score
                    if (headerNormalized === columnNormalized) {
                        score = 100;
                    }
                    // Contains match
                    else if (headerNormalized.includes(columnNormalized)) {
                        score = 80;
                    }
                    // Reverse contains match
                    else if (columnNormalized.includes(headerNormalized)) {
                        score = 70;
                    }
                    // Partial match with grade
                    else if (headerNormalized.includes(grade.toString()) && 
                             (headerNormalized.includes(feeTypeClean) || 
                              feeVariations.some(v => headerNormalized.includes(v)))) {
                        score = 60;
                    }
                    
                    if (score > bestMatchScore) {
                        bestMatchScore = score;
                        paymentColumnIndex = index;
                        matchedColumnName = header;
                    }
                });
            });
            
            // Debug logging
            if (paymentColumnIndex !== -1) {
                console.log(`Found column for ${feeType} grade ${grade}: "${matchedColumnName}" (score: ${bestMatchScore})`);
            } else {
                console.log(`No column found for ${feeType} grade ${grade}. Tried variations:`, feeVariations);
                console.log('Available headers:', headers);
            }
            
            if (paymentColumnIndex === -1 || !row[paymentColumnIndex]) {
                return {
                    paid: false,
                    amount: 0,
                    remaining: expectedAmount,
                    status: 'unpaid',
                    installments: []
                };
            }
            
            const cellValue = row[paymentColumnIndex].toString().trim();
            
            // Check for full payment indicators
            if (cellValue.toLowerCase() === 'lunas' || 
                cellValue.toLowerCase() === 'paid' || 
                cellValue === '1') {
                return {
                    paid: true,
                    amount: expectedAmount,
                    remaining: 0,
                    status: 'paid',
                    installments: [{
                        amount: expectedAmount,
                        date: new Date().toISOString().split('T')[0],
                        note: 'Lunas'
                    }]
                };
            }
            
            // Check for numeric values (installments)
            const numericValue = parseFloat(cellValue.replace(/[^\d.-]/g, ''));
            if (!isNaN(numericValue) && numericValue > 0) {
                const remaining = Math.max(0, expectedAmount - numericValue);
                const isPaid = remaining === 0;
                
                return {
                    paid: isPaid,
                    amount: numericValue,
                    remaining: remaining,
                    status: isPaid ? 'paid' : 'installment',
                    installments: [{
                        amount: numericValue,
                        date: new Date().toISOString().split('T')[0],
                        note: isPaid ? 'Lunas' : 'Cicilan'
                    }]
                };
            }
            
            // Check for multiple installments (comma or semicolon separated)
            if (cellValue.includes(',') || cellValue.includes(';')) {
                const separator = cellValue.includes(',') ? ',' : ';';
                const installmentStrings = cellValue.split(separator);
                const installments = [];
                let totalPaid = 0;
                
                installmentStrings.forEach((installmentStr, index) => {
                    const cleanStr = installmentStr.trim();
                    const amount = parseFloat(cleanStr.replace(/[^\d.-]/g, ''));
                    
                    if (!isNaN(amount) && amount > 0) {
                        totalPaid += amount;
                        installments.push({
                            amount: amount,
                            date: new Date().toISOString().split('T')[0],
                            note: `Cicilan ${index + 1}`
                        });
                    }
                });
                
                if (installments.length > 0) {
                    const remaining = Math.max(0, expectedAmount - totalPaid);
                    const isPaid = remaining === 0;
                    
                    return {
                        paid: isPaid,
                        amount: totalPaid,
                        remaining: remaining,
                        status: isPaid ? 'paid' : 'installment',
                        installments: installments
                    };
                }
            }
            
            // Default: unpaid
            return {
                paid: false,
                amount: 0,
                remaining: expectedAmount,
                status: 'unpaid',
                installments: []
            };
        }

        // Set loading state for search button
        function setLoadingState(loading) {
            const button = document.getElementById('searchButton');
            const text = document.getElementById('searchText');
            const spinner = document.getElementById('loadingSpinner');
            
            if (loading) {
                text.textContent = 'Mencari...';
                spinner.classList.remove('hidden');
                button.disabled = true;
                button.classList.add('opacity-75');
            } else {
                text.textContent = 'üîç Cari Data Siswa';
                spinner.classList.add('hidden');
                button.disabled = false;
                button.classList.remove('opacity-75');
            }
        }

        // Display student information
        function displayStudentInfo(nisn, student) {
            // Show student info section
            document.getElementById('studentInfo').classList.remove('hidden');
            
            // Calculate current class based on entry year
            const currentClass = calculateCurrentClass(student.entryYear);
            
            // Fill student details
            document.getElementById('studentName').textContent = student.name || 'Nama tidak tersedia';
            document.getElementById('displayNisn').textContent = nisn;
            document.getElementById('studentClass').textContent = currentClass;
            document.getElementById('studentMajor').textContent = student.major || '-';
            document.getElementById('studentGender').textContent = student.gender === 'laki-laki' ? 'Laki-laki' : student.gender === 'perempuan' ? 'Perempuan' : (student.gender || '-');
            document.getElementById('entryYear').textContent = student.entryYear || '-';
            document.getElementById('studentInitial').textContent = (student.name || 'A').charAt(0);

            // Update tab years based on entry year
            updateTabYears(student.entryYear);

            // Calculate totals
            calculateTotals(student);
            
            // Show current year payments
            showYear(currentYear);
            
            // Update current month status
            updateCurrentMonthStatus(student);
        }

        // Calculate payment totals
        function calculateTotals(student) {
            let totalPaid = 0;
            let totalUnpaid = 0;

            Object.values(student.payments).forEach(yearPayments => {
                Object.values(yearPayments).forEach(payment => {
                    // Add the actual paid amount
                    totalPaid += payment.paidAmount || 0;
                    // Add the remaining amount to unpaid
                    totalUnpaid += payment.remaining || 0;
                });
            });

            document.getElementById('totalPaid').textContent = formatCurrency(totalPaid);
            document.getElementById('totalUnpaid').textContent = formatCurrency(totalUnpaid);
        }

        // Update current month status
        function updateCurrentMonthStatus(student) {
            // Check SPP payment status for current grade
            const currentGrade = getCurrentGrade(student);
            let sppPaid = false;
            
            if (student.payments[currentGrade] && student.payments[currentGrade]['SPP']) {
                sppPaid = student.payments[currentGrade]['SPP'].paid;
            }

            const statusElement = document.getElementById('currentMonthStatus');
            if (sppPaid) {
                statusElement.textContent = 'SPP Lunas';
                statusElement.className = 'px-4 py-2 rounded-full text-white font-semibold text-sm status-paid';
            } else {
                statusElement.textContent = 'SPP Belum Bayar';
                statusElement.className = 'px-4 py-2 rounded-full text-white font-semibold text-sm status-unpaid';
            }
        }

        // Calculate current class based on entry year
        function calculateCurrentClass(entryYear) {
            if (!entryYear) return '-';
            
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1; // JavaScript months are 0-indexed
            const entryYearInt = parseInt(entryYear);
            
            // School year starts in July (month 7)
            // If current month is January-June, we're still in the previous academic year
            let academicYear = currentYear;
            if (currentMonth < 7) {
                academicYear = currentYear - 1;
            }
            
            const yearsSinceEntry = academicYear - entryYearInt;
            
            if (yearsSinceEntry < 0) return 'Belum Masuk';
            else if (yearsSinceEntry === 0) return '10';
            else if (yearsSinceEntry === 1) return '11';
            else if (yearsSinceEntry === 2) return '12';
            else return 'Lulus';
        }

        // Get current grade based on entry year
        function getCurrentGrade(student) {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;
            const entryYear = parseInt(student.entryYear);
            
            // School year starts in July
            let academicYear = currentYear;
            if (currentMonth < 7) {
                academicYear = currentYear - 1;
            }
            
            const yearsSinceEntry = academicYear - entryYear;
            
            if (yearsSinceEntry <= 0) return 10;
            else if (yearsSinceEntry === 1) return 11;
            else return 12;
        }

        // Update tab years based on student's entry year
        function updateTabYears(entryYear) {
            if (!entryYear) return;
            
            const entryYearInt = parseInt(entryYear);
            
            // Calculate academic years for each grade
            const grade10Year = `${entryYearInt}/${entryYearInt + 1}`;
            const grade11Year = `${entryYearInt + 1}/${entryYearInt + 2}`;
            const grade12Year = `${entryYearInt + 2}/${entryYearInt + 3}`;
            
            // Update tab text content
            document.getElementById('tab10').innerHTML = `Kelas 10 (${grade10Year})`;
            document.getElementById('tab11').innerHTML = `Kelas 11 (${grade11Year})`;
            document.getElementById('tab12').innerHTML = `Kelas 12 (${grade12Year})`;
        }

        // Show payments for specific year
        function showYear(year) {
            currentYear = year;
            
            // Update tab styles
            document.querySelectorAll('[id^="tab"]').forEach(tab => {
                tab.className = 'flex-1 py-3 px-4 rounded-md font-semibold transition-all duration-300 tab-inactive text-gray-600 hover:bg-gray-200';
            });
            document.getElementById(`tab${year}`).className = 'flex-1 py-3 px-4 rounded-md font-semibold transition-all duration-300 tab-active text-white';

            // Display payment details for the year
            displayPaymentDetails(year);
        }

        // Display payment details for a specific year
        function displayPaymentDetails(year) {
            if (!currentStudent) return;

            const payments = currentStudent.payments[year];
            const detailsContainer = document.getElementById('paymentDetails');
            
            // Group payments by frequency
            const paymentsByFrequency = {
                monthly: [],
                semester: [],
                yearly: [],
                oneTime: []
            };

            Object.entries(payments).forEach(([feeType, payment]) => {
                const paymentData = { feeType, ...payment };
                
                if (payment.type === 'monthly') {
                    paymentsByFrequency.monthly.push(paymentData);
                } else if (payment.type === 'semester') {
                    paymentsByFrequency.semester.push(paymentData);
                } else if (payment.type === 'yearly') {
                    paymentsByFrequency.yearly.push(paymentData);
                } else if (payment.type === 'oneTime') {
                    paymentsByFrequency.oneTime.push(paymentData);
                }
            });

            let html = `
                <div class="payment-section rounded-lg p-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-6">Detail Pembayaran Kelas ${year}</h4>
            `;

            // Monthly Payments Section
            if (paymentsByFrequency.monthly.length > 0) {
                html += `
                    <div class="mb-8 monthly-section rounded-lg p-4">
                        <div class="flex items-center mb-4">
                            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mr-3">
                                <span class="text-white text-sm font-bold">üìÖ</span>
                            </div>
                            <h5 class="text-lg font-semibold text-blue-800">Pembayaran Bulanan</h5>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                `;
                
                paymentsByFrequency.monthly.forEach(payment => {
                    html += generatePaymentCard(payment);
                });
                
                html += `
                        </div>
                    </div>
                `;
            }

            // Semester Payments Section
            if (paymentsByFrequency.semester.length > 0) {
                html += `
                    <div class="mb-8 semester-section rounded-lg p-4">
                        <div class="flex items-center mb-4">
                            <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center mr-3">
                                <span class="text-white text-sm font-bold">üìö</span>
                            </div>
                            <h5 class="text-lg font-semibold text-green-800">Pembayaran Per Semester</h5>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                `;
                
                paymentsByFrequency.semester.forEach(payment => {
                    html += generatePaymentCard(payment);
                });
                
                html += `
                        </div>
                    </div>
                `;
            }

            // Yearly Payments Section
            if (paymentsByFrequency.yearly.length > 0) {
                html += `
                    <div class="mb-8 yearly-section rounded-lg p-4">
                        <div class="flex items-center mb-4">
                            <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center mr-3">
                                <span class="text-white text-sm font-bold">üóìÔ∏è</span>
                            </div>
                            <h5 class="text-lg font-semibold text-purple-800">Pembayaran Tahunan</h5>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                `;
                
                paymentsByFrequency.yearly.forEach(payment => {
                    html += generatePaymentCard(payment);
                });
                
                html += `
                        </div>
                    </div>
                `;
            }

            // One-time Payments Section
            if (paymentsByFrequency.oneTime.length > 0) {
                html += `
                    <div class="mb-8 onetime-section rounded-lg p-4">
                        <div class="flex items-center mb-4">
                            <div class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center mr-3">
                                <span class="text-white text-sm font-bold">‚≠ê</span>
                            </div>
                            <h5 class="text-lg font-semibold text-orange-800">Pembayaran Sekali dalam 3 Tahun</h5>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                `;
                
                paymentsByFrequency.oneTime.forEach(payment => {
                    html += generatePaymentCard(payment);
                });
                
                html += `
                        </div>
                    </div>
                `;
            }

            html += `
                </div>
            `;

            detailsContainer.innerHTML = html;
        }

        // Generate payment card HTML
        function generatePaymentCard(payment) {
            let statusClass, statusIcon, statusText;
            
            if (payment.status === 'paid') {
                statusClass = 'status-paid';
                statusIcon = '‚úÖ';
                statusText = 'Lunas';
            } else if (payment.status === 'installment') {
                statusClass = 'status-partial';
                statusIcon = 'üîÑ';
                statusText = 'Cicilan';
            } else {
                statusClass = 'status-unpaid';
                statusIcon = '‚è∞';
                statusText = 'Belum Bayar';
            }
            
            const paymentDate = payment.paid ? `Dibayar: ${formatDate(payment.date)}` : 'Belum ada pembayaran';

            // Get fee type icon
            let feeIcon = 'üí∞';
            if (payment.feeType.includes('SPP')) feeIcon = 'üìö';
            else if (payment.feeType.includes('Tabungan')) feeIcon = 'üè¶';
            else if (payment.feeType.includes('LKS')) feeIcon = 'üìñ';
            else if (payment.feeType.includes('Ulangan Harian')) feeIcon = 'üìù';
            else if (payment.feeType.includes('Ulangan Semester')) feeIcon = 'üìã';
            else if (payment.feeType.includes('Infaq')) feeIcon = 'ü§≤';
            else if (payment.feeType.includes('Perpisahan')) feeIcon = 'üéì';
            else if (payment.feeType.includes('Study Tour')) feeIcon = 'üöå';
            else if (payment.feeType.includes('Buku Kenangan')) feeIcon = 'üìî';
            else if (payment.feeType.includes('Ujian')) feeIcon = 'üìã';
            else if (payment.feeType.includes('Siswa Baru') || payment.feeType.includes('Siswi Baru')) feeIcon = 'üÜï';

            // Determine border color based on status
            let borderColor = 'border-red-500';
            if (payment.status === 'paid') borderColor = 'border-green-500';
            else if (payment.status === 'installment') borderColor = 'border-yellow-500';

            // Build installment details
            let installmentDetails = '';
            if (payment.installments && payment.installments.length > 0) {
                installmentDetails = `
                    <div class="mt-3 pt-2 border-t border-gray-200">
                        <div class="text-xs text-gray-600 mb-1">Detail Pembayaran:</div>
                        ${payment.installments.map(inst => `
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>${inst.note}</span>
                                <span>${formatCurrency(inst.amount)}</span>
                            </div>
                        `).join('')}
                        ${payment.remaining > 0 ? `
                            <div class="flex justify-between text-xs font-medium text-red-600 mt-1 pt-1 border-t border-gray-100">
                                <span>Sisa</span>
                                <span>${formatCurrency(payment.remaining)}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            return `
                <div class="payment-card rounded-lg p-4 border-l-4 ${borderColor} shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="text-lg">${feeIcon}</span>
                            <div>
                                <h5 class="font-semibold text-gray-800 text-sm">${payment.feeType}</h5>
                                <p class="text-xs text-gray-500">${payment.frequency || ''}</p>
                            </div>
                        </div>
                        <span class="text-xl">${statusIcon}</span>
                    </div>
                    <div class="mb-2">
                        <p class="text-lg font-bold text-blue-600">${formatCurrency(payment.amount)}</p>
                        ${payment.status === 'installment' ? `
                            <p class="text-sm text-green-600">Terbayar: ${formatCurrency(payment.paidAmount || 0)}</p>
                        ` : ''}
                    </div>
                    <div class="flex items-center justify-between mb-2">
                        <span class="px-2 py-1 rounded-full text-xs font-medium text-white ${statusClass}">
                            ${statusText}
                        </span>
                    </div>
                    <p class="text-xs text-gray-500">${paymentDate}</p>
                    ${installmentDetails}
                </div>
            `;
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        // Event listeners
        document.getElementById('nisnInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStudent();
            }
        });

        // Format NISN input to numbers only
        document.getElementById('nisnInput').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        // Initialize the application when page loads
        window.addEventListener('load', initializeApp);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97bfc0b0a0e899a9',t:'MTc1NzM0ODIxMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
