<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrasi Madrasah - MA NU Hasyim Asy'ari 1 Kudus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
        }
        .gradient-bg { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            position: relative;
            overflow: hidden;
        }
        .gradient-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
        }
        .card-shadow { 
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }
        .search-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .student-info-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.98), rgba(248,250,252,0.95));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .info-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.95), rgba(241,245,249,0.9));
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .summary-card-1 {
            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
            position: relative;
            overflow: hidden;
        }
        .summary-card-1::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        .summary-card-2 {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%);
            position: relative;
            overflow: hidden;
        }
        .summary-card-2::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        .summary-card-3 {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%);
            position: relative;
            overflow: hidden;
        }
        .summary-card-3::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        .payment-section {
            background: linear-gradient(145deg, rgba(249,250,251,0.9), rgba(243,244,246,0.8));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .monthly-section {
            background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(147,197,253,0.1));
            border: 1px solid rgba(59,130,246,0.2);
        }
        .semester-section {
            background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(110,231,183,0.1));
            border: 1px solid rgba(16,185,129,0.2);
        }
        .yearly-section {
            background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(196,181,253,0.1));
            border: 1px solid rgba(139,92,246,0.2);
        }
        .onetime-section {
            background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(251,191,36,0.1));
            border: 1px solid rgba(245,158,11,0.2);
        }
        .payment-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.95), rgba(248,250,252,0.9));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.4);
            transition: all 0.3s ease;
        }
        .payment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .status-paid { background: linear-gradient(135deg, #10b981, #059669); }
        .status-unpaid { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .status-partial { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .tab-active {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
            box-shadow: 0 4px 15px rgba(59,130,246,0.3);
        }
        .tab-inactive {
            background: linear-gradient(145deg, rgba(255,255,255,0.8), rgba(243,244,246,0.6));
            backdrop-filter: blur(10px);
        }
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        .search-button {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%);
            box-shadow: 0 8px 25px rgba(59,130,246,0.3);
            transition: all 0.3s ease;
        }
        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(59,130,246,0.4);
        }
        .connection-status {
            background: linear-gradient(145deg, rgba(255,255,255,0.9), rgba(248,250,252,0.8));
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 8px 16px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .floating { animation: float 3s ease-in-out infinite; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-4 md:py-6 shadow-lg">
        <div class="container mx-auto px-4">
            <!-- Mobile Layout -->
            <div class="md:hidden">
                <div class="text-center mb-1">
                    <h1 class="text-2xl font-bold leading-tight">MA NU HASYIM ASY'ARI 1 KUDUS</h1>
                </div>
                <div class="text-center">
                    <p class="text-xs text-blue-100 mb-1">Jl. Mayor H. Basuno No. 17 Sunggingan Kota Kudus 59317</p>
                    <p class="text-xs text-blue-100 mb-1" id="currentAcademicYearMobile">Tahun Ajaran 2024/2025</p>
                    <p class="text-xs text-blue-200">Periode 3 Tahun (Kelas 10-12)</p>
                </div>
            </div>
            
            <!-- Desktop Layout -->
            <div class="hidden md:flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold mb-1">MA NU HASYIM ASY'ARI 1 KUDUS</h1>
                    <p class="text-blue-100">Jl. Mayor H. Basuno No. 17 Sunggingan Kota Kudus 59317</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-blue-100" id="currentAcademicYear">Tahun Ajaran 2024/2025</p>
                    <p class="text-xs text-blue-200">Periode 3 Tahun (Kelas 10-12)</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Watermark Logo -->
    <div class="fixed inset-0 flex items-center justify-center pointer-events-none z-0">
        <div class="opacity-5 transform rotate-12">
            <img src="https://lh3.googleusercontent.com/d/1yTmDUC2K2-cSm_EWq1hQt_rtJ1xa4Odc" 
                 alt="Watermark Logo" 
                 class="w-96 h-96 object-contain"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div class="w-96 h-96 flex items-center justify-center text-gray-300 text-9xl font-bold hidden">üè´</div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 relative z-10">
        <!-- Search Section -->
        <div class="search-card rounded-xl card-shadow p-8 mb-8 floating">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Administrasi Madrasah</h2>
                <p class="text-gray-600">Masukkan NISN untuk melihat informasi</p>
            </div>
            
            <div class="max-w-md mx-auto">
                <div class="relative">
                    <input 
                        type="text" 
                        id="nisnInput" 
                        placeholder="Masukkan NISN (10 digit)"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-center text-lg font-medium"
                        maxlength="10"
                    >
                    <button 
                        onclick="searchStudent()" 
                        id="searchButton"
                        class="w-full mt-4 search-button text-white py-3 px-6 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 flex items-center justify-center"
                    >
                        <span id="searchText">üîç Cari Data Siswa</span>
                        <div id="loadingSpinner" class="loading-spinner ml-2 hidden"></div>
                    </button>
                </div>
            </div>

            <!-- Connection Status -->
            <div id="connectionStatus" class="mt-4 text-center text-sm">
                <span class="connection-status text-gray-600">üì° Menghubungkan ke database...</span>
            </div>
        </div>

        <!-- Student Info Section -->
        <div id="studentInfo" class="hidden student-info-card rounded-xl card-shadow p-8 mb-8">
            <div class="flex items-center space-x-6 mb-6 pb-6 border-b">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                    <span id="studentInitial">A</span>
                </div>
                <div class="flex-1 text-right">
                    <h3 class="text-2xl font-bold text-gray-800 whitespace-nowrap overflow-hidden text-ellipsis" id="studentName">Nama Siswa</h3>
                    <div class="grid grid-cols-2 gap-4 mt-2 text-sm text-gray-600 text-right">
                        <p><span class="font-medium">NISN:</span> <span id="displayNisn">-</span></p>
                        <p><span class="font-medium">Kelas:</span> <span id="studentClass">-</span></p>
                        <p><span class="font-medium">Jurusan:</span> <span id="studentMajor">-</span></p>
                        <p><span class="font-medium">Jenis Kelamin:</span> <span id="studentGender">-</span></p>
                        <p><span class="font-medium">Tahun Masuk:</span> <span id="entryYear">-</span></p>
                    </div>
                </div>
                </div>
            </div>
            
            <!-- Current Month Status -->
            <div class="mb-6 pb-6 border-b hidden" id="currentMonthSection">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200">
                    <div class="text-center">
                        <div class="text-sm text-gray-600 mb-3 font-medium">üìÖ Status Pembayaran Bulan Ini</div>
                        <div id="currentMonthStatus" class="inline-block px-6 py-3 rounded-full text-white font-semibold text-sm shadow-lg">
                            Belum Dicek
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Summary -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 hidden" id="paymentSummarySection">
                <div class="summary-card-1 text-white p-6 rounded-xl relative z-10">
                    <div class="flex items-center justify-between relative z-10">
                        <div>
                            <p class="text-green-100 text-sm">Total Terbayar</p>
                            <p class="text-2xl font-bold" id="totalPaid">Rp 0</p>
                        </div>
                        <div class="text-3xl">‚úÖ</div>
                    </div>
                </div>
                <div class="summary-card-2 text-white p-6 rounded-xl relative z-10">
                    <div class="flex items-center justify-between relative z-10">
                        <div>
                            <p class="text-red-100 text-sm">Total Tunggakan</p>
                            <p class="text-2xl font-bold" id="totalUnpaid">Rp 0</p>
                        </div>
                        <div class="text-3xl">‚è∞</div>
                    </div>
                </div>
                <div class="summary-card-3 text-white p-6 rounded-xl relative z-10">
                    <div class="flex items-center justify-between relative z-10">
                        <div>
                            <p class="text-blue-100 text-sm">Total Keseluruhan</p>
                            <p class="text-2xl font-bold" id="totalOverall">Rp 0</p>
                        </div>
                        <div class="text-3xl">üí∞</div>
                    </div>
                </div>
            </div>

            <!-- Component Breakdown -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 hidden" id="componentBreakdownSection">
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                    <div class="text-center">
                        <div class="text-2xl mb-2">üìö</div>
                        <div class="text-xs text-blue-600 mb-1">Total SPP 3 Tahun</div>
                        <div class="text-lg font-bold text-blue-800" id="totalSpp">Rp 0</div>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                    <div class="text-center">
                        <div class="text-2xl mb-2">üìñ</div>
                        <div class="text-xs text-green-600 mb-1">Total Semester</div>
                        <div class="text-lg font-bold text-green-800" id="totalSemester">Rp 0</div>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border border-purple-200">
                    <div class="text-center">
                        <div class="text-2xl mb-2">üéì</div>
                        <div class="text-xs text-purple-600 mb-1">Total Sekali Bayar</div>
                        <div class="text-lg font-bold text-purple-800" id="totalOneTime">Rp 0</div>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4 border border-orange-200">
                    <div class="text-center">
                        <div class="text-2xl mb-2">üè¶</div>
                        <div class="text-xs text-orange-600 mb-1">Total Lainnya</div>
                        <div class="text-lg font-bold text-orange-800" id="totalOthers">Rp 0</div>
                    </div>
                </div>
            </div>

            <!-- Year Tabs -->
            <div class="flex flex-col sm:flex-row space-y-1 sm:space-y-0 sm:space-x-1 mb-6 payment-section p-1 rounded-lg hidden" id="yearTabs">
                <button onclick="showYear(10)" id="tab10" class="flex-1 py-3 px-4 rounded-md font-semibold transition-all duration-300 tab-active text-white text-sm sm:text-base">
                    Kelas 10 (2024/2025)
                </button>
                <button onclick="showYear(11)" id="tab11" class="flex-1 py-3 px-4 rounded-md font-semibold transition-all duration-300 tab-inactive text-gray-600 hover:bg-gray-200 text-sm sm:text-base">
                    Kelas 11 (2025/2026)
                </button>
                <button onclick="showYear(12)" id="tab12" class="flex-1 py-3 px-4 rounded-md font-semibold transition-all duration-300 tab-inactive text-gray-600 hover:bg-gray-200 text-sm sm:text-base">
                    Kelas 12 (2026/2027)
                </button>
            </div>

            <!-- Payment Details -->
            <div id="paymentDetails">
                <!-- Payment details will be populated by JavaScript -->
            </div>
        </div>

        <!-- Info Section -->
        <div id="infoSection" class="info-card rounded-xl card-shadow p-8 hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-4">‚ÑπÔ∏è Informasi Pembayaran</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-semibold text-gray-700 mb-3">Struktur Biaya per Kelas:</h4>
                    
                    <div class="space-y-3 mb-4">
                        <div class="bg-blue-50 rounded-lg p-3">
                            <h5 class="font-semibold text-blue-800 mb-2">üí∞ Biaya Bulanan</h5>
                            <div class="text-sm text-blue-700 space-y-1">
                                <p>‚Ä¢ SPP Kelas 10: Rp 125.000/bulan</p>
                                <p>‚Ä¢ SPP Kelas 11-12: Rp 175.000/bulan</p>
                                <p>‚Ä¢ Tabungan: Rp 50.000/bulan (Kelas 10)</p>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 rounded-lg p-3">
                            <h5 class="font-semibold text-green-800 mb-2">üìö Biaya Semester</h5>
                            <div class="text-sm text-green-700 space-y-1">
                                <p>‚Ä¢ Buku LKS: Rp 150.000</p>
                                <p>‚Ä¢ Ulangan Harian: Rp 100.000</p>
                                <p>‚Ä¢ Ulangan Semester: Rp 120.000</p>
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 rounded-lg p-3">
                            <h5 class="font-semibold text-purple-800 mb-2">üéì Biaya Sekali Bayar</h5>
                            <div class="text-sm text-purple-700 space-y-1">
                                <p>‚Ä¢ Siswa Baru Putra: Rp 1.200.000</p>
                                <p>‚Ä¢ Siswi Baru Putri: Rp 1.350.000</p>
                                <p>‚Ä¢ Study Tour: Rp 500.000</p>
                                <p>‚Ä¢ Perpisahan: Rp 1.000.000</p>
                            </div>
                        </div>
                    </div>
                    
                    <h4 class="font-semibold text-gray-700 mb-2">Cara Pembayaran:</h4>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>‚Ä¢ Bank BNI: 1234567890 (MA NU HASYIM ASY'ARI 1)</li>
                        <li>‚Ä¢ Bank Mandiri: 0987654321 (MA NU HASYIM ASY'ARI 1)</li>
                        <li>‚Ä¢ Kantin Madrasah (Tunai)</li>
                        <li>‚Ä¢ Transfer Digital (QRIS)</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-700 mb-2">Jenis Pembayaran:</h4>
                    <div class="grid grid-cols-2 gap-2 text-xs text-gray-600 mb-4">
                        <div>‚Ä¢ üìö SPP</div>
                        <div>‚Ä¢ üè¶ Tabungan</div>
                        <div>‚Ä¢ üìñ LKS</div>
                        <div>‚Ä¢ üìù UHB</div>
                        <div>‚Ä¢ üìù PAS</div>
                        <div>‚Ä¢ ü§≤ Infaq Kenaikan</div>
                        <div>‚Ä¢ üéì Perpisahan</div>
                        <div>‚Ä¢ üöå Studi Tour</div>
                        <div>‚Ä¢ üìî Buku Kenangan</div>
                        <div>‚Ä¢ üìã Ujian Akhir</div>
                    </div>
                    
                    <h4 class="font-semibold text-gray-700 mb-2">Jadwal Pembayaran:</h4>
                    <ul class="text-sm text-gray-600 space-y-1 mb-4">
                        <li>‚Ä¢ Tanggal 1-10: Pembayaran Normal</li>
                        <li>‚Ä¢ Tanggal 11-20: Denda Rp 25.000</li>
                        <li>‚Ä¢ Tanggal 21-31: Denda Rp 50.000</li>
                    </ul>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <p class="text-xs text-yellow-800">
                            <strong>Catatan:</strong> Siswa yang menunggak lebih dari 2 bulan tidak diperkenankan mengikuti ujian semester.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google Sheets Configuration
        const GOOGLE_SHEETS_CONFIG = {
            SHEET_ID: '17MDc804lNUm_XwUM6hPj6Ui8T-JVtpxJCLq4XovVs0A',
            SHEET_NAME: 'Sheet7',
            API_KEY: 'AIzaSyCAJWvsjw92iebZM54KZivepTpl_Q2gk70'
        };

        let sheetsData = [];
        let currentStudent = null;
        let currentYear = 10;

        // Get current academic year
        function getCurrentAcademicYear() {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1; // JavaScript months are 0-indexed
            
            // Academic year starts in July (month 7)
            // If current month is January-June, we're still in the previous academic year
            if (currentMonth >= 7) {
                // July-December: current year / next year
                return `${currentYear}/${currentYear + 1}`;
            } else {
                // January-June: previous year / current year
                return `${currentYear - 1}/${currentYear}`;
            }
        }

        // Initialize the application
        async function initializeApp() {
            try {
                // Update academic year display
                const academicYear = getCurrentAcademicYear();
                document.getElementById('currentAcademicYear').textContent = `Tahun Ajaran ${academicYear}`;
                document.getElementById('currentAcademicYearMobile').textContent = `Tahun Ajaran ${academicYear}`;
                
                await loadSheetsData();
                updateConnectionStatus('‚úÖ Terhubung ke database', 'text-green-600');
            } catch (error) {
                console.error('Failed to load sheets data:', error);
                updateConnectionStatus('‚ùå Gagal terhubung ke database', 'text-red-600');
            }
        }

        // Load data from Google Sheets
        async function loadSheetsData() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.SHEET_ID}/values/${GOOGLE_SHEETS_CONFIG.SHEET_NAME}?key=${GOOGLE_SHEETS_CONFIG.API_KEY}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                sheetsData = data.values || [];
                console.log('Data loaded from Google Sheets:', sheetsData.length, 'rows');
                return sheetsData;
            } catch (error) {
                console.error('Error loading Google Sheets data:', error);
                throw error;
            }
        }

        // Update connection status
        function updateConnectionStatus(message, className) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.innerHTML = `<span class="${className}">${message}</span>`;
        }

        // Search for student by NISN
        async function searchStudent() {
            const nisn = document.getElementById('nisnInput').value.trim();
            
            if (nisn.length !== 10) {
                alert('NISN harus 10 digit!');
                return;
            }

            // Show loading state
            setLoadingState(true);

            try {
                // Reload data to get latest information
                await loadSheetsData();
                
                // Find student in sheets data
                const student = findStudentByNISN(nisn);
                
                if (!student) {
                    alert('NISN tidak ditemukan dalam database!');
                    setLoadingState(false);
                    return;
                }

                currentStudent = student;
                displayStudentInfo(nisn, student);
                
            } catch (error) {
                console.error('Error searching student:', error);
                alert('Terjadi kesalahan saat mencari data siswa. Silakan coba lagi.');
            } finally {
                setLoadingState(false);
            }
        }

        // Find student by NISN in sheets data
        function findStudentByNISN(nisn) {
            if (sheetsData.length === 0) return null;
            
            // Assuming first row contains headers
            const headers = sheetsData[0];
            const nisnColumnIndex = headers.findIndex(header => 
                header.toLowerCase().includes('nisn')
            );
            
            if (nisnColumnIndex === -1) {
                console.error('NISN column not found in sheets data');
                return null;
            }

            // Find the row with matching NISN
            const studentRow = sheetsData.find((row, index) => {
                if (index === 0) return false; // Skip header row
                return row[nisnColumnIndex] === nisn;
            });

            if (!studentRow) return null;

            // Parse student data from the row
            return parseStudentData(headers, studentRow);
        }

        // Fee structure based on detailed breakdown
        const FEE_STRUCTURE = {
            // One-time payments (paid once in 3 years)
            oneTime: {
                'Siswa Baru Putra': 1200000,
                'Siswi Baru Putri': 1350000,
                'Perpisahan': 1000000,
                'Study Tour': 500000,
                'Buku Kenangan': 50000,
                'Ujian Akhir': 50000
            },
            // Monthly payments
            monthly: {
                'SPP': {
                    10: 125000,
                    11: 175000,
                    12: 175000
                },
                'Tabungan': 50000 // Only for grade 10
            },
            // Semester payments (2 times per year)
            semester: {
                'Buku LKS': 150000,
                'Ulangan Harian': 100000,
                'Ulangan Semester': 120000
            },
            // Yearly payments
            yearly: {
                'Infaq Kenaikan Kelas': 150000
            }
        };

        // Parse student data from sheets row
        function parseStudentData(headers, row) {
            const student = {
                name: '',
                class: '',
                major: '',
                entryYear: '',
                gender: '',
                payments: {
                    10: {},
                    11: {},
                    12: {}
                }
            };

            // Map basic student info
            headers.forEach((header, index) => {
                const value = row[index] || '';
                const headerLower = header.toLowerCase();
                
                if (headerLower.includes('nama')) {
                    student.name = value;
                } else if (headerLower.includes('kelas')) {
                    student.class = value;
                } else if (headerLower.includes('jurusan')) {
                    student.major = value;
                } else if (headerLower.includes('tahun')) {
                    student.entryYear = value;
                } else if (headerLower.includes('jenis_kelamin') || headerLower.includes('gender') || headerLower.includes('kelamin')) {
                    // Normalize gender values
                    const genderValue = value.toLowerCase().trim();
                    if (genderValue.includes('laki') || genderValue === 'l' || genderValue === 'male' || genderValue === 'putra') {
                        student.gender = 'laki-laki';
                    } else if (genderValue.includes('perempuan') || genderValue === 'p' || genderValue === 'female' || genderValue === 'putri') {
                        student.gender = 'perempuan';
                    } else {
                        student.gender = genderValue;
                    }
                }
            });

            // Parse payment data for each grade and payment type
            [10, 11, 12].forEach(grade => {
                const gradePayments = {};
                
                // One-time payments distributed by grade
                Object.keys(FEE_STRUCTURE.oneTime).forEach(feeType => {
                    let shouldInclude = false;
                    
                    // Grade 10: Only new student fees
                    if (grade === 10) {
                        if (feeType === 'Siswa Baru Putra' && student.gender === 'laki-laki') shouldInclude = true;
                        if (feeType === 'Siswi Baru Putri' && student.gender === 'perempuan') shouldInclude = true;
                    }
                    
                    // Grade 11: Study Tour
                    if (grade === 11) {
                        if (feeType === 'Study Tour') shouldInclude = true;
                    }
                    
                    // Grade 12: Graduation-related fees
                    if (grade === 12) {
                        if (feeType === 'Perpisahan' || feeType === 'Buku Kenangan' || feeType === 'Ujian Akhir') {
                            shouldInclude = true;
                        }
                    }
                    
                    if (shouldInclude) {
                        const expectedAmount = FEE_STRUCTURE.oneTime[feeType];
                        const paymentStatus = checkPaymentStatus(headers, row, feeType, grade, expectedAmount);
                        gradePayments[feeType] = {
                            paid: paymentStatus.paid,
                            amount: expectedAmount,
                            paidAmount: paymentStatus.amount,
                            remaining: paymentStatus.remaining,
                            status: paymentStatus.status,
                            installments: paymentStatus.installments,
                            date: paymentStatus.paid ? new Date().toISOString().split('T')[0] : null,
                            type: 'oneTime',
                            frequency: 'Sekali dalam 3 tahun'
                        };
                    }
                });
                
                // Monthly payments
                Object.keys(FEE_STRUCTURE.monthly).forEach(feeType => {
                    // Tabungan only for grade 10
                    if (feeType === 'Tabungan' && grade !== 10) return;
                    
                    // For monthly payments, create entries for each month
                    const months = [
                        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember',
                        'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni'
                    ];
                    
                    months.forEach((month, monthIndex) => {
                        const monthKey = `${feeType} ${month}`;
                        
                        // Get the correct amount based on fee type and grade
                        let expectedAmount;
                        if (feeType === 'SPP') {
                            expectedAmount = FEE_STRUCTURE.monthly[feeType][grade];
                        } else {
                            expectedAmount = FEE_STRUCTURE.monthly[feeType];
                        }
                        
                        const paymentStatus = checkPaymentStatus(headers, row, `${feeType}_${month}`, grade, expectedAmount);
                        
                        gradePayments[monthKey] = {
                            paid: paymentStatus.paid,
                            amount: expectedAmount,
                            paidAmount: paymentStatus.amount,
                            remaining: paymentStatus.remaining,
                            status: paymentStatus.status,
                            installments: paymentStatus.installments,
                            date: paymentStatus.paid ? new Date().toISOString().split('T')[0] : null,
                            type: 'monthly',
                            frequency: 'Per bulan'
                        };
                    });
                });
                
                // Semester payments (2 times per year)
                Object.keys(FEE_STRUCTURE.semester).forEach(feeType => {
                    ['Semester 1', 'Semester 2'].forEach(semester => {
                        const semesterKey = `${feeType} ${semester}`;
                        const expectedAmount = FEE_STRUCTURE.semester[feeType];
                        const paymentStatus = checkPaymentStatus(headers, row, `${feeType}_${semester}`, grade, expectedAmount);
                        
                        gradePayments[semesterKey] = {
                            paid: paymentStatus.paid,
                            amount: expectedAmount,
                            paidAmount: paymentStatus.amount,
                            remaining: paymentStatus.remaining,
                            status: paymentStatus.status,
                            installments: paymentStatus.installments,
                            date: paymentStatus.paid ? new Date().toISOString().split('T')[0] : null,
                            type: 'semester',
                            frequency: 'Per semester'
                        };
                    });
                });
                
                // Yearly payments
                Object.keys(FEE_STRUCTURE.yearly).forEach(feeType => {
                    const expectedAmount = FEE_STRUCTURE.yearly[feeType];
                    
                    // For yearly payments, try exact patterns from spreadsheet
                    let searchPatterns = [
                        feeType,
                        `infaq_naik_kelas_${grade}`,
                        `${feeType}_${grade}`,
                        `infaq_${grade}`,
                        `kenaikan_${grade}`,
                        `infaq_kenaikan_${grade}`,
                        `infaqkenaikan_${grade}`,
                        `infaq_kelas_${grade}`,
                        `kenaikan_kelas_${grade}`,
                        `infaq_naik_kelas`,
                        `naik_kelas_${grade}`
                    ];
                    
                    let paymentStatus = null;
                    
                    // Try each pattern until we find a match
                    for (const pattern of searchPatterns) {
                        paymentStatus = checkPaymentStatus(headers, row, pattern, grade, expectedAmount);
                        if (paymentStatus.paid || paymentStatus.amount > 0) {
                            break;
                        }
                    }
                    
                    // If no specific pattern found, use the original
                    if (!paymentStatus || (paymentStatus.amount === 0 && !paymentStatus.paid)) {
                        paymentStatus = checkPaymentStatus(headers, row, feeType, grade, expectedAmount);
                    }
                    
                    gradePayments[feeType] = {
                        paid: paymentStatus.paid,
                        amount: expectedAmount,
                        paidAmount: paymentStatus.amount,
                        remaining: paymentStatus.remaining,
                        status: paymentStatus.status,
                        installments: paymentStatus.installments,
                        date: paymentStatus.paid ? new Date().toISOString().split('T')[0] : null,
                        type: 'yearly',
                        frequency: 'Per tahun'
                    };
                });
                
                student.payments[grade] = gradePayments;
            });
            
            return student;
        }
        
        // Helper function to check payment status with installment support
        function checkPaymentStatus(headers, row, feeType, grade, expectedAmount) {
            // Special handling for exact column patterns - PRIORITY SEARCH
            const exactPatternMappings = {
                'Ulangan Harian Semester 1': [
                    `uhb_${grade}_sem1`, `UHB_${grade}_sem1`, `uhb_${grade}_semester1`, 
                    `uhb_sem1_${grade}`, `UHB_sem1_${grade}`, `uhb_s1_${grade}`, 
                    `uhb${grade}sem1`, `UHB${grade}sem1`, `uhb_1_${grade}`, 
                    `uhb1_${grade}`, `UHB1_${grade}`, `uh_${grade}_sem1`,
                    `uh_sem1_${grade}`, `ulangan_harian_${grade}_sem1`,
                    `ulangan_harian_sem1_${grade}`, `harian_${grade}_sem1`,
                    `harian_sem1_${grade}`, `uhb_${grade}_1`, `UHB_${grade}_1`
                ],
                'Ulangan Harian Semester 2': [
                    `uhb_${grade}_sem2`, `UHB_${grade}_sem2`, `uhb_${grade}_semester2`, 
                    `uhb_sem2_${grade}`, `UHB_sem2_${grade}`, `uhb_s2_${grade}`, 
                    `uhb${grade}sem2`, `UHB${grade}sem2`, `uhb_2_${grade}`, 
                    `uhb2_${grade}`, `UHB2_${grade}`, `uh_${grade}_sem2`,
                    `uh_sem2_${grade}`, `ulangan_harian_${grade}_sem2`,
                    `ulangan_harian_sem2_${grade}`, `harian_${grade}_sem2`,
                    `harian_sem2_${grade}`, `uhb_${grade}_2`, `UHB_${grade}_2`
                ],
                'Ulangan Semester Semester 1': [
                    `pas_${grade}_sem1`, `PAS_${grade}_sem1`, `pas_${grade}_semester1`, 
                    `pas_sem1_${grade}`, `PAS_sem1_${grade}`, `pas_s1_${grade}`, 
                    `pas${grade}sem1`, `PAS${grade}sem1`, `pas_1_${grade}`, 
                    `pas1_${grade}`, `PAS1_${grade}`, `uas_${grade}_sem1`,
                    `uas_sem1_${grade}`, `ulangan_semester_${grade}_sem1`,
                    `ulangan_semester_sem1_${grade}`, `semester_${grade}_sem1`,
                    `semester_sem1_${grade}`, `pas_${grade}_1`, `PAS_${grade}_1`,
                    `uas_${grade}_1`, `UAS_${grade}_1`, `us_${grade}_sem1`,
                    `us_sem1_${grade}`, `us_${grade}_1`, `US_${grade}_1`
                ],
                'Ulangan Semester Semester 2': [
                    `pas_${grade}_sem2`, `PAS_${grade}_sem2`, `pas_${grade}_semester2`, 
                    `pas_sem2_${grade}`, `PAS_sem2_${grade}`, `pas_s2_${grade}`, 
                    `pas${grade}sem2`, `PAS${grade}sem2`, `pas_2_${grade}`, 
                    `pas2_${grade}`, `PAS2_${grade}`, `uas_${grade}_sem2`,
                    `uas_sem2_${grade}`, `ulangan_semester_${grade}_sem2`,
                    `ulangan_semester_sem2_${grade}`, `semester_${grade}_sem2`,
                    `semester_sem2_${grade}`, `pas_${grade}_2`, `PAS_${grade}_2`,
                    `uas_${grade}_2`, `UAS_${grade}_2`, `us_${grade}_sem2`,
                    `us_sem2_${grade}`, `us_${grade}_2`, `US_${grade}_2`
                ],
                'Buku LKS Semester 1': [
                    `lks_${grade}_sem1`, `LKS_${grade}_sem1`, `lks_${grade}_semester1`, 
                    `bukuLKS_${grade}_sem1`, `buku_lks_${grade}_sem1`, `lks${grade}sem1`, 
                    `LKS${grade}sem1`, `lks_${grade}_s1`, `LKS_${grade}_S1`,
                    `lks${grade}s1`, `LKS${grade}S1`, `lks_sem1_${grade}`, `LKS_sem1_${grade}`,
                    `lks_s1_${grade}`, `LKS_S1_${grade}`, `lks_semester1_${grade}`,
                    `LKS_semester1_${grade}`, `bukuLKS_sem1_${grade}`, `bukuLKS_s1_${grade}`
                ],
                'Buku LKS Semester 2': [
                    `lks_${grade}_sem2`, `LKS_${grade}_sem2`, `lks_${grade}_semester2`, 
                    `bukuLKS_${grade}_sem2`, `buku_lks_${grade}_sem2`, `lks${grade}sem2`, 
                    `LKS${grade}sem2`, `lks_${grade}_s2`, `LKS_${grade}_S2`,
                    `lks${grade}s2`, `LKS${grade}S2`, `lks_sem2_${grade}`, `LKS_sem2_${grade}`,
                    `lks_s2_${grade}`, `LKS_S2_${grade}`, `lks_semester2_${grade}`,
                    `LKS_semester2_${grade}`, `bukuLKS_sem2_${grade}`, `bukuLKS_s2_${grade}`
                ]
            };
            
            // Check for exact pattern matches first
            if (exactPatternMappings[feeType]) {
                for (const pattern of exactPatternMappings[feeType]) {
                    const exactIndex = headers.findIndex(h => h.toLowerCase() === pattern.toLowerCase());
                    if (exactIndex !== -1) {
                        console.log(`‚úÖ Found exact column for "${feeType}": "${headers[exactIndex]}" (pattern: ${pattern})`);
                        const result = processPaymentValue(row[exactIndex], expectedAmount, feeType);
                        if (result.amount > 0 || result.paid) {
                            console.log(`üí∞ ${feeType} payment detected: ${result.amount}, Expected: ${expectedAmount}, Status: ${result.status.toUpperCase()}`);
                            return result;
                        }
                    }
                }
                console.log(`üîç No exact pattern found for "${feeType}", trying patterns:`, exactPatternMappings[feeType]);
            }
            
            // Create comprehensive list of possible column name patterns
            const feeTypeClean = feeType.replace(/\s+/g, '').toLowerCase();
            const feeTypeUnderscore = feeType.replace(/\s+/g, '_').toLowerCase();
            
            // Map common fee type abbreviations with exact column patterns from spreadsheet
            const feeTypeMap = {
                'spp': ['spp'],
                'tabungan': ['tabungan', 'tab'],
                'buku_lks': ['lks', 'buku_lks', 'bukulks', 'bukuLKS'],
                'ulangan_harian': ['uhb', 'ulangan_harian', 'ulanganharian', 'uh', 'UHB', 'ulangan', 'harian'],
                'ulangan_semester': ['pas', 'ulangan_semester', 'ulangansemester', 'us', 'uas', 'PAS', 'UAS', 'semester'],
                'infaq_kenaikan_kelas': ['infaq_naik_kelas', 'infaq_kenaikan', 'infaqkenaikan', 'kenaikan', 'infaq_kelas'],
                'perpisahan': ['perpisahan'],
                'study_tour': ['studytour', 'study_tour', 'tour'],
                'buku_kenangan': ['buku_kenangan', 'bukukenangan'],
                'ujian_akhir': ['ujian_akhir', 'ujianakhir', 'ua'],
                'siswa_baru_putra': ['siswa_baru', 'siswabaru', 'putra'],
                'siswi_baru_putri': ['siswa_baru_putri', 'siswi_baru_putri', 'siswi_baru', 'siswibaruputri', 'putri'],
                // Exact semester-specific mappings from spreadsheet
                'buku_lks_semester_1': ['lks_sem1', 'lks_semester1', 'lks_s1', 'bukuLKS_sem1', 'lks1'],
                'buku_lks_semester_2': ['lks_sem2', 'lks_semester2', 'lks_s2', 'bukuLKS_sem2', 'lks2'],
                'ulangan_harian_semester_1': ['uhb_10_sem1', 'uhb_11_sem1', 'uhb_12_sem1', 'uhb_sem1', 'uhb_semester1', 'uhb_s1', 'UHB_sem1', 'uhb1', 'ulangan_harian_1', 'uh_sem1', 'uh1'],
                'ulangan_harian_semester_2': ['uhb_10_sem2', 'uhb_11_sem2', 'uhb_12_sem2', 'uhb_sem2', 'uhb_semester2', 'uhb_s2', 'UHB_sem2', 'uhb2', 'ulangan_harian_2', 'uh_sem2', 'uh2'],
                'ulangan_semester_semester_1': ['pas_10_sem1', 'pas_11_sem1', 'pas_12_sem1', 'pas_sem1', 'pas_semester1', 'pas_s1', 'PAS_sem1', 'uas_sem1', 'pas1', 'uas1', 'ulangan_semester_1', 'us_sem1', 'us1'],
                'ulangan_semester_semester_2': ['pas_10_sem2', 'pas_11_sem2', 'pas_12_sem2', 'pas_sem2', 'pas_semester2', 'pas_s2', 'PAS_sem2', 'uas_sem2', 'pas2', 'uas2', 'ulangan_semester_2', 'us_sem2', 'us2']
            };
            
            // Get possible fee type variations
            let feeVariations = [feeTypeClean, feeTypeUnderscore];
            
            // Add mapped variations
            Object.entries(feeTypeMap).forEach(([key, variations]) => {
                if (feeTypeClean.includes(key) || key.includes(feeTypeClean)) {
                    feeVariations = feeVariations.concat(variations);
                }
            });
            
            // Special handling for Siswi Baru Putri - add more specific patterns
            if (feeType === 'Siswi Baru Putri') {
                feeVariations = feeVariations.concat([
                    'siswa_baru_putri',
                    'siswi_baru_putri', 
                    'siswibaruputri',
                    'siswa_baru',
                    'siswi_baru',
                    'putri',
                    'baru_putri',
                    'siswa_putri',
                    'siswi_putri',
                    'new_student_female',
                    'student_baru_putri'
                ]);
                console.log(`üîç Enhanced Siswi Baru Putri patterns:`, feeVariations);
            }
            
            // Remove duplicates
            feeVariations = [...new Set(feeVariations)];
            
            // Create all possible column name patterns
            const possibleColumnNames = [];
            
            feeVariations.forEach(feeVar => {
                // Direct patterns
                possibleColumnNames.push(feeVar);
                possibleColumnNames.push(`${feeVar}_${grade}`);
                possibleColumnNames.push(`${feeVar}_kelas_${grade}`);
                possibleColumnNames.push(`kelas_${grade}_${feeVar}`);
                possibleColumnNames.push(`${feeVar}${grade}`);
                possibleColumnNames.push(`${grade}_${feeVar}`);
                
                // With month patterns for monthly payments
                if (feeType.includes('Juli') || feeType.includes('Agustus') || feeType.includes('September') || 
                    feeType.includes('Oktober') || feeType.includes('November') || feeType.includes('Desember') ||
                    feeType.includes('Januari') || feeType.includes('Februari') || feeType.includes('Maret') ||
                    feeType.includes('April') || feeType.includes('Mei') || feeType.includes('Juni')) {
                    
                    const monthMatch = feeType.match(/(Juli|Agustus|September|Oktober|November|Desember|Januari|Februari|Maret|April|Mei|Juni)/);
                    if (monthMatch) {
                        const month = monthMatch[1].toLowerCase();
                        const baseType = feeType.replace(monthMatch[1], '').trim().replace(/\s+/g, '').toLowerCase();
                        
                        possibleColumnNames.push(`${baseType}_${month}_${grade}`);
                        possibleColumnNames.push(`${baseType}_${grade}_${month}`);
                        possibleColumnNames.push(`${month}_${baseType}_${grade}`);
                        possibleColumnNames.push(`${grade}_${baseType}_${month}`);
                        possibleColumnNames.push(`${baseType}${month}${grade}`);
                        possibleColumnNames.push(`${baseType}_${month}`);
                        possibleColumnNames.push(`${month}_${baseType}`);
                    }
                }
                
                // With semester patterns - Enhanced
                if (feeType.includes('Semester')) {
                    const semesterMatch = feeType.match(/(Semester\s*[12])/);
                    if (semesterMatch) {
                        const semesterNum = semesterMatch[1].replace(/\D/g, ''); // Extract just the number
                        const semester = `semester${semesterNum}`;
                        const sem = `sem${semesterNum}`;
                        const s = `s${semesterNum}`;
                        const baseType = feeType.replace(semesterMatch[1], '').trim().replace(/\s+/g, '').toLowerCase();
                        
                        // Standard patterns
                        possibleColumnNames.push(`${baseType}_${semester}_${grade}`);
                        possibleColumnNames.push(`${baseType}_${grade}_${semester}`);
                        possibleColumnNames.push(`${semester}_${baseType}_${grade}`);
                        possibleColumnNames.push(`${grade}_${baseType}_${semester}`);
                        
                        // Short patterns
                        possibleColumnNames.push(`${baseType}_${sem}_${grade}`);
                        possibleColumnNames.push(`${baseType}_${grade}_${sem}`);
                        possibleColumnNames.push(`${sem}_${baseType}_${grade}`);
                        possibleColumnNames.push(`${grade}_${baseType}_${sem}`);
                        
                        // Very short patterns
                        possibleColumnNames.push(`${baseType}_${s}_${grade}`);
                        possibleColumnNames.push(`${baseType}_${grade}_${s}`);
                        possibleColumnNames.push(`${s}_${baseType}_${grade}`);
                        possibleColumnNames.push(`${grade}_${baseType}_${s}`);
                        
                        // Without grade patterns
                        possibleColumnNames.push(`${baseType}_${semester}`);
                        possibleColumnNames.push(`${baseType}_${sem}`);
                        possibleColumnNames.push(`${baseType}_${s}`);
                        possibleColumnNames.push(`${semester}_${baseType}`);
                        possibleColumnNames.push(`${sem}_${baseType}`);
                        possibleColumnNames.push(`${s}_${baseType}`);
                        
                        // Common abbreviations for semester payments
                        if (baseType.includes('lks') || baseType.includes('buku')) {
                            possibleColumnNames.push(`lks_${sem}_${grade}`);
                            possibleColumnNames.push(`lks_${s}_${grade}`);
                            possibleColumnNames.push(`bukuLKS_${sem}_${grade}`);
                            possibleColumnNames.push(`bukuLKS_${s}_${grade}`);
                            possibleColumnNames.push(`lks${semesterNum}_${grade}`);
                            possibleColumnNames.push(`LKS${semesterNum}_${grade}`);
                        }
                        
                        if (baseType.includes('uhb') || baseType.includes('ulangan_harian') || baseType.includes('ulangan') || baseType.includes('harian')) {
                            possibleColumnNames.push(`uhb_${sem}_${grade}`);
                            possibleColumnNames.push(`uhb_${s}_${grade}`);
                            possibleColumnNames.push(`UHB_${sem}_${grade}`);
                            possibleColumnNames.push(`UHB_${s}_${grade}`);
                            possibleColumnNames.push(`uhb${semesterNum}_${grade}`);
                            possibleColumnNames.push(`UHB${semesterNum}_${grade}`);
                            possibleColumnNames.push(`uh_${sem}_${grade}`);
                            possibleColumnNames.push(`uh_${s}_${grade}`);
                            possibleColumnNames.push(`uh${semesterNum}_${grade}`);
                            possibleColumnNames.push(`ulangan_harian_${semesterNum}_${grade}`);
                            possibleColumnNames.push(`ulangan${semesterNum}_${grade}`);
                            possibleColumnNames.push(`harian_${sem}_${grade}`);
                            possibleColumnNames.push(`harian${semesterNum}_${grade}`);
                        }
                        
                        if (baseType.includes('pas') || baseType.includes('ulangan_semester') || baseType.includes('semester')) {
                            possibleColumnNames.push(`pas_${sem}_${grade}`);
                            possibleColumnNames.push(`pas_${s}_${grade}`);
                            possibleColumnNames.push(`PAS_${sem}_${grade}`);
                            possibleColumnNames.push(`PAS_${s}_${grade}`);
                            possibleColumnNames.push(`uas_${sem}_${grade}`);
                            possibleColumnNames.push(`uas_${s}_${grade}`);
                            possibleColumnNames.push(`UAS_${sem}_${grade}`);
                            possibleColumnNames.push(`UAS_${s}_${grade}`);
                            possibleColumnNames.push(`pas${semesterNum}_${grade}`);
                            possibleColumnNames.push(`PAS${semesterNum}_${grade}`);
                            possibleColumnNames.push(`uas${semesterNum}_${grade}`);
                            possibleColumnNames.push(`UAS${semesterNum}_${grade}`);
                            possibleColumnNames.push(`us_${sem}_${grade}`);
                            possibleColumnNames.push(`us_${s}_${grade}`);
                            possibleColumnNames.push(`us${semesterNum}_${grade}`);
                            possibleColumnNames.push(`US${semesterNum}_${grade}`);
                            possibleColumnNames.push(`ulangan_semester_${semesterNum}_${grade}`);
                            possibleColumnNames.push(`semester_${semesterNum}_${grade}`);
                        }
                    }
                }
            });
            
            let paymentColumnIndex = -1;
            let matchedColumnName = '';
            let bestMatchScore = 0;
            
            // Special priority search for Siswi Baru Putri
            if (feeType === 'Siswi Baru Putri') {
                console.log(`üéØ Priority search for Siswi Baru Putri - checking all headers:`, headers);
                
                // High priority patterns for Siswi Baru Putri
                const priorityPatterns = [
                    'siswa_baru_putri',
                    'siswi_baru_putri',
                    'siswibaruputri',
                    'siswa_baru',
                    'siswi_baru',
                    'putri'
                ];
                
                for (const pattern of priorityPatterns) {
                    const foundIndex = headers.findIndex(header => {
                        const headerNorm = header.toLowerCase().replace(/[\s_-]/g, '');
                        const patternNorm = pattern.toLowerCase().replace(/[\s_-]/g, '');
                        return headerNorm.includes(patternNorm) || patternNorm.includes(headerNorm);
                    });
                    
                    if (foundIndex !== -1) {
                        paymentColumnIndex = foundIndex;
                        matchedColumnName = headers[foundIndex];
                        bestMatchScore = 100;
                        console.log(`‚úÖ Found Siswi Baru Putri column with priority pattern "${pattern}": "${matchedColumnName}"`);
                        break;
                    }
                }
            }
            
            // If no priority match found, use regular scoring
            if (paymentColumnIndex === -1) {
                headers.forEach((header, index) => {
                    const headerNormalized = header.toLowerCase().replace(/[\s_-]/g, '');
                    
                    possibleColumnNames.forEach(columnName => {
                        const columnNormalized = columnName.toLowerCase().replace(/[\s_-]/g, '');
                        
                        let score = 0;
                        
                        // Exact match gets highest score
                        if (headerNormalized === columnNormalized) {
                            score = 100;
                        }
                        // Contains match
                        else if (headerNormalized.includes(columnNormalized)) {
                            score = 80;
                        }
                        // Reverse contains match
                        else if (columnNormalized.includes(headerNormalized)) {
                            score = 70;
                        }
                        // Partial match with grade
                        else if (headerNormalized.includes(grade.toString()) && 
                                 (headerNormalized.includes(feeTypeClean) || 
                                  feeVariations.some(v => headerNormalized.includes(v)))) {
                            score = 60;
                        }
                        
                        if (score > bestMatchScore) {
                            bestMatchScore = score;
                            paymentColumnIndex = index;
                            matchedColumnName = header;
                        }
                    });
                });
            }
            
            // Debug logging with enhanced semester info
            if (paymentColumnIndex !== -1) {
                console.log(`‚úÖ Found column for ${feeType} grade ${grade}: "${matchedColumnName}" (score: ${bestMatchScore})`);
                if (row[paymentColumnIndex]) {
                    console.log(`   Value: "${row[paymentColumnIndex]}"`);
                    
                    // Special logging for Siswi Baru Putri
                    if (feeType === 'Siswi Baru Putri') {
                        console.log(`   üîç Siswi Baru Putri - Raw value: "${row[paymentColumnIndex]}", Expected: ${expectedAmount}`);
                    }
                }
            } else {
                console.log(`‚ùå No column found for ${feeType} grade ${grade}`);
                console.log(`   Tried ${possibleColumnNames.length} variations:`, possibleColumnNames.slice(0, 15), '...');
                
                if (feeType.includes('Semester')) {
                    console.log(`   üîç Semester payment - checking headers for patterns:`, 
                        headers.filter(h => h.toLowerCase().includes('lks') || 
                                           h.toLowerCase().includes('uhb') || 
                                           h.toLowerCase().includes('pas') || 
                                           h.toLowerCase().includes('uas') ||
                                           h.toLowerCase().includes('sem') ||
                                           h.toLowerCase().includes('semester') ||
                                           h.toLowerCase().includes('ulangan') ||
                                           h.toLowerCase().includes('harian')));
                }
                
                if (feeType.includes('Infaq') || feeType.includes('Kenaikan')) {
                    console.log(`   üîç Yearly payment - checking headers for patterns:`, 
                        headers.filter(h => h.toLowerCase().includes('infaq') || 
                                           h.toLowerCase().includes('kenaikan') ||
                                           h.toLowerCase().includes('kelas')));
                }
                
                // Show all headers for debugging
                if (feeType.includes('Ulangan Harian') || feeType.includes('Ulangan Semester') || feeType.includes('Infaq') || feeType.includes('Siswi Baru') || feeType.includes('Siswa Baru')) {
                    console.log(`   üìã All available headers:`, headers);
                }
            }
            
            // If no exact match found, try fallback patterns for semester payments
            if (paymentColumnIndex === -1 && feeType.includes('Semester')) {
                console.log(`üîÑ Trying fallback patterns for semester payment: ${feeType}`);
                
                // Extract semester number and base type
                const semesterMatch = feeType.match(/(Semester\s*[12])/);
                if (semesterMatch) {
                    const semesterNum = semesterMatch[1].replace(/\D/g, '');
                    const baseType = feeType.replace(semesterMatch[1], '').trim();
                    
                    // Try common fallback patterns
                    const fallbackPatterns = [];
                    
                    if (baseType.toLowerCase().includes('lks')) {
                        fallbackPatterns.push(`LKS_S${semesterNum}_${grade}`, `lks_s${semesterNum}_${grade}`, `LKS${semesterNum}_${grade}`);
                    }
                    if (baseType.toLowerCase().includes('ulangan harian')) {
                        fallbackPatterns.push(
                            `UHB_S${semesterNum}_${grade}`, `uhb_s${semesterNum}_${grade}`, `UHB${semesterNum}_${grade}`,
                            `uhb_${grade}_s${semesterNum}`, `UHB_${grade}_S${semesterNum}`,
                            `uhb${grade}s${semesterNum}`, `UHB${grade}S${semesterNum}`,
                            `uh_${grade}_s${semesterNum}`, `UH_${grade}_S${semesterNum}`,
                            `ulangan_harian_${grade}_s${semesterNum}`, `harian_${grade}_s${semesterNum}`
                        );
                    }
                    if (baseType.toLowerCase().includes('ulangan semester')) {
                        fallbackPatterns.push(`PAS_S${semesterNum}_${grade}`, `pas_s${semesterNum}_${grade}`, `UAS_S${semesterNum}_${grade}`, `PAS${semesterNum}_${grade}`);
                    }
                    
                    // Try each fallback pattern
                    for (const pattern of fallbackPatterns) {
                        const fallbackIndex = headers.findIndex(h => 
                            h.toLowerCase().replace(/[\s_-]/g, '') === pattern.toLowerCase().replace(/[\s_-]/g, '')
                        );
                        
                        if (fallbackIndex !== -1) {
                            console.log(`‚úÖ Found fallback column: "${headers[fallbackIndex]}" for pattern: ${pattern}`);
                            paymentColumnIndex = fallbackIndex;
                            matchedColumnName = headers[fallbackIndex];
                            break;
                        }
                    }
                }
            }
            
            // Special flexible search for Ulangan Harian if still not found
            if (paymentColumnIndex === -1 && feeType.includes('Ulangan Harian')) {
                console.log(`üîç Flexible search for Ulangan Harian: ${feeType}`);
                
                // Extract semester info
                const semesterMatch = feeType.match(/Semester\s*([12])/);
                const semesterNum = semesterMatch ? semesterMatch[1] : '1';
                
                // Try very flexible patterns
                const flexiblePatterns = [
                    // Common abbreviations with various formats
                    `uhb`, `UHB`, `uh`, `UH`,
                    // With semester indicators
                    `uhb${semesterNum}`, `UHB${semesterNum}`, `uh${semesterNum}`, `UH${semesterNum}`,
                    // With grade
                    `uhb${grade}`, `UHB${grade}`, `uh${grade}`, `UH${grade}`,
                    // Combined
                    `uhb${grade}${semesterNum}`, `UHB${grade}${semesterNum}`,
                    // Full words
                    `ulangan_harian`, `ulanganharian`, `harian`
                ];
                
                // Search for columns containing these patterns
                for (const pattern of flexiblePatterns) {
                    const flexIndex = headers.findIndex(h => {
                        const headerLower = h.toLowerCase().replace(/[\s_-]/g, '');
                        const patternLower = pattern.toLowerCase();
                        
                        // Check if header contains the pattern and semester info
                        return headerLower.includes(patternLower) && 
                               (headerLower.includes(`sem${semesterNum}`) || 
                                headerLower.includes(`semester${semesterNum}`) ||
                                headerLower.includes(`s${semesterNum}`) ||
                                headerLower.includes(semesterNum));
                    });
                    
                    if (flexIndex !== -1) {
                        console.log(`‚úÖ Found flexible match for Ulangan Harian: "${headers[flexIndex]}" (pattern: ${pattern})`);
                        paymentColumnIndex = flexIndex;
                        matchedColumnName = headers[flexIndex];
                        bestMatchScore = 90;
                        break;
                    }
                }
                
                // If still not found, try even more flexible search
                if (paymentColumnIndex === -1) {
                    console.log(`üîç Ultra-flexible search for any UHB/Ulangan Harian column...`);
                    
                    const ultraFlexIndex = headers.findIndex(h => {
                        const headerLower = h.toLowerCase();
                        return (headerLower.includes('uhb') || 
                                headerLower.includes('ulangan') && headerLower.includes('harian') ||
                                headerLower.includes('uh') && !headerLower.includes('buku')) &&
                               (headerLower.includes(grade.toString()) || 
                                headerLower.includes(`sem${semesterNum}`) ||
                                headerLower.includes(semesterNum));
                    });
                    
                    if (ultraFlexIndex !== -1) {
                        console.log(`‚úÖ Found ultra-flexible match: "${headers[ultraFlexIndex]}"`);
                        paymentColumnIndex = ultraFlexIndex;
                        matchedColumnName = headers[ultraFlexIndex];
                        bestMatchScore = 80;
                    }
                }
            }
            
            // Special flexible search for Buku LKS if still not found
            if (paymentColumnIndex === -1 && feeType.includes('Buku LKS')) {
                console.log(`üîç Flexible search for Buku LKS: ${feeType}`);
                
                // Extract semester info
                const semesterMatch = feeType.match(/Semester\s*([12])/);
                const semesterNum = semesterMatch ? semesterMatch[1] : '1';
                
                // Try very flexible patterns for LKS
                const flexiblePatterns = [
                    // Common abbreviations with various formats
                    `lks`, `LKS`, `buku_lks`, `bukuLKS`, `buku`,
                    // With semester indicators
                    `lks${semesterNum}`, `LKS${semesterNum}`,
                    // With grade
                    `lks${grade}`, `LKS${grade}`,
                    // Combined
                    `lks${grade}${semesterNum}`, `LKS${grade}${semesterNum}`,
                    // Full words
                    `buku_lks`, `bukuLKS`, `lks_buku`
                ];
                
                // Search for columns containing these patterns
                for (const pattern of flexiblePatterns) {
                    const flexIndex = headers.findIndex(h => {
                        const headerLower = h.toLowerCase().replace(/[\s_-]/g, '');
                        const patternLower = pattern.toLowerCase();
                        
                        // Check if header contains the pattern and semester info
                        return headerLower.includes(patternLower) && 
                               (headerLower.includes(`sem${semesterNum}`) || 
                                headerLower.includes(`semester${semesterNum}`) ||
                                headerLower.includes(`s${semesterNum}`) ||
                                headerLower.includes(semesterNum)) &&
                               (headerLower.includes(grade.toString()) || 
                                headerLower.includes(`${grade}`));
                    });
                    
                    if (flexIndex !== -1) {
                        console.log(`‚úÖ Found flexible match for Buku LKS: "${headers[flexIndex]}" (pattern: ${pattern})`);
                        paymentColumnIndex = flexIndex;
                        matchedColumnName = headers[flexIndex];
                        bestMatchScore = 90;
                        break;
                    }
                }
                
                // If still not found, try even more flexible search
                if (paymentColumnIndex === -1) {
                    console.log(`üîç Ultra-flexible search for any LKS column...`);
                    
                    const ultraFlexIndex = headers.findIndex(h => {
                        const headerLower = h.toLowerCase();
                        return headerLower.includes('lks') &&
                               (headerLower.includes(grade.toString()) || 
                                headerLower.includes(`sem${semesterNum}`) ||
                                headerLower.includes(semesterNum));
                    });
                    
                    if (ultraFlexIndex !== -1) {
                        console.log(`‚úÖ Found ultra-flexible match for Buku LKS: "${headers[ultraFlexIndex]}"`);
                        paymentColumnIndex = ultraFlexIndex;
                        matchedColumnName = headers[ultraFlexIndex];
                        bestMatchScore = 80;
                    }
                }
            }
            
            // Special flexible search for Ulangan Semester if still not found
            if (paymentColumnIndex === -1 && feeType.includes('Ulangan Semester')) {
                console.log(`üîç Flexible search for Ulangan Semester: ${feeType}`);
                
                // Extract semester info
                const semesterMatch = feeType.match(/Semester\s*([12])/);
                const semesterNum = semesterMatch ? semesterMatch[1] : '1';
                
                // Try very flexible patterns for PAS/UAS
                const flexiblePatterns = [
                    // Common abbreviations with various formats
                    `pas`, `PAS`, `uas`, `UAS`, `us`, `US`,
                    // With semester indicators
                    `pas${semesterNum}`, `PAS${semesterNum}`, `uas${semesterNum}`, `UAS${semesterNum}`,
                    `us${semesterNum}`, `US${semesterNum}`,
                    // With grade
                    `pas${grade}`, `PAS${grade}`, `uas${grade}`, `UAS${grade}`,
                    `us${grade}`, `US${grade}`,
                    // Combined
                    `pas${grade}${semesterNum}`, `PAS${grade}${semesterNum}`,
                    `uas${grade}${semesterNum}`, `UAS${grade}${semesterNum}`,
                    `us${grade}${semesterNum}`, `US${grade}${semesterNum}`,
                    // Full words
                    `ulangan_semester`, `ulangansemester`, `semester`
                ];
                
                // Search for columns containing these patterns
                for (const pattern of flexiblePatterns) {
                    const flexIndex = headers.findIndex(h => {
                        const headerLower = h.toLowerCase().replace(/[\s_-]/g, '');
                        const patternLower = pattern.toLowerCase();
                        
                        // Check if header contains the pattern and semester info
                        return headerLower.includes(patternLower) && 
                               (headerLower.includes(`sem${semesterNum}`) || 
                                headerLower.includes(`semester${semesterNum}`) ||
                                headerLower.includes(`s${semesterNum}`) ||
                                headerLower.includes(semesterNum));
                    });
                    
                    if (flexIndex !== -1) {
                        console.log(`‚úÖ Found flexible match for Ulangan Semester: "${headers[flexIndex]}" (pattern: ${pattern})`);
                        paymentColumnIndex = flexIndex;
                        matchedColumnName = headers[flexIndex];
                        bestMatchScore = 90;
                        break;
                    }
                }
                
                // If still not found, try even more flexible search
                if (paymentColumnIndex === -1) {
                    console.log(`üîç Ultra-flexible search for any PAS/UAS/Ulangan Semester column...`);
                    
                    const ultraFlexIndex = headers.findIndex(h => {
                        const headerLower = h.toLowerCase();
                        return (headerLower.includes('pas') || 
                                headerLower.includes('uas') ||
                                headerLower.includes('us') ||
                                (headerLower.includes('ulangan') && headerLower.includes('semester')) ||
                                (headerLower.includes('semester') && !headerLower.includes('lks') && !headerLower.includes('harian'))) &&
                               (headerLower.includes(grade.toString()) || 
                                headerLower.includes(`sem${semesterNum}`) ||
                                headerLower.includes(semesterNum));
                    });
                    
                    if (ultraFlexIndex !== -1) {
                        console.log(`‚úÖ Found ultra-flexible match for Ulangan Semester: "${headers[ultraFlexIndex]}"`);
                        paymentColumnIndex = ultraFlexIndex;
                        matchedColumnName = headers[ultraFlexIndex];
                        bestMatchScore = 80;
                    }
                }
            }
            
            if (paymentColumnIndex === -1 || !row[paymentColumnIndex]) {
                return {
                    paid: false,
                    amount: 0,
                    remaining: expectedAmount,
                    status: 'unpaid',
                    installments: []
                };
            }
            
            const cellValue = row[paymentColumnIndex].toString().trim();
            
            // Check for full payment indicators
            if (cellValue.toLowerCase() === 'lunas' || 
                cellValue.toLowerCase() === 'paid' || 
                cellValue === '1') {
                return {
                    paid: true,
                    amount: expectedAmount,
                    remaining: 0,
                    status: 'paid',
                    installments: [{
                        amount: expectedAmount,
                        date: new Date().toISOString().split('T')[0],
                        note: 'Lunas'
                    }]
                };
            }
            
            // Check for numeric values (installments)
            const numericValue = parseFloat(cellValue.replace(/[^\d.-]/g, ''));
            if (!isNaN(numericValue) && numericValue > 0) {
                const remaining = Math.max(0, expectedAmount - numericValue);
                const isPaid = remaining === 0;
                
                // Special logging for Siswi Baru Putri
                if (feeType === 'Siswi Baru Putri') {
                    console.log(`üí∞ Siswi Baru Putri payment detected:`);
                    console.log(`   - Raw value: "${cellValue}"`);
                    console.log(`   - Parsed amount: ${numericValue}`);
                    console.log(`   - Expected: ${expectedAmount}`);
                    console.log(`   - Remaining: ${remaining}`);
                    console.log(`   - Status: ${isPaid ? 'LUNAS' : 'CICILAN'}`);
                }
                
                return {
                    paid: isPaid,
                    amount: numericValue,
                    remaining: remaining,
                    status: isPaid ? 'paid' : 'installment',
                    installments: [{
                        amount: numericValue,
                        date: new Date().toISOString().split('T')[0],
                        note: isPaid ? 'Lunas' : 'Cicilan'
                    }]
                };
            }
            
            // Check for multiple installments (comma or semicolon separated)
            if (cellValue.includes(',') || cellValue.includes(';')) {
                const separator = cellValue.includes(',') ? ',' : ';';
                const installmentStrings = cellValue.split(separator);
                const installments = [];
                let totalPaid = 0;
                
                installmentStrings.forEach((installmentStr, index) => {
                    const cleanStr = installmentStr.trim();
                    const amount = parseFloat(cleanStr.replace(/[^\d.-]/g, ''));
                    
                    if (!isNaN(amount) && amount > 0) {
                        totalPaid += amount;
                        installments.push({
                            amount: amount,
                            date: new Date().toISOString().split('T')[0],
                            note: `Cicilan ${index + 1}`
                        });
                    }
                });
                
                if (installments.length > 0) {
                    const remaining = Math.max(0, expectedAmount - totalPaid);
                    const isPaid = remaining === 0;
                    
                    return {
                        paid: isPaid,
                        amount: totalPaid,
                        remaining: remaining,
                        status: isPaid ? 'paid' : 'installment',
                        installments: installments
                    };
                }
            }
            
            // Default: unpaid
            return {
                paid: false,
                amount: 0,
                remaining: expectedAmount,
                status: 'unpaid',
                installments: []
            };
        }
        
        // Helper function to process payment values
        function processPaymentValue(cellValue, expectedAmount, feeType) {
            if (!cellValue) {
                return {
                    paid: false,
                    amount: 0,
                    remaining: expectedAmount,
                    status: 'unpaid',
                    installments: []
                };
            }
            
            const cellValueStr = cellValue.toString().trim();
            
            // Check for full payment indicators
            if (cellValueStr.toLowerCase() === 'lunas' || 
                cellValueStr.toLowerCase() === 'paid' || 
                cellValueStr === '1') {
                return {
                    paid: true,
                    amount: expectedAmount,
                    remaining: 0,
                    status: 'paid',
                    installments: [{
                        amount: expectedAmount,
                        date: new Date().toISOString().split('T')[0],
                        note: 'Lunas'
                    }]
                };
            }
            
            // Check for numeric values (installments)
            const numericValue = parseFloat(cellValueStr.replace(/[^\d.-]/g, ''));
            if (!isNaN(numericValue) && numericValue > 0) {
                const remaining = Math.max(0, expectedAmount - numericValue);
                const isPaid = remaining === 0;
                
                console.log(`üí∞ ${feeType} payment: ${numericValue}, Expected: ${expectedAmount}, Status: ${isPaid ? 'LUNAS' : 'CICILAN'}`);
                
                return {
                    paid: isPaid,
                    amount: numericValue,
                    remaining: remaining,
                    status: isPaid ? 'paid' : 'installment',
                    installments: [{
                        amount: numericValue,
                        date: new Date().toISOString().split('T')[0],
                        note: isPaid ? 'Lunas' : 'Cicilan'
                    }]
                };
            }
            
            // Check for multiple installments (comma or semicolon separated)
            if (cellValueStr.includes(',') || cellValueStr.includes(';')) {
                const separator = cellValueStr.includes(',') ? ',' : ';';
                const installmentStrings = cellValueStr.split(separator);
                const installments = [];
                let totalPaid = 0;
                
                installmentStrings.forEach((installmentStr, index) => {
                    const cleanStr = installmentStr.trim();
                    const amount = parseFloat(cleanStr.replace(/[^\d.-]/g, ''));
                    
                    if (!isNaN(amount) && amount > 0) {
                        totalPaid += amount;
                        installments.push({
                            amount: amount,
                            date: new Date().toISOString().split('T')[0],
                            note: `Cicilan ${index + 1}`
                        });
                    }
                });
                
                if (installments.length > 0) {
                    const remaining = Math.max(0, expectedAmount - totalPaid);
                    const isPaid = remaining === 0;
                    
                    return {
                        paid: isPaid,
                        amount: totalPaid,
                        remaining: remaining,
                        status: isPaid ? 'paid' : 'installment',
                        installments: installments
                    };
                }
            }
            
            // Default: unpaid
            return {
                paid: false,
                amount: 0,
                remaining: expectedAmount,
                status: 'unpaid',
                installments: []
            };
        }

        // Set loading state for search button
        function setLoadingState(loading) {
            const button = document.getElementById('searchButton');
            const text = document.getElementById('searchText');
            const spinner = document.getElementById('loadingSpinner');
            
            if (loading) {
                text.textContent = 'Mencari...';
                spinner.classList.remove('hidden');
                button.disabled = true;
                button.classList.add('opacity-75');
            } else {
                text.textContent = 'üîç Cari Data Siswa';
                spinner.classList.add('hidden');
                button.disabled = false;
                button.classList.remove('opacity-75');
            }
        }

        // Display student information
        function displayStudentInfo(nisn, student) {
            // Show student info section
            document.getElementById('studentInfo').classList.remove('hidden');
            
            // Show all payment information sections
            document.getElementById('currentMonthSection').classList.remove('hidden');
            document.getElementById('paymentSummarySection').classList.remove('hidden');
            document.getElementById('componentBreakdownSection').classList.remove('hidden');
            document.getElementById('yearTabs').classList.remove('hidden');
            document.getElementById('infoSection').classList.remove('hidden');
            
            // Calculate current class based on entry year
            const currentClass = calculateCurrentClass(student.entryYear);
            
            // Fill student details
            document.getElementById('studentName').textContent = student.name || 'Nama tidak tersedia';
            document.getElementById('displayNisn').textContent = nisn;
            document.getElementById('studentClass').textContent = currentClass;
            document.getElementById('studentMajor').textContent = student.major || '-';
            document.getElementById('studentGender').textContent = student.gender === 'laki-laki' ? 'Laki-laki' : student.gender === 'perempuan' ? 'Perempuan' : (student.gender || '-');
            document.getElementById('entryYear').textContent = student.entryYear || '-';
            document.getElementById('studentInitial').textContent = (student.name || 'A').charAt(0);

            // Update tab years based on entry year
            updateTabYears(student.entryYear);

            // Calculate totals
            calculateTotals(student);
            
            // Show current year payments
            showYear(currentYear);
            
            // Update current month status
            updateCurrentMonthStatus(student);
        }

        // Calculate payment totals
        function calculateTotals(student) {
            let totalPaid = 0;
            let totalUnpaid = 0;
            
            // Component totals
            let totalSpp = 0;
            let totalSemester = 0;
            let totalOneTime = 0;
            let totalOthers = 0;

            Object.entries(student.payments).forEach(([grade, yearPayments]) => {
                Object.entries(yearPayments).forEach(([feeType, payment]) => {
                    // Add the actual paid amount
                    totalPaid += payment.paidAmount || 0;
                    // Add the remaining amount to unpaid
                    totalUnpaid += payment.remaining || 0;
                    
                    // Calculate component totals (expected amounts) based on fee type
                    const expectedAmount = payment.amount || 0;
                    
                    if (feeType.includes('SPP')) {
                        totalSpp += expectedAmount;
                    } else if (feeType.includes('LKS') || feeType.includes('Ulangan')) {
                        totalSemester += expectedAmount;
                    } else if (feeType.includes('Siswa Baru') || feeType.includes('Siswi Baru') || 
                              feeType.includes('Perpisahan') || feeType.includes('Study Tour') || 
                              feeType.includes('Buku Kenangan') || feeType.includes('Ujian Akhir')) {
                        totalOneTime += expectedAmount;
                    } else {
                        totalOthers += expectedAmount;
                    }
                });
            });

            const totalOverall = totalPaid + totalUnpaid;

            document.getElementById('totalPaid').textContent = formatCurrency(totalPaid);
            document.getElementById('totalUnpaid').textContent = formatCurrency(totalUnpaid);
            document.getElementById('totalOverall').textContent = formatCurrency(totalOverall);
            document.getElementById('totalSpp').textContent = formatCurrency(totalSpp);
            document.getElementById('totalSemester').textContent = formatCurrency(totalSemester);
            document.getElementById('totalOneTime').textContent = formatCurrency(totalOneTime);
            document.getElementById('totalOthers').textContent = formatCurrency(totalOthers);
        }

        // Update current month status
        function updateCurrentMonthStatus(student) {
            // Get current month name
            const currentDate = new Date();
            const monthNames = [
                'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
            ];
            const currentMonthName = monthNames[currentDate.getMonth()];
            
            // Check SPP payment status for current grade
            const currentGrade = getCurrentGrade(student);
            let sppPaid = false;
            let tabunganPaid = false;
            
            // Check SPP payment for current month
            const sppKey = `SPP ${currentMonthName}`;
            if (student.payments[currentGrade] && student.payments[currentGrade][sppKey]) {
                sppPaid = student.payments[currentGrade][sppKey].paid;
            }
            
            // Check Tabungan payment for current month (only for grade 10)
            const tabunganKey = `Tabungan ${currentMonthName}`;
            if (currentGrade === 10 && student.payments[currentGrade] && student.payments[currentGrade][tabunganKey]) {
                tabunganPaid = student.payments[currentGrade][tabunganKey].paid;
            }

            const statusElement = document.getElementById('currentMonthStatus');
            
            // Create status text based on grade and payment status
            let statusText = '';
            let statusClass = '';
            
            if (currentGrade === 10) {
                // For grade 10, show both SPP and Tabungan
                if (sppPaid && tabunganPaid) {
                    statusText = `SPP & Tabungan ${currentMonthName} Lunas`;
                    statusClass = 'px-4 py-2 rounded-full text-white font-semibold text-sm status-paid';
                } else if (sppPaid && !tabunganPaid) {
                    statusText = `SPP ${currentMonthName} Lunas, Tabungan Belum Bayar`;
                    statusClass = 'px-4 py-2 rounded-full text-white font-semibold text-sm status-partial';
                } else if (!sppPaid && tabunganPaid) {
                    statusText = `Tabungan ${currentMonthName} Lunas, SPP Belum Bayar`;
                    statusClass = 'px-4 py-2 rounded-full text-white font-semibold text-sm status-partial';
                } else {
                    statusText = `SPP & Tabungan ${currentMonthName} Belum Bayar`;
                    statusClass = 'px-4 py-2 rounded-full text-white font-semibold text-sm status-unpaid';
                }
            } else {
                // For grade 11 and 12, show only SPP
                if (sppPaid) {
                    statusText = `SPP ${currentMonthName} Lunas`;
                    statusClass = 'px-4 py-2 rounded-full text-white font-semibold text-sm status-paid';
                } else {
                    statusText = `SPP ${currentMonthName} Belum Bayar`;
                    statusClass = 'px-4 py-2 rounded-full text-white font-semibold text-sm status-unpaid';
                }
            }
            
            statusElement.textContent = statusText;
            statusElement.className = statusClass;
        }

        // Calculate current class based on entry year
        function calculateCurrentClass(entryYear) {
            if (!entryYear) return '-';
            
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1; // JavaScript months are 0-indexed
            const entryYearInt = parseInt(entryYear);
            
            // School year starts in July (month 7)
            // If current month is January-June, we're still in the previous academic year
            let academicYear = currentYear;
            if (currentMonth < 7) {
                academicYear = currentYear - 1;
            }
            
            const yearsSinceEntry = academicYear - entryYearInt;
            
            if (yearsSinceEntry < 0) return 'Belum Masuk';
            else if (yearsSinceEntry === 0) return '10';
            else if (yearsSinceEntry === 1) return '11';
            else if (yearsSinceEntry === 2) return '12';
            else return 'Lulus';
        }

        // Get current grade based on entry year
        function getCurrentGrade(student) {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;
            const entryYear = parseInt(student.entryYear);
            
            // School year starts in July
            let academicYear = currentYear;
            if (currentMonth < 7) {
                academicYear = currentYear - 1;
            }
            
            const yearsSinceEntry = academicYear - entryYear;
            
            if (yearsSinceEntry <= 0) return 10;
            else if (yearsSinceEntry === 1) return 11;
            else return 12;
        }

        // Update tab years based on student's entry year
        function updateTabYears(entryYear) {
            if (!entryYear) return;
            
            const entryYearInt = parseInt(entryYear);
            
            // Calculate academic years for each grade
            const grade10Year = `${entryYearInt}/${entryYearInt + 1}`;
            const grade11Year = `${entryYearInt + 1}/${entryYearInt + 2}`;
            const grade12Year = `${entryYearInt + 2}/${entryYearInt + 3}`;
            
            // Update tab text content
            document.getElementById('tab10').innerHTML = `Kelas 10 (${grade10Year})`;
            document.getElementById('tab11').innerHTML = `Kelas 11 (${grade11Year})`;
            document.getElementById('tab12').innerHTML = `Kelas 12 (${grade12Year})`;
        }

        // Show payments for specific year
        function showYear(year) {
            currentYear = year;
            
            // Update tab styles
            document.querySelectorAll('[id^="tab"]').forEach(tab => {
                tab.className = 'flex-1 py-3 px-4 rounded-md font-semibold transition-all duration-300 tab-inactive text-gray-600 hover:bg-gray-200';
            });
            document.getElementById(`tab${year}`).className = 'flex-1 py-3 px-4 rounded-md font-semibold transition-all duration-300 tab-active text-white';

            // Display payment details for the year
            displayPaymentDetails(year);
        }

        // Display payment details for a specific year
        function displayPaymentDetails(year) {
            if (!currentStudent) return;

            const payments = currentStudent.payments[year];
            const detailsContainer = document.getElementById('paymentDetails');
            
            // Group payments by frequency
            const paymentsByFrequency = {
                monthly: [],
                semester: [],
                yearly: [],
                oneTime: []
            };

            Object.entries(payments).forEach(([feeType, payment]) => {
                const paymentData = { feeType, ...payment };
                
                if (payment.type === 'monthly') {
                    paymentsByFrequency.monthly.push(paymentData);
                } else if (payment.type === 'semester') {
                    paymentsByFrequency.semester.push(paymentData);
                } else if (payment.type === 'yearly') {
                    paymentsByFrequency.yearly.push(paymentData);
                } else if (payment.type === 'oneTime') {
                    paymentsByFrequency.oneTime.push(paymentData);
                }
            });

            let html = `
                <div class="payment-section rounded-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h4 class="text-lg font-semibold text-gray-800">Detail Pembayaran Kelas ${year}</h4>
                        <button onclick="downloadExcel(${year})" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2">
                            <span>üìä</span>
                            <span>Download Excel</span>
                        </button>
                    </div>
                    
                    <!-- Detailed Payment Table -->
                    <div class="mb-8 bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-6 py-3 border-b border-gray-200">
                            <h5 class="text-md font-semibold text-gray-800">üìã Tabel Detail Pembayaran Kelas ${year}</h5>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm" id="paymentTable${year}">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700 border-b">No</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700 border-b">Jenis Pembayaran</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700 border-b">Kategori</th>
                                        <th class="px-4 py-3 text-right font-semibold text-gray-700 border-b">Nominal</th>
                                        <th class="px-4 py-3 text-right font-semibold text-gray-700 border-b">Terbayar</th>
                                        <th class="px-4 py-3 text-right font-semibold text-gray-700 border-b">Sisa</th>
                                        <th class="px-4 py-3 text-center font-semibold text-gray-700 border-b">Status</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700 border-b">Tanggal Bayar</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-700 border-b">Keterangan</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${generateTableRows(paymentsByFrequency, year)}
                                </tbody>
                                <tfoot class="bg-gray-50 border-t-2 border-gray-300">
                                    ${generateTableFooter(paymentsByFrequency)}
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            detailsContainer.innerHTML = html;
        }

        // Generate payment card HTML
        function generatePaymentCard(payment) {
            let statusClass, statusIcon, statusText;
            
            if (payment.status === 'paid') {
                statusClass = 'status-paid';
                statusIcon = '‚úÖ';
                statusText = 'Lunas';
            } else if (payment.status === 'installment') {
                statusClass = 'status-partial';
                statusIcon = 'üîÑ';
                statusText = 'Cicilan';
            } else {
                statusClass = 'status-unpaid';
                statusIcon = '‚è∞';
                statusText = 'Belum Bayar';
            }
            
            const paymentDate = payment.paid ? `Dibayar: ${formatDate(payment.date)}` : 'Belum ada pembayaran';

            // Get fee type icon
            let feeIcon = 'üí∞';
            if (payment.feeType.includes('SPP')) feeIcon = 'üìö';
            else if (payment.feeType.includes('Tabungan')) feeIcon = 'üè¶';
            else if (payment.feeType.includes('LKS')) feeIcon = 'üìñ';
            else if (payment.feeType.includes('Ulangan Harian')) feeIcon = 'üìù';
            else if (payment.feeType.includes('Ulangan Semester')) feeIcon = 'üìã';
            else if (payment.feeType.includes('Infaq')) feeIcon = 'ü§≤';
            else if (payment.feeType.includes('Perpisahan')) feeIcon = 'üéì';
            else if (payment.feeType.includes('Study Tour')) feeIcon = 'üöå';
            else if (payment.feeType.includes('Buku Kenangan')) feeIcon = 'üìî';
            else if (payment.feeType.includes('Ujian')) feeIcon = 'üìã';
            else if (payment.feeType.includes('Siswa Baru') || payment.feeType.includes('Siswi Baru')) feeIcon = 'üÜï';

            // Determine border color based on status
            let borderColor = 'border-red-500';
            if (payment.status === 'paid') borderColor = 'border-green-500';
            else if (payment.status === 'installment') borderColor = 'border-yellow-500';

            // Build installment details
            let installmentDetails = '';
            if (payment.installments && payment.installments.length > 0) {
                installmentDetails = `
                    <div class="mt-3 pt-2 border-t border-gray-200">
                        <div class="text-xs text-gray-600 mb-1">Detail Pembayaran:</div>
                        ${payment.installments.map(inst => `
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>${inst.note}</span>
                                <span>${formatCurrency(inst.amount)}</span>
                            </div>
                        `).join('')}
                        ${payment.remaining > 0 ? `
                            <div class="flex justify-between text-xs font-medium text-red-600 mt-1 pt-1 border-t border-gray-100">
                                <span>Sisa</span>
                                <span>${formatCurrency(payment.remaining)}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            return `
                <div class="payment-card rounded-lg p-4 border-l-4 ${borderColor} shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="text-lg">${feeIcon}</span>
                            <div>
                                <h5 class="font-semibold text-gray-800 text-sm">${payment.feeType}</h5>
                                <p class="text-xs text-gray-500">${payment.frequency || ''}</p>
                            </div>
                        </div>
                        <span class="text-xl">${statusIcon}</span>
                    </div>
                    <div class="mb-2">
                        <p class="text-lg font-bold text-blue-600">${formatCurrency(payment.amount)}</p>
                        ${payment.status === 'installment' ? `
                            <p class="text-sm text-green-600">Terbayar: ${formatCurrency(payment.paidAmount || 0)}</p>
                        ` : ''}
                    </div>
                    <div class="flex items-center justify-between mb-2">
                        <span class="px-2 py-1 rounded-full text-xs font-medium text-white ${statusClass}">
                            ${statusText}
                        </span>
                    </div>
                    <p class="text-xs text-gray-500">${paymentDate}</p>
                    ${installmentDetails}
                </div>
            `;
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        // Generate table rows for payment details
        function generateTableRows(paymentsByFrequency, year) {
            let rows = '';
            let rowNumber = 1;
            
            // Define order of categories
            const categoryOrder = ['monthly', 'semester', 'yearly', 'oneTime'];
            const categoryNames = {
                'monthly': 'Bulanan',
                'semester': 'Per Semester', 
                'yearly': 'Tahunan',
                'oneTime': 'Sekali Bayar'
            };
            
            categoryOrder.forEach(category => {
                if (paymentsByFrequency[category].length > 0) {
                    paymentsByFrequency[category].forEach(payment => {
                        const statusBadge = getStatusBadge(payment.status);
                        const paymentDate = payment.paid ? formatDate(payment.date) : '-';
                        const keterangan = generateKeterangan(payment);
                        
                        rows += `
                            <tr class="hover:bg-gray-50 border-b border-gray-100">
                                <td class="px-4 py-3 text-gray-700">${rowNumber}</td>
                                <td class="px-4 py-3 text-gray-800 font-medium">${payment.feeType}</td>
                                <td class="px-4 py-3 text-gray-600">${categoryNames[category]}</td>
                                <td class="px-4 py-3 text-right text-gray-800 font-medium">${formatCurrency(payment.amount)}</td>
                                <td class="px-4 py-3 text-right text-green-600 font-medium">${formatCurrency(payment.paidAmount || 0)}</td>
                                <td class="px-4 py-3 text-right text-red-600 font-medium">${formatCurrency(payment.remaining || 0)}</td>
                                <td class="px-4 py-3 text-center">${statusBadge}</td>
                                <td class="px-4 py-3 text-gray-600">${paymentDate}</td>
                                <td class="px-4 py-3 text-gray-600 text-xs">${keterangan}</td>
                            </tr>
                        `;
                        rowNumber++;
                    });
                }
            });
            
            return rows;
        }

        // Generate table footer with totals
        function generateTableFooter(paymentsByFrequency) {
            let totalNominal = 0;
            let totalTerbayar = 0;
            let totalSisa = 0;
            
            Object.values(paymentsByFrequency).forEach(categoryPayments => {
                categoryPayments.forEach(payment => {
                    totalNominal += payment.amount || 0;
                    totalTerbayar += payment.paidAmount || 0;
                    totalSisa += payment.remaining || 0;
                });
            });
            
            return `
                <tr class="bg-gray-100 font-bold">
                    <td colspan="3" class="px-4 py-4 text-gray-800 font-bold">TOTAL KESELURUHAN</td>
                    <td class="px-4 py-4 text-right text-blue-800 font-bold text-lg">${formatCurrency(totalNominal)}</td>
                    <td class="px-4 py-4 text-right text-green-700 font-bold text-lg">${formatCurrency(totalTerbayar)}</td>
                    <td class="px-4 py-4 text-right text-red-700 font-bold text-lg">${formatCurrency(totalSisa)}</td>
                    <td colspan="3" class="px-4 py-4"></td>
                </tr>
            `;
        }

        // Get status badge HTML
        function getStatusBadge(status) {
            if (status === 'paid') {
                return '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">‚úÖ Lunas</span>';
            } else if (status === 'installment') {
                return '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium">üîÑ Cicilan</span>';
            } else {
                return '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">‚è∞ Belum Bayar</span>';
            }
        }

        // Generate keterangan text
        function generateKeterangan(payment) {
            if (payment.installments && payment.installments.length > 0) {
                const installmentDetails = payment.installments.map(inst => 
                    `${inst.note}: ${formatCurrency(inst.amount)}`
                ).join(', ');
                return installmentDetails;
            } else if (payment.paid) {
                return 'Pembayaran lunas';
            } else {
                return 'Belum ada pembayaran';
            }
        }

        // Download Excel function
        function downloadExcel(year) {
            if (!currentStudent) {
                alert('Tidak ada data siswa untuk diunduh!');
                return;
            }

            // Get table data
            const payments = currentStudent.payments[year];
            const paymentsByFrequency = {
                monthly: [],
                semester: [],
                yearly: [],
                oneTime: []
            };

            Object.entries(payments).forEach(([feeType, payment]) => {
                const paymentData = { feeType, ...payment };
                
                if (payment.type === 'monthly') {
                    paymentsByFrequency.monthly.push(paymentData);
                } else if (payment.type === 'semester') {
                    paymentsByFrequency.semester.push(paymentData);
                } else if (payment.type === 'yearly') {
                    paymentsByFrequency.yearly.push(paymentData);
                } else if (payment.type === 'oneTime') {
                    paymentsByFrequency.oneTime.push(paymentData);
                }
            });

            // Create Excel data
            const excelData = [];
            
            // Header information
            excelData.push(['DETAIL PEMBAYARAN SISWA']);
            excelData.push(['MA NU HASYIM ASY\'ARI 1 KUDUS']);
            excelData.push(['']);
            excelData.push(['Nama Siswa:', currentStudent.name || '-']);
            excelData.push(['NISN:', document.getElementById('displayNisn').textContent]);
            excelData.push(['Kelas:', `${year}`]);
            excelData.push(['Jurusan:', currentStudent.major || '-']);
            excelData.push(['Jenis Kelamin:', currentStudent.gender || '-']);
            excelData.push(['Tahun Masuk:', currentStudent.entryYear || '-']);
            excelData.push(['Tanggal Export:', new Date().toLocaleDateString('id-ID')]);
            excelData.push(['']);
            
            // Table headers
            excelData.push([
                'No',
                'Jenis Pembayaran', 
                'Kategori',
                'Nominal',
                'Terbayar',
                'Sisa',
                'Status',
                'Tanggal Bayar',
                'Keterangan'
            ]);
            
            // Table data
            let rowNumber = 1;
            const categoryOrder = ['monthly', 'semester', 'yearly', 'oneTime'];
            const categoryNames = {
                'monthly': 'Bulanan',
                'semester': 'Per Semester', 
                'yearly': 'Tahunan',
                'oneTime': 'Sekali Bayar'
            };
            
            let totalNominal = 0;
            let totalTerbayar = 0;
            let totalSisa = 0;
            
            categoryOrder.forEach(category => {
                if (paymentsByFrequency[category].length > 0) {
                    paymentsByFrequency[category].forEach(payment => {
                        const statusText = payment.status === 'paid' ? 'Lunas' : 
                                         payment.status === 'installment' ? 'Cicilan' : 'Belum Bayar';
                        const paymentDate = payment.paid ? formatDate(payment.date) : '-';
                        const keterangan = generateKeterangan(payment);
                        
                        excelData.push([
                            rowNumber,
                            payment.feeType,
                            categoryNames[category],
                            payment.amount || 0,
                            payment.paidAmount || 0,
                            payment.remaining || 0,
                            statusText,
                            paymentDate,
                            keterangan
                        ]);
                        
                        totalNominal += payment.amount || 0;
                        totalTerbayar += payment.paidAmount || 0;
                        totalSisa += payment.remaining || 0;
                        rowNumber++;
                    });
                }
            });
            
            // Total row
            excelData.push(['']);
            excelData.push([
                '',
                '',
                'TOTAL KESELURUHAN',
                totalNominal,
                totalTerbayar,
                totalSisa,
                '',
                '',
                ''
            ]);
            
            // Convert to CSV format
            const csvContent = excelData.map(row => 
                row.map(cell => {
                    // Handle numbers and currency
                    if (typeof cell === 'number') {
                        return cell;
                    }
                    // Escape quotes and wrap in quotes if contains comma
                    const cellStr = String(cell || '');
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return '"' + cellStr.replace(/"/g, '""') + '"';
                    }
                    return cellStr;
                }).join(',')
            ).join('\n');
            
            // Create and download file
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Detail_Pembayaran_${currentStudent.name || 'Siswa'}_Kelas_${year}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message
            alert(`‚úÖ File Excel berhasil diunduh!\n\nDetail Pembayaran Kelas ${year}\nNama: ${currentStudent.name || '-'}\nTotal Nominal: ${formatCurrency(totalNominal)}\nTotal Terbayar: ${formatCurrency(totalTerbayar)}\nTotal Sisa: ${formatCurrency(totalSisa)}`);
        }

        // Event listeners
        document.getElementById('nisnInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStudent();
            }
        });

        // Format NISN input to numbers only
        document.getElementById('nisnInput').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        // Initialize the application when page loads
        window.addEventListener('load', initializeApp);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97c21665d2c54112',t:'MTc1NzM3MjY5NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
