<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Hafalan Siswa - Tahfidz Progress</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .progress-bar { transition: width 0.8s ease-in-out; }
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.6s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .notification-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease-in-out;
        }
        .notification-popup.show {
            transform: translateX(0);
        }
        .notification-popup.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .notification-popup.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        /* Mobile pagination styles */
        @media (max-width: 640px) {
            .pagination-mobile {
                flex-direction: column;
                gap: 0.75rem;
            }
            .page-numbers-mobile {
                max-width: 200px;
                overflow-x: auto;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .page-numbers-mobile::-webkit-scrollbar {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 sm:px-6 py-6 sm:py-8">
            <div class="text-center">
                <h1 class="text-2xl sm:text-4xl font-bold mb-2">üìñ Laporan Hafalan Siswa</h1>
                <p class="text-lg sm:text-xl opacity-90">Pantau Perkembangan Tahfidz Al-Quran</p>
                <div class="mt-4 flex flex-col sm:flex-row justify-center items-center space-y-2 sm:space-y-0 sm:space-x-4">
                    <div class="bg-white bg-opacity-20 rounded-full px-4 py-2">
                        <span class="text-sm font-medium">Total Siswa: <span id="totalStudents">10</span></span>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full px-4 py-2">
                        <span class="text-sm font-medium">Terakhir Update: <span id="lastUpdate">Hari ini</span></span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Controls -->
    <div class="container mx-auto px-4 sm:px-6 py-6">
        <div class="bg-white rounded-xl shadow-md p-4 sm:p-6 mb-6">
            <div class="flex flex-col space-y-4">
                <div class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
                    <div class="flex items-center space-x-2 sm:space-x-4 w-full sm:w-auto justify-center sm:justify-start">
                        <div class="bg-gray-100 rounded-lg p-1 flex">
                            <button id="individualViewBtn" class="px-3 sm:px-4 py-2 rounded-md text-xs sm:text-sm font-medium transition-colors bg-blue-600 text-white" onclick="switchView('individual')">
                                üë§ Individu
                            </button>
                            <button id="overallViewBtn" class="px-3 sm:px-4 py-2 rounded-md text-xs sm:text-sm font-medium transition-colors text-gray-600 hover:text-gray-800" onclick="switchView('overall')">
                                üìä Keseluruhan
                            </button>
                        </div>
                        <button id="refreshBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium transition-colors flex items-center space-x-2" onclick="loadFromGoogleSheets()">
                            <span id="refreshIcon">üîÑ</span>
                            <span class="hidden sm:inline">Refresh Data</span>
                            <span class="sm:hidden">Refresh</span>
                        </button>
                    </div>
                    
                    <div class="hidden md:block text-sm text-gray-600">
                        <span id="connectionStatus" class="flex items-center">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                            Terhubung ke Google Sheets
                        </span>
                    </div>
                </div>
                
                <div class="flex flex-col space-y-3 sm:space-y-0 sm:flex-row sm:space-x-3">
                    <select id="instructorFilter" class="w-full sm:w-auto sm:min-w-[160px] border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="handleInstructorFilter()">
                        <option value="all">Semua Pengampu</option>
                    </select>
                    <select id="sortBy" class="w-full sm:w-auto sm:min-w-[140px] border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="handleSort()">
                        <option value="name">Urutkan: Nama</option>
                        <option value="progress">Urutkan: Progress</option>
                        <option value="surah">Urutkan: Surat</option>
                    </select>
                    <input type="text" id="searchInput" placeholder="Cari nama siswa..." class="w-full sm:flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" oninput="handleSearch()">
                </div>
                
                <div class="md:hidden text-xs text-gray-600 text-center">
                    <span id="connectionStatusMobile" class="flex items-center justify-center">
                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                        Terhubung ke Google Sheets
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Popup -->
    <div id="notificationPopup" class="notification-popup">
        <!-- Notification content will be populated here -->
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="container mx-auto px-6 py-12 text-center hidden">
        <div class="loading-spinner w-8 h-8 border-4 border-blue-200 border-t-blue-600 rounded-full mx-auto mb-4"></div>
        <p class="text-gray-600">Memuat data dari Google Sheets...</p>
    </div>

    <!-- Main Content Area -->
    <div class="container mx-auto px-4 sm:px-6 pb-12">
        <!-- Individual View -->
        <div id="individualView" class="view-content">
            <div id="instructorGroups" class="space-y-8">
                <!-- Instructor groups will be populated here -->
            </div>
            
            <div id="studentsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                <!-- Student cards will be populated here -->
            </div>
            
            <!-- Individual Pagination - Mobile Responsive -->
            <div id="individualPagination" class="mt-8 bg-white rounded-xl shadow-md p-4 sm:p-6 hidden">
                <!-- Mobile Layout -->
                <div class="block sm:hidden pagination-mobile">
                    <div class="text-center mb-3">
                        <span class="text-sm text-gray-600" id="individualPageInfoMobile">Menampilkan 1-6 dari 10 siswa</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <button id="individualPrevBtnMobile" class="flex items-center px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" onclick="changePage('individual', -1)">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                            <span class="hidden xs:inline">Sebelumnya</span>
                        </button>
                        <div id="individualPageNumbersMobile" class="flex items-center space-x-1 page-numbers-mobile">
                            <!-- Page numbers will be populated here -->
                        </div>
                        <button id="individualNextBtnMobile" class="flex items-center px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" onclick="changePage('individual', 1)">
                            <span class="hidden xs:inline">Selanjutnya</span>
                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Desktop Layout -->
                <div class="hidden sm:flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600" id="individualPageInfo">Menampilkan 1-6 dari 10 siswa</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="individualPrevBtn" class="px-4 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" onclick="changePage('individual', -1)">
                            ‚Üê Sebelumnya
                        </button>
                        <div id="individualPageNumbers" class="flex items-center space-x-1">
                            <!-- Page numbers will be populated here -->
                        </div>
                        <button id="individualNextBtn" class="px-4 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" onclick="changePage('individual', 1)">
                            Selanjutnya ‚Üí
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overall View -->
        <div id="overallView" class="view-content hidden">
            <!-- Comprehensive Student Table -->
            <div class="bg-white rounded-xl shadow-md p-4 sm:p-6 mb-6">
                <!-- Mobile Layout -->
                <div class="block sm:hidden">
                    <div class="text-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center justify-center">
                            üìã Tabel Keseluruhan Siswa
                        </h3>
                    </div>
                    <div class="space-y-3">
                        <div class="flex space-x-2">
                            <button id="downloadBtnMobile" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center space-x-2" onclick="downloadTableData()">
                                <span>üì•</span>
                                <span class="hidden xs:inline">Download</span>
                                <span class="xs:hidden">CSV</span>
                            </button>
                            <select id="tableSortMobile" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="document.getElementById('tableSort').value = this.value; handleTableSort();">
                                <option value="name">Nama</option>
                                <option value="progress">Progress</option>
                                <option value="ayat">Total Ayat</option>
                                <option value="instructor">Pengampu</option>
                            </select>
                        </div>
                        <input type="text" id="tableSearchMobile" placeholder="Cari siswa..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" oninput="document.getElementById('tableSearch').value = this.value; handleTableSearch();">
                    </div>
                </div>
                
                <!-- Desktop Layout -->
                <div class="hidden sm:block">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                            üìã Tabel Keseluruhan Siswa
                        </h3>
                        <div class="flex items-center space-x-4">
                            <button id="downloadBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center space-x-2" onclick="downloadTableData()">
                                <span>üì•</span>
                                <span>Download Excel</span>
                            </button>
                            <select id="tableSort" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="handleTableSort()">
                                <option value="name">Urutkan: Nama</option>
                                <option value="progress">Urutkan: Progress</option>
                                <option value="ayat">Urutkan: Total Ayat</option>
                                <option value="instructor">Urutkan: Pengampu</option>
                            </select>
                            <input type="text" id="tableSearch" placeholder="Cari siswa..." class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent w-48" oninput="handleTableSearch()">
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-gray-50 border-b">
                                <th class="text-left p-3 font-semibold text-gray-700">No</th>
                                <th class="text-left p-3 font-semibold text-gray-700">Nama Siswa</th>
                                <th class="text-left p-3 font-semibold text-gray-700">Pengampu</th>
                                <th class="text-left p-3 font-semibold text-gray-700">Surat Terakhir</th>
                                <th class="text-center p-3 font-semibold text-gray-700">Ayat Terakhir</th>
                                <th class="text-center p-3 font-semibold text-gray-700">% Hafalan</th>
                                <th class="text-center p-3 font-semibold text-gray-700">Total Hafalan</th>
                                <th class="text-center p-3 font-semibold text-gray-700">Surat Selesai</th>
                                <th class="text-center p-3 font-semibold text-gray-700">Progress</th>
                                <th class="text-center p-3 font-semibold text-gray-700">Status</th>
                                <th class="text-left p-3 font-semibold text-gray-700">Update Terakhir</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody">
                            <!-- Table rows will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Mobile Table Pagination -->
                <div class="mt-4 block sm:hidden">
                    <div class="text-center mb-3">
                        <div id="tableInfoMobile" class="text-sm text-gray-600 mb-2">Menampilkan 1-20 dari 10 siswa</div>
                        <div class="flex items-center justify-center space-x-2 text-xs">
                            <span>Baris:</span>
                            <select id="rowsPerPageMobile" class="border border-gray-300 rounded px-2 py-1 text-xs" onchange="document.getElementById('rowsPerPage').value = this.value; tableCurrentPage = 1; renderStudentTable();">
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="all">Semua</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <button id="tablePrevBtnMobile" class="flex items-center px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" onclick="changePage('table', -1)">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                            <span class="hidden xs:inline">Sebelumnya</span>
                        </button>
                        <div id="tablePageNumbersMobile" class="flex items-center space-x-1 page-numbers-mobile">
                            <!-- Page numbers will be populated here -->
                        </div>
                        <button id="tableNextBtnMobile" class="flex items-center px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" onclick="changePage('table', 1)">
                            <span class="hidden xs:inline">Selanjutnya</span>
                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Desktop Table Pagination -->
                <div class="mt-4 hidden sm:flex items-center justify-between text-sm text-gray-600">
                    <div id="tableInfo">Menampilkan 1-20 dari 10 siswa</div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <span>Baris per halaman:</span>
                            <select id="rowsPerPage" class="border border-gray-300 rounded px-2 py-1" onchange="document.getElementById('rowsPerPageMobile').value = this.value; tableCurrentPage = 1; renderStudentTable();">
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="all">Semua</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="tablePrevBtn" class="px-3 py-1 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" onclick="changePage('table', -1)">
                                ‚Üê Sebelumnya
                            </button>
                            <div id="tablePageNumbers" class="flex items-center space-x-1">
                                <!-- Page numbers will be populated here -->
                            </div>
                            <button id="tableNextBtn" class="px-3 py-1 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" onclick="changePage('table', 1)">
                                Selanjutnya ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Class Ranking -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                    üèÜ Peringkat Kelas
                </h3>
                <div id="classRanking" class="space-y-3">
                    <!-- Rankings will be populated here -->
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">‚è∞ Aktivitas Terbaru</h3>
                <div id="recentActivity" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Recent activities will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            SHEET_ID: '17MDc804lNUm_XwUM6hPj6Ui8T-JVtpxJCLq4XovVs0A',
            SHEET_NAME: 'Sheet6',
            API_KEY: 'AIzaSyCAJWvsjw92iebZM54KZivepTpl_Q2gk70'
        };

        // Complete Quran structure
        const QURAN_STRUCTURE = {
            totalSurahs: 114,
            totalAyat: 6236,
            totalJuz: 30,
            surahs: [
                { no: 1, name: 'Al-Fatihah', ayat: 7, juz: 1 },
                { no: 2, name: 'Al-Baqarah', ayat: 286, juz: 1 },
                { no: 3, name: 'Ali Imran', ayat: 200, juz: 3 },
                { no: 4, name: 'An-Nisa', ayat: 176, juz: 4 },
                { no: 5, name: 'Al-Maidah', ayat: 120, juz: 6 },
                { no: 6, name: 'Al-An\'am', ayat: 165, juz: 7 },
                { no: 7, name: 'Al-A\'raf', ayat: 206, juz: 8 },
                { no: 8, name: 'Al-Anfal', ayat: 75, juz: 9 },
                { no: 9, name: 'At-Tawbah', ayat: 129, juz: 10 },
                { no: 10, name: 'Yunus', ayat: 109, juz: 11 },
                { no: 11, name: 'Hud', ayat: 123, juz: 11 },
                { no: 12, name: 'Yusuf', ayat: 111, juz: 12 },
                { no: 13, name: 'Ar-Ra\'d', ayat: 43, juz: 13 },
                { no: 14, name: 'Ibrahim', ayat: 52, juz: 13 },
                { no: 15, name: 'Al-Hijr', ayat: 99, juz: 14 },
                { no: 16, name: 'An-Nahl', ayat: 128, juz: 14 },
                { no: 17, name: 'Al-Isra', ayat: 111, juz: 15 },
                { no: 18, name: 'Al-Kahf', ayat: 110, juz: 15 },
                { no: 19, name: 'Maryam', ayat: 98, juz: 16 },
                { no: 20, name: 'Taha', ayat: 135, juz: 16 },
                { no: 21, name: 'Al-Anbiya', ayat: 112, juz: 17 },
                { no: 22, name: 'Al-Hajj', ayat: 78, juz: 17 },
                { no: 23, name: 'Al-Mu\'minun', ayat: 118, juz: 18 },
                { no: 24, name: 'An-Nur', ayat: 64, juz: 18 },
                { no: 25, name: 'Al-Furqan', ayat: 77, juz: 18 },
                { no: 26, name: 'Ash-Shu\'ara', ayat: 227, juz: 19 },
                { no: 27, name: 'An-Naml', ayat: 93, juz: 19 },
                { no: 28, name: 'Al-Qasas', ayat: 88, juz: 20 },
                { no: 29, name: 'Al-Ankabut', ayat: 69, juz: 20 },
                { no: 30, name: 'Ar-Rum', ayat: 60, juz: 21 },
                { no: 31, name: 'Luqman', ayat: 34, juz: 21 },
                { no: 32, name: 'As-Sajdah', ayat: 30, juz: 21 },
                { no: 33, name: 'Al-Ahzab', ayat: 73, juz: 21 },
                { no: 34, name: 'Saba', ayat: 54, juz: 22 },
                { no: 35, name: 'Fatir', ayat: 45, juz: 22 },
                { no: 36, name: 'Ya-Sin', ayat: 83, juz: 22 },
                { no: 37, name: 'As-Saffat', ayat: 182, juz: 23 },
                { no: 38, name: 'Sad', ayat: 88, juz: 23 },
                { no: 39, name: 'Az-Zumar', ayat: 75, juz: 23 },
                { no: 40, name: 'Ghafir', ayat: 85, juz: 24 },
                { no: 41, name: 'Fussilat', ayat: 54, juz: 24 },
                { no: 42, name: 'Ash-Shura', ayat: 53, juz: 25 },
                { no: 43, name: 'Az-Zukhruf', ayat: 89, juz: 25 },
                { no: 44, name: 'Ad-Dukhan', ayat: 59, juz: 25 },
                { no: 45, name: 'Al-Jathiyah', ayat: 37, juz: 25 },
                { no: 46, name: 'Al-Ahqaf', ayat: 35, juz: 26 },
                { no: 47, name: 'Muhammad', ayat: 38, juz: 26 },
                { no: 48, name: 'Al-Fath', ayat: 29, juz: 26 },
                { no: 49, name: 'Al-Hujurat', ayat: 18, juz: 26 },
                { no: 50, name: 'Qaf', ayat: 45, juz: 26 },
                { no: 51, name: 'Adh-Dhariyat', ayat: 60, juz: 26 },
                { no: 52, name: 'At-Tur', ayat: 49, juz: 27 },
                { no: 53, name: 'An-Najm', ayat: 62, juz: 27 },
                { no: 54, name: 'Al-Qamar', ayat: 55, juz: 27 },
                { no: 55, name: 'Ar-Rahman', ayat: 78, juz: 27 },
                { no: 56, name: 'Al-Waqi\'ah', ayat: 96, juz: 27 },
                { no: 57, name: 'Al-Hadid', ayat: 29, juz: 27 },
                { no: 58, name: 'Al-Mujadilah', ayat: 22, juz: 28 },
                { no: 59, name: 'Al-Hashr', ayat: 24, juz: 28 },
                { no: 60, name: 'Al-Mumtahanah', ayat: 13, juz: 28 },
                { no: 61, name: 'As-Saff', ayat: 14, juz: 28 },
                { no: 62, name: 'Al-Jumu\'ah', ayat: 11, juz: 28 },
                { no: 63, name: 'Al-Munafiqun', ayat: 11, juz: 28 },
                { no: 64, name: 'At-Taghabun', ayat: 18, juz: 28 },
                { no: 65, name: 'At-Talaq', ayat: 12, juz: 28 },
                { no: 66, name: 'At-Tahrim', ayat: 12, juz: 28 },
                { no: 67, name: 'Al-Mulk', ayat: 30, juz: 29 },
                { no: 68, name: 'Al-Qalam', ayat: 52, juz: 29 },
                { no: 69, name: 'Al-Haqqah', ayat: 52, juz: 29 },
                { no: 70, name: 'Al-Ma\'arij', ayat: 44, juz: 29 },
                { no: 71, name: 'Nuh', ayat: 28, juz: 29 },
                { no: 72, name: 'Al-Jinn', ayat: 28, juz: 29 },
                { no: 73, name: 'Al-Muzzammil', ayat: 20, juz: 29 },
                { no: 74, name: 'Al-Muddaththir', ayat: 56, juz: 29 },
                { no: 75, name: 'Al-Qiyamah', ayat: 40, juz: 29 },
                { no: 76, name: 'Al-Insan', ayat: 31, juz: 29 },
                { no: 77, name: 'Al-Mursalat', ayat: 50, juz: 29 },
                { no: 78, name: 'An-Naba\'', ayat: 40, juz: 30 },
                { no: 79, name: 'An-Nazi\'at', ayat: 46, juz: 30 },
                { no: 80, name: 'Abasa', ayat: 42, juz: 30 },
                { no: 81, name: 'At-Takwir', ayat: 29, juz: 30 },
                { no: 82, name: 'Al-Infithar', ayat: 19, juz: 30 },
                { no: 83, name: 'Al-Mutaffifin', ayat: 36, juz: 30 },
                { no: 84, name: 'Al-Inshiqaq', ayat: 25, juz: 30 },
                { no: 85, name: 'Al-Buruj', ayat: 22, juz: 30 },
                { no: 86, name: 'At-Tariq', ayat: 17, juz: 30 },
                { no: 87, name: 'Al-A\'la', ayat: 19, juz: 30 },
                { no: 88, name: 'Al-Ghashiyah', ayat: 26, juz: 30 },
                { no: 89, name: 'Al-Fajr', ayat: 30, juz: 30 },
                { no: 90, name: 'Al-Balad', ayat: 20, juz: 30 },
                { no: 91, name: 'Ash-Shams', ayat: 15, juz: 30 },
                { no: 92, name: 'Al-Lail', ayat: 21, juz: 30 },
                { no: 93, name: 'Ad-Duha', ayat: 11, juz: 30 },
                { no: 94, name: 'Ash-Sharh', ayat: 8, juz: 30 },
                { no: 95, name: 'At-Tin', ayat: 8, juz: 30 },
                { no: 96, name: 'Al-Alaq', ayat: 19, juz: 30 },
                { no: 97, name: 'Al-Qadr', ayat: 5, juz: 30 },
                { no: 98, name: 'Al-Bayyinah', ayat: 8, juz: 30 },
                { no: 99, name: 'Az-Zalzalah', ayat: 8, juz: 30 },
                { no: 100, name: 'Al-Adiyat', ayat: 11, juz: 30 },
                { no: 101, name: 'Al-Qari\'ah', ayat: 11, juz: 30 },
                { no: 102, name: 'At-Takathur', ayat: 8, juz: 30 },
                { no: 103, name: 'Al-Asr', ayat: 3, juz: 30 },
                { no: 104, name: 'Al-Humazah', ayat: 9, juz: 30 },
                { no: 105, name: 'Al-Fil', ayat: 5, juz: 30 },
                { no: 106, name: 'Quraish', ayat: 4, juz: 30 },
                { no: 107, name: 'Al-Ma\'un', ayat: 7, juz: 30 },
                { no: 108, name: 'Al-Kawthar', ayat: 3, juz: 30 },
                { no: 109, name: 'Al-Kafirun', ayat: 6, juz: 30 },
                { no: 110, name: 'An-Nasr', ayat: 3, juz: 30 },
                { no: 111, name: 'Al-Masad', ayat: 5, juz: 30 },
                { no: 112, name: 'Al-Ikhlas', ayat: 4, juz: 30 },
                { no: 113, name: 'Al-Falaq', ayat: 5, juz: 30 },
                { no: 114, name: 'An-Nas', ayat: 6, juz: 30 }
            ]
        };

        // Enhanced surah name matching function
        function findSurahByName(inputName) {
            const cleanInput = inputName.toLowerCase().trim();
            
            const nameVariations = {
                'ali imran': 'Ali Imran',
                'ali-imran': 'Ali Imran',
                'al-imran': 'Ali Imran',
                'al-fatihah': 'Al-Fatihah',
                'alfatihah': 'Al-Fatihah',
                'fatihah': 'Al-Fatihah',
                'al-baqarah': 'Al-Baqarah',
                'albaqarah': 'Al-Baqarah',
                'baqarah': 'Al-Baqarah',
                'an-nisa': 'An-Nisa',
                'annisa': 'An-Nisa',
                'al-nisa': 'An-Nisa',
                'nisa': 'An-Nisa',
                'al-maidah': 'Al-Maidah',
                'almaidah': 'Al-Maidah',
                'maidah': 'Al-Maidah',
                'al-anam': 'Al-An\'am',
                'al-an\'am': 'Al-An\'am',
                'anam': 'Al-An\'am',
                'al-a\'raf': 'Al-A\'raf',
                'al-araf': 'Al-A\'raf',
                'araf': 'Al-A\'raf',
                'at-taubah': 'At-Tawbah',
                'at-tawbah': 'At-Tawbah',
                'attaubah': 'At-Tawbah',
                'attawbah': 'At-Tawbah',
                'taubah': 'At-Tawbah',
                'tawbah': 'At-Tawbah',
                'yasin': 'Ya-Sin',
                'ya-sin': 'Ya-Sin',
                'yaseen': 'Ya-Sin',
                'an-naba': 'An-Naba\'',
                'an-naba\'': 'An-Naba\'',
                'annaba': 'An-Naba\'',
                'naba': 'An-Naba\'',
                'naba\'': 'An-Naba\'',
                'an-nazi\'at': 'An-Nazi\'at',
                'an-naziat': 'An-Nazi\'at',
                'annaziat': 'An-Nazi\'at',
                'naziat': 'An-Nazi\'at',
                'nazi\'at': 'An-Nazi\'at',
                'abasa': 'Abasa',
                'at-takwir': 'At-Takwir',
                'attakwir': 'At-Takwir',
                'takwir': 'At-Takwir',
                'al-infitar': 'Al-Infithar',
                'al-infithar': 'Al-Infithar',
                'alinfitar': 'Al-Infithar',
                'infitar': 'Al-Infithar',
                'infithar': 'Al-Infithar',
                'al-mutaffifin': 'Al-Mutaffifin',
                'almutaffifin': 'Al-Mutaffifin',
                'mutaffifin': 'Al-Mutaffifin',
                'al-inshiqaq': 'Al-Inshiqaq',
                'alinshiqaq': 'Al-Inshiqaq',
                'inshiqaq': 'Al-Inshiqaq',
                'al-buruj': 'Al-Buruj',
                'alburuj': 'Al-Buruj',
                'buruj': 'Al-Buruj',
                'at-tariq': 'At-Tariq',
                'attariq': 'At-Tariq',
                'tariq': 'At-Tariq',
                'al-a\'la': 'Al-A\'la',
                'al-ala': 'Al-A\'la',
                'alala': 'Al-A\'la',
                'ala': 'Al-A\'la',
                'a\'la': 'Al-A\'la',
                'al-ghashiyah': 'Al-Ghashiyah',
                'al-ghasiyah': 'Al-Ghashiyah',
                'alghashiyah': 'Al-Ghashiyah',
                'ghashiyah': 'Al-Ghashiyah',
                'ghasiyah': 'Al-Ghashiyah',
                'al-fajr': 'Al-Fajr',
                'alfajr': 'Al-Fajr',
                'fajr': 'Al-Fajr',
                'al-balad': 'Al-Balad',
                'albalad': 'Al-Balad',
                'balad': 'Al-Balad',
                'ash-shams': 'Ash-Shams',
                'ashshams': 'Ash-Shams',
                'shams': 'Ash-Shams',
                'al-lail': 'Al-Lail',
                'allail': 'Al-Lail',
                'lail': 'Al-Lail',
                'ad-duha': 'Ad-Duha',
                'adduha': 'Ad-Duha',
                'duha': 'Ad-Duha',
                'ash-sharh': 'Ash-Sharh',
                'ashsharh': 'Ash-Sharh',
                'sharh': 'Ash-Sharh',
                'al-inshirah': 'Ash-Sharh',
                'inshirah': 'Ash-Sharh',
                'at-tin': 'At-Tin',
                'attin': 'At-Tin',
                'tin': 'At-Tin',
                'al-alaq': 'Al-Alaq',
                'alalaq': 'Al-Alaq',
                'alaq': 'Al-Alaq',
                'iqra': 'Al-Alaq',
                'al-qadr': 'Al-Qadr',
                'alqadr': 'Al-Qadr',
                'qadr': 'Al-Qadr',
                'al-bayyinah': 'Al-Bayyinah',
                'albayyinah': 'Al-Bayyinah',
                'bayyinah': 'Al-Bayyinah',
                'az-zalzalah': 'Az-Zalzalah',
                'azzalzalah': 'Az-Zalzalah',
                'zalzalah': 'Az-Zalzalah',
                'al-adiyat': 'Al-Adiyat',
                'aladiyat': 'Al-Adiyat',
                'adiyat': 'Al-Adiyat',
                'al-qari\'ah': 'Al-Qari\'ah',
                'al-qariah': 'Al-Qari\'ah',
                'alqariah': 'Al-Qari\'ah',
                'qariah': 'Al-Qari\'ah',
                'qari\'ah': 'Al-Qari\'ah',
                'at-takathur': 'At-Takathur',
                'attakathur': 'At-Takathur',
                'takathur': 'At-Takathur',
                'al-asr': 'Al-Asr',
                'alasr': 'Al-Asr',
                'asr': 'Al-Asr',
                'al-humazah': 'Al-Humazah',
                'alhumazah': 'Al-Humazah',
                'humazah': 'Al-Humazah',
                'al-fil': 'Al-Fil',
                'alfil': 'Al-Fil',
                'fil': 'Al-Fil',
                'quraish': 'Quraish',
                'qurais': 'Quraish',
                'quraysh': 'Quraish',
                'al-ma\'un': 'Al-Ma\'un',
                'al-maun': 'Al-Ma\'un',
                'almaun': 'Al-Ma\'un',
                'maun': 'Al-Ma\'un',
                'ma\'un': 'Al-Ma\'un',
                'al-kawthar': 'Al-Kawthar',
                'al-kautsar': 'Al-Kawthar',
                'alkautsar': 'Al-Kawthar',
                'kautsar': 'Al-Kawthar',
                'kawthar': 'Al-Kawthar',
                'al-kafirun': 'Al-Kafirun',
                'alkafirun': 'Al-Kafirun',
                'kafirun': 'Al-Kafirun',
                'an-nasr': 'An-Nasr',
                'annasr': 'An-Nasr',
                'nasr': 'An-Nasr',
                'al-masad': 'Al-Masad',
                'almasad': 'Al-Masad',
                'masad': 'Al-Masad',
                'al-lahab': 'Al-Masad',
                'lahab': 'Al-Masad',
                'al-ikhlas': 'Al-Ikhlas',
                'alikhlas': 'Al-Ikhlas',
                'ikhlas': 'Al-Ikhlas',
                'al-falaq': 'Al-Falaq',
                'alfalaq': 'Al-Falaq',
                'falaq': 'Al-Falaq',
                'an-nas': 'An-Nas',
                'annas': 'An-Nas',
                'nas': 'An-Nas'
            };
            
            if (nameVariations[cleanInput]) {
                return QURAN_STRUCTURE.surahs.find(s => s.name === nameVariations[cleanInput]);
            }
            
            let surah = QURAN_STRUCTURE.surahs.find(s => 
                s.name.toLowerCase() === cleanInput ||
                s.name.toLowerCase() === inputName.toLowerCase()
            );
            
            if (surah) return surah;
            
            const cleanSurahName = cleanInput
                .replace(/^(surat|surah)\s+/i, '')
                .replace(/^(al|an|at|as|ar|ash|ad|az)-?/i, '')
                .replace(/['\-\s]/g, '')
                .trim();
            
            surah = QURAN_STRUCTURE.surahs.find(s => {
                const cleanStructureName = s.name.toLowerCase()
                    .replace(/^(al|an|at|as|ar|ash|ad|az)-?/i, '')
                    .replace(/['\-\s]/g, '')
                    .trim();
                
                return cleanStructureName === cleanSurahName ||
                       cleanStructureName.includes(cleanSurahName) ||
                       cleanSurahName.includes(cleanStructureName);
            });
            
            if (surah) return surah;
            
            return QURAN_STRUCTURE.surahs.find(s => {
                const sName = s.name.toLowerCase();
                return sName.includes(cleanInput) || cleanInput.includes(sName);
            });
        }

        function calculateTotalAyat(completedSurahs, currentSurah, currentAyat, studentName = '') {
            let totalAyat = 0;
            let matchedSurahs = [];
            let unmatchedSurahs = [];
            
            if (completedSurahs && completedSurahs.trim() !== '') {
                const completedList = completedSurahs.split(',').map(s => s.trim()).filter(s => s);
                
                completedList.forEach(surahName => {
                    const surah = findSurahByName(surahName);
                    
                    if (surah) {
                        totalAyat += surah.ayat;
                        matchedSurahs.push(surahName);
                    } else {
                        unmatchedSurahs.push(surahName);
                    }
                });
            }
            
            if (currentSurah && currentAyat > 0) {
                totalAyat += parseInt(currentAyat) || 0;
            }
            
            return totalAyat;
        }

        function calculateCompletedJuz(completedSurahs, currentSurah, currentAyat) {
            return 0;
        }

        // Sample data
        let studentsData = [
            { 
                name: 'A. Azam', 
                currentSurah: 'An-Naba\'', 
                currentAyat: 20, 
                totalHafalan: 20,
                currentJuz: 'Juz 30',
                completedSurahs: 'Al-Fatihah, Al-Baqarah, Ali Imran, An-Nisa, Al-Maidah, Al-An\'am, Al-A\'raf, Al-Anfal, At-Tawbah, Yunus, Hud, Yusuf, Ar-Ra\'d, Ibrahim, Al-Hijr, An-Nahl, Al-Isra, Al-Kahf, Maryam, Taha, Al-Anbiya, Al-Hajj, Al-Mu\'minun, An-Nur, Al-Furqan, Ash-Shu\'ara, An-Naml, Al-Qasas, Al-Ankabut, Ar-Rum, Luqman, As-Sajdah, Al-Ahzab, Saba, Fatir, Ya-Sin, As-Saffat, Sad, Az-Zumar, Ghafir, Fussilat, Ash-Shura, Az-Zukhruf, Ad-Dukhan, Al-Jathiyah, Al-Ahqaf, Muhammad, Al-Fath, Al-Hujurat, Qaf, Adh-Dhariyat, At-Tur, An-Najm, Al-Qamar, Ar-Rahman, Al-Waqi\'ah, Al-Hadid, Al-Mujadilah, Al-Hashr, Al-Mumtahanah, As-Saff, Al-Jumu\'ah, Al-Munafiqun, At-Taghabun, At-Talaq, At-Tahrim, Al-Mulk, Al-Qalam, Al-Haqqah, Al-Ma\'arij, Nuh, Al-Jinn, Al-Muzzammil, Al-Muddaththir, Al-Qiyamah, Al-Insan, Al-Mursalat, An-Nazi\'at, Abasa, At-Takwir, Al-Infithar, Al-Mutaffifin, Al-Inshiqaq, Al-Buruj, At-Tariq, Al-A\'la, Al-Ghashiyah, Al-Fajr, Al-Balad, Ash-Shams, Al-Lail, Ad-Duha, Ash-Sharh, At-Tin, Al-Alaq, Al-Qadr, Al-Bayyinah, Az-Zalzalah, Al-Adiyat, Al-Qari\'ah, At-Takathur, Al-Asr, Al-Humazah, Al-Fil, Quraish, Al-Ma\'un, Al-Kawthar, Al-Kafirun, An-Nasr, Al-Masad, Al-Ikhlas, Al-Falaq, An-Nas',
                surahsCompleted: 113,
                juzCompleted: 30,
                lastUpdate: '1/9/2025 20.58.35',
                status: '1',
                instructor: 'Ustadz Ahmad'
            },
            { 
                name: 'Abyan', 
                currentSurah: 'An-Naba\'', 
                currentAyat: 12, 
                totalHafalan: 12,
                currentJuz: 'Juz 30',
                completedSurahs: '',
                surahsCompleted: 0,
                juzCompleted: 0,
                lastUpdate: '1/9/2025 20.58.35',
                status: '1',
                instructor: 'Ustadz Ahmad'
            },
            { 
                name: 'Zakariya', 
                currentSurah: 'An-Naba\'', 
                currentAyat: 11, 
                totalHafalan: 11,
                currentJuz: 'Juz 30',
                completedSurahs: '',
                surahsCompleted: 0,
                juzCompleted: 0,
                lastUpdate: '1/9/2025 20.58.35',
                status: '1',
                instructor: 'Ustadz Ahmad'
            },
            { 
                name: 'Navisa', 
                currentSurah: 'An-Nazi\'at', 
                currentAyat: 7, 
                totalHafalan: 47,
                currentJuz: 'Juz 30',
                completedSurahs: 'An-Naba\'',
                surahsCompleted: 1,
                juzCompleted: 1,
                lastUpdate: '1/9/2025 20.58.35',
                status: '2',
                instructor: 'Ustadzah Fatimah'
            },
            { 
                name: 'Jelita N', 
                currentSurah: 'An-Naba\'', 
                currentAyat: 34, 
                totalHafalan: 34,
                currentJuz: 'Juz 30',
                completedSurahs: '',
                surahsCompleted: 0,
                juzCompleted: 0,
                lastUpdate: '1/9/2025 20.58.35',
                status: '2',
                instructor: 'Ustadzah Fatimah'
            },
            { 
                name: 'Jihan M', 
                currentSurah: 'Al-Mursalat', 
                currentAyat: 25, 
                totalHafalan: 600,
                currentJuz: 'Juz 29',
                completedSurahs: 'An-Naba\', An-Nazi\'at, Abasa, At-Takwir, Al-Infithar, Al-Mutaffifin, Al-Inshiqaq, Al-Buruj, At-Tariq, Al-A\'la, Al-Ghashiyah, Al-Fajr, Al-Balad, Ash-Shams, Al-Lail, Ad-Duha, Ash-Sharh, At-Tin, Al-Alaq, Al-Qadr, Al-Bayyinah, Az-Zalzalah, Al-Adiyat, Al-Qari\'ah, At-Takathur, Al-Asr, Al-Humazah, Al-Fil, Quraish, Al-Ma\'un, Al-Kawthar, Al-Kafirun, An-Nasr, Al-Masad, Al-Ikhlas, Al-Falaq, An-Nas',
                surahsCompleted: 37,
                juzCompleted: 2,
                lastUpdate: '1/9/2025 19.30.15',
                status: '2',
                instructor: 'Ustadzah Fatimah'
            },
            { 
                name: 'Ahmad Hafidz', 
                currentSurah: 'Al-Baqarah', 
                currentAyat: 150, 
                totalHafalan: 3500,
                currentJuz: 'Juz 2',
                completedSurahs: 'Al-Fatihah, An-Nas, Al-Falaq, Al-Ikhlas, Al-Masad, An-Nasr, Al-Kafirun, Al-Kawthar, Al-Ma\'un, Quraish, Al-Fil, Al-Humazah, Al-Asr, At-Takathur, Al-Qari\'ah, Al-Adiyat, Az-Zalzalah, Al-Bayyinah, Al-Qadr, Al-Alaq, At-Tin, Ash-Sharh, Ad-Duha, Al-Lail, Ash-Shams, Al-Balad, Al-Fajr, Al-Ghashiyah, Al-A\'la, At-Tariq, Al-Buruj, Al-Inshiqaq, Al-Mutaffifin, Al-Infithar, At-Takwir, Abasa, An-Nazi\'at, An-Naba\', Al-Mursalat, Al-Insan, Al-Qiyamah, Al-Muddaththir, Al-Muzzammil, Al-Jinn, Nuh, Al-Ma\'arij, Al-Haqqah, Al-Qalam, Al-Mulk',
                surahsCompleted: 50,
                juzCompleted: 3,
                lastUpdate: '1/9/2025 18.45.20',
                status: '3',
                instructor: 'Ustadz Mustofa'
            },
            { 
                name: 'Fatimah Az-Zahra', 
                currentSurah: 'Ali Imran', 
                currentAyat: 100, 
                totalHafalan: 4200,
                currentJuz: 'Juz 3',
                completedSurahs: 'Al-Fatihah, Al-Baqarah, An-Nas, Al-Falaq, Al-Ikhlas, Al-Masad, An-Nasr, Al-Kafirun, Al-Kawthar, Al-Ma\'un, Quraish, Al-Fil, Al-Humazah, Al-Asr, At-Takathur, Al-Qari\'ah, Al-Adiyat, Az-Zalzalah, Al-Bayyinah, Al-Qadr, Al-Alaq, At-Tin, Ash-Sharh, Ad-Duha, Al-Lail, Ash-Shams, Al-Balad, Al-Fajr, Al-Ghashiyah, Al-A\'la, At-Tariq, Al-Buruj, Al-Inshiqaq, Al-Mutaffifin, Al-Infithar, At-Takwir, Abasa, An-Nazi\'at, An-Naba\'',
                surahsCompleted: 39,
                juzCompleted: 3,
                lastUpdate: '1/9/2025 17.20.10',
                status: '4',
                instructor: 'Ustadz Mustofa'
            },
            { 
                name: 'Micky', 
                currentSurah: 'An-Nazi\'at', 
                currentAyat: 4, 
                totalHafalan: 44,
                currentJuz: 'Juz 30',
                completedSurahs: 'An-Naba\'',
                surahsCompleted: 1,
                juzCompleted: 1,
                lastUpdate: '1/9/2025 20.58.35',
                status: '3',
                instructor: 'Ustadz Yusuf'
            },
            { 
                name: 'M. Alden', 
                currentSurah: 'Al-Infithar', 
                currentAyat: 7, 
                totalHafalan: 164,
                currentJuz: 'Juz 30',
                completedSurahs: 'An-Naba\', An-Nazi\'at, Abasa, At-Takwir',
                surahsCompleted: 4,
                juzCompleted: 1,
                lastUpdate: '1/9/2025 20.58.35',
                status: '3',
                instructor: 'Ustadz Yusuf'
            },
            { 
                name: 'Alfino', 
                currentSurah: 'An-Nazi\'at', 
                currentAyat: 8, 
                totalHafalan: 48,
                currentJuz: 'Juz 30',
                completedSurahs: 'An-Naba\'',
                surahsCompleted: 1,
                juzCompleted: 1,
                lastUpdate: '1/9/2025 20.58.35',
                status: '3',
                instructor: 'Ustadz Yusuf'
            },
            { 
                name: 'Khadijah', 
                currentSurah: 'Al-Mujadilah', 
                currentAyat: 15, 
                totalHafalan: 750,
                currentJuz: 'Juz 28',
                completedSurahs: 'An-Naba\', An-Nazi\'at, Abasa, At-Takwir, Al-Infithar, Al-Mutaffifin, Al-Inshiqaq, Al-Buruj, At-Tariq, Al-A\'la, Al-Ghashiyah, Al-Fajr, Al-Balad, Ash-Shams, Al-Lail, Ad-Duha, Ash-Sharh, At-Tin, Al-Alaq, Al-Qadr, Al-Bayyinah, Az-Zalzalah, Al-Adiyat, Al-Qari\'ah, At-Takathur, Al-Asr, Al-Humazah, Al-Fil, Quraish, Al-Ma\'un, Al-Kawthar, Al-Kafirun, An-Nasr, Al-Masad, Al-Ikhlas, Al-Falaq, An-Nas, Al-Mursalat, Al-Insan, Al-Qiyamah, Al-Muddaththir, Al-Muzzammil, Al-Jinn, Nuh, Al-Ma\'arij, Al-Haqqah, Al-Qalam, Al-Mulk, At-Tahrim, At-Talaq, At-Taghabun, Al-Munafiqun, Al-Jumu\'ah, As-Saff, Al-Mumtahanah, Al-Hashr',
                surahsCompleted: 58,
                juzCompleted: 3,
                lastUpdate: '1/9/2025 16.15.45',
                status: '2',
                instructor: 'Ustadzah Aisyah'
            }
        ];

        // Current view mode
        let currentView = 'individual';
        
        // Pagination state
        let individualCurrentPage = 1;
        let individualItemsPerPage = 10;
        let tableCurrentPage = 1;
        let tableItemsPerPage = 20;
        let currentFilteredData = [];

        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return 'Tidak ada data';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return dateString;
                }
                return date.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }

        function formatStatusText(status) {
            const statusMap = {
                '1': 'Pemula',
                '2': 'Menengah',
                '3': 'Lanjutan',
                '4': 'Mahir'
            };
            return statusMap[status] || 'Tidak diketahui';
        }

        // DOM Elements
        let studentsGrid, instructorGroups, instructorFilter, refreshBtn, refreshIcon, loadingState;
        let searchInput, sortBy, connectionStatus, individualViewBtn, overallViewBtn;
        let individualView, overallView;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM loaded, initializing...');
            
            // Get DOM elements
            studentsGrid = document.getElementById('studentsGrid');
            instructorGroups = document.getElementById('instructorGroups');
            instructorFilter = document.getElementById('instructorFilter');
            refreshBtn = document.getElementById('refreshBtn');
            refreshIcon = document.getElementById('refreshIcon');
            loadingState = document.getElementById('loadingState');
            searchInput = document.getElementById('searchInput');
            sortBy = document.getElementById('sortBy');
            connectionStatus = document.getElementById('connectionStatus');
            individualViewBtn = document.getElementById('individualViewBtn');
            overallViewBtn = document.getElementById('overallViewBtn');
            individualView = document.getElementById('individualView');
            overallView = document.getElementById('overallView');
            
            console.log('‚úÖ Elements found:', {
                studentsGrid: !!studentsGrid,
                instructorGroups: !!instructorGroups,
                individualView: !!individualView,
                instructorFilter: !!instructorFilter
            });
            
            // Process student data
            studentsData = studentsData.map(student => ({
                ...student,
                totalHafalan: calculateTotalAyat(student.completedSurahs, student.currentSurah, student.currentAyat, student.name),
                juzCompleted: calculateCompletedJuz(student.completedSurahs, student.currentSurah, student.currentAyat)
            }));
            
            console.log('üìä Processed students data:', studentsData.length, 'students');
            console.log('üìã Sample student data:', studentsData[0]);
            
            // Initialize current filtered data
            currentFilteredData = studentsData;
            
            // Setup UI
            populateInstructorFilter();
            updateStatistics();
            
            // Set individual view as active
            currentView = 'individual';
            if (individualView) {
                individualView.classList.remove('hidden');
                individualView.style.display = 'block';
                console.log('‚úÖ Individual view made visible');
            }
            if (overallView) {
                overallView.classList.add('hidden');
                console.log('‚úÖ Overall view hidden');
            }
            
            // CRITICAL: Render students immediately with demo data
            console.log('üéØ Rendering students by instructor with demo data...');
            
            // Force render with demo data first
            if (instructorGroups) {
                console.log('üìù Instructor groups element found, rendering...');
                
                // IMMEDIATE render without any delays
                renderStudentsByInstructor(studentsData);
                
                // Force visibility with multiple methods
                instructorGroups.classList.remove('hidden');
                instructorGroups.style.display = 'block';
                instructorGroups.style.visibility = 'visible';
                instructorGroups.style.opacity = '1';
                
                console.log('‚úÖ Instructor groups made visible');
                
                // Force a reflow to ensure rendering
                instructorGroups.offsetHeight;
                
                // Double-check rendering after a brief moment
                setTimeout(() => {
                    if (instructorGroups.children.length === 0) {
                        console.warn('‚ö†Ô∏è No children found, forcing emergency render...');
                        // Emergency fallback render
                        instructorGroups.innerHTML = `
                            <div class="bg-white rounded-xl shadow-md p-6">
                                <h3 class="text-lg font-semibold mb-4">üìö Data Siswa Tahfidz</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    ${studentsData.slice(0, 6).map(student => `
                                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                            <h4 class="font-semibold text-blue-800">${student.name}</h4>
                                            <p class="text-sm text-blue-600">${student.currentSurah} - Ayat ${student.currentAyat}</p>
                                            <p class="text-xs text-blue-500">Pengampu: ${student.instructor}</p>
                                            <div class="mt-2 bg-blue-200 rounded-full h-2">
                                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${(student.totalHafalan / 6236 * 100).toFixed(1)}%"></div>
                                            </div>
                                            <p class="text-xs text-blue-600 mt-1">${student.totalHafalan} ayat (${(student.totalHafalan / 6236 * 100).toFixed(1)}%)</p>
                                        </div>
                                    `).join('')}
                                </div>
                                ${studentsData.length > 6 ? `
                                    <div class="mt-4 text-center">
                                        <button onclick="renderStudentsByInstructor(studentsData)" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                            Tampilkan Semua ${studentsData.length} Siswa
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    
                    console.log('üîç Final instructor groups check:', {
                        innerHTML: instructorGroups.innerHTML.length,
                        children: instructorGroups.children.length,
                        visible: !instructorGroups.classList.contains('hidden'),
                        display: instructorGroups.style.display,
                        opacity: instructorGroups.style.opacity
                    });
                }, 50);
            } else {
                console.error('‚ùå instructorGroups element not found!');
            }
            
            if (studentsGrid) {
                studentsGrid.classList.add('hidden');
                console.log('‚úÖ Students grid hidden');
            }
            
            const individualPagination = document.getElementById('individualPagination');
            if (individualPagination) {
                individualPagination.classList.add('hidden');
                console.log('‚úÖ Individual pagination hidden');
            }
            
            console.log('‚úÖ Initial setup complete, loading from Google Sheets in background...');
            
            // Load from Google Sheets in background (don't wait for it)
            setTimeout(() => {
                loadFromGoogleSheets();
            }, 1000);
        });

        function switchView(view) {
            currentView = view;
            
            if (view === 'individual') {
                individualView.classList.remove('hidden');
                overallView.classList.add('hidden');
                
                individualViewBtn.classList.add('bg-blue-600', 'text-white');
                individualViewBtn.classList.remove('text-gray-600');
                overallViewBtn.classList.remove('bg-blue-600', 'text-white');
                overallViewBtn.classList.add('text-gray-600');
                
                renderStudents(studentsData);
            } else {
                individualView.classList.add('hidden');
                overallView.classList.remove('hidden');
                
                overallViewBtn.classList.add('bg-blue-600', 'text-white');
                overallViewBtn.classList.remove('text-gray-600');
                individualViewBtn.classList.remove('bg-blue-600', 'text-white');
                individualViewBtn.classList.add('text-gray-600');
                
                renderOverallView();
            }
        }

        async function loadFromGoogleSheets() {
            console.log('üîÑ Starting Google Sheets data load...');
            showLoading(true);
            refreshIcon.textContent = '‚è≥';
            
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${CONFIG.SHEET_NAME}?key=${CONFIG.API_KEY}`;
                console.log('üì° Fetching from URL:', url);
                
                const response = await fetch(url);
                console.log('üì• Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Response error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Data received:', data);
                
                if (data.values && data.values.length > 1) {
                    console.log('üìä Processing', data.values.length - 1, 'rows of data...');
                    const processedData = processSheetData(data.values);
                    studentsData = processedData;
                    currentFilteredData = studentsData;
                    populateInstructorFilter();
                    
                    console.log('‚úÖ Processed', processedData.length, 'students successfully');
                    
                    if (currentView === 'individual') {
                        renderStudentsByInstructor(studentsData);
                        updateStatistics();
                    } else {
                        renderOverallView();
                    }
                    
                    updateConnectionStatus(true, 'Data berhasil dimuat dari Google Sheets');
                    showNotification(`‚úÖ Data berhasil dimuat! (${processedData.length} siswa)`, 'success');
                } else {
                    console.warn('‚ö†Ô∏è No data found in sheets response');
                    updateConnectionStatus(false, 'Data tidak ditemukan di Google Sheets');
                    showNotification('‚ö†Ô∏è Data tidak ditemukan di Google Sheets', 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Error loading from Google Sheets:', error);
                console.log('üîÑ Using demo data instead...');
                
                // Ensure we still have working data
                if (studentsData.length === 0) {
                    console.log('üìù Initializing with demo data...');
                    initializeDemoData();
                }
                
                updateConnectionStatus(false, 'Menggunakan data demo - ' + error.message);
                showNotification('‚ö†Ô∏è Gagal memuat data online, menggunakan data demo', 'error');
                
                // Still render the current view with demo data
                if (currentView === 'individual') {
                    renderStudentsByInstructor(studentsData);
                    updateStatistics();
                } else {
                    renderOverallView();
                }
            } finally {
                showLoading(false);
                refreshIcon.textContent = 'üîÑ';
                console.log('‚úÖ Load process completed');
            }
        }

        function initializeDemoData() {
            // Reinitialize demo data if needed
            studentsData = [
                { 
                    name: 'A. Azam', 
                    currentSurah: 'An-Naba\'', 
                    currentAyat: 20, 
                    totalHafalan: 20,
                    currentJuz: 'Juz 30',
                    completedSurahs: '',
                    surahsCompleted: 0,
                    juzCompleted: 0,
                    lastUpdate: '1/9/2025 20.58.35',
                    status: '1',
                    instructor: 'Ustadz Ahmad'
                },
                { 
                    name: 'Abyan', 
                    currentSurah: 'An-Naba\'', 
                    currentAyat: 12, 
                    totalHafalan: 12,
                    currentJuz: 'Juz 30',
                    completedSurahs: '',
                    surahsCompleted: 0,
                    juzCompleted: 0,
                    lastUpdate: '1/9/2025 20.58.35',
                    status: '1',
                    instructor: 'Ustadz Ahmad'
                },
                { 
                    name: 'Zakariya', 
                    currentSurah: 'An-Naba\'', 
                    currentAyat: 11, 
                    totalHafalan: 11,
                    currentJuz: 'Juz 30',
                    completedSurahs: '',
                    surahsCompleted: 0,
                    juzCompleted: 0,
                    lastUpdate: '1/9/2025 20.58.35',
                    status: '1',
                    instructor: 'Ustadz Ahmad'
                },
                { 
                    name: 'Navisa', 
                    currentSurah: 'An-Nazi\'at', 
                    currentAyat: 7, 
                    totalHafalan: 47,
                    currentJuz: 'Juz 30',
                    completedSurahs: 'An-Naba\'',
                    surahsCompleted: 1,
                    juzCompleted: 1,
                    lastUpdate: '1/9/2025 20.58.35',
                    status: '2',
                    instructor: 'Ustadzah Fatimah'
                },
                { 
                    name: 'Jelita N', 
                    currentSurah: 'An-Naba\'', 
                    currentAyat: 34, 
                    totalHafalan: 34,
                    currentJuz: 'Juz 30',
                    completedSurahs: '',
                    surahsCompleted: 0,
                    juzCompleted: 0,
                    lastUpdate: '1/9/2025 20.58.35',
                    status: '2',
                    instructor: 'Ustadzah Fatimah'
                }
            ];
            
            // Recalculate totals
            studentsData = studentsData.map(student => ({
                ...student,
                totalHafalan: calculateTotalAyat(student.completedSurahs, student.currentSurah, student.currentAyat, student.name)
            }));
            
            currentFilteredData = studentsData;
            console.log('üìù Demo data initialized with', studentsData.length, 'students');
        }

        function processSheetData(values) {
            const processedData = [];
            
            for (let i = 1; i < values.length; i++) {
                const row = values[i];
                if (row.length >= 8 && row[0]) {
                    const student = {
                        name: row[0] || '',
                        currentSurah: row[1] || '',
                        currentAyat: parseInt(row[2]) || 0,
                        totalHafalan: parseInt(row[3]) || 0,
                        currentJuz: row[4] || '',
                        completedSurahs: row[5] || '',
                        lastUpdate: row[6] || '',
                        status: row[7] || '',
                        instructor: row[8] || 'Tidak ada pengampu'
                    };
                    
                    student.totalHafalan = calculateTotalAyat(
                        student.completedSurahs, 
                        student.currentSurah, 
                        student.currentAyat,
                        student.name
                    );
                    
                    const surahsList = student.completedSurahs.split(',').map(s => s.trim()).filter(s => s);
                    student.surahsCompleted = surahsList.length;
                    
                    student.juzCompleted = calculateCompletedJuz(student.completedSurahs, student.currentSurah, student.currentAyat);
                    
                    processedData.push(student);
                }
            }
            
            return processedData.length > 0 ? processedData : studentsData;
        }

        function showLoading(show) {
            if (show) {
                loadingState.classList.remove('hidden');
                studentsGrid.style.opacity = '0.5';
            } else {
                loadingState.classList.add('hidden');
                studentsGrid.style.opacity = '1';
            }
        }

        function updateConnectionStatus(connected, message) {
            const statusElement = connectionStatus;
            const statusElementMobile = document.getElementById('connectionStatusMobile');
            
            const statusHTML = connected ? 
                `<span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>Terhubung ke Google Sheets` :
                `<span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>Menggunakan data demo`;
            
            if (statusElement) {
                statusElement.innerHTML = statusHTML;
            }
            if (statusElementMobile) {
                statusElementMobile.innerHTML = statusHTML;
            }
        }

        function showNotification(message, type = 'success', duration = 3000) {
            const popup = document.getElementById('notificationPopup');
            
            popup.innerHTML = `
                <div class="notification-popup ${type} text-white px-6 py-4 rounded-lg shadow-lg max-w-sm">
                    <div class="flex items-center space-x-3">
                        <div class="text-2xl">
                            ${type === 'success' ? '‚úÖ' : '‚ùå'}
                        </div>
                        <div>
                            <div class="font-semibold text-sm">${message}</div>
                        </div>
                        <button onclick="hideNotification()" class="ml-auto text-white hover:text-gray-200 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                popup.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                hideNotification();
            }, duration);
        }

        function hideNotification() {
            const popup = document.getElementById('notificationPopup');
            popup.classList.remove('show');
        }

        function updateStatistics() {
            const totalStudents = studentsData.length;
            const totalStudentsElement = document.getElementById('totalStudents');
            const lastUpdateElement = document.getElementById('lastUpdate');
            
            if (totalStudentsElement) {
                totalStudentsElement.textContent = totalStudents;
            }
            
            if (lastUpdateElement) {
                const now = new Date();
                lastUpdateElement.textContent = now.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            }
        }

        function renderStudents(students) {
            currentFilteredData = students;
            individualCurrentPage = 1;
            renderStudentsWithPagination();
        }
        
        function renderStudentsWithPagination() {
            studentsGrid.innerHTML = '';
            
            const startIndex = (individualCurrentPage - 1) * individualItemsPerPage;
            const endIndex = startIndex + individualItemsPerPage;
            const paginatedStudents = currentFilteredData.slice(startIndex, endIndex);
            
            paginatedStudents.forEach((student, index) => {
                const card = createStudentCard(student, startIndex + index);
                studentsGrid.appendChild(card);
            });
            
            updateIndividualPagination();
        }
        
        function updateIndividualPagination() {
            const totalItems = currentFilteredData.length;
            const totalPages = Math.ceil(totalItems / individualItemsPerPage);
            const startItem = (individualCurrentPage - 1) * individualItemsPerPage + 1;
            const endItem = Math.min(individualCurrentPage * individualItemsPerPage, totalItems);
            
            const pageInfoText = `Menampilkan ${startItem}-${endItem} dari ${totalItems} siswa`;
            
            // Update desktop pagination
            const pageInfoDesktop = document.getElementById('individualPageInfo');
            if (pageInfoDesktop) {
                pageInfoDesktop.textContent = pageInfoText;
            }
            
            // Update mobile pagination
            const pageInfoMobile = document.getElementById('individualPageInfoMobile');
            if (pageInfoMobile) {
                pageInfoMobile.textContent = pageInfoText;
            }
            
            // Update desktop buttons
            const prevBtn = document.getElementById('individualPrevBtn');
            const nextBtn = document.getElementById('individualNextBtn');
            if (prevBtn) prevBtn.disabled = individualCurrentPage === 1;
            if (nextBtn) nextBtn.disabled = individualCurrentPage === totalPages || totalPages === 0;
            
            // Update mobile buttons
            const prevBtnMobile = document.getElementById('individualPrevBtnMobile');
            const nextBtnMobile = document.getElementById('individualNextBtnMobile');
            if (prevBtnMobile) prevBtnMobile.disabled = individualCurrentPage === 1;
            if (nextBtnMobile) nextBtnMobile.disabled = individualCurrentPage === totalPages || totalPages === 0;
            
            // Update desktop page numbers
            const pageNumbersContainer = document.getElementById('individualPageNumbers');
            if (pageNumbersContainer) {
                updatePageNumbers(pageNumbersContainer, totalPages, individualCurrentPage, 'individual');
            }
            
            // Update mobile page numbers
            const pageNumbersContainerMobile = document.getElementById('individualPageNumbersMobile');
            if (pageNumbersContainerMobile) {
                updatePageNumbers(pageNumbersContainerMobile, totalPages, individualCurrentPage, 'individual', true);
            }
            
            const paginationElement = document.getElementById('individualPagination');
            if (totalPages > 1) {
                paginationElement.classList.remove('hidden');
            } else {
                paginationElement.classList.add('hidden');
            }
        }
        
        function updatePageNumbers(container, totalPages, currentPage, type, isMobile = false) {
            container.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            const maxVisiblePages = isMobile ? 3 : 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // Add first page and ellipsis if needed
            if (startPage > 1) {
                addPageButton(container, 1, currentPage, type, isMobile);
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-2 py-1 text-gray-400 text-sm';
                    ellipsis.textContent = '...';
                    container.appendChild(ellipsis);
                }
            }
            
            // Add visible page numbers
            for (let i = startPage; i <= endPage; i++) {
                addPageButton(container, i, currentPage, type, isMobile);
            }
            
            // Add ellipsis and last page if needed
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-2 py-1 text-gray-400 text-sm';
                    ellipsis.textContent = '...';
                    container.appendChild(ellipsis);
                }
                addPageButton(container, totalPages, currentPage, type, isMobile);
            }
        }
        
        function addPageButton(container, pageNum, currentPage, type, isMobile = false) {
            const pageBtn = document.createElement('button');
            const isActive = pageNum === currentPage;
            const sizeClass = isMobile ? 'px-2 py-1 text-xs' : 'px-3 py-1 text-sm';
            
            pageBtn.className = `${sizeClass} font-medium rounded ${
                isActive 
                    ? 'bg-blue-600 text-white' 
                    : 'text-gray-500 hover:bg-gray-100'
            }`;
            pageBtn.textContent = pageNum;
            pageBtn.onclick = () => {
                if (type === 'individual') {
                    individualCurrentPage = pageNum;
                    renderStudentsWithPagination();
                } else if (type === 'table') {
                    tableCurrentPage = pageNum;
                    renderStudentTable();
                }
            };
            container.appendChild(pageBtn);
        }

        function createStudentCard(student, index) {
            const card = document.createElement('div');
            card.className = 'bg-gradient-to-br from-blue-50 to-indigo-100 border border-blue-200 rounded-xl shadow-lg p-6 card-hover fade-in';
            card.style.animationDelay = `${index * 0.1}s`;
            
            const ayatProgress = (student.totalHafalan / QURAN_STRUCTURE.totalAyat * 100);
            const motivationMessage = getMotivationMessage(ayatProgress);
            
            card.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-indigo-800">${student.name}</h3>
                    <div class="text-2xl">${getStudentEmoji(ayatProgress)}</div>
                </div>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-indigo-700">Surat Terakhir: ${student.currentSurah}</span>
                        <span class="text-sm font-bold text-indigo-600">${ayatProgress.toFixed(1)}%</span>
                    </div>
                    <div class="w-full bg-indigo-200 rounded-full h-3">
                        <div class="progress-bar h-3 rounded-full bg-gradient-to-r from-indigo-500 to-blue-600" 
                             style="width: ${ayatProgress}%"></div>
                    </div>
                    <div class="text-xs text-indigo-600 mt-1 font-medium">
                        Ayat ke-${student.currentAyat} ‚Ä¢ ${student.currentJuz}
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <div class="text-center p-2 bg-gradient-to-br from-emerald-100 to-green-200 border border-emerald-300 rounded-lg">
                        <div class="text-sm font-bold text-emerald-700">${student.totalHafalan}</div>
                        <div class="text-xs text-emerald-600">Ayat Hafal</div>
                    </div>
                    <div class="text-center p-2 bg-gradient-to-br from-blue-100 to-cyan-200 border border-blue-300 rounded-lg">
                        <div class="text-sm font-bold text-blue-700">${ayatProgress.toFixed(1)}%</div>
                        <div class="text-xs text-blue-600">Hafalan</div>
                    </div>
                    <div class="text-center p-2 bg-gradient-to-br from-purple-100 to-violet-200 border border-purple-300 rounded-lg">
                        <div class="text-sm font-bold text-purple-700">${student.surahsCompleted}</div>
                        <div class="text-xs text-purple-600">Surat Hafal</div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-indigo-100 to-blue-100 border border-indigo-200 rounded-lg p-3 mb-4">
                    <div class="text-sm text-indigo-700 font-medium mb-1">Surat yang Sudah Dihafal:</div>
                    <div class="text-xs text-indigo-600 mb-2">
                        ${student.completedSurahs || 'Belum ada surat yang selesai'}
                    </div>
                    <div class="text-xs text-indigo-600">
                        ‚Ä¢ Total: ${student.surahsCompleted} surat<br>
                        ‚Ä¢ Update: ${formatDate(student.lastUpdate)}
                    </div>
                </div>
                
                <div class="border-t border-indigo-200 pt-3">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-sm font-medium text-indigo-700">üë®‚Äçüè´ Pengampu:</div>
                        <div class="text-sm text-blue-700 font-semibold">${student.instructor}</div>
                    </div>
                    <div class="text-sm font-medium text-indigo-700 mb-1">üí¨ Motivasi:</div>
                    <div class="text-xs text-indigo-600 italic font-medium">"${motivationMessage}"</div>
                </div>
            `;
            
            return card;
        }

        function getProgressColor(progress) {
            if (progress >= 80) return 'text-green-600';
            if (progress >= 60) return 'text-blue-600';
            if (progress >= 40) return 'text-yellow-600';
            return 'text-red-500';
        }

        function getStudentEmoji(progress) {
            if (progress >= 90) return 'üèÜ';
            if (progress >= 70) return '‚≠ê';
            if (progress >= 50) return 'üìö';
            if (progress >= 30) return 'üí™';
            return 'üå±';
        }

        function getStatusText(progress) {
            if (progress >= 90) return 'Sangat Baik';
            if (progress >= 70) return 'Baik';
            if (progress >= 50) return 'Cukup';
            if (progress >= 30) return 'Perlu Usaha';
            return 'Pemula';
        }

        function getMotivationMessage(progress) {
            const messages = {
                high: [
                    "Masya Allah! Terus pertahankan semangat hafalanmu!",
                    "Luar biasa! Kamu adalah teladan untuk teman-teman!",
                    "Alhamdulillah, progress yang sangat membanggakan!"
                ],
                medium: [
                    "Bagus sekali! Terus semangat, kamu pasti bisa!",
                    "Progress yang baik, jangan menyerah ya!",
                    "Keren! Sedikit lagi mencapai target berikutnya!"
                ],
                low: [
                    "Semangat! Setiap ayat yang dihafal adalah berkah!",
                    "Jangan menyerah, Allah akan memudahkan langkahmu!",
                    "Pelan tapi pasti, yang penting konsisten!"
                ]
            };
            
            let category = 'low';
            if (progress >= 70) category = 'high';
            else if (progress >= 40) category = 'medium';
            
            const categoryMessages = messages[category];
            return categoryMessages[Math.floor(Math.random() * categoryMessages.length)];
        }

        function handleSearch() {
            const query = searchInput.value.toLowerCase();
            const selectedInstructor = instructorFilter.value;
            
            if (selectedInstructor === 'all') {
                let dataToShow = studentsData;
                if (query) {
                    dataToShow = studentsData.filter(student => 
                        student.name.toLowerCase().includes(query)
                    );
                }
                
                if (currentView === 'individual') {
                    renderStudentsByInstructor(dataToShow);
                    studentsGrid.classList.add('hidden');
                    instructorGroups.classList.remove('hidden');
                    document.getElementById('individualPagination').classList.add('hidden');
                }
            } else {
                let filtered = studentsData.filter(student => student.instructor === selectedInstructor);
                if (query) {
                    filtered = filtered.filter(student => 
                        student.name.toLowerCase().includes(query)
                    );
                }
                
                if (currentView === 'individual') {
                    renderStudents(filtered);
                    studentsGrid.classList.remove('hidden');
                    instructorGroups.classList.add('hidden');
                }
            }
        }

        function handleSort() {
            const sortType = sortBy.value;
            const selectedInstructor = instructorFilter.value;
            const query = searchInput.value.toLowerCase();
            let sorted = [...studentsData];
            
            switch(sortType) {
                case 'name':
                    sorted.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'progress':
                    sorted.sort((a, b) => b.totalHafalan - a.totalHafalan);
                    break;
                case 'surah':
                    sorted.sort((a, b) => a.currentSurah.localeCompare(b.currentSurah));
                    break;
            }
            
            if (selectedInstructor === 'all') {
                let dataToShow = sorted;
                if (query) {
                    dataToShow = sorted.filter(student => 
                        student.name.toLowerCase().includes(query)
                    );
                }
                
                if (currentView === 'individual') {
                    renderStudentsByInstructor(dataToShow);
                    studentsGrid.classList.add('hidden');
                    instructorGroups.classList.remove('hidden');
                    document.getElementById('individualPagination').classList.add('hidden');
                }
            } else {
                let filtered = sorted.filter(student => student.instructor === selectedInstructor);
                if (query) {
                    filtered = filtered.filter(student => 
                        student.name.toLowerCase().includes(query)
                    );
                }
                
                if (currentView === 'individual') {
                    renderStudents(filtered);
                    studentsGrid.classList.remove('hidden');
                    instructorGroups.classList.add('hidden');
                }
            }
        }

        function populateInstructorFilter() {
            const instructors = [...new Set(studentsData.map(student => student.instructor))].sort();
            instructorFilter.innerHTML = '<option value="all">Semua Pengampu</option>';
            
            instructors.forEach(instructor => {
                const option = document.createElement('option');
                option.value = instructor;
                option.textContent = instructor;
                instructorFilter.appendChild(option);
            });
        }

        function handleInstructorFilter() {
            const selectedInstructor = instructorFilter.value;
            const query = searchInput.value.toLowerCase();
            
            if (selectedInstructor === 'all') {
                let dataToShow = studentsData;
                if (query) {
                    dataToShow = studentsData.filter(student => 
                        student.name.toLowerCase().includes(query)
                    );
                }
                
                // Show instructor groups for "all" selection in individual view
                if (currentView === 'individual') {
                    renderStudentsByInstructor(dataToShow);
                    studentsGrid.classList.add('hidden');
                    instructorGroups.classList.remove('hidden');
                    document.getElementById('individualPagination').classList.add('hidden');
                }
            } else {
                let filtered = studentsData.filter(student => student.instructor === selectedInstructor);
                if (query) {
                    filtered = filtered.filter(student => 
                        student.name.toLowerCase().includes(query)
                    );
                }
                
                if (currentView === 'individual') {
                    renderStudents(filtered);
                    studentsGrid.classList.remove('hidden');
                    instructorGroups.classList.add('hidden');
                }
            }
        }

        function renderStudentsByInstructor(students) {
            console.log('üéØ renderStudentsByInstructor called with', students.length, 'students');
            
            if (!instructorGroups) {
                console.error('‚ùå instructorGroups element not found');
                // EMERGENCY: Try to find it again
                instructorGroups = document.getElementById('instructorGroups');
                if (!instructorGroups) {
                    console.error('‚ùå Still cannot find instructorGroups element!');
                    return;
                }
            }
            
            // EMERGENCY: Add immediate visible content
            instructorGroups.innerHTML = '<div class="bg-blue-100 p-4 rounded-lg text-center">üîÑ Memuat data siswa...</div>';
            console.log('üîÑ Added loading message');
            
            // Group students by instructor
            const groupedByInstructor = students.reduce((groups, student) => {
                const instructor = student.instructor || 'Tidak ada pengampu';
                if (!groups[instructor]) {
                    groups[instructor] = [];
                }
                groups[instructor].push(student);
                return groups;
            }, {});

            console.log('üìä Grouped by instructor:', Object.keys(groupedByInstructor));

            const instructorNames = Object.keys(groupedByInstructor);
            console.log('üë®‚Äçüè´ Instructor names found:', instructorNames);
            
            if (instructorNames.length === 0) {
                console.error('‚ùå No instructors found!');
                instructorGroups.innerHTML = `
                    <div class="bg-red-100 border border-red-300 rounded-lg p-6 text-center">
                        <div class="text-red-600 text-lg mb-2">‚ö†Ô∏è Tidak ada data pengampu</div>
                        <div class="text-red-500 text-sm">Debug: ${students.length} siswa ditemukan</div>
                        <div class="text-red-500 text-xs mt-2">Sample: ${JSON.stringify(students[0] || {})}</div>
                    </div>
                `;
                return;
            }
            
            // Clear loading message
            instructorGroups.innerHTML = '';
            
            const sortedInstructors = instructorNames.sort((a, b) => {
                const aIsMustofa = a.toLowerCase().includes('mustofa');
                const bIsMustofa = b.toLowerCase().includes('mustofa');
                
                const aIsAhmadAmir = a.toLowerCase().includes('ahmad') && (a.toLowerCase().includes('amir') || a.toLowerCase().includes('yusuf'));
                const bIsAhmadAmir = b.toLowerCase().includes('ahmad') && (b.toLowerCase().includes('amir') || b.toLowerCase().includes('yusuf'));
                
                if (aIsMustofa && !bIsMustofa) return -1;
                if (!aIsMustofa && bIsMustofa) return 1;
                
                if (aIsAhmadAmir && !bIsAhmadAmir) return 1;
                if (!aIsAhmadAmir && bIsAhmadAmir) return -1;
                
                return a.localeCompare(b);
            });

            console.log('üìã Sorted instructors:', sortedInstructors);

            // Create sections for each instructor
            sortedInstructors.forEach((instructor, index) => {
                const instructorStudents = groupedByInstructor[instructor];
                console.log(`üèóÔ∏è Creating section ${index + 1} for ${instructor} with ${instructorStudents.length} students`);
                
                try {
                    const instructorSection = createInstructorSection(instructor, instructorStudents);
                    instructorGroups.appendChild(instructorSection);
                    console.log(`‚úÖ Successfully added section for ${instructor}`);
                } catch (error) {
                    console.error(`‚ùå Error creating section for ${instructor}:`, error);
                    
                    // EMERGENCY: Add basic section if creation fails
                    const emergencySection = document.createElement('div');
                    emergencySection.className = 'bg-yellow-100 border border-yellow-300 rounded-lg p-4 mb-4';
                    emergencySection.innerHTML = `
                        <h3 class="font-bold text-yellow-800">‚ö†Ô∏è ${instructor}</h3>
                        <p class="text-yellow-700">${instructorStudents.length} siswa (Error dalam rendering)</p>
                        <div class="text-xs text-yellow-600 mt-2">
                            Siswa: ${instructorStudents.map(s => s.name).join(', ')}
                        </div>
                    `;
                    instructorGroups.appendChild(emergencySection);
                }
            });
            
            console.log('‚úÖ Finished rendering instructor groups. Total sections:', sortedInstructors.length);
            console.log('üìè instructorGroups innerHTML length:', instructorGroups.innerHTML.length);
            
            // FORCE visibility with multiple methods
            instructorGroups.style.display = 'block';
            instructorGroups.style.visibility = 'visible';
            instructorGroups.classList.remove('hidden');
            instructorGroups.setAttribute('data-rendered', 'true');
            
            // Final check
            setTimeout(() => {
                console.log('üîç Final visibility check:', {
                    display: instructorGroups.style.display,
                    visibility: instructorGroups.style.visibility,
                    hidden: instructorGroups.classList.contains('hidden'),
                    children: instructorGroups.children.length,
                    rendered: instructorGroups.getAttribute('data-rendered')
                });
            }, 200);
        }

        function createInstructorSection(instructor, students) {
            const section = document.createElement('div');
            section.className = 'bg-white rounded-xl shadow-md overflow-hidden';
            
            const totalStudents = students.length;
            const avgHafalan = students.reduce((sum, s) => sum + s.totalHafalan, 0) / totalStudents;
            const topStudent = students.reduce((top, s) => s.totalHafalan > top.totalHafalan ? s : top);
            
            const safeInstructorId = 'instructor-' + Math.random().toString(36).substr(2, 9);
            const paginationId = 'pagination-' + Math.random().toString(36).substr(2, 9);
            
            // Pagination settings for instructor sections
            const studentsPerPage = 6;
            const totalPages = Math.ceil(totalStudents / studentsPerPage);
            let currentPage = 1;
            
            section.innerHTML = `
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-xl font-bold mb-2">üë®‚Äçüè´ ${instructor}</h3>
                            <p class="text-blue-100">Mengelola ${totalStudents} siswa</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold">${Math.round(avgHafalan)}</div>
                            <div class="text-sm text-blue-100">Rata-rata Ayat</div>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <div class="bg-white bg-opacity-20 rounded-lg p-3">
                            <div class="text-sm text-blue-100">Siswa Terdepan</div>
                            <div class="font-semibold">${topStudent.name}</div>
                            <div class="text-xs text-blue-200">${topStudent.totalHafalan} ayat</div>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-lg p-3">
                            <div class="text-sm text-blue-100">Total Hafalan</div>
                            <div class="font-semibold">${students.reduce((sum, s) => sum + s.totalHafalan, 0)} ayat</div>
                            <div class="text-xs text-blue-200">Seluruh siswa</div>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="${safeInstructorId}">
                        <!-- Student cards will be populated here -->
                    </div>
                    
                    ${totalPages > 1 ? `
                    <div class="mt-6 pt-4 border-t border-gray-200" id="${paginationId}">
                        <!-- Mobile Pagination -->
                        <div class="block sm:hidden">
                            <div class="text-center mb-3">
                                <span class="text-sm text-gray-600" id="${paginationId}-info-mobile">Menampilkan 1-${Math.min(studentsPerPage, totalStudents)} dari ${totalStudents} siswa</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <button class="flex items-center px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" 
                                        id="${paginationId}-prev-mobile" onclick="changeInstructorPage('${safeInstructorId}', '${paginationId}', [], -1)">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                    </svg>
                                    <span class="hidden xs:inline">Sebelumnya</span>
                                </button>
                                <div class="flex items-center space-x-1" id="${paginationId}-numbers-mobile">
                                    <!-- Page numbers will be populated here -->
                                </div>
                                <button class="flex items-center px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" 
                                        id="${paginationId}-next-mobile" onclick="changeInstructorPage('${safeInstructorId}', '${paginationId}', [], 1)">
                                    <span class="hidden xs:inline">Selanjutnya</span>
                                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Desktop Pagination -->
                        <div class="hidden sm:flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <span class="text-sm text-gray-600" id="${paginationId}-info">Menampilkan 1-${Math.min(studentsPerPage, totalStudents)} dari ${totalStudents} siswa</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="px-4 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" 
                                        id="${paginationId}-prev" onclick="changeInstructorPage('${safeInstructorId}', '${paginationId}', [], -1)">
                                    ‚Üê Sebelumnya
                                </button>
                                <div class="flex items-center space-x-1" id="${paginationId}-numbers">
                                    <!-- Page numbers will be populated here -->
                                </div>
                                <button class="px-4 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" 
                                        id="${paginationId}-next" onclick="changeInstructorPage('${safeInstructorId}', '${paginationId}', [], 1)">
                                    Selanjutnya ‚Üí
                                </button>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            // Store pagination data on the section element
            section.instructorData = {
                students: students,
                currentPage: 1,
                studentsPerPage: studentsPerPage,
                totalPages: totalPages,
                containerId: safeInstructorId,
                paginationId: paginationId
            };
            
            // Render first page of students
            renderInstructorStudents(safeInstructorId, paginationId, students, 1);
            
            return section;
        }

        function changePage(type, direction) {
            if (type === 'individual') {
                const totalPages = Math.ceil(currentFilteredData.length / individualItemsPerPage);
                
                if (direction === -1 && individualCurrentPage > 1) {
                    individualCurrentPage--;
                    renderStudentsWithPagination();
                } else if (direction === 1 && individualCurrentPage < totalPages) {
                    individualCurrentPage++;
                    renderStudentsWithPagination();
                }
            } else if (type === 'table') {
                const totalPages = Math.ceil(currentFilteredData.length / tableItemsPerPage);
                
                if (direction === -1 && tableCurrentPage > 1) {
                    tableCurrentPage--;
                    renderStudentTable();
                } else if (direction === 1 && tableCurrentPage < totalPages) {
                    tableCurrentPage++;
                    renderStudentTable();
                }
            }
        }

        // Global storage for instructor pagination states
        const instructorPaginationStates = {};

        function renderInstructorStudents(containerId, paginationId, students, currentPage) {
            const studentsPerPage = 6;
            const totalPages = Math.ceil(students.length / studentsPerPage);
            
            // Store state
            instructorPaginationStates[containerId] = {
                students: students,
                currentPage: currentPage,
                studentsPerPage: studentsPerPage,
                totalPages: totalPages,
                paginationId: paginationId
            };
            
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            const startIndex = (currentPage - 1) * studentsPerPage;
            const endIndex = startIndex + studentsPerPage;
            const paginatedStudents = students.slice(startIndex, endIndex);
            
            paginatedStudents.forEach((student, index) => {
                const card = createStudentCard(student, startIndex + index);
                container.appendChild(card);
            });
            
            // Update pagination info and buttons
            updateInstructorPagination(containerId, paginationId, students.length, currentPage, studentsPerPage, totalPages);
        }

        function updateInstructorPagination(containerId, paginationId, totalStudents, currentPage, studentsPerPage, totalPages) {
            const startItem = (currentPage - 1) * studentsPerPage + 1;
            const endItem = Math.min(currentPage * studentsPerPage, totalStudents);
            const pageInfoText = `Menampilkan ${startItem}-${endItem} dari ${totalStudents} siswa`;
            
            // Update desktop info
            const infoDesktop = document.getElementById(`${paginationId}-info`);
            if (infoDesktop) {
                infoDesktop.textContent = pageInfoText;
            }
            
            // Update mobile info
            const infoMobile = document.getElementById(`${paginationId}-info-mobile`);
            if (infoMobile) {
                infoMobile.textContent = pageInfoText;
            }
            
            // Update desktop buttons
            const prevBtn = document.getElementById(`${paginationId}-prev`);
            const nextBtn = document.getElementById(`${paginationId}-next`);
            if (prevBtn) prevBtn.disabled = currentPage === 1;
            if (nextBtn) nextBtn.disabled = currentPage === totalPages;
            
            // Update mobile buttons
            const prevBtnMobile = document.getElementById(`${paginationId}-prev-mobile`);
            const nextBtnMobile = document.getElementById(`${paginationId}-next-mobile`);
            if (prevBtnMobile) prevBtnMobile.disabled = currentPage === 1;
            if (nextBtnMobile) nextBtnMobile.disabled = currentPage === totalPages;
            
            // Update desktop page numbers
            const pageNumbersContainer = document.getElementById(`${paginationId}-numbers`);
            if (pageNumbersContainer) {
                updateInstructorPageNumbers(pageNumbersContainer, totalPages, currentPage, containerId, false);
            }
            
            // Update mobile page numbers
            const pageNumbersContainerMobile = document.getElementById(`${paginationId}-numbers-mobile`);
            if (pageNumbersContainerMobile) {
                updateInstructorPageNumbers(pageNumbersContainerMobile, totalPages, currentPage, containerId, true);
            }
        }

        function updateInstructorPageNumbers(container, totalPages, currentPage, containerId, isMobile = false) {
            container.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            const maxVisiblePages = isMobile ? 3 : 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // Add first page and ellipsis if needed
            if (startPage > 1) {
                addInstructorPageButton(container, 1, currentPage, containerId, isMobile);
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-2 py-1 text-gray-400 text-sm';
                    ellipsis.textContent = '...';
                    container.appendChild(ellipsis);
                }
            }
            
            // Add visible page numbers
            for (let i = startPage; i <= endPage; i++) {
                addInstructorPageButton(container, i, currentPage, containerId, isMobile);
            }
            
            // Add ellipsis and last page if needed
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-2 py-1 text-gray-400 text-sm';
                    ellipsis.textContent = '...';
                    container.appendChild(ellipsis);
                }
                addInstructorPageButton(container, totalPages, currentPage, containerId, isMobile);
            }
        }

        function addInstructorPageButton(container, pageNum, currentPage, containerId, isMobile = false) {
            const pageBtn = document.createElement('button');
            const isActive = pageNum === currentPage;
            const sizeClass = isMobile ? 'px-2 py-1 text-xs' : 'px-3 py-1 text-sm';
            
            pageBtn.className = `${sizeClass} font-medium rounded ${
                isActive 
                    ? 'bg-blue-600 text-white' 
                    : 'text-gray-500 hover:bg-gray-100'
            }`;
            pageBtn.textContent = pageNum;
            pageBtn.onclick = () => {
                const state = instructorPaginationStates[containerId];
                if (state) {
                    renderInstructorStudents(containerId, state.paginationId, state.students, pageNum);
                }
            };
            container.appendChild(pageBtn);
        }

        function changeInstructorPage(containerId, paginationId, studentsData, direction) {
            const state = instructorPaginationStates[containerId];
            if (!state) return;
            
            const newPage = state.currentPage + direction;
            
            if (newPage >= 1 && newPage <= state.totalPages) {
                renderInstructorStudents(containerId, paginationId, state.students, newPage);
            }
        }

        // Safe event handling helper
        function safeGetClassName(element) {
            if (!element) return '';
            if (typeof element.className === 'string') return element.className;
            if (element.className && typeof element.className.toString === 'function') {
                return element.className.toString();
            }
            return '';
        }



        function renderOverallView() {
            renderClassRanking();
            renderStudentTable();
            renderRecentActivity();
            updateOverallStatistics();
        }

        function renderClassRanking() {
            const ranking = [...studentsData]
                .sort((a, b) => b.totalHafalan - a.totalHafalan)
                .slice(0, 10);
            
            const rankingContainer = document.getElementById('classRanking');
            rankingContainer.innerHTML = '';
            
            ranking.forEach((student, index) => {
                const ayatProgress = (student.totalHafalan / QURAN_STRUCTURE.totalAyat * 100);
                const medal = index < 3 ? ['ü•á', 'ü•à', 'ü•â'][index] : `#${index + 1}`;
                
                const rankItem = document.createElement('div');
                rankItem.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg';
                rankItem.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="text-2xl">${medal}</div>
                        <div>
                            <div class="font-semibold text-gray-800">${student.name}</div>
                            <div class="text-sm text-gray-600">${student.totalHafalan} ayat ‚Ä¢ ${student.surahsCompleted} Surat Hafal</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-blue-600">${ayatProgress.toFixed(1)}%</div>
                        <div class="text-xs text-gray-500">Surat ${student.currentSurah}</div>
                    </div>
                `;
                rankingContainer.appendChild(rankItem);
            });
        }

        function renderRecentActivity() {
            const activities = studentsData
                .sort((a, b) => {
                    const dateA = new Date(a.lastUpdate);
                    const dateB = new Date(b.lastUpdate);
                    
                    if (isNaN(dateA.getTime()) && isNaN(dateB.getTime())) return 0;
                    if (isNaN(dateA.getTime())) return 1;
                    if (isNaN(dateB.getTime())) return -1;
                    
                    return dateB - dateA;
                });
            
            const activityContainer = document.getElementById('recentActivity');
            activityContainer.innerHTML = '';
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'flex items-center justify-between mb-3 pb-2 border-b border-gray-200';
            headerDiv.innerHTML = `
                <span class="text-sm font-medium text-gray-600">Menampilkan ${activities.length} siswa</span>
                <span class="text-xs text-gray-500">Diurutkan berdasarkan update terbaru</span>
            `;
            activityContainer.appendChild(headerDiv);
            
            activities.forEach((student, index) => {
                let dateText = 'Tidak ada data';
                let timeAgo = '';
                
                if (student.lastUpdate) {
                    try {
                        const updateDate = new Date(student.lastUpdate);
                        if (!isNaN(updateDate.getTime())) {
                            dateText = updateDate.toLocaleDateString('id-ID', {
                                weekday: 'short',
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            
                            const now = new Date();
                            const diffMs = now - updateDate;
                            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                            
                            if (diffDays === 0) {
                                if (diffHours === 0) {
                                    timeAgo = 'Baru saja';
                                } else {
                                    timeAgo = `${diffHours} jam lalu`;
                                }
                            } else if (diffDays === 1) {
                                timeAgo = 'Kemarin';
                            } else if (diffDays < 7) {
                                timeAgo = `${diffDays} hari lalu`;
                            } else {
                                timeAgo = `${Math.floor(diffDays / 7)} minggu lalu`;
                            }
                        } else {
                            dateText = student.lastUpdate;
                        }
                    } catch (e) {
                        dateText = student.lastUpdate;
                    }
                }
                
                let rankingBadge = '';
                if (index < 3) {
                    const badges = ['ü•á', 'ü•à', 'ü•â'];
                    rankingBadge = `<span class="text-lg mr-1">${badges[index]}</span>`;
                }
                
                const activityItem = document.createElement('div');
                activityItem.className = `flex items-center space-x-3 p-3 rounded-lg transition-colors hover:bg-gray-100 ${index < 3 ? 'bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200' : 'bg-gray-50'}`;
                activityItem.innerHTML = `
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                        <span class="text-sm">üìñ</span>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center">
                            ${rankingBadge}
                            <span class="text-sm font-medium text-gray-800">${student.name}</span>
                            <span class="ml-2 text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">${student.instructor}</span>
                        </div>
                        <div class="text-xs text-gray-600 mt-1">
                            Update hafalan ${student.currentSurah} ayat ke-${student.currentAyat} ‚Ä¢ Total ${student.totalHafalan} ayat ‚Ä¢ ${formatStatusText(student.status)}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-500">${dateText}</div>
                        ${timeAgo ? `<div class="text-xs text-blue-600 font-medium">${timeAgo}</div>` : ''}
                    </div>
                `;
                activityContainer.appendChild(activityItem);
            });
        }

        function renderStudentTable(filteredData = null) {
            if (filteredData) {
                currentFilteredData = filteredData;
                tableCurrentPage = 1;
            } else if (currentFilteredData.length === 0) {
                currentFilteredData = studentsData;
            }
            
            const tableBody = document.getElementById('studentTableBody');
            const rowsPerPageSelect = document.getElementById('rowsPerPage');
            tableItemsPerPage = rowsPerPageSelect.value === 'all' ? currentFilteredData.length : parseInt(rowsPerPageSelect.value);
            
            tableBody.innerHTML = '';
            
            const startIndex = (tableCurrentPage - 1) * tableItemsPerPage;
            const endIndex = startIndex + tableItemsPerPage;
            const paginatedData = tableItemsPerPage === currentFilteredData.length ? 
                currentFilteredData : 
                currentFilteredData.slice(startIndex, endIndex);
            
            paginatedData.forEach((student, index) => {
                const ayatProgress = (student.totalHafalan / QURAN_STRUCTURE.totalAyat * 100);
                const progressColor = getProgressColor(ayatProgress);
                const statusEmoji = getStudentEmoji(ayatProgress);
                const statusText = getStatusText(ayatProgress);
                
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50 transition-colors';
                
                row.innerHTML = `
                    <td class="p-3 text-gray-600">${startIndex + index + 1}</td>
                    <td class="p-3">
                        <div class="font-medium text-gray-800">${student.name}</div>
                    </td>
                    <td class="p-3">
                        <div class="text-sm text-blue-600 font-medium">${student.instructor}</div>
                    </td>
                    <td class="p-3">
                        <div class="text-sm text-gray-700">${student.currentSurah}</div>
                    </td>
                    <td class="p-3 text-center">
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">
                            ${student.currentAyat}
                        </span>
                    </td>
                    <td class="p-3 text-center">
                        <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs font-medium">
                            ${ayatProgress.toFixed(1)}%
                        </span>
                    </td>
                    <td class="p-3 text-center">
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-bold">
                            ${student.totalHafalan}
                        </span>
                    </td>
                    <td class="p-3 text-center">
                        <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs font-medium">
                            ${student.surahsCompleted}
                        </span>
                    </td>
                    <td class="p-3 text-center">
                        <div class="flex items-center justify-center space-x-2">
                            <div class="w-16 bg-gray-200 rounded-full h-2">
                                <div class="${progressColor.replace('text-', 'bg-')} h-2 rounded-full transition-all duration-300" style="width: ${ayatProgress}%"></div>
                            </div>
                            <span class="text-xs font-medium ${progressColor}">${ayatProgress.toFixed(1)}%</span>
                        </div>
                    </td>
                    <td class="p-3 text-center">
                        <div class="flex items-center justify-center space-x-1">
                            <span class="text-lg">${statusEmoji}</span>
                            <span class="text-xs ${progressColor} font-medium">${statusText}</span>
                        </div>
                    </td>
                    <td class="p-3">
                        <div class="text-xs text-gray-600">${formatDate(student.lastUpdate)}</div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            updateTablePagination();
        }

        function updateTablePagination() {
            const totalItems = currentFilteredData.length;
            const totalPages = tableItemsPerPage === totalItems ? 1 : Math.ceil(totalItems / tableItemsPerPage);
            const startItem = tableItemsPerPage === totalItems ? 1 : (tableCurrentPage - 1) * tableItemsPerPage + 1;
            const endItem = tableItemsPerPage === totalItems ? totalItems : Math.min(tableCurrentPage * tableItemsPerPage, totalItems);
            
            const pageInfoText = `Menampilkan ${startItem}-${endItem} dari ${totalItems} siswa`;
            
            // Update desktop info
            const tableInfoDesktop = document.getElementById('tableInfo');
            if (tableInfoDesktop) {
                tableInfoDesktop.textContent = pageInfoText;
            }
            
            // Update mobile info
            const tableInfoMobile = document.getElementById('tableInfoMobile');
            if (tableInfoMobile) {
                tableInfoMobile.textContent = pageInfoText;
            }
            
            // Update desktop buttons
            const prevBtn = document.getElementById('tablePrevBtn');
            const nextBtn = document.getElementById('tableNextBtn');
            if (prevBtn) {
                prevBtn.disabled = tableCurrentPage === 1 || totalPages === 1;
            }
            if (nextBtn) {
                nextBtn.disabled = tableCurrentPage === totalPages || totalPages === 1;
            }
            
            // Update mobile buttons
            const prevBtnMobile = document.getElementById('tablePrevBtnMobile');
            const nextBtnMobile = document.getElementById('tableNextBtnMobile');
            if (prevBtnMobile) {
                prevBtnMobile.disabled = tableCurrentPage === 1 || totalPages === 1;
            }
            if (nextBtnMobile) {
                nextBtnMobile.disabled = tableCurrentPage === totalPages || totalPages === 1;
            }
            
            // Update desktop page numbers
            const pageNumbersContainer = document.getElementById('tablePageNumbers');
            if (pageNumbersContainer) {
                updatePageNumbers(pageNumbersContainer, totalPages, tableCurrentPage, 'table');
            }
            
            // Update mobile page numbers
            const pageNumbersContainerMobile = document.getElementById('tablePageNumbersMobile');
            if (pageNumbersContainerMobile) {
                updatePageNumbers(pageNumbersContainerMobile, totalPages, tableCurrentPage, 'table', true);
            }
        }

        function updateOverallStatistics() {
            // This function can be used to update any overall statistics if needed
        }

        function handleTableSort() {
            const sortType = document.getElementById('tableSort').value;
            let sorted = [...studentsData];
            
            switch(sortType) {
                case 'name':
                    sorted.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'progress':
                    sorted.sort((a, b) => b.totalHafalan - a.totalHafalan);
                    break;
                case 'ayat':
                    sorted.sort((a, b) => b.totalHafalan - a.totalHafalan);
                    break;
                case 'instructor':
                    sorted.sort((a, b) => a.instructor.localeCompare(b.instructor));
                    break;
            }
            
            renderStudentTable(sorted);
        }

        function handleTableSearch() {
            const query = document.getElementById('tableSearch').value.toLowerCase();
            const filtered = studentsData.filter(student => 
                student.name.toLowerCase().includes(query) ||
                student.instructor.toLowerCase().includes(query) ||
                student.currentSurah.toLowerCase().includes(query)
            );
            
            renderStudentTable(filtered);
        }

        function downloadTableData() {
            const downloadBtn = document.getElementById('downloadBtn');
            const originalText = downloadBtn.innerHTML;
            
            // Show processing state
            downloadBtn.innerHTML = '<span>‚è≥</span><span>Memproses...</span>';
            downloadBtn.disabled = true;
            
            try {
                const dataToDownload = studentsData;
                console.log(`Memproses ${dataToDownload.length} data siswa untuk download...`);
                
                // Simple CSV format - no complex escaping
                let csvContent = 'No,Nama Siswa,Pengampu,Surat Terakhir,Ayat Terakhir,Persentase Hafalan,Total Hafalan,Surat Selesai,Status,Update Terakhir\n';
                
                dataToDownload.forEach((student, index) => {
                    const ayatProgress = student.totalHafalan ? 
                        (student.totalHafalan / QURAN_STRUCTURE.totalAyat * 100) : 0;
                    const statusText = getStatusText(ayatProgress);
                    
                    // Simple comma-separated values (remove commas from data)
                    const cleanText = (str) => String(str || '').replace(/,/g, ' ');
                    
                    const row = [
                        index + 1,
                        cleanText(student.name),
                        cleanText(student.instructor),
                        cleanText(student.currentSurah),
                        student.currentAyat || 0,
                        ayatProgress.toFixed(1) + '%',
                        student.totalHafalan || 0,
                        student.surahsCompleted || 0,
                        cleanText(statusText),
                        cleanText(formatDate(student.lastUpdate))
                    ];
                    
                    csvContent += row.join(',') + '\n';
                });
                
                // Create filename
                const now = new Date();
                const dateStr = now.getFullYear() + '-' + 
                              String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                              String(now.getDate()).padStart(2, '0');
                const filename = `laporan-hafalan-siswa-${dateStr}.csv`;
                
                // Simple download method
                const element = document.createElement('a');
                element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));
                element.setAttribute('download', filename);
                element.style.display = 'none';
                
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
                
                // Success feedback
                downloadBtn.innerHTML = '<span>‚úÖ</span><span>Berhasil!</span>';
                showNotification(`File ${filename} berhasil didownload! (${dataToDownload.length} siswa)`, 'success');
                console.log(`Download berhasil: ${filename} dengan ${dataToDownload.length} data`);
                
            } catch (error) {
                console.error('Download error:', error);
                downloadBtn.innerHTML = '<span>‚ùå</span><span>Gagal</span>';
                showNotification('Gagal mendownload file. Coba lagi.', 'error');
            }
            
            // Reset button after 2 seconds
            setTimeout(() => {
                downloadBtn.innerHTML = originalText;
                downloadBtn.disabled = false;
            }, 2000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97af0fd2d1d65f54',t:'MTc1NzE3MzE5NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
