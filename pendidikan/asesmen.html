<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduAssess - Platform Asesmen Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .nav-active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .floating-timer {
            position: fixed;
            top: 80px;
            right: 8px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            transform: translateX(0);
        }
        @media (max-width: 480px) {
            .floating-timer {
                right: 4px;
                transform: scale(0.9);
            }
        }
        .floating-timer:hover {
            transform: scale(1.05);
        }
        .timer-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Header -->
    <header id="mainHeader" class="gradient-bg text-white p-4 fixed top-0 w-full z-50 shadow-lg hidden">
        <div class="flex justify-between items-center max-w-md mx-auto">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center">
                    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhaFuNZl9lzmjUMmeAmjpXJMZxPptqYTYs3GGvoGIMHRuxTnex7vKPxNK4w9Zn0YaTtYxFallE-ffgAUGuuG3M-qJPVN_VgUwsP7ChiBnjNTo6cz-K8CAc8EH92Orop9RwiTMAV1y4Pf_rgs4iJddUf4LDH5r9yeM2pqVx6V0fZsUmZSft5DnX8P8xhc7eE/s16000/logo_hasyim_edit-removebg-preview.png" 
                         alt="Logo" 
                         class="w-6 h-6 object-contain"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <i class="fas fa-graduation-cap text-lg" style="display: none;"></i>
                </div>
                <h1 class="text-xl font-bold">EduAssess</h1>
            </div>
            <div id="userInfo" class="hidden flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full overflow-hidden border border-white flex items-center justify-center bg-white bg-opacity-20">
                    <img id="headerPhoto" src="" alt="Foto" 
                         class="w-full h-full object-cover hidden"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <i class="fas fa-user text-sm text-white"></i>
                </div>
                <span id="userName" class="text-sm"></span>
                <button onclick="logout()" class="ml-2 text-sm bg-white bg-opacity-20 px-2 py-1 rounded">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Floating Timer (only visible during assessment) -->
    <div id="floatingTimer" class="floating-timer bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg p-2 shadow-2xl border border-white hidden">
        <div class="flex items-center space-x-1 mb-1">
            <i class="fas fa-clock text-xs"></i>
            <span class="text-xs font-bold">Waktu</span>
        </div>
        <div id="floatingTimerText" class="text-lg font-bold font-mono text-center leading-tight">
            00:00
        </div>
        <div class="text-xs opacity-90 text-center">
            Tersisa
        </div>
    </div>

    <!-- Main Content -->
    <main id="mainContent" class="pb-20 px-4 max-w-md mx-auto">
        <!-- Login Screen -->
        <div id="loginScreen" class="fade-in">
            <div class="bg-white rounded-2xl card-shadow p-8 mt-8">
                <div class="text-center mb-8">
                    <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg border-4 border-blue-100">
                        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhaFuNZl9lzmjUMmeAmjpXJMZxPptqYTYs3GGvoGIMHRuxTnex7vKPxNK4w9Zn0YaTtYxFallE-ffgAUGuuG3M-qJPVN_VgUwsP7ChiBnjNTo6cz-K8CAc8EH92Orop9RwiTMAV1y4Pf_rgs4iJddUf4LDH5r9yeM2pqVx6V0fZsUmZSft5DnX8P8xhc7eE/s16000/logo_hasyim_edit-removebg-preview.png" 
                             alt="Logo Sekolah" 
                             class="w-16 h-16 object-contain"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="w-16 h-16 gradient-bg rounded-full flex items-center justify-center" style="display: none;">
                            <i class="fas fa-user-graduate text-2xl text-white"></i>
                        </div>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Selamat Datang</h2>
                    <p class="text-gray-600">Masuk untuk mengakses asesmen</p>
                </div>
                
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Username</label>
                        <input type="text" id="username" required 
                               placeholder="Masukkan username sesuai Google Sheet"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                        <input type="password" id="password" required 
                               placeholder="Masukkan password sesuai Google Sheet"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <button type="submit" id="loginBtn" 
                            class="w-full gradient-bg text-white py-3 rounded-xl font-medium hover:opacity-90 transition-opacity">
                        <span id="loginText">Masuk</span>
                        <i id="loginSpinner" class="fas fa-spinner loading hidden ml-2"></i>
                    </button>
                    

                </form>
                
                <div id="loginError" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm"></div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden">
            <!-- Welcome Card -->
            <div class="bg-white rounded-2xl card-shadow p-6 mb-6 fade-in">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 rounded-full overflow-hidden border-2 border-blue-200 flex items-center justify-center bg-gray-100">
                        <img id="welcomePhoto" src="" alt="Foto Profil" 
                             class="w-full h-full object-cover hidden"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="w-full h-full gradient-bg rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-2xl text-white"></i>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-800" id="welcomeName">Selamat datang!</h3>
                        <p class="text-gray-600 text-sm" id="userClass">Kelas: -</p>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white rounded-xl card-shadow p-4 text-center">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-clipboard-list text-blue-600"></i>
                    </div>
                    <p class="text-2xl font-bold text-gray-800" id="totalAssessments">0</p>
                    <p class="text-gray-600 text-sm">Asesmen Aktif</p>
                </div>
                <div class="bg-white rounded-xl card-shadow p-4 text-center">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-check-circle text-green-600"></i>
                    </div>
                    <p class="text-2xl font-bold text-gray-800" id="completedAssessments">0</p>
                    <p class="text-gray-600 text-sm">Selesai</p>
                </div>
            </div>
        </div>

        <!-- Assessments List -->
        <div id="assessmentsList" class="hidden">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-800">Daftar Asesmen</h2>
                <button onclick="refreshAssessments()" class="text-blue-600 hover:text-blue-800">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div id="assessmentsContainer"></div>
        </div>

        <!-- Assessment Detail -->
        <div id="assessmentDetail" class="hidden">
            <button onclick="showAssessments()" class="mb-4 text-blue-600 hover:text-blue-800">
                <i class="fas fa-arrow-left mr-2"></i>Kembali
            </button>
            <div id="assessmentInfo" class="bg-white rounded-2xl card-shadow p-6 mb-6"></div>
            <div id="questionsContainer"></div>
            <button id="submitAssessment" onclick="submitAssessment(false)" 
                    class="w-full gradient-bg text-white py-3 rounded-xl font-medium mt-6 hidden hover:opacity-90 transition-opacity">
                <i class="fas fa-paper-plane mr-2"></i>Kirim Jawaban
            </button>
        </div>

        <!-- Results -->
        <div id="resultsScreen" class="hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-6">Hasil Asesmen</h2>
            <div id="resultsContainer"></div>
        </div>

        <!-- Profile -->
        <div id="profileScreen" class="hidden">
            <div class="bg-white rounded-2xl card-shadow p-6">
                <div class="text-center mb-6">
                    <div class="w-24 h-24 rounded-full overflow-hidden border-4 border-blue-200 flex items-center justify-center mx-auto mb-4 bg-gray-100">
                        <img id="profilePhoto" src="" alt="Foto Profil" 
                             class="w-full h-full object-cover hidden"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="w-full h-full gradient-bg rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-4xl text-white"></i>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800" id="profileName">Nama Siswa</h3>
                    <p class="text-gray-600" id="profileClass">Kelas</p>
                    <p class="text-gray-500 text-sm" id="profileClassNumber">Kelas: -</p>
                </div>
                
                <div class="space-y-4">
                    <div class="flex justify-between items-center py-3 border-b border-gray-200">
                        <span class="text-gray-700">Total Asesmen</span>
                        <span class="font-medium" id="profileTotalAssessments">0</span>
                    </div>
                    <div class="flex justify-between items-center py-3 border-b border-gray-200">
                        <span class="text-gray-700">Asesmen Selesai</span>
                        <span class="font-medium" id="profileCompletedAssessments">0</span>
                    </div>
                    <div class="flex justify-between items-center py-3">
                        <span class="text-gray-700">Rata-rata Nilai</span>
                        <span class="font-medium" id="profileAverageScore">0</span>
                    </div>
                </div>
                
                <button onclick="logout()" 
                        class="w-full mt-6 bg-red-500 text-white py-3 rounded-xl font-medium hover:bg-red-600 transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>Keluar
                </button>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav id="bottomNav" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 hidden">
        <div class="flex justify-around py-2 max-w-md mx-auto">
            <button onclick="showDashboard()" class="nav-item flex flex-col items-center py-2 px-4 rounded-lg nav-active">
                <i class="fas fa-home text-xl mb-1"></i>
                <span class="text-xs">Beranda</span>
            </button>
            <button onclick="showAssessments()" class="nav-item flex flex-col items-center py-2 px-4 rounded-lg">
                <i class="fas fa-clipboard-list text-xl mb-1"></i>
                <span class="text-xs">Asesmen</span>
            </button>
            <button onclick="showResults()" class="nav-item flex flex-col items-center py-2 px-4 rounded-lg">
                <i class="fas fa-chart-bar text-xl mb-1"></i>
                <span class="text-xs">Hasil</span>
            </button>
            <button onclick="showProfile()" class="nav-item flex flex-col items-center py-2 px-4 rounded-lg">
                <i class="fas fa-user text-xl mb-1"></i>
                <span class="text-xs">Profil</span>
            </button>
        </div>
    </nav>

    <script>
        // Configuration
        const SHEET_ID = '17MDc804lNUm_XwUM6hPj6Ui8T-JVtpxJCLq4XovVs0A';
        const API_KEY = 'AIzaSyCAJWvsjw92iebZM54KZivepTpl_Q2gk70';
        const BASE_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values`;

        // Global variables
        let currentUser = null;
        let assessments = [];
        let currentAssessment = null;
        let userAnswers = {};
        let assessmentTimer = null;
        let timeRemaining = 0;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
        });

        // Check if user is already logged in
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showDashboard();
                loadUserData();
            }
        }

        // Handle login
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            const loginText = document.getElementById('loginText');
            const loginSpinner = document.getElementById('loginSpinner');
            const loginError = document.getElementById('loginError');

            // Show loading state
            loginBtn.disabled = true;
            loginText.textContent = 'Memverifikasi...';
            loginSpinner.classList.remove('hidden');
            loginError.classList.add('hidden');

            try {
                // Fetch login data from Google Sheets
                const response = await fetch(`${BASE_URL}/Login!A:Z?key=${API_KEY}`);
                
                if (!response.ok) {
                    throw new Error('Tidak dapat terhubung ke server. Periksa koneksi internet Anda.');
                }
                
                const data = await response.json();
                
                if (!data.values || data.values.length < 2) {
                    throw new Error('Data login tidak ditemukan di Google Sheet');
                }
                
                // Skip header row and process login data
                const users = data.values.slice(1);
                console.log('Total users found:', users.length);
                console.log('First 5 users:', users.slice(0, 5).map(row => ({ 
                    username: row[0], 
                    password: row[1] ? '***' : 'EMPTY',
                    name: row[2] || 'No name'
                })));
                
                // Find matching user with detailed logging
                let foundUser = null;
                for (let i = 0; i < users.length; i++) {
                    const row = users[i];
                    if (!row[0] || !row[1]) continue; // Skip rows without username or password
                    
                    const sheetUsername = row[0].toString().trim();
                    const sheetPassword = row[1].toString().trim();
                    
                    // Try exact match first
                    if (sheetUsername === username && sheetPassword === password) {
                        foundUser = row;
                        console.log('Exact match found:', { username: sheetUsername, row: i + 2 });
                        break;
                    }
                    
                    // Try case-insensitive match
                    if (sheetUsername.toLowerCase() === username.toLowerCase() && sheetPassword === password) {
                        foundUser = row;
                        console.log('Case-insensitive match found:', { username: sheetUsername, row: i + 2 });
                        break;
                    }
                }
                
                if (foundUser) {
                    // Get user details from the sheet
                    const userDetails = {
                        username: foundUser[0],
                        password: foundUser[1],
                        name: foundUser[2] || foundUser[0], // Use column C for name, fallback to username
                        email: foundUser[3] || '', // Column D for email if exists
                        class: foundUser[4] || 'Tidak diketahui', // Column E for class
                        studentId: foundUser[5] || '', // Column F for student ID if exists
                        photoUrl: foundUser[6] || 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEigLX3uVV_Ekk_xsNDlI_VVi65dp7YCOLoQl7w6C5CRnN_-gnWKpDdp1AcryOhNzWARyc0-uNd4JgmRNMpUhrzurL5LOn7NyFZ8gSCdkJE88iIkCHmyeVVcE2LXB8R2bUQHiR7M9c9jPfn-XHRcEW-o3vMmJhf6cYjpdyFe85IsXXcFBo84tLk9Pw3-oBLF/s200-c/photo_.431_w.jpg' // Column G for link foto
                    };
                    
                    currentUser = userDetails;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // Show success message briefly
                    loginText.textContent = 'Login berhasil!';
                    setTimeout(() => {
                        showDashboard();
                        loadUserData();
                    }, 500);
                    
                } else {
                    // Debug information
                    const sampleUsers = users.slice(0, 5).map(row => `${row[0]}:${row[1] ? 'ada' : 'kosong'}`);
                    console.log('Login failed. Sample data:', sampleUsers);
                    
                    throw new Error(`Login gagal! Username "${username}" tidak ditemukan atau password salah.\n\nPastikan:\n• Username dan password sesuai dengan data di Google Sheet\n• Tidak ada spasi tambahan\n• Huruf besar/kecil sesuai`);
                }
                
            } catch (error) {
                console.error('Login error:', error);
                loginError.innerHTML = `<div class="text-red-700">${error.message.replace(/\n/g, '<br>')}</div>`;
                loginError.classList.remove('hidden');
            } finally {
                // Reset loading state
                loginBtn.disabled = false;
                loginText.textContent = 'Masuk';
                loginSpinner.classList.add('hidden');
            }
        }

        // Get user class (now directly from Login sheet column E)
        // This function is no longer needed as class is read from Login sheet

        // Load user data and assessments
        async function loadUserData() {
            if (!currentUser) return;

            // Show header and update user info
            document.getElementById('mainHeader').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('pt-20');
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userInfo').classList.remove('hidden');

            // Update welcome message
            document.getElementById('welcomeName').textContent = `Selamat datang, ${currentUser.name}!`;
            document.getElementById('userClass').textContent = `Kelas: ${currentUser.class}`;

            // Update user photos
            updateUserPhotos();

            // Load assessments
            await loadAssessments();
            
            // Load user results
            await loadUserResults();
        }

        // Load assessments
        async function loadAssessments() {
            try {
                console.log('Loading assessments from sheet: asesmen aktif');
                const response = await fetch(`${BASE_URL}/asesmen%20aktif!A:J?key=${API_KEY}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status} - ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Raw assessment data:', data);
                
                if (data.values && data.values.length > 1) {
                    // Skip header row and map data according to new column structure
                    // A: Judul asesmen, B: Deskripsi, C: Durasi, D: Icon emoji, E: Warna tema, 
                    // F: kategori, G: target kelas, H: tingkat, I: durasi menit, J: jumlah soal
                    assessments = data.values.slice(1).map((row, index) => ({
                        id: `asesmen_${index + 1}`, // Generate ID since no ID column
                        title: row[0] || 'Asesmen Tanpa Judul',
                        description: row[1] || 'Tidak ada deskripsi',
                        duration: row[2] || 'Tidak ditentukan',
                        icon: row[3] || '📝',
                        themeColor: row[4] || '#667eea',
                        category: row[5] || 'Umum',
                        targetClass: row[6] || 'Semua Kelas',
                        level: row[7] || 'Semua Kelas',
                        timeLimit: row[8] || '60',
                        questionCount: row[9] || '10',
                        status: 'aktif' // All assessments in this sheet are active
                    }));
                    
                    console.log('Processed assessments:', assessments);
                    
                    updateDashboardStats();
                    renderAssessmentsList();
                } else {
                    console.log('No assessment data found');
                    assessments = [];
                    updateDashboardStats();
                    renderAssessmentsList();
                }
            } catch (error) {
                console.error('Error loading assessments:', error);
                // Show error message to user
                const container = document.getElementById('assessmentsContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
                            <p class="text-red-600 mb-2">Gagal memuat asesmen</p>
                            <p class="text-gray-600 text-sm">${error.message}</p>
                            <button onclick="loadAssessments()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                Coba Lagi
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            // Filter assessments by user's class (same logic as in renderAssessmentsList)
            const activeAssessments = assessments.filter(a => {
                if (a.status !== 'aktif') return false;
                
                // Check if assessment is for user's class
                const assessmentTargetClass = (a.targetClass || '').toString().toLowerCase();
                const userClass = (currentUser.class || '').toString().toLowerCase();
                
                // Show if:
                // 1. Assessment target class matches user class exactly
                // 2. Assessment is for "Semua Kelas" or "All"
                // 3. Assessment level matches user class (fallback)
                const classMatch = assessmentTargetClass.includes('semua') ||
                                 assessmentTargetClass.includes('all') ||
                                 assessmentTargetClass === userClass ||
                                 (a.level || '').toString().toLowerCase() === userClass;
                
                return classMatch;
            });
            
            // Show actual count from Google Sheet data
            const totalCount = activeAssessments.length;
            document.getElementById('totalAssessments').textContent = totalCount;
            
            console.log(`Dashboard Stats - Total assessments for ${currentUser.class}: ${totalCount}`);
            console.log('Available assessments:', activeAssessments.map(a => a.title));
            
            // Update completed assessments count
            const results = JSON.parse(localStorage.getItem('assessmentResults') || '[]');
            const userResults = results.filter(r => r.username === currentUser.username);
            document.getElementById('completedAssessments').textContent = userResults.length;
        }

        // Render assessments list
        function renderAssessmentsList() {
            const container = document.getElementById('assessmentsContainer');
            container.innerHTML = '';

            // Filter assessments by user's class
            const activeAssessments = assessments.filter(a => {
                if (a.status !== 'aktif') return false;
                
                // Check if assessment is for user's class
                const assessmentTargetClass = (a.targetClass || '').toString().toLowerCase();
                const userClass = (currentUser.class || '').toString().toLowerCase();
                
                // Show if:
                // 1. Assessment target class matches user class exactly
                // 2. Assessment is for "Semua Kelas" or "All"
                // 3. Assessment level matches user class (fallback)
                const classMatch = assessmentTargetClass.includes('semua') ||
                                 assessmentTargetClass.includes('all') ||
                                 assessmentTargetClass === userClass ||
                                 (a.level || '').toString().toLowerCase() === userClass;
                
                return classMatch;
            });
            
            console.log(`Filtered ${activeAssessments.length} assessments for class ${currentUser.class}`);
            console.log('Available assessments:', activeAssessments.map(a => ({
                title: a.title,
                targetClass: a.targetClass,
                level: a.level
            })));
            
            if (activeAssessments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-clipboard-list text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600">Tidak ada asesmen aktif untuk kelas ${currentUser.class}</p>
                        <p class="text-gray-500 text-sm mt-2">Asesmen akan muncul sesuai dengan kelas Anda</p>
                    </div>
                `;
                return;
            }

            activeAssessments.forEach(assessment => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl card-shadow p-4 mb-4 cursor-pointer hover:shadow-lg transition-shadow';
                card.onclick = () => openAssessment(assessment);
                
                // Use theme color if provided, otherwise use default gradient
                const cardStyle = assessment.themeColor && assessment.themeColor !== '#667eea' 
                    ? `border-l-4 border-l-[${assessment.themeColor}]` 
                    : 'border-l-4 border-l-blue-500';
                
                card.className += ` ${cardStyle}`;
                
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center space-x-2 flex-1">
                            <span class="text-2xl">${assessment.icon}</span>
                            <h3 class="font-bold text-gray-800">${assessment.title}</h3>
                        </div>
                        <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full ml-2">Aktif</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-3">${assessment.description}</p>
                    <div class="grid grid-cols-2 gap-2 text-xs text-gray-500 mb-2">
                        <span><i class="fas fa-tag mr-1"></i>${assessment.category}</span>
                        <span><i class="fas fa-graduation-cap mr-1"></i>${assessment.targetClass}</span>
                        <span><i class="fas fa-clock mr-1"></i>${assessment.timeLimit} menit</span>
                        <span><i class="fas fa-list mr-1"></i>${assessment.questionCount} soal</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs px-2 py-1 bg-gray-100 rounded-full">Kelas ${assessment.level}</span>
                        <span class="text-xs text-gray-400">${assessment.duration}</span>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Open assessment
        async function openAssessment(assessment) {
            currentAssessment = assessment;
            userAnswers = {};
            
            // Load questions for this assessment
            await loadQuestions(assessment.id);
            
            // Show assessment detail
            showAssessmentDetail();
        }

        // Load questions
        async function loadQuestions(assessmentId) {
            try {
                console.log('Loading questions from sheet: soal asesmen');
                const response = await fetch(`${BASE_URL}/soal%20asesmen!A:K?key=${API_KEY}`);
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    console.log('Raw questions data:', data);
                    
                    // Skip header row and map data according to new column structure
                    // A: Soal, B: Jenis, C: Pilihan A/Jawaban, D: Pilihan B, E: Pilihan C, 
                    // F: Pilihan D, G: Pilihan E, H: Kunci Jawaban, I: Kategori, J: Target Kelas, K: Tingkat
                    const allQuestions = data.values.slice(1);
                    
                    // Filter questions based on assessment criteria
                    const filteredQuestions = allQuestions.filter(row => {
                        const questionCategory = (row[8] || '').toString().trim();
                        const questionTargetClass = (row[9] || '').toString().trim();
                        const questionLevel = (row[10] || '').toString().trim();
                        
                        // Check category match (case-insensitive)
                        const categoryMatch = !questionCategory || 
                                            questionCategory.toLowerCase() === currentAssessment.category.toLowerCase() ||
                                            questionCategory.toLowerCase() === 'umum' ||
                                            currentAssessment.category.toLowerCase() === 'umum';
                        
                        // Check target class match (case-insensitive)
                        const classMatch = !questionTargetClass || 
                                         questionTargetClass.toLowerCase() === currentAssessment.targetClass.toLowerCase() ||
                                         questionTargetClass.toLowerCase().includes('semua') ||
                                         currentAssessment.targetClass.toLowerCase().includes('semua') ||
                                         questionTargetClass.toLowerCase() === currentUser.class.toLowerCase();
                        
                        // Check level match (case-insensitive)
                        const levelMatch = !questionLevel || 
                                         questionLevel.toLowerCase() === currentAssessment.level.toLowerCase() ||
                                         questionLevel.toLowerCase().includes('semua') ||
                                         currentAssessment.level.toLowerCase().includes('semua');
                        
                        return categoryMatch && classMatch && levelMatch;
                    });
                    
                    console.log(`Filtered ${filteredQuestions.length} questions from ${allQuestions.length} total questions`);
                    console.log('Filter criteria:', {
                        assessmentCategory: currentAssessment.category,
                        assessmentTargetClass: currentAssessment.targetClass,
                        assessmentLevel: currentAssessment.level,
                        userClass: currentUser.class
                    });
                    
                    // Map filtered questions to the required format
                    currentAssessment.questions = filteredQuestions.map((row, index) => {
                        const questionType = row[1] || 'pilihan_ganda';
                        const isMultipleChoice = questionType.toLowerCase().includes('pilihan') || questionType.toLowerCase().includes('ganda');
                        
                        // Collect all non-empty options
                        const options = [];
                        if (isMultipleChoice) {
                            // For multiple choice, use columns C-G as options
                            [row[2], row[3], row[4], row[5], row[6]].forEach(option => {
                                if (option && option.trim()) {
                                    options.push(option.trim());
                                }
                            });
                        }
                        
                        return {
                            id: `question_${index + 1}`,
                            question: row[0] || 'Soal tidak tersedia',
                            type: questionType,
                            options: options,
                            correctAnswer: row[7] || '', // Column H: Kunci Jawaban
                            category: row[8] || 'Umum', // Column I: Kategori
                            targetClass: row[9] || 'Semua Kelas', // Column J: Target Kelas
                            level: row[10] || 'Menengah', // Column K: Tingkat
                            number: index + 1,
                            isMultipleChoice: isMultipleChoice
                        };
                    });
                    
                    console.log('Processed questions:', currentAssessment.questions);
                    
                    // Update question count in assessment info
                    if (currentAssessment.questions.length > 0) {
                        currentAssessment.questionCount = currentAssessment.questions.length.toString();
                    }
                    
                    renderAssessmentDetail();
                } else {
                    console.log('No questions data found');
                    currentAssessment.questions = [];
                    renderAssessmentDetail();
                }
            } catch (error) {
                console.error('Error loading questions:', error);
                // Show error in questions container
                const questionsContainer = document.getElementById('questionsContainer');
                questionsContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
                        <p class="text-red-600 mb-2">Gagal memuat soal</p>
                        <p class="text-gray-600 text-sm">${error.message}</p>
                        <button onclick="loadQuestions('${assessmentId}')" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                            Coba Lagi
                        </button>
                    </div>
                `;
            }
        }

        // Render assessment detail
        function renderAssessmentDetail() {
            const infoContainer = document.getElementById('assessmentInfo');
            const questionsContainer = document.getElementById('questionsContainer');
            
            // Assessment info
            infoContainer.innerHTML = `
                <div class="text-center mb-6">
                    <div class="text-4xl mb-3">${currentAssessment.icon}</div>
                    <h2 class="text-xl font-bold text-gray-800 mb-2">${currentAssessment.title}</h2>
                    <p class="text-gray-600 mb-4">${currentAssessment.description}</p>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm text-gray-500 mb-4">
                        <div class="flex items-center justify-center">
                            <i class="fas fa-list mr-1"></i>
                            <span>${currentAssessment.questions?.length || currentAssessment.questionCount} soal</span>
                        </div>
                        <div class="flex items-center justify-center">
                            <i class="fas fa-clock mr-1"></i>
                            <span>${currentAssessment.timeLimit} menit</span>
                        </div>
                        <div class="flex items-center justify-center">
                            <i class="fas fa-tag mr-1"></i>
                            <span>${currentAssessment.category}</span>
                        </div>
                        <div class="flex items-center justify-center">
                            <i class="fas fa-graduation-cap mr-1"></i>
                            <span>${currentAssessment.targetClass}</span>
                        </div>
                    </div>
                    <div class="flex justify-center">
                        <span class="text-xs px-3 py-1 bg-gray-100 rounded-full">Kelas: ${currentAssessment.level}</span>
                    </div>
                </div>
            `;
            
            // Start timer and show floating timer
            startAssessmentTimer();
            
            // Questions
            questionsContainer.innerHTML = '';
            
            if (currentAssessment.questions && currentAssessment.questions.length > 0) {
                currentAssessment.questions.forEach(question => {
                    const questionCard = document.createElement('div');
                    questionCard.className = 'bg-white rounded-xl card-shadow p-6 mb-4';
                    
                    let optionsHtml = '';
                    let questionTypeLabel = '';
                    
                    // Determine question type and create appropriate input
                    if (question.isMultipleChoice && question.options.length > 0) {
                        questionTypeLabel = 'Pilihan Ganda';
                        optionsHtml = question.options.map((option, index) => {
                            const optionLabel = String.fromCharCode(65 + index); // A, B, C, D, E
                            return `
                                <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 mb-2 transition-colors">
                                    <input type="radio" name="question_${question.id}" value="${option}" 
                                           onchange="saveAnswer('${question.id}', this.value)"
                                           class="mr-3 text-blue-600">
                                    <span class="font-medium text-blue-600 mr-2">${optionLabel}.</span>
                                    <span>${option}</span>
                                </label>
                            `;
                        }).join('');
                    } else {
                        questionTypeLabel = 'Uraian';
                        optionsHtml = `
                            <textarea name="question_${question.id}" 
                                      onchange="saveAnswer('${question.id}', this.value)"
                                      oninput="saveAnswer('${question.id}', this.value)"
                                      class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                      rows="4" placeholder="Tulis jawaban Anda di sini..."></textarea>
                        `;
                    }
                    
                    questionCard.innerHTML = `
                        <div class="flex items-center justify-between mb-4">
                            <span class="bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full">
                                Soal ${question.number}
                            </span>
                            <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded-full">
                                ${questionTypeLabel}
                            </span>
                        </div>
                        <h3 class="text-lg font-medium text-gray-800 mb-4">${question.question}</h3>
                        <div class="space-y-2">
                            ${optionsHtml}
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-100 text-xs text-gray-500 flex justify-between">
                            <span><i class="fas fa-tag mr-1"></i>${question.category}</span>
                            <span><i class="fas fa-graduation-cap mr-1"></i>${question.targetClass}</span>
                        </div>
                    `;
                    
                    questionsContainer.appendChild(questionCard);
                });
                
                // Show submit button and add event listener as backup
                const submitBtn = document.getElementById('submitAssessment');
                submitBtn.classList.remove('hidden');
                
                // Add event listener as backup to onclick
                submitBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Submit button clicked via event listener');
                    submitAssessment(false);
                });
            } else {
                questionsContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-question-circle text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600">Tidak ada soal tersedia untuk asesmen ini</p>
                    </div>
                `;
            }
        }

        // Save answer
        function saveAnswer(questionId, answer) {
            userAnswers[questionId] = answer;
        }

        // Timer functions
        function startAssessmentTimer() {
            // Clear any existing timer
            if (assessmentTimer) {
                clearInterval(assessmentTimer);
            }
            
            // Set time remaining in seconds
            timeRemaining = parseInt(currentAssessment.timeLimit) * 60;
            
            // Show floating timer
            const floatingTimer = document.getElementById('floatingTimer');
            floatingTimer.classList.remove('hidden');
            
            // Update timer display immediately
            updateFloatingTimer();
            
            // Start countdown
            assessmentTimer = setInterval(() => {
                timeRemaining--;
                updateFloatingTimer();
                
                // Check if time is up
                if (timeRemaining <= 0) {
                    clearInterval(assessmentTimer);
                    handleTimeUp();
                }
            }, 1000);
        }
        
        function updateFloatingTimer() {
            const floatingTimerText = document.getElementById('floatingTimerText');
            const floatingTimer = document.getElementById('floatingTimer');
            
            if (!floatingTimerText || !floatingTimer) return;
            
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            
            // Format time as MM:SS
            const timeString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            floatingTimerText.textContent = timeString;
            
            // Change color and add effects based on remaining time
            if (timeRemaining <= 300) { // Last 5 minutes - red with pulse
                floatingTimer.className = 'floating-timer bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl p-3 shadow-2xl border-2 border-white timer-pulse';
            } else if (timeRemaining <= 600) { // Last 10 minutes - orange
                floatingTimer.className = 'floating-timer bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl p-3 shadow-2xl border-2 border-white';
            } else { // Normal - blue
                floatingTimer.className = 'floating-timer bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl p-3 shadow-2xl border-2 border-white';
            }
        }
        
        function handleTimeUp() {
            // Hide floating timer
            document.getElementById('floatingTimer').classList.add('hidden');
            
            // Show time up notification
            const notification = document.createElement('div');
            notification.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            notification.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-2xl text-center">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-clock text-2xl text-red-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Waktu Habis!</h3>
                    <p class="text-gray-600 mb-4">
                        Waktu asesmen telah berakhir. Jawaban Anda akan otomatis dikirim.
                    </p>
                    <div class="flex items-center justify-center space-x-2 text-sm text-gray-500 mb-4">
                        <i class="fas fa-info-circle"></i>
                        <span>Mengirim jawaban...</span>
                        <i class="fas fa-spinner loading"></i>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-submit after 2 seconds
            setTimeout(() => {
                notification.remove();
                submitAssessment(true); // Pass true to indicate auto-submit
            }, 2000);
        }
        
        function stopAssessmentTimer() {
            if (assessmentTimer) {
                clearInterval(assessmentTimer);
                assessmentTimer = null;
            }
            
            // Hide floating timer
            const floatingTimer = document.getElementById('floatingTimer');
            if (floatingTimer) {
                floatingTimer.classList.add('hidden');
            }
        }

        // Automatic correction function - moved to website
        function performAutomaticCorrection(questions, userAnswers) {
            let correctAnswers = 0;
            const correctionResults = [];
            
            questions.forEach(question => {
                const userAnswer = userAnswers[question.id] || 'Tidak dijawab';
                let isCorrect = false;
                let correctionNote = '';
                
                // KOREKSI PILIHAN GANDA
                if (question.isMultipleChoice) {
                    isCorrect = userAnswer.trim().toLowerCase() === question.correctAnswer.trim().toLowerCase();
                    correctionNote = isCorrect ? 'Benar' : 'Salah';
                }
                // KOREKSI ISIAN SINGKAT DAN ESSAY
                else {
                    const jawabanSiswa = userAnswer.trim().toLowerCase();
                    const kunciJawaban = question.correctAnswer.trim().toLowerCase();
                    
                    if (question.type.toLowerCase().includes('isian')) {
                        // Exact match
                        if (jawabanSiswa === kunciJawaban) {
                            isCorrect = true;
                            correctionNote = 'Benar (exact match)';
                        }
                        // Partial match (mengandung kata kunci)
                        else if (jawabanSiswa.includes(kunciJawaban) || kunciJawaban.includes(jawabanSiswa)) {
                            isCorrect = true;
                            correctionNote = 'Benar (partial match)';
                        }
                        // Similarity check untuk typo
                        else if (calculateSimilarity(jawabanSiswa, kunciJawaban) > 0.8) {
                            isCorrect = true;
                            correctionNote = 'Benar (similar)';
                        }
                        else {
                            correctionNote = 'Salah';
                        }
                    }
                    // KOREKSI ESSAY (scoring berdasarkan kata kunci)
                    else if (question.type.toLowerCase().includes('essay') || question.type.toLowerCase().includes('uraian')) {
                        const kataKunci = kunciJawaban.split(',').map(kata => kata.trim()).filter(kata => kata.length > 0);
                        
                        let keywordCount = 0;
                        kataKunci.forEach(kata => {
                            if (jawabanSiswa.includes(kata)) {
                                keywordCount++;
                            }
                        });
                        
                        const keywordPercentage = kataKunci.length > 0 ? (keywordCount / kataKunci.length) * 100 : 0;
                        
                        if (keywordPercentage >= 80) {
                            isCorrect = true;
                            correctionNote = `Sangat Baik (${keywordPercentage.toFixed(0)}% kata kunci)`;
                        } else if (keywordPercentage >= 60) {
                            isCorrect = true;
                            correctionNote = `Baik (${keywordPercentage.toFixed(0)}% kata kunci)`;
                        } else if (keywordPercentage >= 40) {
                            isCorrect = true;
                            correctionNote = `Cukup (${keywordPercentage.toFixed(0)}% kata kunci)`;
                        } else {
                            correctionNote = `Kurang (${keywordPercentage.toFixed(0)}% kata kunci)`;
                        }
                    }
                }
                
                if (isCorrect && userAnswer !== 'Tidak dijawab') {
                    correctAnswers++;
                }
                
                correctionResults.push({
                    nomor: question.number,
                    soal: question.question,
                    jenis: question.type,
                    jawaban_siswa: userAnswer,
                    kunci_jawaban: question.correctAnswer,
                    status: correctionNote,
                    benar: isCorrect
                });
            });
            
            return {
                correctAnswers,
                correctionResults
            };
        }

        // Helper function untuk menghitung similarity
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        // Submit assessment with automatic correction
        async function submitAssessment(isAutoSubmit = false) {
            console.log('Submit assessment called, isAutoSubmit:', isAutoSubmit);
            console.log('Current user answers:', userAnswers);
            console.log('Total questions:', currentAssessment?.questions?.length);
            
            if (!currentAssessment || !currentAssessment.questions) {
                alert('Terjadi kesalahan: Data asesmen tidak ditemukan.');
                return;
            }
            
            if (!isAutoSubmit && Object.keys(userAnswers).length === 0) {
                alert('Silakan jawab minimal satu soal sebelum mengirim.');
                return;
            }
            
            if (!isAutoSubmit && !confirm('Apakah Anda yakin ingin mengirim jawaban? Jawaban tidak dapat diubah setelah dikirim.')) {
                return;
            }
            
            // Show loading state
            const submitBtn = document.getElementById('submitAssessment');
            if (!submitBtn) {
                console.error('Submit button not found');
                return;
            }
            
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner loading mr-2"></i>Mengirim jawaban...';
            submitBtn.disabled = true;
            
            // Stop the timer and calculate time taken
            const timeSpent = (parseInt(currentAssessment.timeLimit) * 60) - timeRemaining;
            const timeSpentMinutes = Math.floor(timeSpent / 60);
            const timeSpentSeconds = timeSpent % 60;
            const timeSpentFormatted = `${timeSpentMinutes}:${String(timeSpentSeconds).padStart(2, '0')}`;
            
            stopAssessmentTimer();
            
            try {
                // Perform automatic correction
                const correctionResult = performAutomaticCorrection(currentAssessment.questions, userAnswers);
                const correctAnswers = correctionResult.correctAnswers;
                const totalQuestions = currentAssessment.questions.length;
                
                // Calculate score and percentage
                const score = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
                const percentage = `${score}%`;
                
                // Determine pass/fail status (75% threshold)
                const status = score >= 75 ? 'Lulus' : 'Tidak Lulus';
                
                // Calculate correct answer percentage
                const correctPercentage = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
                
                // Get current date and time in Indonesian format
                const now = new Date();
                const tanggal = now.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric'
                });
                const waktu = now.toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                // Prepare detailed answers for storage
                const detailedAnswers = correctionResult.correctionResults.map(result => ({
                    soal: result.nomor,
                    pertanyaan: result.soal,
                    jawaban_siswa: result.jawaban_siswa,
                    jawaban_benar: result.kunci_jawaban,
                    status: result.status
                }));
                
                // Send to Google Sheets using the simplified approach
                await sendResultToGoogleSheet({
                    nama: currentUser.name || currentUser.username,
                    username: currentUser.username,
                    kelas: currentUser.class || 'Tidak diketahui',
                    judulAsesmen: currentAssessment.title,
                    tanggal: tanggal,
                    waktu: waktu,
                    totalSoal: totalQuestions.toString(),
                    jawabanBenar: correctAnswers.toString(),
                    skor: score.toString(),
                    persentase: percentage,
                    status: status,
                    waktuPengerjaan: timeSpentFormatted,
                    detailJawaban: JSON.stringify(detailedAnswers),
                    percobaan: '1'
                });
                
                // Save result locally as backup
                const result = {
                    username: currentUser.username,
                    assessmentId: currentAssessment.id,
                    assessmentTitle: currentAssessment.title,
                    score: score,
                    correctAnswers: correctAnswers,
                    totalQuestions: totalQuestions,
                    status: status,
                    submittedAt: now.toISOString(),
                    timeSpent: timeSpentFormatted
                };
                
                let results = JSON.parse(localStorage.getItem('assessmentResults') || '[]');
                results.push(result);
                localStorage.setItem('assessmentResults', JSON.stringify(results));
                
                // Show success message with detailed results
                const statusIcon = status === 'Lulus' ? '🎉' : '📚';
                const statusColor = status === 'Lulus' ? 'text-green-600' : 'text-red-600';
                
                const message = isAutoSubmit 
                    ? `⏰ Waktu habis! Asesmen otomatis dikirim ke Google Sheet.\n\n📊 Hasil Anda:\n• Skor: ${score}/100 (${correctPercentage}% jawaban benar)\n• Status: ${status} ${statusIcon}\n• Jawaban benar: ${correctAnswers}/${totalQuestions}\n• Waktu pengerjaan: ${timeSpentFormatted}`
                    : `✅ Asesmen berhasil dikirim ke Google Sheet!\n\n📊 Hasil Anda:\n• Skor: ${score}/100 (${correctPercentage}% jawaban benar)\n• Status: ${status} ${statusIcon}\n• Jawaban benar: ${correctAnswers}/${totalQuestions}\n• Waktu pengerjaan: ${timeSpentFormatted}`;
                
                alert(message);
                
                // Return to assessments list
                showAssessments();
                
            } catch (error) {
                console.error('Error submitting assessment:', error);
                
                // Show detailed error message
                let errorMessage = 'Terjadi kesalahan saat mengirim jawaban:\n\n';
                if (error.message.includes('403')) {
                    errorMessage += '❌ Akses ditolak ke Google Sheet\n• Periksa pengaturan berbagi sheet\n• Pastikan sheet dapat diakses publik';
                } else if (error.message.includes('404')) {
                    errorMessage += '❌ Google Sheet tidak ditemukan\n• Periksa ID sheet di konfigurasi\n• Pastikan sheet "hasil asesmen" ada';
                } else if (error.message.includes('network')) {
                    errorMessage += '❌ Masalah koneksi internet\n• Periksa koneksi internet Anda\n• Coba lagi dalam beberapa saat';
                } else {
                    errorMessage += `❌ ${error.message}\n\n💡 Jawaban Anda telah disimpan secara lokal sebagai backup.`;
                }
                
                alert(errorMessage);
                
            } finally {
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }
        
        // Send result to Google Sheet via Google Apps Script (simplified)
        async function sendResultToGoogleSheet(resultData) {
            try {
                console.log('Sending result to Google Apps Script:', resultData);
                
                // Google Apps Script Web App URL
                const scriptUrl = 'https://script.google.com/macros/s/AKfycbzhz5RdaIgBQ64MktMBS63LtGHE0V9ieDa2VladvlwPwUQTOZ2PAsq_pXBjPANifgRh/exec';
                
                // Prepare form data for Google Apps Script
                const formData = new FormData();
                formData.append('action', 'saveAsesmenResult');
                
                // Add all result data
                Object.keys(resultData).forEach(key => {
                    formData.append(key, resultData[key]);
                });
                
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Gagal mengirim ke Google Apps Script`);
                }
                
                const responseText = await response.text();
                console.log('Google Apps Script response:', responseText);
                
                // Try to parse as JSON, fallback to text
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = { message: responseText };
                }
                
                // Check if the response indicates success
                if (responseData.success === false || responseText.toLowerCase().includes('error')) {
                    throw new Error(responseData.message || responseText || 'Gagal mengirim hasil asesmen');
                }
                
                console.log('Successfully sent to Google Apps Script:', responseData);
                return responseData;
                
            } catch (error) {
                console.error('Error sending to Google Apps Script:', error);
                
                // If it's a network error, provide more specific message
                if (!navigator.onLine) {
                    throw new Error('Tidak ada koneksi internet. Periksa koneksi Anda dan coba lagi.');
                }
                
                // Provide more user-friendly error messages
                if (error.message.includes('Failed to fetch')) {
                    throw new Error('Tidak dapat terhubung ke server. Periksa koneksi internet Anda.');
                }
                
                throw error;
            }
        }

        // Update user photos across all elements
        function updateUserPhotos() {
            if (!currentUser || !currentUser.photoUrl) {
                console.log('No user or photo URL found');
                return;
            }
            
            console.log('Updating user photos with URL:', currentUser.photoUrl);
            
            const photoElements = [
                { id: 'headerPhoto', fallback: 'fas fa-user text-sm text-white' },
                { id: 'welcomePhoto', fallback: 'fas fa-user text-2xl text-white' },
                { id: 'profilePhoto', fallback: 'fas fa-user text-4xl text-white' }
            ];
            
            photoElements.forEach(element => {
                const img = document.getElementById(element.id);
                if (img && currentUser.photoUrl.trim()) {
                    // Process Blogger URL to ensure it works
                    let processedUrl = processImageUrl(currentUser.photoUrl.trim());
                    console.log(`Setting ${element.id} photo URL:`, processedUrl);
                    
                    img.src = processedUrl;
                    img.classList.remove('hidden');
                    
                    // Hide fallback icon when image loads successfully
                    img.onload = function() {
                        console.log(`${element.id} photo loaded successfully`);
                        const fallbackIcon = this.nextElementSibling;
                        if (fallbackIcon && fallbackIcon.tagName === 'DIV') {
                            fallbackIcon.style.display = 'none';
                        }
                    };
                    
                    // Show fallback icon if image fails to load
                    img.onerror = function() {
                        console.log(`${element.id} photo failed to load:`, this.src);
                        this.style.display = 'none';
                        const fallbackIcon = this.nextElementSibling;
                        if (fallbackIcon && fallbackIcon.tagName === 'DIV') {
                            fallbackIcon.style.display = 'flex';
                        }
                    };
                }
            });
        }

        // Process image URL to handle different formats (Blogger, Google Drive, etc.)
        function processImageUrl(url) {
            if (!url || !url.trim()) return '';
            
            url = url.trim();
            
            // Handle Blogger URLs - ensure they have proper size parameter
            if (url.includes('blogger.googleusercontent.com') || url.includes('blogspot.com')) {
                // Remove existing size parameters and add a reasonable size
                url = url.replace(/\/s\d+(-c)?\//, '/s200-c/');
                // If no size parameter exists, add one
                if (!url.includes('/s200-c/') && !url.includes('/s') && url.includes('blogger.googleusercontent.com')) {
                    url = url.replace(/\/([^\/]+)$/, '/s200-c/$1');
                }
                console.log('Processed Blogger URL:', url);
                return url;
            }
            
            // Handle Google Drive URLs
            if (url.includes('drive.google.com')) {
                const fileIdMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
                if (fileIdMatch) {
                    return `https://drive.google.com/uc?id=${fileIdMatch[1]}`;
                }
            }
            
            // Handle Google Drive direct links
            if (url.includes('drive.google.com/uc?id=')) {
                return url;
            }
            
            // Return original URL for other cases
            return url;
        }

        // Load user results
        async function loadUserResults() {
            // In demo, load from localStorage
            const results = JSON.parse(localStorage.getItem('assessmentResults') || '[]');
            const userResults = results.filter(r => r.username === currentUser.username);
            
            document.getElementById('completedAssessments').textContent = userResults.length;
            
            if (userResults.length > 0) {
                const averageScore = Math.round(userResults.reduce((sum, r) => sum + r.score, 0) / userResults.length);
                document.getElementById('profileAverageScore').textContent = averageScore;
            }
        }

        // Show results
        function showResults() {
            hideAllScreens();
            document.getElementById('resultsScreen').classList.remove('hidden');
            updateNavigation('results');
            
            const container = document.getElementById('resultsContainer');
            const results = JSON.parse(localStorage.getItem('assessmentResults') || '[]');
            const userResults = results.filter(r => r.username === currentUser.username);
            
            container.innerHTML = '';
            
            if (userResults.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-chart-bar text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600">Belum ada hasil asesmen</p>
                    </div>
                `;
                return;
            }
            
            userResults.forEach(result => {
                const resultCard = document.createElement('div');
                resultCard.className = 'bg-white rounded-xl card-shadow p-4 mb-4';
                
                const scoreColor = result.score >= 75 ? 'text-green-600' : 'text-red-600';
                const statusIcon = result.status === 'Lulus' ? '🎉' : '📚';
                const statusColor = result.status === 'Lulus' ? 'text-green-600' : 'text-red-600';
                
                resultCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-gray-800 flex-1">${result.assessmentTitle}</h3>
                        <div class="text-right">
                            <span class="text-2xl font-bold ${scoreColor}">${result.score}</span>
                            <div class="text-xs ${statusColor} font-medium">${result.status || (result.score >= 75 ? 'Lulus' : 'Tidak Lulus')} ${statusIcon}</div>
                        </div>
                    </div>
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>Jawaban benar: ${result.correctAnswers}/${result.totalQuestions} (${Math.round((result.correctAnswers/result.totalQuestions)*100)}%)</span>
                        <span>${new Date(result.submittedAt).toLocaleDateString('id-ID')}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: ${result.score}%"></div>
                    </div>
                    <div class="text-xs text-gray-500 text-center">
                        Waktu pengerjaan: ${result.timeSpent || 'Tidak tercatat'}
                    </div>
                `;
                
                container.appendChild(resultCard);
            });
        }

        // Navigation functions
        function showDashboard() {
            hideAllScreens();
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('bottomNav').classList.remove('hidden');
            updateNavigation('dashboard');
            
            // Hide floating timer when not in assessment
            stopAssessmentTimer();
        }

        function showAssessments() {
            // Stop timer if running
            stopAssessmentTimer();
            
            hideAllScreens();
            document.getElementById('assessmentsList').classList.remove('hidden');
            document.getElementById('bottomNav').classList.remove('hidden');
            updateNavigation('assessments');
        }

        function showAssessmentDetail() {
            hideAllScreens();
            document.getElementById('assessmentDetail').classList.remove('hidden');
            document.getElementById('bottomNav').classList.add('hidden');
        }

        function showProfile() {
            hideAllScreens();
            document.getElementById('profileScreen').classList.remove('hidden');
            updateNavigation('profile');
            
            // Hide floating timer when not in assessment
            stopAssessmentTimer();
            
            // Update profile info
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileClass').textContent = `Kelas: ${currentUser.class}`;
            document.getElementById('profileClassNumber').textContent = ``;
            
            // Update profile photo
            updateUserPhotos();
            
            const results = JSON.parse(localStorage.getItem('assessmentResults') || '[]');
            const userResults = results.filter(r => r.username === currentUser.username);
            
            // Show assessments available for user's class
            const userAssessments = assessments.filter(a => {
                if (a.status !== 'aktif') return false;
                
                const assessmentTargetClass = (a.targetClass || '').toString().toLowerCase();
                const userClass = (currentUser.class || '').toString().toLowerCase();
                
                const classMatch = assessmentTargetClass.includes('semua') ||
                                 assessmentTargetClass.includes('all') ||
                                 assessmentTargetClass === userClass ||
                                 (a.level || '').toString().toLowerCase() === userClass;
                
                return classMatch;
            });
            
            document.getElementById('profileTotalAssessments').textContent = userAssessments.length;
            document.getElementById('profileCompletedAssessments').textContent = userResults.length;
            
            if (userResults.length > 0) {
                const averageScore = Math.round(userResults.reduce((sum, r) => sum + r.score, 0) / userResults.length);
                document.getElementById('profileAverageScore').textContent = averageScore;
            }
        }

        function hideAllScreens() {
            const screens = ['loginScreen', 'dashboard', 'assessmentsList', 'assessmentDetail', 'resultsScreen', 'profileScreen'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
        }

        function updateNavigation(active) {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('nav-active'));
            
            const navMap = {
                'dashboard': 0,
                'assessments': 1,
                'results': 2,
                'profile': 3
            };
            
            if (navMap[active] !== undefined) {
                navItems[navMap[active]].classList.add('nav-active');
            }
        }

        function refreshAssessments() {
            loadAssessments();
        }



        function logout() {
            // Create custom confirmation dialog
            const confirmDialog = document.createElement('div');
            confirmDialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            confirmDialog.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-2xl">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-sign-out-alt text-2xl text-red-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Konfirmasi Keluar</h3>
                        <p class="text-gray-600 text-sm leading-relaxed">
                            Apakah Anda yakin ingin keluar dari aplikasi?
                            <br><br>
                            <span class="text-red-600 font-medium">⚠️ Perhatian:</span>
                            <br>• Anda akan kembali ke halaman login
                            <br>• Semua progress yang belum disimpan akan hilang
                            <br>• Perlu login ulang untuk mengakses asesmen
                        </p>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="cancelLogout()" 
                                class="flex-1 bg-gray-200 text-gray-800 py-3 rounded-xl font-medium hover:bg-gray-300 transition-colors">
                            <i class="fas fa-times mr-2"></i>Batal
                        </button>
                        <button onclick="confirmLogout()" 
                                class="flex-1 bg-red-500 text-white py-3 rounded-xl font-medium hover:bg-red-600 transition-colors">
                            <i class="fas fa-sign-out-alt mr-2"></i>Ya, Keluar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDialog);
        }

        function cancelLogout() {
            const dialog = document.querySelector('.fixed.inset-0.bg-black');
            if (dialog) {
                dialog.remove();
            }
        }

        function confirmLogout() {
            // Remove dialog
            const dialog = document.querySelector('.fixed.inset-0.bg-black');
            if (dialog) {
                dialog.remove();
            }
            
            // Stop timer if running
            stopAssessmentTimer();
            
            // Perform logout
            localStorage.removeItem('currentUser');
            currentUser = null;
            hideAllScreens();
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('bottomNav').classList.add('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            
            // Hide header and remove top padding
            document.getElementById('mainHeader').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('pt-20');
            
            // Reset form
            document.getElementById('loginForm').reset();
            
            // Show success message
            setTimeout(() => {
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                successMsg.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Berhasil keluar dari aplikasi';
                document.body.appendChild(successMsg);
                
                setTimeout(() => {
                    successMsg.remove();
                }, 3000);
            }, 500);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'982c7a3be026a3ec',t:'MTc1ODQ4ODI3My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
