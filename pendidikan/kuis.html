<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizEdu - Media Pembelajaran</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .quiz-card { transition: all 0.3s ease; }
        .quiz-card:hover { transform: translateY(-2px); }
        .nav-item.active { color: #3B82F6; }
        .nav-item.active svg { stroke: #3B82F6; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen pb-20">
    <!-- Header -->
    <header id="appHeader" class="hidden bg-white shadow-sm px-4 py-4">
        <div class="flex items-center justify-between max-w-md mx-auto">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 flex items-center justify-center">
                    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEibBotgRQ9Xr7To_m-r7-o3Aqa63uK-qZGH525qRILSkgoz7DjfXJJt40pgYlnwlgQc4nH_X4r4W-ExfXLkpFawps8gEcfIASHubmncsnR2jKN9ojXnNl8iO2G80_Zt3_xVvHYtkF2ccZpB2KDQpFGR6GJUmNxyL5JzFgf8nYUBjWSymMnOM9URIhT4IxeP/s16000/LOGO_MA_HASYIM-removebg-preview.png" 
                         alt="Logo MA Hasyim" 
                         class="w-full h-full object-contain"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-10 h-10 bg-blue-500 rounded-full hidden items-center justify-center">
                        <span class="text-white font-bold text-lg">Q</span>
                    </div>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-800">QuizEdu</h1>
                    <p class="text-xs text-gray-500">Media Pembelajaran</p>
                </div>
            </div>
            <button onclick="showLogoutConfirm()" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors">
                <span class="text-sm">üë§</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-md mx-auto px-4 py-6" id="mainContent">
        <!-- Login Page -->
        <div id="loginPage" class="space-y-6">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto mb-4 flex items-center justify-center">
                    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEibBotgRQ9Xr7To_m-r7-o3Aqa63uK-qZGH525qRILSkgoz7DjfXJJt40pgYlnwlgQc4nH_X4r4W-ExfXLkpFawps8gEcfIASHubmncsnR2jKN9ojXnNl8iO2G80_Zt3_xVvHYtkF2ccZpB2KDQpFGR6GJUmNxyL5JzFgf8nYUBjWSymMnOM9URIhT4IxeP/s16000/LOGO_MA_HASYIM-removebg-preview.png" 
                         alt="Logo MA Hasyim" 
                         class="w-full h-full object-contain rounded-full"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full hidden items-center justify-center text-white text-3xl font-bold">
                        Q
                    </div>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Selamat Datang</h1>
                <p class="text-gray-600">Masuk untuk melanjutkan belajar</p>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm">
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email atau Username</label>
                        <input type="text" id="loginUsername" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan email atau username" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan password" required>
                    </div>
                    
                    <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-700 transition-all">
                        Masuk
                    </button>
                </form>
                
                <div class="mt-4 text-center">
                    <p class="text-sm text-gray-600">Belum punya akun? <button onclick="showRegister()" class="text-blue-500 font-medium">Daftar di sini</button></p>
                </div>
            </div>


        </div>

        <!-- Register Page -->
        <div id="registerPage" class="hidden space-y-6">
            <div class="text-center mb-6">
                <button onclick="showLogin()" class="absolute left-4 top-20 text-gray-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Daftar Akun</h1>
                <p class="text-gray-600">Buat akun baru untuk mulai belajar</p>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm">
                <form id="registerForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                        <input type="text" id="registerName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan nama lengkap" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="registerUsername" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Pilih username" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="registerEmail" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan email" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="registerPassword" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Buat password" required>
                    </div>
                    
                    <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 rounded-xl font-semibold hover:from-green-600 hover:to-emerald-700 transition-all">
                        Daftar
                    </button>
                </form>
            </div>
        </div>



        <!-- Home Page -->
        <div id="homePage" class="hidden space-y-6">
            <!-- Welcome Card -->
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl p-6 text-white">
                <h2 class="text-2xl font-bold mb-2">Selamat Datang! üëã</h2>
                <p class="text-blue-100 mb-4">Siap untuk belajar dengan quiz interaktif?</p>
                <div class="flex items-center space-x-4 text-sm">
                    <div class="flex items-center space-x-1">
                        <span>üèÜ</span>
                        <span>Level 5</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <span>‚≠ê</span>
                        <span>850 Poin</span>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-3 gap-3">
                <div class="bg-white rounded-xl p-4 text-center shadow-sm">
                    <div class="text-2xl font-bold text-green-500">12</div>
                    <div class="text-xs text-gray-500">Quiz Selesai</div>
                </div>
                <div class="bg-white rounded-xl p-4 text-center shadow-sm">
                    <div class="text-2xl font-bold text-blue-500">85%</div>
                    <div class="text-xs text-gray-500">Akurasi</div>
                </div>
                <div class="bg-white rounded-xl p-4 text-center shadow-sm">
                    <div class="text-2xl font-bold text-purple-500">7</div>
                    <div class="text-xs text-gray-500">Hari Berturut</div>
                </div>
            </div>


        </div>

        <!-- Quiz Page -->
        <div id="quizPage" class="hidden">
            <!-- No Activity Message -->
            <div id="noActivityMessage" class="flex flex-col items-center justify-center h-96 text-center">
                <div class="text-6xl mb-4">üìù</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Tidak Ada Aktivitas</h3>
                <p class="text-gray-600 mb-6">Belum ada quiz yang sedang dikerjakan</p>
                <button onclick="goHome()" class="bg-blue-500 text-white px-6 py-3 rounded-xl font-medium hover:bg-blue-600 transition-colors">
                    Kembali ke Beranda
                </button>
            </div>

            <!-- Quiz Content -->
            <div id="quizContent" class="bg-white rounded-2xl p-6 shadow-sm hidden">
                <div class="flex items-center justify-between mb-6">
                    <button onclick="goHome()" class="text-gray-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <div class="text-center">
                        <h3 class="font-semibold text-gray-800" id="quizTitle">Quiz</h3>
                        <p class="text-sm text-gray-500">Soal <span id="currentQuestion">1</span> dari <span id="totalQuestions">5</span></p>
                    </div>
                    <div class="text-sm text-blue-500 font-medium" id="timer">05:00</div>
                </div>

                <div class="mb-6">
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                        <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" id="progressBar" style="width: 20%"></div>
                    </div>
                </div>

                <div id="questionContainer">
                    <h4 class="text-lg font-semibold text-gray-800 mb-6" id="questionText">Berapa hasil dari 15 + 27?</h4>
                    
                    <div class="space-y-3" id="answersContainer">
                        <button class="answer-btn w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 transition-colors" onclick="selectAnswer(this, 'A')">
                            <span class="font-medium text-blue-500">A.</span> 42
                        </button>
                        <button class="answer-btn w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 transition-colors" onclick="selectAnswer(this, 'B')">
                            <span class="font-medium text-blue-500">B.</span> 41
                        </button>
                        <button class="answer-btn w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 transition-colors" onclick="selectAnswer(this, 'C')">
                            <span class="font-medium text-blue-500">C.</span> 43
                        </button>
                        <button class="answer-btn w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 transition-colors" onclick="selectAnswer(this, 'D')">
                            <span class="font-medium text-blue-500">D.</span> 40
                        </button>
                    </div>
                </div>

                <button id="nextBtn" class="w-full bg-blue-500 text-white py-4 rounded-xl font-semibold mt-6 opacity-50 cursor-not-allowed" disabled onclick="nextQuestion()">
                    Lanjut
                </button>
            </div>
        </div>

        <!-- Categories Page -->
        <div id="categoriesPage" class="hidden space-y-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Kategori Quiz</h2>
            
            <div id="categoriesContainer" class="grid grid-cols-2 gap-4">
                <!-- Loading state -->
                <div class="col-span-2 text-center py-8 text-gray-500">
                    <div class="animate-spin w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full mx-auto mb-2"></div>
                    <p class="text-sm">Memuat kategori...</p>
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profilePage" class="hidden space-y-6">
            <div class="text-center">
                <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                    üë§
                </div>
                <h2 class="text-xl font-bold text-gray-800 user-name">John Doe</h2>
                <p class="text-gray-500">Pelajar Aktif</p>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm">
                <h3 class="font-semibold text-gray-800 mb-4">Statistik</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Total Quiz</span>
                        <span class="font-semibold" id="totalQuizCount">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Rata-rata Skor</span>
                        <span class="font-semibold text-green-500" id="averageScore">0%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Quiz Lulus</span>
                        <span class="font-semibold text-blue-500" id="passedQuizCount">0</span>
                    </div>
                </div>
            </div>

            <!-- Quiz History -->
            <div class="bg-white rounded-2xl p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold text-gray-800">Riwayat Quiz</h3>
                    <button onclick="loadQuizHistory()" class="text-blue-500 text-sm hover:underline">Refresh</button>
                </div>
                <div id="quizHistoryContainer" class="space-y-3 max-h-64 overflow-y-auto">
                    <div class="text-center py-4 text-gray-500">
                        <div class="animate-spin w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full mx-auto mb-2"></div>
                        <p class="text-sm">Memuat riwayat...</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm">
                <h3 class="font-semibold text-gray-800 mb-4">Pencapaian</h3>
                <div class="grid grid-cols-3 gap-4">
                    <div class="text-center">
                        <div class="text-2xl mb-2">üèÜ</div>
                        <p class="text-xs text-gray-600">Quiz Master</p>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl mb-2">‚≠ê</div>
                        <p class="text-xs text-gray-600">Perfect Score</p>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl mb-2">üî•</div>
                        <p class="text-xs text-gray-600">7 Hari Streak</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 mx-4 max-w-sm w-full">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-2xl">üö™</span>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Keluar dari Akun</h3>
                <p class="text-gray-600 mb-6">Apakah Anda yakin ingin keluar dari akun?</p>
                
                <div class="flex space-x-3">
                    <button onclick="hideLogoutConfirm()" class="flex-1 px-4 py-3 bg-gray-200 text-gray-800 rounded-xl font-medium hover:bg-gray-300 transition-colors">
                        Batal
                    </button>
                    <button onclick="confirmLogout()" class="flex-1 px-4 py-3 bg-red-500 text-white rounded-xl font-medium hover:bg-red-600 transition-colors">
                        Keluar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-4 py-2">
        <div class="max-w-md mx-auto">
            <div class="flex justify-around">
                <button class="nav-item active flex flex-col items-center py-2 px-3" onclick="showPage('home')">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    <span class="text-xs">Beranda</span>
                </button>
                
                <button class="nav-item flex flex-col items-center py-2 px-3 text-gray-400" onclick="showPage('categories')">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                    <span class="text-xs">Kategori</span>
                </button>
                
                <button class="nav-item flex flex-col items-center py-2 px-3 text-gray-400" onclick="showPage('quiz')">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    <span class="text-xs">Quiz</span>
                </button>
                
                <button class="nav-item flex flex-col items-center py-2 px-3 text-gray-400" onclick="showPage('profile')">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span class="text-xs">Profil</span>
                </button>
            </div>
        </div>
    </nav>

    <script>
        let currentQuestionIndex = 0;
        let selectedAnswer = null;
        let timer = 300; // 5 minutes
        let timerInterval;
        let isLoggedIn = false;
        let currentUser = null;
        let isQuizActive = false;
        let correctAnswers = 0;
        let userAnswers = [];
        // Google Sheets API Configuration
        const SHEET_CONFIG = {
            SHEET_ID: '17MDc804lNUm_XwUM6hPj6Ui8T-JVtpxJCLq4XovVs0A',
            SHEET_NAME: 'Login',
            QUIZ_SHEET_NAME: 'kuis aktif',
            CATEGORY_SHEET_NAME: 'kategori kuis',
            QUESTIONS_SHEET_NAME: 'soal quiz',
            RESULTS_SHEET_NAME: 'hasil quiz',
            API_KEY: 'AIzaSyCAJWvsjw92iebZM54KZivepTpl_Q2gk70'
        };
        let usersData = [];
        let activeQuizData = [];
        let categoryData = [];
        let questionsData = [];

        const sampleQuestions = [
            {
                question: "Berapa hasil dari 15 + 27?",
                type: "pilihan_ganda",
                answers: ["40", "41", "42", "43", "44"],
                correct: 2
            },
            {
                question: "Siapa penemu lampu pijar?",
                type: "pilihan_ganda",
                answers: ["Thomas Edison", "Nikola Tesla", "Alexander Bell", "Albert Einstein", "Isaac Newton"],
                correct: 0
            },
            {
                question: "Ibu kota Indonesia adalah ____",
                type: "isian",
                correctAnswer: "Jakarta"
            },
            {
                question: "Jelaskan proses fotosintesis pada tumbuhan!",
                type: "essay",
                correctAnswer: "Fotosintesis adalah proses pembuatan makanan oleh tumbuhan menggunakan cahaya matahari, air, dan karbon dioksida untuk menghasilkan glukosa dan oksigen."
            },
            {
                question: "Planet terdekat dengan matahari adalah?",
                type: "pilihan_ganda",
                answers: ["Venus", "Mars", "Merkurius", "Bumi", "Jupiter"],
                correct: 2
            }
        ];

        function showPage(page) {
            // Hide all pages
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('quizPage').classList.add('hidden');
            document.getElementById('categoriesPage').classList.add('hidden');
            document.getElementById('profilePage').classList.add('hidden');

            // Show selected page
            if (page === 'home') {
                document.getElementById('homePage').classList.remove('hidden');
            } else if (page === 'categories') {
                document.getElementById('categoriesPage').classList.remove('hidden');
                loadCategoriesFromSheet();
            } else if (page === 'quiz') {
                document.getElementById('quizPage').classList.remove('hidden');
                if (!isQuizActive) {
                    showNoActivity();
                }
            } else if (page === 'profile') {
                document.getElementById('profilePage').classList.remove('hidden');
                loadQuizHistory(); // Load quiz history when profile page is opened
            }

            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                item.classList.add('text-gray-400');
            });
            
            event.target.closest('.nav-item').classList.add('active');
            event.target.closest('.nav-item').classList.remove('text-gray-400');
        }

        async function startQuiz(title) {
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('categoriesPage').classList.add('hidden');
            document.getElementById('quizPage').classList.remove('hidden');
            
            isQuizActive = true;
            document.getElementById('quizTitle').textContent = title;
            currentQuestionIndex = 0;
            selectedAnswer = null;
            timer = 300;
            correctAnswers = 0;
            userAnswers = [];
            
            // Hide no activity message and show quiz content
            const noActivityDiv = document.getElementById('noActivityMessage');
            const quizContent = document.getElementById('quizContent');
            if (noActivityDiv) noActivityDiv.classList.add('hidden');
            if (quizContent) quizContent.classList.remove('hidden');
            
            // Load questions from Google Sheets
            await loadQuestionsFromSheet();
            
            loadQuestion();
            startTimer();
        }

        function showNoActivity() {
            const quizContent = document.getElementById('quizContent');
            const noActivityDiv = document.getElementById('noActivityMessage');
            
            if (quizContent) quizContent.classList.add('hidden');
            if (noActivityDiv) noActivityDiv.classList.remove('hidden');
        }

        function loadQuestion() {
            // Use questions from Google Sheets if available, otherwise use sample questions
            const questions = questionsData.length > 0 ? questionsData : sampleQuestions;
            
            if (currentQuestionIndex >= questions.length) {
                finishQuiz();
                return;
            }
            
            const question = questions[currentQuestionIndex];
            document.getElementById('questionText').textContent = question.question;
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = questions.length;
            
            const answersContainer = document.getElementById('answersContainer');
            answersContainer.innerHTML = '';
            
            // Handle different question types
            const questionType = question.type || 'pilihan_ganda';
            
            if (questionType === 'pilihan_ganda') {
                // Multiple choice questions
                if (questionsData.length > 0) {
                    // Google Sheets format
                    const options = [question.optionA, question.optionB, question.optionC, question.optionD, question.optionE];
                    options.forEach((option, index) => {
                        if (option && option.trim()) { // Only show non-empty options
                            const button = document.createElement('button');
                            button.className = 'answer-btn w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 transition-colors';
                            button.innerHTML = `<span class="font-medium text-blue-500">${String.fromCharCode(65 + index)}.</span> ${option}`;
                            button.onclick = () => selectAnswer(button, String.fromCharCode(65 + index));
                            answersContainer.appendChild(button);
                        }
                    });
                } else {
                    // Sample questions format
                    question.answers.forEach((answer, index) => {
                        const button = document.createElement('button');
                        button.className = 'answer-btn w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 transition-colors';
                        button.innerHTML = `<span class="font-medium text-blue-500">${String.fromCharCode(65 + index)}.</span> ${answer}`;
                        button.onclick = () => selectAnswer(button, String.fromCharCode(65 + index));
                        answersContainer.appendChild(button);
                    });
                }
            } else if (questionType === 'isian') {
                // Fill-in-the-blank questions
                const inputDiv = document.createElement('div');
                inputDiv.className = 'w-full';
                inputDiv.innerHTML = `
                    <input type="text" id="fillAnswer" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none" 
                           placeholder="Ketik jawaban Anda di sini..." onkeyup="handleTextInput()">
                `;
                answersContainer.appendChild(inputDiv);
            } else if (questionType === 'essay') {
                // Essay questions
                const textareaDiv = document.createElement('div');
                textareaDiv.className = 'w-full';
                textareaDiv.innerHTML = `
                    <textarea id="essayAnswer" rows="6" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none resize-none" 
                              placeholder="Tulis jawaban essay Anda di sini..." onkeyup="handleTextInput()"></textarea>
                    <div class="mt-2 text-sm text-gray-500">
                        <span id="charCount">0</span> karakter
                    </div>
                `;
                answersContainer.appendChild(textareaDiv);
            }
            
            // Update progress bar
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
            // Reset next button
            const nextBtn = document.getElementById('nextBtn');
            nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            nextBtn.disabled = true;
            selectedAnswer = null;
        }

        function selectAnswer(button, answer) {
            // Remove previous selection
            document.querySelectorAll('.answer-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
                btn.classList.add('border-gray-200');
            });
            
            // Highlight selected answer
            button.classList.remove('border-gray-200');
            button.classList.add('border-blue-500', 'bg-blue-50');
            
            selectedAnswer = answer;
            
            // Enable next button
            const nextBtn = document.getElementById('nextBtn');
            nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            nextBtn.disabled = false;
        }

        function handleTextInput() {
            const fillInput = document.getElementById('fillAnswer');
            const essayInput = document.getElementById('essayAnswer');
            const charCount = document.getElementById('charCount');
            
            let inputValue = '';
            
            if (fillInput) {
                inputValue = fillInput.value.trim();
                selectedAnswer = inputValue;
            } else if (essayInput) {
                inputValue = essayInput.value.trim();
                selectedAnswer = inputValue;
                
                // Update character count
                if (charCount) {
                    charCount.textContent = essayInput.value.length;
                }
            }
            
            // Enable/disable next button based on input
            const nextBtn = document.getElementById('nextBtn');
            if (inputValue.length > 0) {
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                nextBtn.disabled = false;
            } else {
                nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
                nextBtn.disabled = true;
            }
        }

        function nextQuestion() {
            if (!selectedAnswer) return;
            
            // Check if answer is correct
            const questions = questionsData.length > 0 ? questionsData : sampleQuestions;
            const currentQuestion = questions[currentQuestionIndex];
            const questionType = currentQuestion.type || 'pilihan_ganda';
            
            let isCorrect = false;
            let correctAnswerDisplay = '';
            
            if (questionType === 'pilihan_ganda') {
                if (questionsData.length > 0) {
                    // Google Sheets format
                    isCorrect = selectedAnswer === currentQuestion.correctAnswer;
                    correctAnswerDisplay = currentQuestion.correctAnswer;
                } else {
                    // Sample questions format
                    const correctIndex = currentQuestion.correct;
                    const correctLetter = String.fromCharCode(65 + correctIndex);
                    isCorrect = selectedAnswer === correctLetter;
                    correctAnswerDisplay = correctLetter;
                }
            } else if (questionType === 'isian') {
                // For fill-in questions, check if answer matches (case-insensitive)
                const userAnswer = selectedAnswer.toLowerCase().trim();
                const correctAnswer = currentQuestion.correctAnswer.toLowerCase().trim();
                isCorrect = userAnswer === correctAnswer;
                correctAnswerDisplay = currentQuestion.correctAnswer;
            } else if (questionType === 'essay') {
                // For essay questions, we'll mark as correct if user provided an answer
                // In real implementation, this would need manual grading
                isCorrect = selectedAnswer.length >= 10; // Minimum 10 characters
                correctAnswerDisplay = currentQuestion.correctAnswer;
            }
            
            if (isCorrect) {
                correctAnswers++;
            }
            
            // Store user answer
            userAnswers.push({
                question: currentQuestion.question,
                type: questionType,
                userAnswer: selectedAnswer,
                correctAnswer: correctAnswerDisplay,
                isCorrect: isCorrect
            });
            
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= questions.length) {
                finishQuiz();
            } else {
                loadQuestion();
            }
        }

        async function finishQuiz() {
            clearInterval(timerInterval);
            isQuizActive = false;
            
            const questions = questionsData.length > 0 ? questionsData : sampleQuestions;
            const totalQuestions = questions.length;
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            
            // Save quiz result to Google Sheets
            await saveQuizResult(percentage, correctAnswers, totalQuestions);
            
            showQuizResult(percentage, correctAnswers, totalQuestions);
        }

        function showQuizResult(percentage, correctAnswers, totalQuestions) {
            const quizContent = document.getElementById('quizContent');
            const currentQuizTitle = document.getElementById('quizTitle').textContent;
            
            let statusColor = 'red';
            let statusIcon = '‚ùå';
            let statusText = 'Belum Lulus';
            let message = 'Skor Anda masih di bawah 75%. Silakan coba lagi!';
            
            if (percentage >= 75) {
                statusColor = 'green';
                statusIcon = '‚úÖ';
                statusText = 'Lulus';
                message = 'Selamat! Anda telah lulus quiz ini.';
            }
            
            quizContent.innerHTML = `
                <div class="text-center">
                    <div class="w-20 h-20 mx-auto mb-6 bg-${statusColor}-100 rounded-full flex items-center justify-center">
                        <span class="text-3xl">${statusIcon}</span>
                    </div>
                    
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Quiz Selesai!</h2>
                    <h3 class="text-lg font-semibold text-gray-600 mb-6">${currentQuizTitle}</h3>
                    
                    <div class="bg-gray-50 rounded-2xl p-6 mb-6">
                        <div class="text-4xl font-bold text-${statusColor}-500 mb-2">${percentage}%</div>
                        <div class="text-gray-600 mb-2">Skor: ${correctAnswers}/${totalQuestions}</div>
                        <div class="inline-block px-4 py-2 bg-${statusColor}-100 text-${statusColor}-700 rounded-full text-sm font-medium">
                            ${statusText}
                        </div>
                    </div>
                    
                    <p class="text-gray-600 mb-6">${message}</p>
                    
                    <div class="space-y-4 mb-6">
                        <h4 class="font-semibold text-gray-800 text-left">Detail Jawaban:</h4>
                        <div class="bg-white rounded-xl p-4 max-h-48 overflow-y-auto">
                            ${generateAnswerDetails()}
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        ${percentage < 75 ? `
                            <button onclick="retryQuiz('${currentQuizTitle}')" class="w-full bg-blue-500 text-white py-4 rounded-xl font-semibold hover:bg-blue-600 transition-colors">
                                üîÑ Ulangi Quiz
                            </button>
                        ` : ''}
                        <button onclick="goHome()" class="w-full bg-gray-500 text-white py-4 rounded-xl font-semibold hover:bg-gray-600 transition-colors">
                            üè† Kembali ke Beranda
                        </button>
                    </div>
                </div>
            `;
        }

        function generateAnswerDetails() {
            let detailsHTML = '';
            
            userAnswers.forEach((answer, index) => {
                const status = answer.isCorrect ? '‚úÖ' : '‚ùå';
                const questionType = answer.type || 'pilihan_ganda';
                
                detailsHTML += `<div class="text-left border-b border-gray-100 pb-3 mb-3 last:border-b-0 last:mb-0">`;
                detailsHTML += `<div class="flex items-start space-x-2">`;
                detailsHTML += `<span class="text-lg">${status}</span>`;
                detailsHTML += `<div class="flex-1">`;
                detailsHTML += `<div class="font-medium text-gray-800 text-sm mb-1">Soal ${index + 1}</div>`;
                
                if (questionType === 'pilihan_ganda') {
                    detailsHTML += `<div class="text-sm text-gray-600">Jawaban Anda: <span class="font-medium">${answer.userAnswer}</span></div>`;
                    if (!answer.isCorrect) {
                        detailsHTML += `<div class="text-sm text-green-600">Jawaban Benar: <span class="font-medium">${answer.correctAnswer}</span></div>`;
                    }
                } else if (questionType === 'isian') {
                    detailsHTML += `<div class="text-sm text-gray-600">Jawaban Anda: "${answer.userAnswer}"</div>`;
                    if (!answer.isCorrect) {
                        detailsHTML += `<div class="text-sm text-green-600">Jawaban Benar: "${answer.correctAnswer}"</div>`;
                    }
                } else if (questionType === 'essay') {
                    const preview = answer.userAnswer.length > 30 ? answer.userAnswer.substring(0, 30) + '...' : answer.userAnswer;
                    detailsHTML += `<div class="text-sm text-gray-600">Essay: "${preview}"</div>`;
                }
                
                detailsHTML += `</div></div></div>`;
            });
            
            return detailsHTML;
        }

        function retryQuiz(title) {
            // Reset quiz state
            currentQuestionIndex = 0;
            selectedAnswer = null;
            timer = 300;
            correctAnswers = 0;
            userAnswers = [];
            isQuizActive = true;
            
            // Reset quiz content
            const quizContent = document.getElementById('quizContent');
            quizContent.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <button onclick="goHome()" class="text-gray-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <div class="text-center">
                        <h3 class="font-semibold text-gray-800" id="quizTitle">${title}</h3>
                        <p class="text-sm text-gray-500">Soal <span id="currentQuestion">1</span> dari <span id="totalQuestions">5</span></p>
                    </div>
                    <div class="text-sm text-blue-500 font-medium" id="timer">05:00</div>
                </div>

                <div class="mb-6">
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                        <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" id="progressBar" style="width: 20%"></div>
                    </div>
                </div>

                <div id="questionContainer">
                    <h4 class="text-lg font-semibold text-gray-800 mb-6" id="questionText">Berapa hasil dari 15 + 27?</h4>
                    
                    <div class="space-y-3" id="answersContainer">
                        <button class="answer-btn w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 transition-colors" onclick="selectAnswer(this, 'A')">
                            <span class="font-medium text-blue-500">A.</span> 42
                        </button>
                        <button class="answer-btn w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 transition-colors" onclick="selectAnswer(this, 'B')">
                            <span class="font-medium text-blue-500">B.</span> 41
                        </button>
                        <button class="answer-btn w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 transition-colors" onclick="selectAnswer(this, 'C')">
                            <span class="font-medium text-blue-500">C.</span> 43
                        </button>
                        <button class="answer-btn w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 transition-colors" onclick="selectAnswer(this, 'D')">
                            <span class="font-medium text-blue-500">D.</span> 40
                        </button>
                    </div>
                </div>

                <button id="nextBtn" class="w-full bg-blue-500 text-white py-4 rounded-xl font-semibold mt-6 opacity-50 cursor-not-allowed" disabled onclick="nextQuestion()">
                    Lanjut
                </button>
            `;
            
            // Start quiz again
            loadQuestion();
            startTimer();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timer--;
                const minutes = Math.floor(timer / 60);
                const seconds = timer % 60;
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timer <= 0) {
                    finishQuiz();
                }
            }, 1000);
        }

        function goHome() {
            clearInterval(timerInterval);
            isQuizActive = false;
            document.getElementById('quizPage').classList.add('hidden');
            document.getElementById('homePage').classList.remove('hidden');
            
            // Reset navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                item.classList.add('text-gray-400');
            });
            document.querySelector('.nav-item').classList.add('active');
            document.querySelector('.nav-item').classList.remove('text-gray-400');
        }

        function showCategoryQuizzes(category) {
            // Filter active quizzes by category
            const categoryQuizzes = activeQuizData.filter(quiz => 
                quiz.category && quiz.category.toLowerCase() === category.toLowerCase()
            );
            
            if (categoryQuizzes.length === 0) {
                alert(`üìù Belum ada quiz aktif untuk kategori "${category}".\n\nSilakan cek kembali nanti atau hubungi admin.`);
                return;
            }
            
            // Show quiz selection modal
            showCategoryQuizModal(category, categoryQuizzes);
        }

        function showCategoryQuizModal(categoryName, quizzes) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.id = 'categoryQuizModal';
            
            const colorClasses = {
                'blue': 'from-blue-100 to-blue-200',
                'green': 'from-green-100 to-emerald-100',
                'orange': 'from-orange-100 to-red-100',
                'purple': 'from-purple-100 to-purple-200',
                'red': 'from-red-100 to-red-200',
                'yellow': 'from-yellow-100 to-yellow-200'
            };
            
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-md w-full max-h-96 overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Quiz ${categoryName}</h3>
                        <button onclick="closeCategoryQuizModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-3">
                        ${quizzes.map(quiz => `
                            <div class="quiz-card bg-gradient-to-r ${colorClasses[quiz.color] || colorClasses.blue} rounded-xl p-4 cursor-pointer hover:scale-105 transition-all" onclick="startQuizFromCategory('${quiz.title}')">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">${quiz.title}</h4>
                                        <p class="text-sm text-gray-600">${quiz.description} ‚Ä¢ ${quiz.duration}</p>
                                    </div>
                                    <div class="text-2xl">${quiz.icon}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button onclick="closeCategoryQuizModal()" class="w-full mt-4 bg-gray-500 text-white py-3 rounded-xl font-medium hover:bg-gray-600 transition-colors">
                        Tutup
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeCategoryQuizModal() {
            const modal = document.getElementById('categoryQuizModal');
            if (modal) {
                modal.remove();
            }
        }

        function startQuizFromCategory(quizTitle) {
            closeCategoryQuizModal();
            startQuiz(quizTitle);
        }

        // Save Quiz Result to Google Sheets
        async function saveQuizResult(percentage, correctAnswers, totalQuestions) {
            if (!currentUser) {
                console.error('No current user found');
                return;
            }
            
            try {
                const currentQuizTitle = document.getElementById('quizTitle').textContent;
                const currentDate = new Date();
                const dateString = currentDate.toLocaleDateString('id-ID');
                const timeString = currentDate.toLocaleTimeString('id-ID');
                const status = percentage >= 75 ? 'Lulus' : 'Tidak Lulus';
                
                // Calculate time taken (5 minutes - remaining time)
                const timeTaken = Math.floor((300 - timer) / 60);
                const timeTakenText = `${timeTaken} menit`;
                
                // Prepare detailed answers
                const detailedAnswers = userAnswers.map((answer, index) => {
                    return `Soal ${index + 1}: ${answer.isCorrect ? '‚úì' : '‚úó'} (${answer.userAnswer})`;
                }).join(' | ');
                
                // Show saving indicator
                showSavingIndicator();
                
                // Method 1: Try using Google Sheets API directly (requires public sheet)
                try {
                    const appendUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_CONFIG.SHEET_ID}/values/${SHEET_CONFIG.RESULTS_SHEET_NAME}:append?valueInputOption=RAW&key=${SHEET_CONFIG.API_KEY}`;
                    
                    const response = await fetch(appendUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            values: [[
                                currentUser.nama,           // Nama
                                currentUser.username,       // Username
                                currentQuizTitle,          // Judul Quiz
                                dateString,                // Tanggal
                                timeString,                // Waktu
                                totalQuestions,            // Total Soal
                                correctAnswers,            // Jawaban Benar
                                `${correctAnswers}/${totalQuestions}`, // Skor
                                `${percentage}%`,          // Persentase
                                status,                    // Status
                                timeTakenText,             // Waktu Pengerjaan
                                detailedAnswers            // Detail Jawaban
                            ]]
                        })
                    });
                    
                    if (response.ok) {
                        hideSavingIndicator();
                        showSaveSuccess();
                        return;
                    } else {
                        throw new Error('API append failed');
                    }
                } catch (apiError) {
                    console.log('Direct API failed, trying alternative method...');
                }
                
                // Method 2: Use Google Apps Script Web App
                try {
                    // Your deployed Web App URL
                    const webAppUrl = 'https://script.google.com/macros/s/AKfycbwUCaPf03mq7bijYdfDPuXYFINBsBAoqmBEc25HW6W_S-Ib_IANNqTsrdoHKBfboDC7/exec';
                    
                    const formData = new FormData();
                    formData.append('action', 'saveQuizResult');
                    formData.append('nama', currentUser.nama);
                    formData.append('username', currentUser.username);
                    formData.append('judulQuiz', currentQuizTitle);
                    formData.append('tanggal', dateString);
                    formData.append('waktu', timeString);
                    formData.append('totalSoal', totalQuestions);
                    formData.append('jawabanBenar', correctAnswers);
                    formData.append('skor', `${correctAnswers}/${totalQuestions}`);
                    formData.append('persentase', `${percentage}%`);
                    formData.append('status', status);
                    formData.append('waktuPengerjaan', timeTakenText);
                    formData.append('detailJawaban', detailedAnswers);
                    
                    const response = await fetch(webAppUrl, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        hideSavingIndicator();
                        showSaveSuccess();
                        return;
                    } else {
                        throw new Error('Web App failed');
                    }
                } catch (webAppError) {
                    console.log('Web App method failed');
                }
                
                // Method 3: Store locally and show instructions
                const quizData = {
                    nama: currentUser.nama,
                    username: currentUser.username,
                    judulQuiz: currentQuizTitle,
                    tanggal: dateString,
                    waktu: timeString,
                    totalSoal: totalQuestions,
                    jawabanBenar: correctAnswers,
                    skor: `${correctAnswers}/${totalQuestions}`,
                    persentase: `${percentage}%`,
                    status: status,
                    waktuPengerjaan: timeTakenText,
                    detailJawaban: detailedAnswers
                };
                
                // Store in localStorage as backup
                const existingResults = JSON.parse(localStorage.getItem('quizResults') || '[]');
                existingResults.push(quizData);
                localStorage.setItem('quizResults', JSON.stringify(existingResults));
                
                hideSavingIndicator();
                showSaveInstructions(quizData);
                
            } catch (error) {
                console.error('Error saving quiz result:', error);
                hideSavingIndicator();
                showSaveError();
            }
        }
        
        function showSaveInstructions(quizData) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-md w-full max-h-96 overflow-y-auto">
                    <div class="text-center mb-4">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-2xl">üìã</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Simpan Hasil Quiz</h3>
                        <p class="text-sm text-gray-600 mb-4">Salin data berikut ke Google Sheet "hasil quiz" Anda:</p>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-4 text-sm">
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div><strong>Nama:</strong> ${quizData.nama}</div>
                            <div><strong>Username:</strong> ${quizData.username}</div>
                            <div><strong>Quiz:</strong> ${quizData.judulQuiz}</div>
                            <div><strong>Tanggal:</strong> ${quizData.tanggal}</div>
                            <div><strong>Waktu:</strong> ${quizData.waktu}</div>
                            <div><strong>Total Soal:</strong> ${quizData.totalSoal}</div>
                            <div><strong>Benar:</strong> ${quizData.jawabanBenar}</div>
                            <div><strong>Skor:</strong> ${quizData.skor}</div>
                            <div><strong>Persentase:</strong> ${quizData.persentase}</div>
                            <div><strong>Status:</strong> ${quizData.status}</div>
                            <div class="col-span-2"><strong>Waktu Pengerjaan:</strong> ${quizData.waktuPengerjaan}</div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="copyQuizData('${JSON.stringify(quizData).replace(/'/g, "\\'")}'); this.parentElement.parentElement.parentElement.remove();" class="w-full bg-blue-500 text-white py-3 rounded-xl font-medium hover:bg-blue-600 transition-colors">
                            üìã Salin Data
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove();" class="w-full bg-gray-500 text-white py-3 rounded-xl font-medium hover:bg-gray-600 transition-colors">
                            Tutup
                        </button>
                    </div>
                    
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                        <p class="text-xs text-blue-800 mb-2">
                            <strong>üîß Setup Otomatis:</strong> Untuk menyimpan hasil quiz secara otomatis ke Google Sheets:
                        </p>
                        <ol class="text-xs text-blue-700 list-decimal list-inside space-y-1">
                            <li>Buka <a href="https://script.google.com" target="_blank" class="underline">script.google.com</a></li>
                            <li>Klik "New Project" dan paste kode Apps Script</li>
                            <li>Deploy sebagai Web App dengan akses "Anyone"</li>
                            <li>Salin URL Web App ke konfigurasi sistem</li>
                        </ol>
                        <button onclick="showAppsScriptCode()" class="mt-2 text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
                            üìã Lihat Kode Apps Script
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function copyQuizData(dataString) {
            try {
                const data = JSON.parse(dataString);
                const textToCopy = `${data.nama}\t${data.username}\t${data.judulQuiz}\t${data.tanggal}\t${data.waktu}\t${data.totalSoal}\t${data.jawabanBenar}\t${data.skor}\t${data.persentase}\t${data.status}\t${data.waktuPengerjaan}\t${data.detailJawaban}`;
                
                navigator.clipboard.writeText(textToCopy).then(() => {
                    alert('‚úÖ Data berhasil disalin!\n\nSekarang buka Google Sheet "hasil quiz" dan paste (Ctrl+V) data ini ke baris baru.');
                }).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = textToCopy;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('‚úÖ Data berhasil disalin!\n\nSekarang buka Google Sheet "hasil quiz" dan paste (Ctrl+V) data ini ke baris baru.');
                });
            } catch (error) {
                alert('‚ùå Gagal menyalin data. Silakan salin manual.');
            }
        }
        
        function showSavingIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'savingIndicator';
            indicator.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center space-x-2';
            indicator.innerHTML = `
                <div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div>
                <span class="text-sm">Menyimpan hasil...</span>
            `;
            document.body.appendChild(indicator);
        }
        
        function hideSavingIndicator() {
            const indicator = document.getElementById('savingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        function showSaveSuccess() {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center space-x-2';
            notification.innerHTML = `
                <span class="text-lg">‚úÖ</span>
                <span class="text-sm">Hasil quiz tersimpan!</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function showSaveError() {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center space-x-2';
            notification.innerHTML = `
                <span class="text-lg">‚ùå</span>
                <span class="text-sm">Gagal menyimpan hasil</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Authentication Functions
        async function loadUsersFromSheet() {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_CONFIG.SHEET_ID}/values/${SHEET_CONFIG.SHEET_NAME}?key=${SHEET_CONFIG.API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                usersData = [];
                const rows = data.values || [];
                
                // Skip header row (index 0)
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row && row.length >= 4 && row[0]) {
                        usersData.push({
                            username: row[0].trim(),
                            email: row[1].trim(),
                            password: row[2].trim(),
                            nama: row[3].trim()
                        });
                    }
                }
                console.log('Users loaded from Google Sheets:', usersData.length);
            } catch (error) {
                console.error('Error loading users from Google Sheets:', error);
                alert('Gagal memuat data pengguna dari Google Sheets. Periksa konfigurasi API.');
            }
        }

        async function loadCompletedQuizFromSheet() {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_CONFIG.SHEET_ID}/values/${SHEET_CONFIG.QUIZ_SHEET_NAME}?key=${SHEET_CONFIG.API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                activeQuizData = [];
                const rows = data.values || [];
                
                // Skip header row (index 0)
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row && row.length >= 4 && row[0]) {
                        activeQuizData.push({
                            title: row[0].trim(),
                            description: row[1].trim(),
                            duration: row[2].trim(),
                            icon: row[3].trim(),
                            color: row[4] ? row[4].trim() : 'blue',
                            category: row[5] ? row[5].trim() : ''
                        });
                    }
                }
                console.log('Completed quiz loaded from Google Sheets:', activeQuizData.length);
                
                // Load categories first, then display quiz
                await loadCategoriesFromSheet();
                displayCompletedQuiz();
            } catch (error) {
                console.error('Error loading completed quiz from Google Sheets:', error);
                displayCompletedQuizError();
            }
        }

        function checkQuizAvailability(quizTitle) {
            // Find the quiz in activeQuizData
            const quiz = activeQuizData.find(q => q.title === quizTitle);
            if (!quiz || !quiz.category) {
                return true; // If no category specified, allow access
            }
            
            // Check if the quiz category exists in categoryData
            const categoryExists = categoryData.some(cat => 
                cat.name.toLowerCase() === quiz.category.toLowerCase()
            );
            
            return categoryExists;
        }

        function showQuizUnavailable(quizTitle) {
            const quiz = activeQuizData.find(q => q.title === quizTitle);
            const categoryName = quiz ? quiz.category : 'Unknown';
            
            alert(`üîí Quiz "${quizTitle}" tidak dapat diakses!\n\n` +
                  `Kategori "${categoryName}" belum tersedia dalam daftar kategori quiz.\n\n` +
                  `Silakan hubungi admin untuk menambahkan kategori ini.`);
        }

        async function loadCategoriesFromSheet() {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_CONFIG.SHEET_ID}/values/${SHEET_CONFIG.CATEGORY_SHEET_NAME}?key=${SHEET_CONFIG.API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                categoryData = [];
                const rows = data.values || [];
                
                // Skip header row (index 0)
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row && row.length >= 3 && row[0]) {
                        categoryData.push({
                            name: row[0].trim(),
                            icon: row[1].trim(),
                            quizCount: row[2].trim(),
                            color: row[3] ? row[3].trim() : 'blue',
                            description: row[4] ? row[4].trim() : ''
                        });
                    }
                }
                console.log('Categories loaded from Google Sheets:', categoryData.length);
                displayCategories();
            } catch (error) {
                console.error('Error loading categories from Google Sheets:', error);
                displayCategoriesError();
            }
        }

        async function loadQuestionsFromSheet() {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_CONFIG.SHEET_ID}/values/${SHEET_CONFIG.QUESTIONS_SHEET_NAME}?key=${SHEET_CONFIG.API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                questionsData = [];
                const rows = data.values || [];
                
                // Skip header row (index 0)
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row && row.length >= 3 && row[0]) {
                        const questionType = row[1] ? row[1].trim().toLowerCase() : 'pilihan_ganda';
                        
                        if (questionType === 'pilihan_ganda' && row.length >= 8) {
                            questionsData.push({
                                question: row[0].trim(),
                                type: 'pilihan_ganda',
                                optionA: row[2].trim(),
                                optionB: row[3].trim(),
                                optionC: row[4].trim(),
                                optionD: row[5].trim(),
                                optionE: row[6].trim(),
                                correctAnswer: row[7].trim().toUpperCase(),
                                category: row[8] ? row[8].trim() : 'Umum'
                            });
                        } else if (questionType === 'isian' && row.length >= 4) {
                            questionsData.push({
                                question: row[0].trim(),
                                type: 'isian',
                                correctAnswer: row[2].trim(),
                                category: row[3] ? row[3].trim() : 'Umum'
                            });
                        } else if (questionType === 'essay' && row.length >= 4) {
                            questionsData.push({
                                question: row[0].trim(),
                                type: 'essay',
                                correctAnswer: row[2].trim(),
                                category: row[3] ? row[3].trim() : 'Umum'
                            });
                        }
                    }
                }
                console.log('Questions loaded from Google Sheets:', questionsData.length);
            } catch (error) {
                console.error('Error loading questions from Google Sheets:', error);
                alert('Gagal memuat soal dari Google Sheets. Menggunakan soal default.');
            }
        }

        function displayCompletedQuiz() {
            const container = document.getElementById('completedQuizContainer');
            
            if (activeQuizData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-3xl mb-2">‚úÖ</div>
                        <p class="text-sm">Belum ada quiz selesai</p>
                    </div>
                `;
                return;
            }
            
            const colorClasses = {
                'blue': 'from-blue-100 to-blue-200',
                'green': 'from-green-100 to-emerald-100',
                'orange': 'from-orange-100 to-red-100',
                'purple': 'from-purple-100 to-purple-200',
                'red': 'from-red-100 to-red-200',
                'yellow': 'from-yellow-100 to-yellow-200'
            };
            
            container.innerHTML = activeQuizData.map(quiz => {
                return `
                    <div class="quiz-card bg-gradient-to-r ${colorClasses[quiz.color] || colorClasses.blue} rounded-xl p-4 relative opacity-75 transition-all">
                        <div class="absolute top-2 right-2 text-green-600">‚úÖ</div>
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-semibold text-gray-800">${quiz.title}</h4>
                                <p class="text-sm text-gray-600">${quiz.description} ‚Ä¢ Selesai</p>
                                <p class="text-xs text-green-600 mt-1">üìä Skor: 85% ‚Ä¢ ‚≠ê Lulus</p>
                            </div>
                            <div class="text-2xl">${quiz.icon}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayCompletedQuizError() {
            const container = document.getElementById('completedQuizContainer');
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <div class="text-3xl mb-2">‚ö†Ô∏è</div>
                    <p class="text-sm">Gagal memuat quiz selesai</p>
                    <button onclick="loadCompletedQuizFromSheet()" class="mt-2 text-blue-500 text-sm hover:underline">Coba lagi</button>
                </div>
            `;
        }

        function displayCategories() {
            const container = document.getElementById('categoriesContainer');
            
            if (categoryData.length === 0) {
                container.innerHTML = `
                    <div class="col-span-2 text-center py-8 text-gray-500">
                        <div class="text-3xl mb-2">üìÇ</div>
                        <p class="text-sm">Belum ada kategori tersedia</p>
                    </div>
                `;
                return;
            }
            
            const colorClasses = {
                'blue': 'from-blue-400 to-blue-600',
                'green': 'from-green-400 to-green-600',
                'orange': 'from-orange-400 to-orange-600',
                'purple': 'from-purple-400 to-purple-600',
                'red': 'from-red-400 to-red-600',
                'yellow': 'from-yellow-400 to-yellow-600'
            };
            
            const textColorClasses = {
                'blue': 'text-blue-100',
                'green': 'text-green-100',
                'orange': 'text-orange-100',
                'purple': 'text-purple-100',
                'red': 'text-red-100',
                'yellow': 'text-yellow-100'
            };
            
            container.innerHTML = categoryData.map(category => `
                <div class="bg-gradient-to-br ${colorClasses[category.color] || colorClasses.blue} rounded-2xl p-6 text-white cursor-pointer quiz-card" onclick="showCategoryQuizzes('${category.name}')">
                    <div class="text-3xl mb-3">${category.icon}</div>
                    <h3 class="font-semibold mb-1">${category.name}</h3>
                    <p class="text-sm ${textColorClasses[category.color] || textColorClasses.blue}">${category.quizCount} Quiz</p>
                </div>
            `).join('');
        }

        function displayCategoriesError() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = `
                <div class="col-span-2 text-center py-8 text-gray-500">
                    <div class="text-3xl mb-2">‚ö†Ô∏è</div>
                    <p class="text-sm">Gagal memuat kategori</p>
                    <button onclick="loadCategoriesFromSheet()" class="mt-2 text-blue-500 text-sm hover:underline">Coba lagi</button>
                </div>
            `;
        }

        function showLogin() {
            hideAllPages();
            document.getElementById('loginPage').classList.remove('hidden');
        }

        function showRegister() {
            hideAllPages();
            document.getElementById('registerPage').classList.remove('hidden');
        }



        function hideAllPages() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('registerPage').classList.add('hidden');
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('quizPage').classList.add('hidden');
            document.getElementById('categoriesPage').classList.add('hidden');
            document.getElementById('profilePage').classList.add('hidden');
        }

        // Login Form Handler
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Memuat...';
            submitBtn.disabled = true;
            
            try {
                await loadUsersFromSheet();
                
                const user = usersData.find(u => 
                    (u.username === username || u.email === username) && u.password === password
                );
                
                if (user) {
                    isLoggedIn = true;
                    currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    showMainApp();
                } else {
                    alert('Username/email atau password salah');
                }
            } catch (error) {
                alert('Gagal memuat data. Periksa koneksi internet.');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // Register Form Handler
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const nama = document.getElementById('registerName').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            
            // Basic validation
            if (nama.length < 2) {
                alert('Nama harus minimal 2 karakter');
                return;
            }
            
            if (username.length < 3) {
                alert('Username harus minimal 3 karakter');
                return;
            }
            
            if (password.length < 6) {
                alert('Password harus minimal 6 karakter');
                return;
            }
            
            // Check if username/email already exists
            const existingUser = usersData.find(u => u.username === username || u.email === email);
            if (existingUser) {
                alert('Username atau email sudah digunakan');
                return;
            }
            
            alert('Pendaftaran berhasil! Silakan tambahkan data berikut ke Google Sheet Anda:\n\n' +
                  `Username: ${username}\n` +
                  `Email: ${email}\n` +
                  `Password: ${password}\n` +
                  `Nama: ${nama}\n\n` +
                  'Setelah menambahkan data, Anda bisa login.');
            
            showLogin();
        });

        function showMainApp() {
            hideAllPages();
            document.getElementById('homePage').classList.remove('hidden');
            document.getElementById('appHeader').classList.remove('hidden');
            
            // Update profile info
            if (currentUser) {
                // Update any profile displays with current user data
                const profileElements = document.querySelectorAll('.user-name');
                profileElements.forEach(el => el.textContent = currentUser.nama);
            }
            
            // Load completed quiz data
            loadCompletedQuizFromSheet();
        }

        function showLogoutConfirm() {
            document.getElementById('logoutModal').classList.remove('hidden');
        }

        function hideLogoutConfirm() {
            document.getElementById('logoutModal').classList.add('hidden');
        }

        function confirmLogout() {
            isLoggedIn = false;
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('appHeader').classList.add('hidden');
            document.getElementById('logoutModal').classList.add('hidden');
            showLogin();
        }

        function logout() {
            showLogoutConfirm();
        }

        // Load Quiz History from Google Sheets and Local Storage
        async function loadQuizHistory() {
            if (!currentUser) return;
            
            let userQuizHistory = [];
            
            // First, try to load from Google Sheets
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_CONFIG.SHEET_ID}/values/${SHEET_CONFIG.RESULTS_SHEET_NAME}?key=${SHEET_CONFIG.API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.error && data.values) {
                    const rows = data.values || [];
                    
                    // Skip header row and filter by current user
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        if (row && row.length >= 10 && (row[0] === currentUser.nama || row[1] === currentUser.username)) {
                            userQuizHistory.push({
                                nama: row[0],
                                username: row[1],
                                judulQuiz: row[2],
                                tanggal: row[3],
                                waktu: row[4],
                                totalSoal: parseInt(row[5]) || 0,
                                jawabanBenar: parseInt(row[6]) || 0,
                                skor: row[7],
                                persentase: row[8],
                                status: row[9],
                                waktuPengerjaan: row[10] || '',
                                detailJawaban: row[11] || '',
                                source: 'sheets'
                            });
                        }
                    }
                }
            } catch (error) {
                console.log('Could not load from Google Sheets, checking local storage...');
            }
            
            // Also load from localStorage (for results not yet saved to sheets)
            try {
                const localResults = JSON.parse(localStorage.getItem('quizResults') || '[]');
                const userLocalResults = localResults.filter(result => 
                    result.nama === currentUser.nama || result.username === currentUser.username
                );
                
                // Add local results with a flag
                userLocalResults.forEach(result => {
                    userQuizHistory.push({
                        ...result,
                        source: 'local'
                    });
                });
            } catch (error) {
                console.error('Error loading local quiz results:', error);
            }
            
            // Remove duplicates (prefer sheets data over local)
            const uniqueHistory = [];
            const seen = new Set();
            
            // First add sheets data
            userQuizHistory.filter(h => h.source === 'sheets').forEach(history => {
                const key = `${history.judulQuiz}-${history.tanggal}-${history.waktu}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueHistory.push(history);
                }
            });
            
            // Then add local data that's not already in sheets
            userQuizHistory.filter(h => h.source === 'local').forEach(history => {
                const key = `${history.judulQuiz}-${history.tanggal}-${history.waktu}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueHistory.push(history);
                }
            });
            
            displayQuizHistory(uniqueHistory);
            updateProfileStats(uniqueHistory);
        }
        
        function displayQuizHistory(history) {
            const container = document.getElementById('quizHistoryContainer');
            
            if (history.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <div class="text-2xl mb-2">üìù</div>
                        <p class="text-sm">Belum ada riwayat quiz</p>
                    </div>
                `;
                return;
            }
            
            // Sort by date (newest first)
            history.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
            
            container.innerHTML = history.map(quiz => {
                const statusColor = quiz.status === 'Lulus' ? 'text-green-600' : 'text-red-600';
                const statusIcon = quiz.status === 'Lulus' ? '‚úÖ' : '‚ùå';
                const percentage = parseInt(quiz.persentase.replace('%', ''));
                
                // Show indicator for local vs sheets data
                const sourceIndicator = quiz.source === 'local' ? 
                    '<span class="inline-block w-2 h-2 bg-orange-400 rounded-full ml-1" title="Belum tersimpan di Google Sheets"></span>' : 
                    '<span class="inline-block w-2 h-2 bg-green-400 rounded-full ml-1" title="Tersimpan di Google Sheets"></span>';
                
                return `
                    <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50 transition-colors">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <h4 class="font-medium text-gray-800 text-sm">${quiz.judulQuiz}</h4>
                                ${sourceIndicator}
                            </div>
                            <span class="${statusColor} text-xs font-medium">${statusIcon} ${quiz.status}</span>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span>${quiz.tanggal}</span>
                            <span class="font-medium ${percentage >= 75 ? 'text-green-600' : 'text-red-600'}">${quiz.persentase}</span>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-400 mt-1">
                            <span>Skor: ${quiz.skor}</span>
                            <span>${quiz.waktuPengerjaan}</span>
                        </div>
                        ${quiz.source === 'local' ? `
                            <div class="mt-2 pt-2 border-t border-gray-100">
                                <button onclick="showLocalQuizData('${JSON.stringify(quiz).replace(/'/g, "\\'")}', this)" class="text-xs text-orange-600 hover:text-orange-700 font-medium">
                                    üìã Salin ke Google Sheets
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function showLocalQuizData(dataString, buttonElement) {
            try {
                const data = JSON.parse(dataString);
                const textToCopy = `${data.nama}\t${data.username}\t${data.judulQuiz}\t${data.tanggal}\t${data.waktu}\t${data.totalSoal}\t${data.jawabanBenar}\t${data.skor}\t${data.persentase}\t${data.status}\t${data.waktuPengerjaan}\t${data.detailJawaban}`;
                
                navigator.clipboard.writeText(textToCopy).then(() => {
                    buttonElement.innerHTML = '‚úÖ Tersalin!';
                    buttonElement.className = 'text-xs text-green-600 font-medium';
                    
                    setTimeout(() => {
                        buttonElement.innerHTML = 'üìã Salin ke Google Sheets';
                        buttonElement.className = 'text-xs text-orange-600 hover:text-orange-700 font-medium';
                    }, 2000);
                    
                    alert('‚úÖ Data quiz berhasil disalin!\n\nSekarang buka Google Sheet "hasil quiz" dan paste (Ctrl+V) data ini ke baris baru.');
                }).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = textToCopy;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('‚úÖ Data quiz berhasil disalin!\n\nSekarang buka Google Sheet "hasil quiz" dan paste (Ctrl+V) data ini ke baris baru.');
                });
            } catch (error) {
                alert('‚ùå Gagal menyalin data. Silakan salin manual.');
            }
        }
        
        function displayQuizHistoryError() {
            const container = document.getElementById('quizHistoryContainer');
            container.innerHTML = `
                <div class="text-center py-4 text-gray-500">
                    <div class="text-2xl mb-2">‚ö†Ô∏è</div>
                    <p class="text-sm">Gagal memuat riwayat</p>
                    <button onclick="loadQuizHistory()" class="mt-2 text-blue-500 text-sm hover:underline">Coba lagi</button>
                </div>
            `;
        }
        
        function updateProfileStats(history) {
            const totalQuizCount = history.length;
            const passedQuizCount = history.filter(quiz => quiz.status === 'Lulus').length;
            
            let averageScore = 0;
            if (totalQuizCount > 0) {
                const totalPercentage = history.reduce((sum, quiz) => {
                    return sum + parseInt(quiz.persentase.replace('%', ''));
                }, 0);
                averageScore = Math.round(totalPercentage / totalQuizCount);
            }
            
            document.getElementById('totalQuizCount').textContent = totalQuizCount;
            document.getElementById('averageScore').textContent = `${averageScore}%`;
            document.getElementById('passedQuizCount').textContent = passedQuizCount;
            
            // Update color based on average score
            const averageScoreElement = document.getElementById('averageScore');
            if (averageScore >= 75) {
                averageScoreElement.className = 'font-semibold text-green-500';
            } else if (averageScore >= 60) {
                averageScoreElement.className = 'font-semibold text-yellow-500';
            } else {
                averageScoreElement.className = 'font-semibold text-red-500';
            }
        }

        // Check if user is already logged in
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                isLoggedIn = true;
                showMainApp();
            } else {
                showLogin();
            }
            
            // Pre-load users data from Google Sheets
            loadUsersFromSheet();
        }

        // Show Google Apps Script Code
        function showAppsScriptCode() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-2xl w-full max-h-96 overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Google Apps Script Code</h3>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm font-mono overflow-x-auto mb-4">
<pre>function doPost(e) {
  try {
    const params = e.parameter;
    
    if (params.action === 'saveQuizResult') {
      // Ganti dengan ID Google Sheet Anda
      const SHEET_ID = '17MDc804lNUm_XwUM6hPj6Ui8T-JVtpxJCLq4XovVs0A';
      const SHEET_NAME = 'hasil quiz';
      
      const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
      
      // Data yang akan disimpan
      const rowData = [
        params.nama,
        params.username,
        params.judulQuiz,
        params.tanggal,
        params.waktu,
        params.totalSoal,
        params.jawabanBenar,
        params.skor,
        params.persentase,
        params.status,
        params.waktuPengerjaan,
        params.detailJawaban
      ];
      
      // Tambahkan baris baru
      sheet.appendRow(rowData);
      
      return ContentService
        .createTextOutput(JSON.stringify({success: true, message: 'Data berhasil disimpan'}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({success: false, message: 'Action tidak dikenali'}))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({success: false, message: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService
    .createTextOutput('Quiz Result Saver Web App is running!')
    .setMimeType(ContentService.MimeType.TEXT);
}</pre>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="copyAppsScriptCode()" class="w-full bg-blue-500 text-white py-3 rounded-xl font-medium hover:bg-blue-600 transition-colors">
                            üìã Salin Kode Apps Script
                        </button>
                        
                        <div class="bg-yellow-50 p-3 rounded-lg">
                            <p class="text-xs text-yellow-800 mb-2"><strong>üìù Langkah Setup:</strong></p>
                            <ol class="text-xs text-yellow-700 list-decimal list-inside space-y-1">
                                <li>Salin kode di atas</li>
                                <li>Buka <a href="https://script.google.com" target="_blank" class="text-blue-600 underline">script.google.com</a></li>
                                <li>Klik "New Project"</li>
                                <li>Hapus kode default, paste kode di atas</li>
                                <li>Ganti SHEET_ID dengan ID Google Sheet Anda</li>
                                <li>Klik "Deploy" ‚Üí "New deployment"</li>
                                <li>Type: "Web app", Execute as: "Me", Access: "Anyone"</li>
                                <li>Klik "Deploy" dan salin URL Web App</li>
                                <li>Ganti URL di konfigurasi sistem dengan URL tersebut</li>
                            </ol>
                        </div>
                        
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="w-full bg-gray-500 text-white py-3 rounded-xl font-medium hover:bg-gray-600 transition-colors">
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function copyAppsScriptCode() {
            const code = `function doPost(e) {
  try {
    const params = e.parameter;
    
    if (params.action === 'saveQuizResult') {
      // Ganti dengan ID Google Sheet Anda
      const SHEET_ID = '17MDc804lNUm_XwUM6hPj6Ui8T-JVtpxJCLq4XovVs0A';
      const SHEET_NAME = 'hasil quiz';
      
      const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
      
      // Data yang akan disimpan
      const rowData = [
        params.nama,
        params.username,
        params.judulQuiz,
        params.tanggal,
        params.waktu,
        params.totalSoal,
        params.jawabanBenar,
        params.skor,
        params.persentase,
        params.status,
        params.waktuPengerjaan,
        params.detailJawaban
      ];
      
      // Tambahkan baris baru
      sheet.appendRow(rowData);
      
      return ContentService
        .createTextOutput(JSON.stringify({success: true, message: 'Data berhasil disimpan'}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({success: false, message: 'Action tidak dikenali'}))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({success: false, message: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService
    .createTextOutput('Quiz Result Saver Web App is running!')
    .setMimeType(ContentService.MimeType.TEXT);
}`;
            
            navigator.clipboard.writeText(code).then(() => {
                alert('‚úÖ Kode Google Apps Script berhasil disalin!\\n\\nSekarang buka script.google.com dan ikuti langkah-langkah setup.');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = code;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('‚úÖ Kode Google Apps Script berhasil disalin!\\n\\nSekarang buka script.google.com dan ikuti langkah-langkah setup.');
            });
        }

        // Initialize app
        checkLoginStatus();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9807f7fe40d4f8e0',t:'MTc1ODEwNTQ1MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
