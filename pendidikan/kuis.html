<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizEdu - Media Pembelajaran</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .quiz-card { transition: all 0.3s ease; }
        .quiz-card:hover { transform: translateY(-2px); }
        .nav-item.active { color: #3B82F6; }
        .nav-item.active svg { stroke: #3B82F6; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen pb-20">
    <!-- Header -->
    <header id="appHeader" class="hidden bg-white shadow-sm px-4 py-4">
        <div class="flex items-center justify-between max-w-md mx-auto">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                    <span class="text-white font-bold text-lg">Q</span>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-800">QuizEdu</h1>
                    <p class="text-xs text-gray-500">Media Pembelajaran</p>
                </div>
            </div>
            <button onclick="showLogoutConfirm()" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors">
                <span class="text-sm">üë§</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-md mx-auto px-4 py-6" id="mainContent">
        <!-- Login Page -->
        <div id="loginPage" class="space-y-6">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mx-auto mb-4 flex items-center justify-center text-white text-3xl font-bold">
                    Q
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Selamat Datang</h1>
                <p class="text-gray-600">Masuk untuk melanjutkan belajar</p>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm">
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email atau Username</label>
                        <input type="text" id="loginUsername" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan email atau username" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan password" required>
                    </div>
                    
                    <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-700 transition-all">
                        Masuk
                    </button>
                </form>
                
                <div class="mt-4 text-center">
                    <p class="text-sm text-gray-600">Belum punya akun? <button onclick="showRegister()" class="text-blue-500 font-medium">Daftar di sini</button></p>
                </div>
            </div>


        </div>

        <!-- Register Page -->
        <div id="registerPage" class="hidden space-y-6">
            <div class="text-center mb-6">
                <button onclick="showLogin()" class="absolute left-4 top-20 text-gray-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Daftar Akun</h1>
                <p class="text-gray-600">Buat akun baru untuk mulai belajar</p>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm">
                <form id="registerForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                        <input type="text" id="registerName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan nama lengkap" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="registerUsername" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Pilih username" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="registerEmail" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan email" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="registerPassword" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Buat password" required>
                    </div>
                    
                    <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 rounded-xl font-semibold hover:from-green-600 hover:to-emerald-700 transition-all">
                        Daftar
                    </button>
                </form>
            </div>
        </div>



        <!-- Home Page -->
        <div id="homePage" class="hidden space-y-6">
            <!-- Welcome Card -->
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl p-6 text-white">
                <h2 class="text-2xl font-bold mb-2">Selamat Datang! üëã</h2>
                <p class="text-blue-100 mb-4">Siap untuk belajar dengan quiz interaktif?</p>
                <div class="flex items-center space-x-4 text-sm">
                    <div class="flex items-center space-x-1">
                        <span>üèÜ</span>
                        <span>Level 5</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <span>‚≠ê</span>
                        <span>850 Poin</span>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-3 gap-3">
                <div class="bg-white rounded-xl p-4 text-center shadow-sm">
                    <div class="text-2xl font-bold text-green-500">12</div>
                    <div class="text-xs text-gray-500">Quiz Selesai</div>
                </div>
                <div class="bg-white rounded-xl p-4 text-center shadow-sm">
                    <div class="text-2xl font-bold text-blue-500">85%</div>
                    <div class="text-xs text-gray-500">Akurasi</div>
                </div>
                <div class="bg-white rounded-xl p-4 text-center shadow-sm">
                    <div class="text-2xl font-bold text-purple-500">7</div>
                    <div class="text-xs text-gray-500">Hari Berturut</div>
                </div>
            </div>

            <!-- Active Quiz -->
            <div class="bg-white rounded-2xl p-6 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Quiz Aktif</h3>
                <div id="activeQuizContainer" class="space-y-3">
                    <!-- Loading state -->
                    <div class="text-center py-8 text-gray-500">
                        <div class="animate-spin w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full mx-auto mb-2"></div>
                        <p class="text-sm">Memuat quiz aktif...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quiz Page -->
        <div id="quizPage" class="hidden">
            <!-- No Activity Message -->
            <div id="noActivityMessage" class="flex flex-col items-center justify-center h-96 text-center">
                <div class="text-6xl mb-4">üìù</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Tidak Ada Aktivitas</h3>
                <p class="text-gray-600 mb-6">Belum ada quiz yang sedang dikerjakan</p>
                <button onclick="goHome()" class="bg-blue-500 text-white px-6 py-3 rounded-xl font-medium hover:bg-blue-600 transition-colors">
                    Kembali ke Beranda
                </button>
            </div>

            <!-- Quiz Content -->
            <div id="quizContent" class="bg-white rounded-2xl p-6 shadow-sm hidden">
                <div class="flex items-center justify-between mb-6">
                    <button onclick="goHome()" class="text-gray-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <div class="text-center">
                        <h3 class="font-semibold text-gray-800" id="quizTitle">Quiz</h3>
                        <p class="text-sm text-gray-500">Soal <span id="currentQuestion">1</span> dari <span id="totalQuestions">5</span></p>
                    </div>
                    <div class="text-sm text-blue-500 font-medium" id="timer">05:00</div>
                </div>

                <div class="mb-6">
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                        <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" id="progressBar" style="width: 20%"></div>
                    </div>
                </div>

                <div id="questionContainer">
                    <h4 class="text-lg font-semibold text-gray-800 mb-6" id="questionText">Berapa hasil dari 15 + 27?</h4>
                    
                    <div class="space-y-3" id="answersContainer">
                        <button class="answer-btn w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 transition-colors" onclick="selectAnswer(this, 'A')">
                            <span class="font-medium text-blue-500">A.</span> 42
                        </button>
                        <button class="answer-btn w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 transition-colors" onclick="selectAnswer(this, 'B')">
                            <span class="font-medium text-blue-500">B.</span> 41
                        </button>
                        <button class="answer-btn w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 transition-colors" onclick="selectAnswer(this, 'C')">
                            <span class="font-medium text-blue-500">C.</span> 43
                        </button>
                        <button class="answer-btn w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 transition-colors" onclick="selectAnswer(this, 'D')">
                            <span class="font-medium text-blue-500">D.</span> 40
                        </button>
                    </div>
                </div>

                <button id="nextBtn" class="w-full bg-blue-500 text-white py-4 rounded-xl font-semibold mt-6 opacity-50 cursor-not-allowed" disabled onclick="nextQuestion()">
                    Lanjut
                </button>
            </div>
        </div>

        <!-- Categories Page -->
        <div id="categoriesPage" class="hidden space-y-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Kategori Quiz</h2>
            
            <div id="categoriesContainer" class="grid grid-cols-2 gap-4">
                <!-- Loading state -->
                <div class="col-span-2 text-center py-8 text-gray-500">
                    <div class="animate-spin w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full mx-auto mb-2"></div>
                    <p class="text-sm">Memuat kategori...</p>
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profilePage" class="hidden space-y-6">
            <div class="text-center">
                <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mx-auto mb-4 flex items-center justify-center text-white text-2xl font-bold">
                    JD
                </div>
                <h2 class="text-xl font-bold text-gray-800 user-name">John Doe</h2>
                <p class="text-gray-500">Pelajar Aktif</p>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm">
                <h3 class="font-semibold text-gray-800 mb-4">Statistik</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Total Quiz</span>
                        <span class="font-semibold">24</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Rata-rata Skor</span>
                        <span class="font-semibold text-green-500">85%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Waktu Belajar</span>
                        <span class="font-semibold">12 jam</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm">
                <h3 class="font-semibold text-gray-800 mb-4">Pencapaian</h3>
                <div class="grid grid-cols-3 gap-4">
                    <div class="text-center">
                        <div class="text-2xl mb-2">üèÜ</div>
                        <p class="text-xs text-gray-600">Quiz Master</p>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl mb-2">‚≠ê</div>
                        <p class="text-xs text-gray-600">Perfect Score</p>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl mb-2">üî•</div>
                        <p class="text-xs text-gray-600">7 Hari Streak</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 mx-4 max-w-sm w-full">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-2xl">üö™</span>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Keluar dari Akun</h3>
                <p class="text-gray-600 mb-6">Apakah Anda yakin ingin keluar dari akun?</p>
                
                <div class="flex space-x-3">
                    <button onclick="hideLogoutConfirm()" class="flex-1 px-4 py-3 bg-gray-200 text-gray-800 rounded-xl font-medium hover:bg-gray-300 transition-colors">
                        Batal
                    </button>
                    <button onclick="confirmLogout()" class="flex-1 px-4 py-3 bg-red-500 text-white rounded-xl font-medium hover:bg-red-600 transition-colors">
                        Keluar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-4 py-2">
        <div class="max-w-md mx-auto">
            <div class="flex justify-around">
                <button class="nav-item active flex flex-col items-center py-2 px-3" onclick="showPage('home')">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    <span class="text-xs">Beranda</span>
                </button>
                
                <button class="nav-item flex flex-col items-center py-2 px-3 text-gray-400" onclick="showPage('categories')">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                    <span class="text-xs">Kategori</span>
                </button>
                
                <button class="nav-item flex flex-col items-center py-2 px-3 text-gray-400" onclick="showPage('quiz')">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    <span class="text-xs">Quiz</span>
                </button>
                
                <button class="nav-item flex flex-col items-center py-2 px-3 text-gray-400" onclick="showPage('profile')">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span class="text-xs">Profil</span>
                </button>
            </div>
        </div>
    </nav>

    <script>
        let currentQuestionIndex = 0;
        let selectedAnswer = null;
        let timer = 300; // 5 minutes
        let timerInterval;
        let isLoggedIn = false;
        let currentUser = null;
        let isQuizActive = false;
        let correctAnswers = 0;
        let userAnswers = [];
        // Google Sheets API Configuration
        const SHEET_CONFIG = {
            SHEET_ID: '17MDc804lNUm_XwUM6hPj6Ui8T-JVtpxJCLq4XovVs0A',
            SHEET_NAME: 'Login',
            QUIZ_SHEET_NAME: 'kuis aktif',
            CATEGORY_SHEET_NAME: 'kategori kuis',
            QUESTIONS_SHEET_NAME: 'soal quiz',
            API_KEY: 'AIzaSyCAJWvsjw92iebZM54KZivepTpl_Q2gk70'
        };
        let usersData = [];
        let activeQuizData = [];
        let categoryData = [];
        let questionsData = [];

        const sampleQuestions = [
            {
                question: "Berapa hasil dari 15 + 27?",
                type: "pilihan_ganda",
                answers: ["40", "41", "42", "43", "44"],
                correct: 2
            },
            {
                question: "Siapa penemu lampu pijar?",
                type: "pilihan_ganda",
                answers: ["Thomas Edison", "Nikola Tesla", "Alexander Bell", "Albert Einstein", "Isaac Newton"],
                correct: 0
            },
            {
                question: "Ibu kota Indonesia adalah ____",
                type: "isian",
                correctAnswer: "Jakarta"
            },
            {
                question: "Jelaskan proses fotosintesis pada tumbuhan!",
                type: "essay",
                correctAnswer: "Fotosintesis adalah proses pembuatan makanan oleh tumbuhan menggunakan cahaya matahari, air, dan karbon dioksida untuk menghasilkan glukosa dan oksigen."
            },
            {
                question: "Planet terdekat dengan matahari adalah?",
                type: "pilihan_ganda",
                answers: ["Venus", "Mars", "Merkurius", "Bumi", "Jupiter"],
                correct: 2
            }
        ];

        function showPage(page) {
            // Hide all pages
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('quizPage').classList.add('hidden');
            document.getElementById('categoriesPage').classList.add('hidden');
            document.getElementById('profilePage').classList.add('hidden');

            // Show selected page
            if (page === 'home') {
                document.getElementById('homePage').classList.remove('hidden');
            } else if (page === 'categories') {
                document.getElementById('categoriesPage').classList.remove('hidden');
                loadCategoriesFromSheet();
            } else if (page === 'quiz') {
                document.getElementById('quizPage').classList.remove('hidden');
                if (!isQuizActive) {
                    showNoActivity();
                }
            } else if (page === 'profile') {
                document.getElementById('profilePage').classList.remove('hidden');
            }

            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                item.classList.add('text-gray-400');
            });
            
            event.target.closest('.nav-item').classList.add('active');
            event.target.closest('.nav-item').classList.remove('text-gray-400');
        }

        async function startQuiz(title) {
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('categoriesPage').classList.add('hidden');
            document.getElementById('quizPage').classList.remove('hidden');
            
            isQuizActive = true;
            document.getElementById('quizTitle').textContent = title;
            currentQuestionIndex = 0;
            selectedAnswer = null;
            timer = 300;
            correctAnswers = 0;
            userAnswers = [];
            
            // Hide no activity message and show quiz content
            const noActivityDiv = document.getElementById('noActivityMessage');
            const quizContent = document.getElementById('quizContent');
            if (noActivityDiv) noActivityDiv.classList.add('hidden');
            if (quizContent) quizContent.classList.remove('hidden');
            
            // Load questions from Google Sheets
            await loadQuestionsFromSheet();
            
            loadQuestion();
            startTimer();
        }

        function showNoActivity() {
            const quizContent = document.getElementById('quizContent');
            const noActivityDiv = document.getElementById('noActivityMessage');
            
            if (quizContent) quizContent.classList.add('hidden');
            if (noActivityDiv) noActivityDiv.classList.remove('hidden');
        }

        function loadQuestion() {
            // Use questions from Google Sheets if available, otherwise use sample questions
            const questions = questionsData.length > 0 ? questionsData : sampleQuestions;
            
            if (currentQuestionIndex >= questions.length) {
                finishQuiz();
                return;
            }
            
            const question = questions[currentQuestionIndex];
            document.getElementById('questionText').textContent = question.question;
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = questions.length;
            
            const answersContainer = document.getElementById('answersContainer');
            answersContainer.innerHTML = '';
            
            // Handle different question types
            const questionType = question.type || 'pilihan_ganda';
            
            if (questionType === 'pilihan_ganda') {
                // Multiple choice questions
                if (questionsData.length > 0) {
                    // Google Sheets format
                    const options = [question.optionA, question.optionB, question.optionC, question.optionD, question.optionE];
                    options.forEach((option, index) => {
                        if (option && option.trim()) { // Only show non-empty options
                            const button = document.createElement('button');
                            button.className = 'answer-btn w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 transition-colors';
                            button.innerHTML = `<span class="font-medium text-blue-500">${String.fromCharCode(65 + index)}.</span> ${option}`;
                            button.onclick = () => selectAnswer(button, String.fromCharCode(65 + index));
                            answersContainer.appendChild(button);
                        }
                    });
                } else {
                    // Sample questions format
                    question.answers.forEach((answer, index) => {
                        const button = document.createElement('button');
                        button.className = 'answer-btn w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 transition-colors';
                        button.innerHTML = `<span class="font-medium text-blue-500">${String.fromCharCode(65 + index)}.</span> ${answer}`;
                        button.onclick = () => selectAnswer(button, String.fromCharCode(65 + index));
                        answersContainer.appendChild(button);
                    });
                }
            } else if (questionType === 'isian') {
                // Fill-in-the-blank questions
                const inputDiv = document.createElement('div');
                inputDiv.className = 'w-full';
                inputDiv.innerHTML = `
                    <input type="text" id="fillAnswer" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none" 
                           placeholder="Ketik jawaban Anda di sini..." onkeyup="handleTextInput()">
                `;
                answersContainer.appendChild(inputDiv);
            } else if (questionType === 'essay') {
                // Essay questions
                const textareaDiv = document.createElement('div');
                textareaDiv.className = 'w-full';
                textareaDiv.innerHTML = `
                    <textarea id="essayAnswer" rows="6" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none resize-none" 
                              placeholder="Tulis jawaban essay Anda di sini..." onkeyup="handleTextInput()"></textarea>
                    <div class="mt-2 text-sm text-gray-500">
                        <span id="charCount">0</span> karakter
                    </div>
                `;
                answersContainer.appendChild(textareaDiv);
            }
            
            // Update progress bar
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
            // Reset next button
            const nextBtn = document.getElementById('nextBtn');
            nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            nextBtn.disabled = true;
            selectedAnswer = null;
        }

        function selectAnswer(button, answer) {
            // Remove previous selection
            document.querySelectorAll('.answer-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50');
                btn.classList.add('border-gray-200');
            });
            
            // Highlight selected answer
            button.classList.remove('border-gray-200');
            button.classList.add('border-blue-500', 'bg-blue-50');
            
            selectedAnswer = answer;
            
            // Enable next button
            const nextBtn = document.getElementById('nextBtn');
            nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            nextBtn.disabled = false;
        }

        function handleTextInput() {
            const fillInput = document.getElementById('fillAnswer');
            const essayInput = document.getElementById('essayAnswer');
            const charCount = document.getElementById('charCount');
            
            let inputValue = '';
            
            if (fillInput) {
                inputValue = fillInput.value.trim();
                selectedAnswer = inputValue;
            } else if (essayInput) {
                inputValue = essayInput.value.trim();
                selectedAnswer = inputValue;
                
                // Update character count
                if (charCount) {
                    charCount.textContent = essayInput.value.length;
                }
            }
            
            // Enable/disable next button based on input
            const nextBtn = document.getElementById('nextBtn');
            if (inputValue.length > 0) {
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                nextBtn.disabled = false;
            } else {
                nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
                nextBtn.disabled = true;
            }
        }

        function nextQuestion() {
            if (!selectedAnswer) return;
            
            // Check if answer is correct
            const questions = questionsData.length > 0 ? questionsData : sampleQuestions;
            const currentQuestion = questions[currentQuestionIndex];
            const questionType = currentQuestion.type || 'pilihan_ganda';
            
            let isCorrect = false;
            let correctAnswerDisplay = '';
            
            if (questionType === 'pilihan_ganda') {
                if (questionsData.length > 0) {
                    // Google Sheets format
                    isCorrect = selectedAnswer === currentQuestion.correctAnswer;
                    correctAnswerDisplay = currentQuestion.correctAnswer;
                } else {
                    // Sample questions format
                    const correctIndex = currentQuestion.correct;
                    const correctLetter = String.fromCharCode(65 + correctIndex);
                    isCorrect = selectedAnswer === correctLetter;
                    correctAnswerDisplay = correctLetter;
                }
            } else if (questionType === 'isian') {
                // For fill-in questions, check if answer matches (case-insensitive)
                const userAnswer = selectedAnswer.toLowerCase().trim();
                const correctAnswer = currentQuestion.correctAnswer.toLowerCase().trim();
                isCorrect = userAnswer === correctAnswer;
                correctAnswerDisplay = currentQuestion.correctAnswer;
            } else if (questionType === 'essay') {
                // For essay questions, we'll mark as correct if user provided an answer
                // In real implementation, this would need manual grading
                isCorrect = selectedAnswer.length >= 10; // Minimum 10 characters
                correctAnswerDisplay = currentQuestion.correctAnswer;
            }
            
            if (isCorrect) {
                correctAnswers++;
            }
            
            // Store user answer
            userAnswers.push({
                question: currentQuestion.question,
                type: questionType,
                userAnswer: selectedAnswer,
                correctAnswer: correctAnswerDisplay,
                isCorrect: isCorrect
            });
            
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= questions.length) {
                finishQuiz();
            } else {
                loadQuestion();
            }
        }

        function finishQuiz() {
            clearInterval(timerInterval);
            isQuizActive = false;
            
            const questions = questionsData.length > 0 ? questionsData : sampleQuestions;
            const totalQuestions = questions.length;
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            
            let resultMessage = `Quiz Selesai!\n\n`;
            resultMessage += `Skor Anda: ${correctAnswers}/${totalQuestions} (${percentage}%)\n\n`;
            resultMessage += `Detail Jawaban:\n`;
            
            userAnswers.forEach((answer, index) => {
                const status = answer.isCorrect ? '‚úì' : '‚úó';
                const questionType = answer.type || 'pilihan_ganda';
                
                if (questionType === 'pilihan_ganda') {
                    resultMessage += `${index + 1}. ${status} ${answer.userAnswer} ${answer.isCorrect ? '' : '(Benar: ' + answer.correctAnswer + ')'}\n`;
                } else if (questionType === 'isian') {
                    resultMessage += `${index + 1}. ${status} "${answer.userAnswer}" ${answer.isCorrect ? '' : '(Benar: "' + answer.correctAnswer + '")'}\n`;
                } else if (questionType === 'essay') {
                    const preview = answer.userAnswer.length > 50 ? answer.userAnswer.substring(0, 50) + '...' : answer.userAnswer;
                    resultMessage += `${index + 1}. ${status} Essay: "${preview}"\n`;
                    if (!answer.isCorrect) {
                        resultMessage += `   Contoh jawaban: "${answer.correctAnswer}"\n`;
                    }
                }
            });
            
            alert(resultMessage);
            
            // Reset quiz data
            correctAnswers = 0;
            userAnswers = [];
            
            goHome();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timer--;
                const minutes = Math.floor(timer / 60);
                const seconds = timer % 60;
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timer <= 0) {
                    finishQuiz();
                }
            }, 1000);
        }

        function goHome() {
            clearInterval(timerInterval);
            isQuizActive = false;
            document.getElementById('quizPage').classList.add('hidden');
            document.getElementById('homePage').classList.remove('hidden');
            
            // Reset navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                item.classList.add('text-gray-400');
            });
            document.querySelector('.nav-item').classList.add('active');
            document.querySelector('.nav-item').classList.remove('text-gray-400');
        }

        function showCategoryQuizzes(category) {
            alert(`Menampilkan quiz untuk kategori: ${category}`);
        }

        // Authentication Functions
        async function loadUsersFromSheet() {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_CONFIG.SHEET_ID}/values/${SHEET_CONFIG.SHEET_NAME}?key=${SHEET_CONFIG.API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                usersData = [];
                const rows = data.values || [];
                
                // Skip header row (index 0)
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row && row.length >= 4 && row[0]) {
                        usersData.push({
                            username: row[0].trim(),
                            email: row[1].trim(),
                            password: row[2].trim(),
                            nama: row[3].trim()
                        });
                    }
                }
                console.log('Users loaded from Google Sheets:', usersData.length);
            } catch (error) {
                console.error('Error loading users from Google Sheets:', error);
                alert('Gagal memuat data pengguna dari Google Sheets. Periksa konfigurasi API.');
            }
        }

        async function loadActiveQuizFromSheet() {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_CONFIG.SHEET_ID}/values/${SHEET_CONFIG.QUIZ_SHEET_NAME}?key=${SHEET_CONFIG.API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                activeQuizData = [];
                const rows = data.values || [];
                
                // Skip header row (index 0)
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row && row.length >= 4 && row[0]) {
                        activeQuizData.push({
                            title: row[0].trim(),
                            description: row[1].trim(),
                            duration: row[2].trim(),
                            icon: row[3].trim(),
                            color: row[4] ? row[4].trim() : 'blue'
                        });
                    }
                }
                console.log('Active quiz loaded from Google Sheets:', activeQuizData.length);
                displayActiveQuiz();
            } catch (error) {
                console.error('Error loading active quiz from Google Sheets:', error);
                displayActiveQuizError();
            }
        }

        async function loadCategoriesFromSheet() {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_CONFIG.SHEET_ID}/values/${SHEET_CONFIG.CATEGORY_SHEET_NAME}?key=${SHEET_CONFIG.API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                categoryData = [];
                const rows = data.values || [];
                
                // Skip header row (index 0)
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row && row.length >= 3 && row[0]) {
                        categoryData.push({
                            name: row[0].trim(),
                            icon: row[1].trim(),
                            quizCount: row[2].trim(),
                            color: row[3] ? row[3].trim() : 'blue',
                            description: row[4] ? row[4].trim() : ''
                        });
                    }
                }
                console.log('Categories loaded from Google Sheets:', categoryData.length);
                displayCategories();
            } catch (error) {
                console.error('Error loading categories from Google Sheets:', error);
                displayCategoriesError();
            }
        }

        async function loadQuestionsFromSheet() {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_CONFIG.SHEET_ID}/values/${SHEET_CONFIG.QUESTIONS_SHEET_NAME}?key=${SHEET_CONFIG.API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                questionsData = [];
                const rows = data.values || [];
                
                // Skip header row (index 0)
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row && row.length >= 3 && row[0]) {
                        const questionType = row[1] ? row[1].trim().toLowerCase() : 'pilihan_ganda';
                        
                        if (questionType === 'pilihan_ganda' && row.length >= 8) {
                            questionsData.push({
                                question: row[0].trim(),
                                type: 'pilihan_ganda',
                                optionA: row[2].trim(),
                                optionB: row[3].trim(),
                                optionC: row[4].trim(),
                                optionD: row[5].trim(),
                                optionE: row[6].trim(),
                                correctAnswer: row[7].trim().toUpperCase(),
                                category: row[8] ? row[8].trim() : 'Umum'
                            });
                        } else if (questionType === 'isian' && row.length >= 4) {
                            questionsData.push({
                                question: row[0].trim(),
                                type: 'isian',
                                correctAnswer: row[2].trim(),
                                category: row[3] ? row[3].trim() : 'Umum'
                            });
                        } else if (questionType === 'essay' && row.length >= 4) {
                            questionsData.push({
                                question: row[0].trim(),
                                type: 'essay',
                                correctAnswer: row[2].trim(),
                                category: row[3] ? row[3].trim() : 'Umum'
                            });
                        }
                    }
                }
                console.log('Questions loaded from Google Sheets:', questionsData.length);
            } catch (error) {
                console.error('Error loading questions from Google Sheets:', error);
                alert('Gagal memuat soal dari Google Sheets. Menggunakan soal default.');
            }
        }

        function displayActiveQuiz() {
            const container = document.getElementById('activeQuizContainer');
            
            if (activeQuizData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-3xl mb-2">üìù</div>
                        <p class="text-sm">Belum ada quiz aktif</p>
                    </div>
                `;
                return;
            }
            
            const colorClasses = {
                'blue': 'from-blue-100 to-blue-200',
                'green': 'from-green-100 to-emerald-100',
                'orange': 'from-orange-100 to-red-100',
                'purple': 'from-purple-100 to-purple-200',
                'red': 'from-red-100 to-red-200',
                'yellow': 'from-yellow-100 to-yellow-200'
            };
            
            container.innerHTML = activeQuizData.map(quiz => `
                <div class="quiz-card bg-gradient-to-r ${colorClasses[quiz.color] || colorClasses.blue} rounded-xl p-4 cursor-pointer" onclick="startQuiz('${quiz.title}')">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold text-gray-800">${quiz.title}</h4>
                            <p class="text-sm text-gray-600">${quiz.description} ‚Ä¢ ${quiz.duration}</p>
                        </div>
                        <div class="text-2xl">${quiz.icon}</div>
                    </div>
                </div>
            `).join('');
        }

        function displayActiveQuizError() {
            const container = document.getElementById('activeQuizContainer');
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <div class="text-3xl mb-2">‚ö†Ô∏è</div>
                    <p class="text-sm">Gagal memuat quiz aktif</p>
                    <button onclick="loadActiveQuizFromSheet()" class="mt-2 text-blue-500 text-sm hover:underline">Coba lagi</button>
                </div>
            `;
        }

        function displayCategories() {
            const container = document.getElementById('categoriesContainer');
            
            if (categoryData.length === 0) {
                container.innerHTML = `
                    <div class="col-span-2 text-center py-8 text-gray-500">
                        <div class="text-3xl mb-2">üìÇ</div>
                        <p class="text-sm">Belum ada kategori tersedia</p>
                    </div>
                `;
                return;
            }
            
            const colorClasses = {
                'blue': 'from-blue-400 to-blue-600',
                'green': 'from-green-400 to-green-600',
                'orange': 'from-orange-400 to-orange-600',
                'purple': 'from-purple-400 to-purple-600',
                'red': 'from-red-400 to-red-600',
                'yellow': 'from-yellow-400 to-yellow-600'
            };
            
            const textColorClasses = {
                'blue': 'text-blue-100',
                'green': 'text-green-100',
                'orange': 'text-orange-100',
                'purple': 'text-purple-100',
                'red': 'text-red-100',
                'yellow': 'text-yellow-100'
            };
            
            container.innerHTML = categoryData.map(category => `
                <div class="bg-gradient-to-br ${colorClasses[category.color] || colorClasses.blue} rounded-2xl p-6 text-white cursor-pointer quiz-card" onclick="showCategoryQuizzes('${category.name}')">
                    <div class="text-3xl mb-3">${category.icon}</div>
                    <h3 class="font-semibold mb-1">${category.name}</h3>
                    <p class="text-sm ${textColorClasses[category.color] || textColorClasses.blue}">${category.quizCount} Quiz</p>
                </div>
            `).join('');
        }

        function displayCategoriesError() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = `
                <div class="col-span-2 text-center py-8 text-gray-500">
                    <div class="text-3xl mb-2">‚ö†Ô∏è</div>
                    <p class="text-sm">Gagal memuat kategori</p>
                    <button onclick="loadCategoriesFromSheet()" class="mt-2 text-blue-500 text-sm hover:underline">Coba lagi</button>
                </div>
            `;
        }

        function showLogin() {
            hideAllPages();
            document.getElementById('loginPage').classList.remove('hidden');
        }

        function showRegister() {
            hideAllPages();
            document.getElementById('registerPage').classList.remove('hidden');
        }



        function hideAllPages() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('registerPage').classList.add('hidden');
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('quizPage').classList.add('hidden');
            document.getElementById('categoriesPage').classList.add('hidden');
            document.getElementById('profilePage').classList.add('hidden');
        }

        // Login Form Handler
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Memuat...';
            submitBtn.disabled = true;
            
            try {
                await loadUsersFromSheet();
                
                const user = usersData.find(u => 
                    (u.username === username || u.email === username) && u.password === password
                );
                
                if (user) {
                    isLoggedIn = true;
                    currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    showMainApp();
                } else {
                    alert('Username/email atau password salah');
                }
            } catch (error) {
                alert('Gagal memuat data. Periksa koneksi internet.');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // Register Form Handler
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const nama = document.getElementById('registerName').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            
            // Basic validation
            if (nama.length < 2) {
                alert('Nama harus minimal 2 karakter');
                return;
            }
            
            if (username.length < 3) {
                alert('Username harus minimal 3 karakter');
                return;
            }
            
            if (password.length < 6) {
                alert('Password harus minimal 6 karakter');
                return;
            }
            
            // Check if username/email already exists
            const existingUser = usersData.find(u => u.username === username || u.email === email);
            if (existingUser) {
                alert('Username atau email sudah digunakan');
                return;
            }
            
            alert('Pendaftaran berhasil! Silakan tambahkan data berikut ke Google Sheet Anda:\n\n' +
                  `Username: ${username}\n` +
                  `Email: ${email}\n` +
                  `Password: ${password}\n` +
                  `Nama: ${nama}\n\n` +
                  'Setelah menambahkan data, Anda bisa login.');
            
            showLogin();
        });

        function showMainApp() {
            hideAllPages();
            document.getElementById('homePage').classList.remove('hidden');
            document.getElementById('appHeader').classList.remove('hidden');
            
            // Update profile info
            if (currentUser) {
                // Update any profile displays with current user data
                const profileElements = document.querySelectorAll('.user-name');
                profileElements.forEach(el => el.textContent = currentUser.nama);
            }
            
            // Load active quiz data
            loadActiveQuizFromSheet();
        }

        function showLogoutConfirm() {
            document.getElementById('logoutModal').classList.remove('hidden');
        }

        function hideLogoutConfirm() {
            document.getElementById('logoutModal').classList.add('hidden');
        }

        function confirmLogout() {
            isLoggedIn = false;
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('appHeader').classList.add('hidden');
            document.getElementById('logoutModal').classList.add('hidden');
            showLogin();
        }

        function logout() {
            showLogoutConfirm();
        }

        // Check if user is already logged in
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                isLoggedIn = true;
                showMainApp();
            } else {
                showLogin();
            }
            
            // Pre-load users data from Google Sheets
            loadUsersFromSheet();
        }

        // Initialize app
        checkLoginStatus();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98077e46f6509f8b',t:'MTc1ODEwMDQ2Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
